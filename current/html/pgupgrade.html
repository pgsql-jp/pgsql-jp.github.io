<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>pg_upgrade</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="prev" href="pgtesttiming.html" title="pg_test_timing" /><link rel="next" href="pgwaldump.html" title="pg_waldump" /><meta name="viewport" content="width=device-width,initial-scale=1.0" /></head><body id="docContent" class="container-fluid col-10"><div class="other_version"><a href="https://www.postgresql.jp/document/">バージョンごとのドキュメント一覧</a></div><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="4" align="center"><a accesskey="h" href="index.html">PostgreSQL 18.0文書</a></th></tr><tr><td width="10%" align="left"></td><td width="10%" align="left"></td><td width="60%" align="center"><a href="reference-server.html" title="PostgreSQLサーバアプリケーション">PostgreSQLサーバアプリケーション</a></td><td width="20%" align="right"><div class="actions"><a class="issue" title="github" href="https://github.com/pgsql-jp/jpug-doc/issues/new?template=bug_report.yml&amp;what-happened=version 18.0 : pgupgrade.html">誤訳等の報告
                    </a></div></td></tr><tr><td width="10%" align="left"><a accesskey="p" href="pgtesttiming.html" title="pg_test_timing">前へ</a> </td><td width="10%" align="left"><a accesskey="u" href="reference-server.html" title="PostgreSQLサーバアプリケーション">上へ</a></td><td width="60%" align="center"><span class="application">pg_upgrade</span></td><td width="20%" align="right"> <a accesskey="n" href="pgwaldump.html" title="pg_waldump">次へ</a></td></tr></table><hr /></div><div class="refentry" id="PGUPGRADE"><div class="titlepage"></div><a id="id-1.9.5.13.1" class="indexterm"></a><div class="refnamediv"><h2><span class="refentrytitle"><span class="application">pg_upgrade</span></span></h2><p>pg_upgrade<span class="original">
  &lt;refpurpose&gt;upgrade a &lt;productname&gt;PostgreSQL&lt;/productname&gt; server instance&lt;/refpurpose&gt;
</span> — <span class="productname">PostgreSQL</span>サーバインスタンスをアップグレードする</p></div><div class="refsynopsisdiv"><h2>概要</h2><div class="cmdsynopsis"><p id="id-1.9.5.13.4.1"><code class="command">pg_upgrade</code>  <code class="option">-b</code>   <em class="replaceable"><code>oldbindir</code></em>  [<code class="option">-B</code> <em class="replaceable"><code>newbindir</code></em>]  <code class="option">-d</code>   <em class="replaceable"><code>oldconfigdir</code></em>   <code class="option">-D</code>   <em class="replaceable"><code>newconfigdir</code></em>  [<em class="replaceable"><code>option</code></em>...]</p></div></div><div class="refsect1" id="id-1.9.5.13.5"><h2>説明</h2><span class="original">
  &lt;title&gt;Description&lt;/title&gt;
</span><p>
<span class="original">
  &lt;application&gt;pg_upgrade&lt;/application&gt; (formerly called &lt;application&gt;pg_migrator&lt;/application&gt;) allows data
  stored in &lt;productname&gt;PostgreSQL&lt;/productname&gt; data files to be upgraded to a later &lt;productname&gt;PostgreSQL&lt;/productname&gt;
  major version without the data dump/restore typically required for
  major version upgrades, e.g., from 12.14 to 13.10 or from 14.9 to 15.5.
  It is not required for minor version upgrades, e.g., from 12.7 to 12.8
  or from 14.1 to 14.5.
</span>
<span class="application">pg_upgrade</span>(これまでは<span class="application">pg_migrator</span>と呼ばれていました)を使用することで、メジャーバージョンのアップグレード、例えば、12.14から13.10へ、14.9から15.5へのアップグレードで通常必要とされるデータのダンプ/リストアを行うことなく、<span class="productname">PostgreSQL</span>データファイル内に格納されたデータをより最新の<span class="productname">PostgreSQL</span>メジャーバージョンに移行できます。
これは、例えば12.7から12.8、14.1から14.5などマイナーバージョンのアップグレードでは必要ありません。
 </p><p>
<span class="original">
  Major PostgreSQL releases regularly add new features that often
  change the layout of the system tables, but the internal data storage
  format rarely changes.  &lt;application&gt;pg_upgrade&lt;/application&gt; uses this fact
  to perform rapid upgrades by creating new system tables and simply
  reusing the old user data files.  If a future major release ever
  changes the data storage format in a way that makes the old data
  format unreadable, &lt;application&gt;pg_upgrade&lt;/application&gt; will not be usable
  for such upgrades.  (The community will attempt to avoid such
  situations.)
</span>
PostgreSQLのメジャーリリースでは通常、システムテーブルのレイアウトをよく変更する、多くの機能が追加されます。
しかし内部データの格納書式はまれにしか変更されません。
<span class="application">pg_upgrade</span>はこの事実を使用して、システムテーブルを新しく作成し、古いユーザデータファイルを単に再利用することで、高速なアップグレードを実施します。
将来のメジャーリリースでついに古いデータ書式を読み取ることができなくなるようにデータ格納書式を変更した場合、<span class="application">pg_upgrade</span>ではこうしたアップグレードを扱うことができません。
（コミュニティはこうした状況を防ごうと考えています。）
 </p><p>
<span class="original">
  &lt;application&gt;pg_upgrade&lt;/application&gt; does its best to
  make sure the old and new clusters are binary-compatible, e.g.,  by
  checking for compatible compile-time settings, including 32/64-bit
  binaries.  It is important that
  any external modules are also binary compatible, though this cannot
  be checked by &lt;application&gt;pg_upgrade&lt;/application&gt;.
</span>
<span class="application">pg_upgrade</span>は古いクラスタと新しいクラスタとの間で、例えばコンパイル時の設定に互換性があるかどうか、32ビットバイナリか64ビットバイナリかなど、バイナリ互換性があることを確実にするために最善を尽くします。
任意の外部モジュールがバイナリ互換であることも重要ですが、これは<span class="application">pg_upgrade</span>では検査することができません。
 </p><p>
<span class="original">
   &lt;application&gt;pg_upgrade&lt;/application&gt; supports upgrades from 9.2.X and later to the current
   major release of &lt;productname&gt;PostgreSQL&lt;/productname&gt;, including snapshot and beta releases.
</span>
《マッチ度[83.783784]》pg_upgradeは9.2.X以降から現時点の<span class="productname">PostgreSQL</span>のメジャーリリース(スナップショット版やβリリースを含む)へのアップグレードをサポートします。
《機械翻訳》<span class="application">pg_upgrade</span>は、9.2.X以降から現在メジャーリリースの<span class="productname">PostgreSQL</span>、snapshotおよびベータのリリースを含むへのアップグレードをサポートします。
  </p><div class="warning"><h3 class="title">警告</h3><p>
<span class="original">
    Upgrading a cluster causes the destination to execute arbitrary code of the
    source superusers' choice.  Ensure that the source superusers are trusted
    before upgrading.
</span>
クラスタをアップグレードすると、アップグレード元のスーパーユーザが選択した任意のコードをアップグレード先で実行することになります。
アップグレードする前に、アップグレード元のスーパーユーザが信頼できることを確認してください。
   </p></div></div><div class="refsect1" id="id-1.9.5.13.6"><h2>オプション</h2><span class="original">
  &lt;title&gt;Options&lt;/title&gt;
</span><p>
<span class="original">
    &lt;application&gt;pg_upgrade&lt;/application&gt; accepts the following command-line arguments:
</span>
    <span class="application">pg_upgrade</span>は以下のコマンドライン引数を受け付けます。

    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-b</code> <em class="replaceable"><code>bindir</code></em><br /></span><span class="term"><code class="option">--old-bindir=</code><em class="replaceable"><code>bindir</code></em></span></dt><dd><p>古いPostgreSQLの実行ファイル格納ディレクトリ。<code class="envar">PGBINOLD</code>環境変数</p></dd><dt><span class="term"><code class="option">-B</code> <em class="replaceable"><code>bindir</code></em><br /></span><span class="term"><code class="option">--new-bindir=</code><em class="replaceable"><code>bindir</code></em></span></dt><dd><p>新しいPostgreSQLの実行ファイル格納ディレクトリ。デフォルトは<span class="application">pg_upgrade</span>のあるディレクトリ。<code class="envar">PGBINNEW</code>環境変数</p></dd><dt><span class="term"><code class="option">-c</code><br /></span><span class="term"><code class="option">--check</code></span></dt><dd><p>クラスタの検査のみを行い、データの変更を行いません。</p></dd><dt><span class="term"><code class="option">-d</code> <em class="replaceable"><code>configdir</code></em><br /></span><span class="term"><code class="option">--old-datadir=</code><em class="replaceable"><code>configdir</code></em></span></dt><dd><p>古いクラスタの設定データディレクトリ。<code class="envar">PGDATAOLD</code>環境変数</p></dd><dt><span class="term"><code class="option">-D</code> <em class="replaceable"><code>configdir</code></em><br /></span><span class="term"><code class="option">--new-datadir=</code><em class="replaceable"><code>configdir</code></em></span></dt><dd><p>新しいクラスタの設定データディレクトリ。<code class="envar">PGDATANEW</code>環境変数</p></dd><dt><span class="term"><code class="option">-j <em class="replaceable"><code>njobs</code></em></code><br /></span><span class="term"><code class="option">--jobs=<em class="replaceable"><code>njobs</code></em></code></span></dt><dd><p>《機械翻訳》使用する同時接続とプロセス/スレッドの数。</p></dd><dt><span class="term"><code class="option">-k</code><br /></span><span class="term"><code class="option">--link</code></span></dt><dd><p>新しいクラスタにファイルをコピーするのではなく、ハードリンクを使用します。</p></dd><dt><span class="term"><code class="option">-N</code><br /></span><span class="term"><code class="option">--no-sync</code></span></dt><dd><p>
<span class="original">
        By default, &lt;command&gt;pg_upgrade&lt;/command&gt; will wait for all files
        of the upgraded cluster to be written safely to disk.  This option
        causes &lt;command&gt;pg_upgrade&lt;/command&gt; to return without waiting, which
        is faster, but means that a subsequent operating system crash can leave
        the data directory corrupt.  Generally, this option is
        useful for testing but should not be used on a production
        installation.
</span>
デフォルトでは、<code class="command">pg_upgrade</code>はアップグレードされたクラスタのすべてのファイルが安全にディスクに書き込まれるのを待ちます。
このオプションで<code class="command">pg_upgrade</code>は待たずに戻るようになります。これはより高速ですが、その後のオペレーティングシステムのクラッシュによってデータディレクトリが壊れたままになる可能性があることを意味します。
一般的に、このオプションは試験するには有用ですが、実稼働環境では使用すべきではありません。
       </p></dd><dt><span class="term"><code class="option">-o</code> <em class="replaceable"><code>options</code></em><br /></span><span class="term"><code class="option">--old-options</code> <em class="replaceable"><code>options</code></em></span></dt><dd><p>古い<code class="command">postgres</code>コマンドに直接渡すオプションです。複数の起動オプションが追加されます。</p></dd><dt><span class="term"><code class="option">-O</code> <em class="replaceable"><code>options</code></em><br /></span><span class="term"><code class="option">--new-options</code> <em class="replaceable"><code>options</code></em></span></dt><dd><p>新しい<code class="command">postgres</code>コマンドに直接渡すオプションです。複数の起動オプションが追加されます。</p></dd><dt><span class="term"><code class="option">-p</code> <em class="replaceable"><code>port</code></em><br /></span><span class="term"><code class="option">--old-port=</code><em class="replaceable"><code>port</code></em></span></dt><dd><p>古いクラスタのポート番号。<code class="envar">PGPORTOLD</code>環境変数</p></dd><dt><span class="term"><code class="option">-P</code> <em class="replaceable"><code>port</code></em><br /></span><span class="term"><code class="option">--new-port=</code><em class="replaceable"><code>port</code></em></span></dt><dd><p>新しいクラスタのポート番号。<code class="envar">PGPORTNEW</code>環境変数</p></dd><dt><span class="term"><code class="option">-r</code><br /></span><span class="term"><code class="option">--retain</code></span></dt><dd><p>正常に完了した場合であってもSQLファイルとログファイルを保持します。</p></dd><dt><span class="term"><code class="option">-s</code> <em class="replaceable"><code>dir</code></em><br /></span><span class="term"><code class="option">--socketdir=</code><em class="replaceable"><code>dir</code></em></span></dt><dd><p>アップグレード中にpostmasterソケット用に利用するディレクトリ。デフォルトは現在の作業ディレクトリです。環境変数<code class="envar">PGSOCKETDIR</code></p></dd><dt><span class="term"><code class="option">-U</code> <em class="replaceable"><code>username</code></em><br /></span><span class="term"><code class="option">--username=</code><em class="replaceable"><code>username</code></em></span></dt><dd><p>クラスタのインストールユーザの名称。<code class="envar">PGUSER</code>環境変数</p></dd><dt><span class="term"><code class="option">-v</code><br /></span><span class="term"><code class="option">--verbose</code></span></dt><dd><p>冗長な内部ログを有効にします。</p></dd><dt><span class="term"><code class="option">-V</code><br /></span><span class="term"><code class="option">--version</code></span></dt><dd><p>バージョン情報を表示し、終了します。</p></dd><dt><span class="term"><code class="option">--clone</code></span></dt><dd><p>
<span class="original">
        Use efficient file cloning (also known as &lt;quote&gt;reflinks&lt;/quote&gt; on
        some systems) instead of copying files to the new cluster.  This can
        result in near-instantaneous copying of the data files, giving the
        speed advantages of &lt;option&gt;-k&lt;/option&gt;/&lt;option&gt;&amp;#45;-link&lt;/option&gt; while
        leaving the old cluster untouched.
</span>
新しいクラスタにファイルをコピーする代わりに、効率的なファイルの複製(システムのいくつかでは<span class="quote">「<span class="quote">reflink</span>」</span>としても知られています)を使います。
これは、データファイルをほぼ瞬間的にコピーし、古いクラスタに手をつけずに<code class="option">-k</code>/<code class="option">--link</code>の速度の利点を与えることになるでしょう、
       </p><p>
<span class="original">
        File cloning is only supported on some operating systems and file
        systems.  If it is selected but not supported, the
        &lt;application&gt;pg_upgrade&lt;/application&gt; run will error.  At present, it
        is supported on Linux (kernel 4.5 or later) with Btrfs and XFS (on
        file systems created with reflink support), and on macOS with APFS.
</span>
ファイルの複製はいくつかのオペレーティングシステムとファイルシステムでのみサポートされています。
選択されたもののサポートされていなければ、<span class="application">pg_upgrade</span>の実行はエラーになります。
現在のところ、BtrfsとXFS(のreflinkサポート付きで作られたファイルシステム)のLinux(カーネル4.5以降)と、APFSのmacOSでサポートされています。
       </p></dd><dt><span class="term"><code class="option">--copy</code></span></dt><dd><p>
<span class="original">
        Copy files to the new cluster.  This is the default.  (See also
        &lt;option&gt;&amp;#45;-link&lt;/option&gt;, &lt;option&gt;&amp;#45;-clone&lt;/option&gt;,
        &lt;option&gt;&amp;#45;-copy-file-range&lt;/option&gt;, and &lt;option&gt;&amp;#45;-swap&lt;/option&gt;.)
</span>
《マッチ度[55.617978]》新しいクラスタにファイルをコピーします。
これがデフォルトです。
（<code class="option">--link</code>および<code class="option">--clone</code>も参照してください。）
《機械翻訳》コピーが新しいクラスタにファイルします。
これがデフォルトです。
<code class="option">--link</code>、<code class="option">--clone</code>、<code class="option">--copy-file-range</code>、および<code class="option">--swap</code>。
も参照してください。
       </p></dd><dt><span class="term"><code class="option">--copy-file-range</code></span></dt><dd><p>
<span class="original">
        Use the &lt;function&gt;copy_file_range&lt;/function&gt; system call for efficient
        copying.  On some file systems this gives results similar to
        &lt;option&gt;&amp;#45;-clone&lt;/option&gt;, sharing physical disk blocks, while on others
        it may still copy blocks, but do so via an optimized path.  At present,
        it is supported on Linux and FreeBSD.
</span>
効率的なコピーを行うには、システムコール<code class="function">copy_file_range</code>を使用します。
ファイルシステムによっては、物理ディスクブロックを共有する<code class="option">--clone</code>と同様の結果を得られるものもあれば、ブロックをコピーするものの、最適化されたパスを介してコピーするものもあります。
現在、LinuxとFreeBSDでサポートされています。
       </p></dd><dt><span class="term"><code class="option">--no-statistics</code></span></dt><dd><p>
<span class="original">
        Do not restore statistics from the old cluster into the new cluster.
</span>
《機械翻訳》古いクラスタから新しいクラスタに統計処理をリストアしないでください。
       </p></dd><dt><span class="term"><code class="option">--set-char-signedness=</code><em class="replaceable"><code>option</code></em></span></dt><dd><p>
<span class="original">
        Manually set the default char signedness of new clusters. Possible values
        are &lt;literal&gt;signed&lt;/literal&gt; and &lt;literal&gt;unsigned&lt;/literal&gt;.
</span>
《機械翻訳》新しいクラスタのデフォルト文字の符号を手動で設定します。
有効な値は<code class="literal">signed</code>と<code class="literal">unsigned</code>です。
       </p><p>
<span class="original">
        In the C language, the default signedness of the &lt;type&gt;char&lt;/type&gt; type
        (when not explicitly specified) varies across platforms. For example,
        &lt;type&gt;char&lt;/type&gt; defaults to &lt;type&gt;signed char&lt;/type&gt; on x86 CPUs but
        to &lt;type&gt;unsigned char&lt;/type&gt; on ARM CPUs.
</span>
《機械翻訳》C言語では、<code class="type">char</code>デフォルトのタイプ符号はプラットフォームによって異なります。
例の場合、<code class="type">char</code>のデフォルトはx86 CPUでは<code class="type">signed char</code>ですが、ARM CPUでは<code class="type">unsigned char</code>です。
       </p><p>
<span class="original">
        Starting from &lt;productname&gt;PostgreSQL&lt;/productname&gt; 18, database clusters
        maintain their own default char signedness setting, which can be used to
        ensure consistent behavior across platforms with different default char
        signedness. By default, &lt;application&gt;pg_upgrade&lt;/application&gt; preserves
        the char signedness setting when upgrading from an existing cluster.
        However, when upgrading from &lt;productname&gt;PostgreSQL&lt;/productname&gt; 17 or
        earlier, &lt;application&gt;pg_upgrade&lt;/application&gt; adopts the char signedness
        of the platform on which it was built.
</span>
《機械翻訳》<span class="productname">PostgreSQL</span>18以降、データベースクラスタは独自のデフォルトchar signedness設定を維持しており、これを使用して、異なる保証char signednessを持つプラットフォーム間で一貫した動作をデフォルトすることができる。
デフォルトでは、既存のクラスタからアップグレード処理する場合、<span class="application">pg_upgrade</span> char signedness設定を保持する。
ただし、<span class="productname">PostgreSQL</span>17以前のアップグレード処理では、<span class="application">pg_upgrade</span>それが構築されたプラットフォームのchar signednessを採用する。
       </p><p>
<span class="original">
        This option allows you to explicitly set the default char signedness for
        the new cluster, overriding any inherited values. There are two specific
        scenarios where this option is relevant:
</span>
《機械翻訳》このオプションを使用すると、新しいデフォルトのクラスタ文字の符号を明示的に設定し、継承された値を上書きできます。
このオプションが関連する具体的なシナリオは次の2つです。
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
<span class="original">
           If you are planning to migrate to a different platform after the upgrade,
           you should not use this option. The default behavior is right in this case.
           Instead, perform the upgrade on the original platform without this flag,
           and then migrate the cluster afterward. This is the recommended and safest
           approach.
</span>
《機械翻訳》アップグレードの後に別のプラットフォームに移行する場合は、このオプションを使用しないでください。
デフォルトの動作はこのケースにあります。
かわりに、このフラグのないオリジナルプラットフォームでアップグレードを実行し、その後クラスタを移行します。
これは推奨される最も安全なアプローチです。
          </p></li><li class="listitem"><p>
<span class="original">
           If you have already migrated the cluster to a platform with different
           char signedness (for example, from an x86-based system to an ARM-based
           system), you should use this option to specify the signedness matching
           the original platform's default char signedness. Additionally, it's
           essential not to modify any data files between migrating data files and
           running &lt;command&gt;pg_upgrade&lt;/command&gt;. &lt;command&gt;pg_upgrade&lt;/command&gt;
           should be the first operation that starts the cluster on the new platform.
</span>
《機械翻訳》既に異なるchar signednessを持つプラットフォームにクラスタを移行している場合(例えば、x86ベースのシステムからARMベースのシステムへ)、このオプションを使用して、元のプラットフォームのデフォルトchar signednessと一致する符号を指定する必要があります。
さらに、データファイルを移行してから<code class="command">pg_upgrade</code>を実行するまでの間に、データファイルを変更しないことが不可欠です。
<code class="command">pg_upgrade</code>は、新しいプラットフォームでクラスタを起動する最初の操作である必要があります。
          </p></li></ul></div><p>
       </p></dd><dt><span class="term"><code class="option">--swap</code></span></dt><dd><p>
<span class="original">
        Move the data directories from the old cluster to the new cluster.
        Then, replace the catalog files with those generated for the new
        cluster.  This mode can outperform &lt;option&gt;&amp;#45;-link&lt;/option&gt;,
        &lt;option&gt;&amp;#45;-clone&lt;/option&gt;, &lt;option&gt;&amp;#45;-copy&lt;/option&gt;, and
        &lt;option&gt;&amp;#45;-copy-file-range&lt;/option&gt;, especially on clusters with many
        relations.
</span>
《機械翻訳》データディレクトリを古いクラスタから新しいクラスタに移動します。
次に、カタログファイルを新しいクラスタ用に生成されたものに置き換えます。
このモードは、<code class="option">--link</code>、<code class="option">--clone</code>、<code class="option">--copy</code>、および<code class="option">--copy-file-range</code>、特に多くのリレーションを持つクラスタではよりも優れています。
       </p><p>
<span class="original">
        However, this mode creates many garbage files in the old cluster, which
        can prolong the file synchronization step if
        &lt;option&gt;&amp;#45;-sync-method=syncfs&lt;/option&gt; is used.  Therefore, it is
        recommended to use &lt;option&gt;&amp;#45;-sync-method=fsync&lt;/option&gt; with
        &lt;option&gt;&amp;#45;-swap&lt;/option&gt;.
</span>
《機械翻訳》ただし、このモードでは古いクラスタに多くの不要なファイルが作成されるため、<code class="option">--sync-method=syncfs</code>が使用されている場合、ファイルの同期のステップが長くなる可能性があります。
したがって、<code class="option">--sync-method=fsync</code>と<code class="option">--swap</code>を併用することをお勧めします。
       </p><p>
<span class="original">
        Additionally, once the file transfer step begins, the old cluster will
        be destructively modified and therefore will no longer be safe to
        start.  See &lt;xref linkend="pgupgrade-step-revert"/&gt; for details.
</span>
《機械翻訳》さらに、ファイル転送ステップが開始されると、古いクラスタは破壊的に変更されるため、セーフからスタートではなくなります。
詳細については、<a class="xref" href="pgupgrade.html#PGUPGRADE-STEP-REVERT" title="古いクラスタへの戻し">ステップ 17</a>を参照してください。
       </p></dd><dt><span class="term"><code class="option">--sync-method=</code><em class="replaceable"><code>method</code></em></span></dt><dd><p>
<span class="original">
        When set to &lt;literal&gt;fsync&lt;/literal&gt;, which is the default,
        &lt;command&gt;pg_upgrade&lt;/command&gt; will recursively open and synchronize all
        files in the upgraded cluster's data directory.  The search for files
        will follow symbolic links for the WAL directory and each configured
        tablespace.
</span>
デフォルトの<code class="literal">fsync</code>に設定すると、<code class="command">pg_upgrade</code>はアップグレードされたクラスタのデータディレクトリ内のすべてのファイルを再帰的に開いて同期します。
ファイルの検索はWALディレクトリと設定された各テーブル空間のシンボリックリンクをたどります。
       </p><p>
<span class="original">
        On Linux, &lt;literal&gt;syncfs&lt;/literal&gt; may be used instead to ask the
        operating system to synchronize the whole file systems that contain the
        upgraded cluster's data directory, its WAL files, and each tablespace.
        See &lt;xref linkend="guc-recovery-init-sync-method"/&gt; for information
        about the caveats to be aware of when using &lt;literal&gt;syncfs&lt;/literal&gt;.
</span>
Linuxでは、<code class="literal">syncfs</code>を代わりに使用して、アップグレードされたクラスタのデータディレクトリ、WALファイル、および各テーブル空間を含むファイルシステム全体を同期するようにオペレーティングシステムに要求できます。
<code class="literal">syncfs</code>を使用する際に注意すべき点については、<a class="xref" href="runtime-config-error-handling.html#GUC-RECOVERY-INIT-SYNC-METHOD">recovery_init_sync_method</a>を参照してください。
       </p><p>
<span class="original">
        This option has no effect when &lt;option&gt;&amp;#45;-no-sync&lt;/option&gt; is used.
</span>
このオプションは<code class="option">--no-sync</code>が使われている場合は効果がありません。
       </p></dd><dt><span class="term"><code class="option">-?</code><br /></span><span class="term"><code class="option">--help</code></span></dt><dd><p>使用方法を表示し、終了します。</p></dd></dl></div><p>
   </p></div><div class="refsect1" id="id-1.9.5.13.7"><h2>使用方法</h2><span class="original">
  &lt;title&gt;Usage&lt;/title&gt;
</span><p>
<span class="original">
   These are the steps to perform an upgrade
   with &lt;application&gt;pg_upgrade&lt;/application&gt;:
</span>
<span class="application">pg_upgrade</span>を用いたアップグレードを行う手順を示します。
  </p><div class="note"><h3 class="title">注記</h3><p>
<span class="original">
     The steps to upgrade &lt;glossterm linkend="glossary-logical-replication-cluster"&gt;logical replication clusters&lt;/glossterm&gt;
     are not covered here;
     refer to &lt;xref linkend="logical-replication-upgrade"/&gt; for details.
</span>
《機械翻訳》アップグレードへのステップ<a class="glossterm" href="glossary.html#GLOSSARY-LOGICAL-REPLICATION-CLUSTER"><em class="glossterm"><a class="glossterm" href="glossary.html#GLOSSARY-LOGICAL-REPLICATION-CLUSTER" title="Logical replication cluster">論理レプリケーションクラスタ</a></em></a>はここでは取り上げません。
詳細については<a class="xref" href="logical-replication-upgrade.html" title="29.13. Upgrade">29.13</a>を参照してください。
    </p></div><div class="procedure"><ol class="procedure" type="1"><li class="step"><span class="original">
    &lt;title&gt;Optionally move the old cluster&lt;/title&gt;
</span><p class="title"><strong>古いクラスタの移動（省略可能）</strong></p><p>
<span class="original">
     If you are using a version-specific installation directory, e.g.,
     &lt;filename&gt;/opt/PostgreSQL/&amp;majorversion;&lt;/filename&gt;, you do not need to move the old cluster. The
     graphical installers all use version-specific installation directories.
</span>
バージョンに関連したインストレーションディレクトリ(例えば<code class="filename">/opt/PostgreSQL/18</code>)を使用しているのであれば、古いクラスタを移動する必要はありません。
グラフィカルインストーラはすべて、バージョンに関連したインストレーションディレクトリを使用します。
    </p><p>
<span class="original">
     If your installation directory is not version-specific, e.g.,
     &lt;filename&gt;/usr/local/pgsql&lt;/filename&gt;, it is necessary to move the current PostgreSQL install
     directory so it does not interfere with the new &lt;productname&gt;PostgreSQL&lt;/productname&gt; installation.
     Once the current &lt;productname&gt;PostgreSQL&lt;/productname&gt; server is shut down, it is safe to rename the
     PostgreSQL installation directory; assuming the old directory is
     &lt;filename&gt;/usr/local/pgsql&lt;/filename&gt;, you can do:
</span>
インストレーションディレクトリがバージョンに関連していない（例えば<code class="filename">/usr/local/pgsql</code>）のであれば、新しい<span class="productname">PostgreSQL</span>のインストレーションに干渉しないように、現在のPostgreSQLインストレーションディレクトリを移動しなければなりません。
一度現在の<span class="productname">PostgreSQL</span>サーバを停止させていれば、PostgreSQLのインストレーションの名前を変更しても安全です。
古いディレクトリが<code class="filename">/usr/local/pgsql</code>であれば、以下のようにディレクトリ名を変更します。

</p><pre class="programlisting">
mv /usr/local/pgsql /usr/local/pgsql.old
</pre><p>
<span class="original">
     to rename the directory.
</span>
    </p></li><li class="step"><span class="original">
    &lt;title&gt;For source installs, build the new version&lt;/title&gt;
</span><p class="title"><strong>ソースからのインストールの場合の新しいバージョンの構築</strong></p><p>
<span class="original">
     Build the new PostgreSQL source with &lt;command&gt;configure&lt;/command&gt; flags that are compatible
     with the old cluster. &lt;application&gt;pg_upgrade&lt;/application&gt; will check &lt;command&gt;pg_controldata&lt;/command&gt; to make
     sure all settings are compatible before starting the upgrade.
</span>
古いクラスタと互換性を持つような<code class="command">configure</code>オプションを付けて新しいPostgreSQLソースを構築してください。
<span class="application">pg_upgrade</span>はアップグレードを始める前にすべての設定が互換性を持っていることを確認するために<code class="command">pg_controldata</code>を検査します。
    </p></li><li class="step"><span class="original">
    &lt;title&gt;Install the new PostgreSQL binaries&lt;/title&gt;
</span><p class="title"><strong>新しいPostgreSQLのバイナリのインストール</strong></p><p>
<span class="original">
     Install the new server's binaries and support
     files.  &lt;application&gt;pg_upgrade&lt;/application&gt; is included in a default installation.
</span>
新しいサーバのバイナリとサポートファイルをインストールしてください。
<span class="application">pg_upgrade</span>はデフォルトのインストレーションに含まれています。
    </p><p>
<span class="original">
     For source installs, if you wish to install the new server in a custom
     location, use the &lt;literal&gt;prefix&lt;/literal&gt; variable:
</span>
ソースからインストールする場合、独自の場所に新しいサーバをインストールしたければ、以下のように<code class="literal">prefix</code>を使用してください。

</p><pre class="programlisting">
make prefix=/usr/local/pgsql.new install
</pre></li><li class="step"><span class="original">
    &lt;title&gt;Initialize the new PostgreSQL cluster&lt;/title&gt;
</span><p class="title"><strong>新しいPostgreSQLクラスタを初期化</strong></p><p>
<span class="original">
     Initialize the new cluster using &lt;command&gt;initdb&lt;/command&gt;.
     Again, use compatible &lt;command&gt;initdb&lt;/command&gt;
     flags that match the old cluster. Many
     prebuilt installers do this step automatically. There is no need to
     start the new cluster.
</span>
<code class="command">initdb</code>を使用して新しいクラスタを初期化してください。
ここでも、古いクラスタに合うように互換性がある<code class="command">initdb</code>のオプションを使用してください。
あらかじめ組み込まれたインストーラの多くは、この手順を自動的に実施します。
新しいクラスタを起動する必要はありません。
    </p></li><li class="step"><span class="original">
    &lt;title&gt;Install extension shared object files&lt;/title&gt;
</span><p class="title"><strong>拡張共有オブジェクトファイルをインストール</strong></p><p>
<span class="original">
     Many extensions and custom modules, whether from
     &lt;filename&gt;contrib&lt;/filename&gt; or another source, use shared object
     files (or DLLs), e.g., &lt;filename&gt;pgcrypto.so&lt;/filename&gt;.  If the old
     cluster used these, shared object files matching the new server binary
     must be installed in the new cluster, usually via operating system
     commands.  Do not load the schema definitions, e.g., &lt;command&gt;CREATE
     EXTENSION pgcrypto&lt;/command&gt;, because these will be duplicated from
     the old cluster.  If extension updates are available,
     &lt;application&gt;pg_upgrade&lt;/application&gt; will report this and create
     a script that can be run later to update them.
</span>
<code class="filename">contrib</code>からのものであろうとその他のソースからのものであろうと、多くの拡張や独自のモジュールは、例えば<code class="filename">pgcrypto.so</code>などの独自の共有オブジェクトファイル(またはDLL)を使います。
古いクラスタがこれらを使用していたのであれば、新しいサーバのバイナリに合った共有オブジェクトファイルを、たいていはオペレーティングシステムのコマンドで、新しいクラスタにインストールしなければなりません。
例えば<code class="command">CREATE EXTENSION pgcrypto</code>などのスキーマ定義はロードしないでください。これらは古いクラスタから複製されるためです。
拡張アップデートが利用可能であれば、<span class="application">pg_upgrade</span>はこれを報告し、アップデートのために後で実行できるスクリプトを作成します。
    </p></li><li class="step"><span class="original">
    &lt;title&gt;Copy custom full-text search files&lt;/title&gt;
</span><p class="title"><strong>独自の全文検索ファイルをコピー</strong></p><p>
<span class="original">
     Copy any custom full text search files (dictionary, synonym,
     thesaurus, stop words) from the old to the new cluster.
</span>
独自の全文検索ファイル(辞書、同義語、類語辞書、ストップワード)を古いクラスタから新しいクラスタにコピーしてください。
    </p></li><li class="step"><span class="original">
    &lt;title&gt;Adjust authentication&lt;/title&gt;
</span><p class="title"><strong>認証の調整</strong></p><p>
<span class="original">
     &lt;command&gt;pg_upgrade&lt;/command&gt; will connect to the old and new servers several
     times, so you might want to set authentication to &lt;literal&gt;peer&lt;/literal&gt;
     in &lt;filename&gt;pg_hba.conf&lt;/filename&gt; or use a &lt;filename&gt;~/.pgpass&lt;/filename&gt; file
     (see &lt;xref linkend="libpq-pgpass"/&gt;).
</span>
<code class="command">pg_upgrade</code>は古いサーバと新しいサーバに複数回接続します。
このため、<code class="filename">pg_hba.conf</code>内で<code class="literal">peer</code>認証に設定、あるいは、<code class="filename">~/.pgpass</code>ファイル(<a class="xref" href="libpq-pgpass.html" title="32.16. パスワードファイル">32.16</a>参照)を使用するようにした方が良いかもしれません。
    </p></li><li class="step"><span class="original">
    &lt;title&gt;Stop both servers&lt;/title&gt;
</span><p class="title"><strong>両サーバの停止</strong></p><p>
<span class="original">
     Make sure both database servers are stopped using, on Unix, e.g.:
</span>
両サーバが停止していることを確実にしてください。
例えばUnixでは以下を使用します。

</p><pre class="programlisting">
pg_ctl -D /opt/PostgreSQL/12 stop
pg_ctl -D /opt/PostgreSQL/18 stop
</pre><p>

<span class="original">
     or on Windows, using the proper service names:
</span>
Windowsでは以下

</p><pre class="programlisting">
NET STOP postgresql-12
NET STOP postgresql-18
</pre><p>
    </p><p>
<span class="original">
     Streaming replication and log-shipping standby servers must be
     running during this shutdown so they receive all changes.
</span>
すべての変更を受信するよう、ストリーミングレプリケーションおよびログシッピングのスタンバイサーバは、このシャットダウン中は実行していなければなりません。
    </p></li><li class="step"><span class="original">
    &lt;title&gt;Prepare for standby server upgrades&lt;/title&gt;
</span><p class="title"><strong>スタンバイサーバのアップグレードの準備</strong></p><p>
<span class="original">
     If you are upgrading standby servers using methods outlined in section &lt;xref
     linkend="pgupgrade-step-replicas"/&gt;, verify that the old standby
     servers are caught up by running &lt;application&gt;pg_controldata&lt;/application&gt;
     against the old primary and standby clusters.  Verify that the
     &lt;quote&gt;Latest checkpoint location&lt;/quote&gt; values match in all clusters.
     Also, make sure &lt;varname&gt;wal_level&lt;/varname&gt; is not set to
     &lt;literal&gt;minimal&lt;/literal&gt; in the &lt;filename&gt;postgresql.conf&lt;/filename&gt; file on the
     new primary cluster.
</span>
スタンバイサーバを<a class="xref" href="pgupgrade.html#PGUPGRADE-STEP-REPLICAS" title="ストリーミングレプリケーションおよびログシッピングのスタンバイサーバのアップグレード">ステップ 11</a>の節で示した手順でアップグレードする場合は、<span class="application">pg_controldata</span>を実行して、古いスタンバイサーバが、古いプライマリ及びスタンバイのクラスタに同期していることを確認してください。
すべてのクラスタで<span class="quote">「<span class="quote">Latest checkpoint location</span>」</span>（最終チェックポイント位置）の値が一致することを確認してください。
また、新しいプライマリのクラスタの<code class="filename">postgresql.conf</code>ファイルで<code class="varname">wal_level</code>を<code class="literal">minimal</code>に絶対に設定しないようにしてください。
    </p></li><li class="step"><span class="original">
    &lt;title&gt;Run &lt;application&gt;pg_upgrade&lt;/application&gt;&lt;/title&gt;
</span><p class="title"><strong><span class="application">pg_upgrade</span>の実行</strong></p><p>
<span class="original">
     Always run the &lt;application&gt;pg_upgrade&lt;/application&gt; binary of the new server, not the old one.
     &lt;application&gt;pg_upgrade&lt;/application&gt; requires the specification of the old and new cluster's
     data and executable (&lt;filename&gt;bin&lt;/filename&gt;) directories. You can also specify
     user and port values, and whether you want the data files linked, cloned, or swapped
     instead of the default copy behavior.
</span>
《マッチ度[91.603053]》古いサーバのものではなく、常に新しいサーバの<span class="application">pg_upgrade</span>バイナリを実行してください。
<span class="application">pg_upgrade</span>は古いクラスタおよび新しいクラスタのデータと実行形式ファイルの格納ディレクトリ（<code class="filename">bin</code>）の指定を要求します。
また、ユーザやポート番号の指定や、デフォルト動作のコピーではなくデータファイルのリンクや複製を使用するかどうかを指定することができます。
    </p><p>
<span class="original">
     If you use link mode, the upgrade will be much faster (no file
     copying) and use less disk space, but you will not be able to access
     your old cluster
     once you start the new cluster after the upgrade.  Link mode also
     requires that the old and new cluster data directories be in the
     same file system.  (Tablespaces and &lt;filename&gt;pg_wal&lt;/filename&gt; can be on
     different file systems.)
     Clone mode provides the same speed and disk space advantages but
     does not cause the old cluster to be unusable once the new cluster
     is started.  Clone mode also requires that the old and new data
     directories be in the same file system.  This mode is only available
     on certain operating systems and file systems.
     Swap mode may be the fastest if there are many relations, but you will not
     be able to access your old cluster once the file transfer step begins.
     Swap mode also requires that the old and new cluster data directories be
     in the same file system.
</span>
《マッチ度[66.881720]》リンクモードを使用する場合、アップグレードは非常に高速になり(ファイルのコピーがありません)、ディスク容量が少なくなりますが、アップグレード後に新しいクラスタを一度でも実行してしまうと、古いクラスタにアクセスすることができなくなります。
リンクモードはまた、古いクラスタと新しいクラスタのデータディレクトリが同じファイルシステムにあることが必要です。
（テーブル空間および<code class="filename">pg_wal</code>は異なるファイルシステムに置くことができます。）
複製モードは同じ速度とディスク容量の利点を提供しますが、新しいクラスタを一度実行しても、古いクラスタが使えなくなる訳ではありません。
複製モードはまた、新旧のデータディレクトリが同じファイルシステム内にあることを要求します。
このモードは特定のオペレーティングシステムのファイルシステム上でのみ利用可能です。
《機械翻訳》リンクモードを使用すると、アップグレードがはるかに速くなり（ファイルのコピーが不要）、ディスクスペースの使用量も少なくなりますが、アップグレードの後に新しいクラスタをスタートすると、古いクラスタをアクセスすることはできません。
また、リンクモードでは、新旧のクラスタデータディレクトリが同じファイルシステム内にある必要があります。
(表領域と<code class="filename">pg_wal</code>異なるファイルシステム上にある場合もありますクローンモードは同じ速度とディスクスペースの利点を提供しますが、新しいクラスタが開始された後に古いクラスタが使用できなくなることはありません。
クローンモードでも、新旧のデータディレクトリが同じファイルシステム内にある必要があります。
このモードは、特定のオペレーティングシステムとファイルシステムでのみ使用できます。
の数が多い場合は、が最も高速になる可能性がありますが、ファイル転送が開始されると、古いディレクトリをできなくなります。
また、では、新旧ののディレクトリが同じ内にある必要があります。
リレーションクラスタモードクラスタファイルシステムスワップモードアクセスステップスワップデータ
    </p><p>
<span class="original">
     Setting &lt;option&gt;&amp;#45;-jobs&lt;/option&gt; to 2 or higher allows pg_upgrade to
     process multiple databases and tablespaces in parallel.  A good starting
     point is the number of CPU cores on the machine.  This option can
     substantially reduce the upgrade time for multi-database and
     multi-tablespace servers.
</span>
《機械翻訳》<code class="option">--jobs</code>を2以上に設定すると、pg_upgradeからプロセスマルチプルのデータベースおよび表領域をパラレルで使用できます。
まずはマシンのCPUコア数から始めるとよいでしょう。
このオプションを使用すると、マルチデータベースおよびマルチテーブルスペースサーバのアップグレード時間を大幅に削減できます。
    </p><p>
<span class="original">
     For Windows users, you must be logged into an administrative account,
     and then run &lt;application&gt;pg_upgrade&lt;/application&gt; with quoted
     directories, e.g.:
</span>
Windowsユーザの場合、管理アカウントでログインし、引用符でくくったディレクトリを付けて<span class="application">pg_upgrade</span>を実行してください。

</p><pre class="programlisting">
pg_upgrade.exe
        --old-datadir "C:/Program Files/PostgreSQL/12/data"
        --new-datadir "C:/Program Files/PostgreSQL/18/data"
        --old-bindir "C:/Program Files/PostgreSQL/12/bin"
        --new-bindir "C:/Program Files/PostgreSQL/18/bin"
</pre><p>

<span class="original">
     Once started, &lt;command&gt;pg_upgrade&lt;/command&gt; will verify the two clusters are compatible
     and then do the upgrade. You can use &lt;command&gt;pg_upgrade &amp;#45;-check&lt;/command&gt;
     to perform only the checks, even if the old server is still
     running. &lt;command&gt;pg_upgrade &amp;#45;-check&lt;/command&gt; will also outline any
     manual adjustments you will need to make after the upgrade.  If you
     are going to be using link, clone, copy-file-range, or swap mode, you
     should use the option &lt;option&gt;&amp;#45;-link&lt;/option&gt;, &lt;option&gt;&amp;#45;-clone&lt;/option&gt;,
     &lt;option&gt;&amp;#45;-copy-file-range&lt;/option&gt;, or &lt;option&gt;&amp;#45;-swap&lt;/option&gt; with
     &lt;option&gt;&amp;#45;-check&lt;/option&gt; to enable mode-specific checks.
     &lt;command&gt;pg_upgrade&lt;/command&gt; requires write permission in the current directory.
</span>
《マッチ度[81.355932]》起動後、<code class="command">pg_upgrade</code>は2つのクラスタに互換性があるかどうか検証し、その後、アップグレードを行います。
検査のみを行う<code class="command">pg_upgrade --check</code>を使用することができます。
この場合は古いサーバは稼働中であっても構いません。
また<code class="command">pg_upgrade --check</code>は、アップグレード後に手作業で行わなければならない調整作業があればその概要を示します。
リンクまたは複製モードを使用する予定であれば、モード固有の検査を有効にするために<code class="option">--check</code>を付けて<code class="option">--link</code>または<code class="option">--clone</code>オプションを使用すべきです。
<code class="command">pg_upgrade</code>は現在のディレクトリに対する書き込み権限を必要とします。
《機械翻訳》起動後、<code class="command">pg_upgrade</code>は2つのクラスタに互換性があることを確認し、アップグレードを実行します。
<code class="command">pg_upgrade--チェック</code>を使用すると、古いサーバがまだ実行中であっても、チェックのみを実行できます。
<code class="command">pg_upgrade--チェック</code>では、アップグレードの後にmakeで必要となるマニュアル調整の概要も示されます。
リンク、クローン、コピー-ファイル-レンジ、またはスワップモードを使用する場合は、オプション<code class="option">--link</code>,<code class="option">--clone</code>,<code class="option">--copy-file-range</code>,または<code class="option">--swap</code>と<code class="option">--check</code>を使用してモード固有のチェックを有効にします。
<code class="command">pg_upgrade</code>はカレントディレクトリにwriteパーミッションが必要です。
    </p><p>
<span class="original">
     Obviously, no one should be accessing the clusters during the
     upgrade.  &lt;application&gt;pg_upgrade&lt;/application&gt; defaults to running servers
     on port 50432 to avoid unintended client connections.
     You can use the same port number for both clusters when doing an
     upgrade because the old and new clusters will not be running at the
     same time.  However, when checking an old running server, the old
     and new port numbers must be different.
</span>
言うまでもありませんが、アップグレード中はクラスタにアクセスしてはいけません。
意図しないクライアント接続を防ぐために、デフォルトでは<span class="application">pg_upgrade</span>は50432ポートでサーバを稼働します。
古いクラスタと新しいクラスタが同時に稼働することはありませんので、両クラスタで同じポート番号を使用することができます。
しかし実行中の古いクラスタを検査する時には、新旧で異なるポート番号でなければなりません。
    </p><p>
<span class="original">
     If an error occurs while restoring the database schema, &lt;command&gt;pg_upgrade&lt;/command&gt; will
     exit and you will have to revert to the old cluster as outlined in &lt;xref linkend="pgupgrade-step-revert"/&gt;
     below. To try &lt;command&gt;pg_upgrade&lt;/command&gt; again, you will need to modify the old
     cluster so the pg_upgrade schema restore succeeds. If the problem is a
     &lt;filename&gt;contrib&lt;/filename&gt; module, you might need to uninstall the &lt;filename&gt;contrib&lt;/filename&gt; module from
     the old cluster and install it in the new cluster after the upgrade,
     assuming the module is not being used to store user data.
</span>
データベーススキーマのリストア中にエラーが発生した場合、<code class="command">pg_upgrade</code>は終了しますので、後述の<a class="xref" href="pgupgrade.html#PGUPGRADE-STEP-REVERT" title="古いクラスタへの戻し">ステップ 17</a>で示すように古いクラスタに戻さなければなりません。
再び<code class="command">pg_upgrade</code>を試すためには、pg_upgradeによるスキーマのリストアが成功するように古いクラスタを変更しなければなりません。
問題が<code class="filename">contrib</code>モジュールであれば、そのモジュールがユーザデータを格納するために使用されていないことが前提ですが、古いクラスタからその<code class="filename">contrib</code>モジュールをアンインストールし、アップグレードした後に新しいクラスタにそれをインストールする必要があるかもしれません。
    </p></li><li class="step" id="PGUPGRADE-STEP-REPLICAS"><span class="original">
    &lt;title&gt;Upgrade streaming replication and log-shipping standby servers&lt;/title&gt;
</span><p class="title"><strong>ストリーミングレプリケーションおよびログシッピングのスタンバイサーバのアップグレード</strong></p><p>
<span class="original">
     If you used link mode and have Streaming Replication (see &lt;xref
     linkend="streaming-replication"/&gt;) or Log-Shipping (see &lt;xref
     linkend="warm-standby"/&gt;) standby servers, you can follow these steps to
     quickly upgrade them.  You will not be running &lt;application&gt;pg_upgrade&lt;/application&gt; on
     the standby servers, but rather &lt;application&gt;rsync&lt;/application&gt; on the primary.
     Do not start any servers yet.
</span>
リンクモードを使用した場合で、ストリーミングレプリケーション（<a class="xref" href="warm-standby.html#STREAMING-REPLICATION" title="26.2.5. ストリーミングレプリケーション">26.2.5</a>参照）またはログシッピング（<a class="xref" href="warm-standby.html" title="26.2. ログシッピングスタンバイサーバ">26.2</a>参照）のスタンバイサーバがある場合、以下の手順に従って、素早くアップグレードすることができます。
スタンバイサーバで<span class="application">pg_upgrade</span>は実行せず、代わりにプライマリで<span class="application">rsync</span>を実行することになります。
どのサーバもまだ起動しないでください。
    </p><p>
<span class="original">
     If you did &lt;emphasis&gt;not&lt;/emphasis&gt; use link mode, do not have or do not
     want to use &lt;application&gt;rsync&lt;/application&gt;, or want an easier solution, skip
     the instructions in this section and simply recreate the standby
     servers once &lt;application&gt;pg_upgrade&lt;/application&gt; completes and the new primary
     is running.
</span>
リンクモードを使用<span class="emphasis"><em>しなかった</em></span>場合、<span class="application">rsync</span>の機能が使えない場合や使いたくない場合、あるいはもっと容易な方法を望む場合は、この節の手順を読み飛ばし、<span class="application">pg_upgrade</span>が完了して新しいプライマリが起動したら、単純にスタンバイサーバを再作成してください。
    </p><div class="procedure"><ol class="procedure" type="1"><li class="step"><span class="original">
      &lt;title&gt;Install the new PostgreSQL binaries on standby servers&lt;/title&gt;
</span><p class="title"><strong>PostgreSQLの新しいバイナリをスタンバイサーバにインストール</strong></p><p>
<span class="original">
       Make sure the new binaries and support files are installed on all
       standby servers.
</span>
すべてのスタンバイサーバで新しいバイナリとサポートファイルがインストールされていることを確実にしてください。
      </p></li><li class="step"><span class="original">
      &lt;title&gt;Make sure the new standby data directories do &lt;emphasis&gt;not&lt;/emphasis&gt; exist&lt;/title&gt;
</span><p class="title"><strong>新しいスタンバイのデータディレクトリが存在<span class="emphasis"><em>しない</em></span>ことの確認</strong></p><p>
<span class="original">
       Make sure the new standby data directories do &lt;emphasis&gt;not&lt;/emphasis&gt;
       exist or are empty.  If &lt;application&gt;initdb&lt;/application&gt; was run, delete
       the standby servers' new data directories.
</span>
新しいスタンバイのデータディレクトリが存在<span class="emphasis"><em>しない</em></span>か空であることを確実にしてください。
<span class="application">initdb</span>が実行されている場合は、スタンバイサーバの新しいデータディレクトリを削除してください。
      </p></li><li class="step"><span class="original">
      &lt;title&gt;Install extension shared object files&lt;/title&gt;
</span><p class="title"><strong>拡張共有オブジェクトファイルのインストール</strong></p><p>
<span class="original">
       Install the same extension shared object files on the new standbys
       that you installed in the new primary cluster.
</span>
新しいプライマリのクラスタにインストールしたのと同じ拡張共有オブジェクトファイルを新しいスタンバイにインストールしてください。
      </p></li><li class="step"><span class="original">
      &lt;title&gt;Stop standby servers&lt;/title&gt;
</span><p class="title"><strong>スタンバイサーバの停止</strong></p><p>
<span class="original">
       If the standby servers are still running, stop them now using the
       above instructions.
</span>
スタンバイサーバがまだ実行中なら、上記の手順に従って停止してください。
      </p></li><li class="step"><span class="original">
      &lt;title&gt;Save configuration files&lt;/title&gt;
</span><p class="title"><strong>設定ファイルの保存</strong></p><p>
<span class="original">
       Save any configuration files from the old standbys' configuration
       directories you need to keep, e.g.,  &lt;filename&gt;postgresql.conf&lt;/filename&gt;
       (and any files included by it), &lt;filename&gt;postgresql.auto.conf&lt;/filename&gt;,
       &lt;literal&gt;pg_hba.conf&lt;/literal&gt;, because these will be overwritten
       or removed in the next step.
</span>
スタンバイの設定ディレクトリの設定ファイルで保持する必要のあるもの、例えば<code class="filename">postgresql.conf</code>(とそれがインクルードしているファイル)や<code class="filename">postgresql.auto.conf</code>、<code class="literal">pg_hba.conf</code>を保存してください。
これらは次のステップで上書きあるいは削除されるからです。
      </p></li><li class="step"><span class="original">
      &lt;title&gt;Run &lt;application&gt;rsync&lt;/application&gt;&lt;/title&gt;
</span><p class="title"><strong><span class="application">rsync</span>の実行</strong></p><p>
<span class="original">
       When using link mode, standby servers can be quickly upgraded using
       &lt;application&gt;rsync&lt;/application&gt;.  To accomplish this, from a directory on
       the primary server that is above the old and new database cluster
       directories, run this on the &lt;emphasis&gt;primary&lt;/emphasis&gt; for each standby
       server:
</span>
リンクモードを使用する場合、<span class="application">rsync</span>を使用してスタンバイサーバを素早くアップグレードすることができます。
これを実行するには、古いデータベースクラスタのディレクトリおよび新しいデータベースクラスタのディレクトリより上位にあるプライマリサーバ上のディレクトリで、<span class="emphasis"><em>プライマリ</em></span>上で各スタンバイサーバに対して以下を実行します。

</p><pre class="programlisting">
rsync --archive --delete --hard-links --size-only --no-inc-recursive old_cluster new_cluster remote_dir
</pre><p>

<span class="original">
       where &lt;option&gt;old_cluster&lt;/option&gt; and &lt;option&gt;new_cluster&lt;/option&gt; are relative
       to the current directory on the primary, and &lt;option&gt;remote_dir&lt;/option&gt;
       is &lt;emphasis&gt;above&lt;/emphasis&gt; the old and new cluster directories
       on the standby.  The directory structure under the specified
       directories on the primary and standbys must match.  Consult the
       &lt;application&gt;rsync&lt;/application&gt; manual page for details on specifying the
       remote directory, e.g.,
</span>
ここで<code class="option">old_cluster</code>および<code class="option">new_cluster</code>はプライマリのカレントディレクトリからの相対パス、<code class="option">remote_dir</code>はスタンバイサーバ上の古いクラスタと新しいクラスタのディレクトリの<span class="emphasis"><em>上位</em></span>のディレクトリです。
プライマリとスタンバイの指定したディレクトリより下のディレクトリ構造は一致しなければなりません。
リモートディレクトリの指定の詳細については<span class="application">rsync</span>のマニュアルを参照してください。
例を示します。

</p><pre class="programlisting">
rsync --archive --delete --hard-links --size-only --no-inc-recursive /opt/PostgreSQL/12 \
      /opt/PostgreSQL/18 standby.example.com:/opt/PostgreSQL
</pre><p>

<span class="original">
       You can verify what the command will do using
       &lt;application&gt;rsync&lt;/application&gt;'s &lt;option&gt;&amp;#45;-dry-run&lt;/option&gt; option.  While
       &lt;application&gt;rsync&lt;/application&gt; must be run on the primary for at least one
       standby, it is possible to run &lt;application&gt;rsync&lt;/application&gt; on an upgraded
       standby to upgrade other standbys, as long as the upgraded standby
       has not been started.
</span>
<span class="application">rsync</span>の<code class="option">--dry-run</code>オプションを使うことで、そのコマンドが何をするか確認することができます。
<span class="application">rsync</span>は少なくとも1つのスタンバイに対して、プライマリ上で実行しなければなりませんが、アップグレード済みのスタンバイがまだ起動していなければ、そのスタンバイ上で<span class="application">rsync</span>を実行して、他のスタンバイをアップグレードすることができます。
      </p><p>
<span class="original">
       What this does is to record the links created by
       &lt;application&gt;pg_upgrade&lt;/application&gt;'s link mode that connect files in the
       old and new clusters on the primary server.  It then finds matching
       files in the standby's old cluster and creates links for them in the
       standby's new cluster.  Files that were not linked on the primary
       are copied from the primary to the standby.  (They are usually
       small.)  This provides rapid standby upgrades.  Unfortunately,
       &lt;application&gt;rsync&lt;/application&gt; needlessly copies files associated with
       temporary and unlogged tables because these files don't normally
       exist on standby servers.
</span>
これが実行するのは<span class="application">pg_upgrade</span>のリンクモードが作成したプライマリサーバ上の古いクラスタのファイルと新しいクラスタのファイルを接続するリンクについて記録することです。
次にスタンバイの古いクラスタ内の一致するファイルを探し、スタンバイの新しいクラスタ内に対応するリンクを作成します。
プライマリ上でリンクされなかったファイルは、プライマリからスタンバイにコピーされます。
（それらは通常は小さいです。）
これにより高速なアップグレードが可能になります。
残念ながら<span class="application">rsync</span>は一時テーブルやログを取らないテーブルに関連したファイルを不要であるにも関わらずコピーします。
これらのファイルが通常はスタンバイサーバに存在しないからです。
      </p><p>
<span class="original">
       If you have tablespaces, you will need to run a similar
       &lt;application&gt;rsync&lt;/application&gt; command for each tablespace directory, e.g.:
</span>
テーブル空間を使用している場合は、各テーブル空間のディレクトリについて、同様の<span class="application">rsync</span>コマンドを実行する必要があります。
例を示します。

</p><pre class="programlisting">
rsync --archive --delete --hard-links --size-only --no-inc-recursive /vol1/pg_tblsp/PG_12_201909212 \
      /vol1/pg_tblsp/PG_18_202307071 standby.example.com:/vol1/pg_tblsp
</pre><p>

<span class="original">
       If you have relocated &lt;filename&gt;pg_wal&lt;/filename&gt; outside the data
       directories, &lt;application&gt;rsync&lt;/application&gt; must be run on those directories
       too.
</span>
<code class="filename">pg_wal</code>をデータディレクトリの外側に移動している場合は、そのディレクトリについても<span class="application">rsync</span>を実行しなければなりません。
      </p></li><li class="step"><span class="original">
      &lt;title&gt;Configure streaming replication and log-shipping standby servers&lt;/title&gt;
</span><p class="title"><strong>ストリーミングレプリケーションおよびログシッピングのスタンバイサーバの設定</strong></p><p>
<span class="original">
       Configure the servers for log shipping.  (You do not need to run
       &lt;function&gt;pg_backup_start()&lt;/function&gt; and &lt;function&gt;pg_backup_stop()&lt;/function&gt;
       or take a file system backup as the standbys are still synchronized
       with the primary.) If the old primary is prior to version 17.0, then no
       slots on the primary are copied to the new standby, so all the slots on
       the old standby must be recreated manually. If the old primary is
       version 17.0 or later, then only logical slots on the primary are copied
       to the new standby, but other slots on the old standby are not copied,
       so must be recreated manually.
</span>
ログシッピングのためにサーバを設定します。
（スタンバイはまだプライマリと同期されているので、<code class="function">pg_backup_start()</code>と<code class="function">pg_backup_stop()</code>を実行したり、ファイルシステムのバックアップを取得したりする必要はありません。）
古いプライマリがバージョン 17.0 より前の場合、プライマリのスロットは新しいスタンバイにコピーされないため、古いスタンバイのすべてのスロットを手動で再作成する必要があります。
古いプライマリがバージョン 17.0 以降の場合、プライマリの論理スロットだけが新しいスタンバイにコピーされますが、古いスタンバイの他のスロットはコピーされないため、手動で再作成する必要があります。
      </p></li></ol></div></li><li class="step"><span class="original">
    &lt;title&gt;Restore &lt;filename&gt;pg_hba.conf&lt;/filename&gt;&lt;/title&gt;
</span><p class="title"><strong><code class="filename">pg_hba.conf</code>の復旧</strong></p><p>
<span class="original">
     If you modified &lt;filename&gt;pg_hba.conf&lt;/filename&gt;, restore its original settings.
     It might also be necessary to adjust other configuration files in the new
     cluster to match the old cluster, e.g., &lt;filename&gt;postgresql.conf&lt;/filename&gt;
     (and any files included by it), &lt;filename&gt;postgresql.auto.conf&lt;/filename&gt;.
</span>
<code class="filename">pg_hba.conf</code>を変更している場合は、元の認証設定に戻してください。
また新しいクラスタにおけるこの他の設定ファイル、例えば<code class="filename">postgresql.conf</code>（とそれがインクルードしているファイル）、<code class="filename">postgresql.auto.conf</code>も古いクラスタに合わせるように調整する必要があります。
    </p></li><li class="step"><span class="original">
    &lt;title&gt;Start the new server&lt;/title&gt;
</span><p class="title"><strong>新しいサーバの起動</strong></p><p>
<span class="original">
     The new server can now be safely started, and then any
     &lt;application&gt;rsync&lt;/application&gt;'ed standby servers.
</span>
ここで新しいサーバが安全に起動できます。
それから<span class="application">rsync</span>したすべてのスタンバイサーバを起動できます。
    </p></li><li class="step"><span class="original">
    &lt;title&gt;Post-upgrade processing&lt;/title&gt;
</span><p class="title"><strong>移行後の処理</strong></p><p>
<span class="original">
     If any post-upgrade processing is required, pg_upgrade will issue
     warnings as it completes. It will also generate script files that must
     be run by the administrator. The script files will connect to each
     database that needs post-upgrade processing. Each script should be
     run using:
</span>
アップグレード後の処理が必要な場合、pg_upgradeはその終了時に警告を発します。
また、管理者として実行しなければならないスクリプトファイルを生成します。
このスクリプトファイルは、アップグレード後の処理を必要とするデータベースそれぞれに接続します。
各スクリプトは以下を使用して実行しなければなりません。

</p><pre class="programlisting">
psql --username=postgres --file=script.sql postgres
</pre><p>

<span class="original">
     The scripts can be run in any order and can be deleted once they have
     been run.
</span>
スクリプトは任意の順番で実行することができ、また、実行が終わったら削除することができます。
    </p><div class="caution"><h3 class="title">注意</h3><p>
<span class="original">
     In general it is unsafe to access tables referenced in rebuild scripts
     until the rebuild scripts have run to completion; doing so could yield
     incorrect results or poor performance. Tables not referenced in rebuild
     scripts can be accessed immediately.
</span>
一般的には、再構築用のスクリプトの実行が完了するより前に、再構築用のスクリプトで参照されるテーブルにアクセスすることは安全ではありません。
これを行うと間違った結果が生じたり、性能が劣化することがあり得ます。
再構築用のスクリプトで参照されないテーブルにはすぐにアクセスすることができます。
    </p></div></li><li class="step"><span class="original">
    &lt;title&gt;Statistics&lt;/title&gt;
</span><p class="title"><strong>統計情報</strong></p><p>
<span class="original">
     Unless the &lt;option&gt;&amp;#45;-no-statistics&lt;/option&gt; option is specified,
     &lt;command&gt;pg_upgrade&lt;/command&gt; will transfer most optimizer statistics
     from the old cluster to the new cluster.  However, some statistics may
     not be transferred, such as those created explicitly with &lt;xref
     linkend="sql-createstatistics"/&gt; or custom statistics added by an
     extension.
</span>
《機械翻訳》<code class="option">--no-statistics</code>オプションが指定されていない場合、<code class="command">pg_upgrade</code>はほとんどのオプティマイザ統計処理を古いクラスタから新しいクラスタに移行します。
ただし、<a class="xref" href="sql-createstatistics.html" title="CREATE STATISTICS"><span class="refentrytitle">CREATE STATISTICS</span></a>を使用して明示的に作成された統計処理や、extensionによって追加されたカスタム統計処理など、一部のは移行できません。
    </p><p>
<span class="original">
     Because not all statistics are transferred by
     &lt;command&gt;pg_upgrade&lt;/command&gt;, you will be instructed to run commands to
     regenerate that information at the end of the upgrade.  You might need to
     set connection parameters to match your new cluster.
</span>
《マッチ度[85.245902]》オプティマイザの統計情報は<code class="command">pg_upgrade</code>により転送されませんので、アップグレード後に統計情報を再生成するコマンドを実行するように指示されます。
新しいクラスタに合わせるために接続パラメータを設定する必要があるかもしれません。
《機械翻訳》すべての統計処理が<code class="command">pg_upgrade</code>によって転送されるわけではないため、アップグレードの最後にその情報を再生成するコマンドを実行するように指示されます。
新しいコネクションをマッチするようにクラスタパラメータを設定する必要がある場合があります。
    </p><p>
<span class="original">
     First, use
     &lt;command&gt;vacuumdb &amp;#45;-all &amp;#45;-analyze-in-stages &amp;#45;-missing-stats-only&lt;/command&gt;
     to quickly generate minimal optimizer statistics for relations without
     any.  Then, use &lt;command&gt;vacuumdb &amp;#45;-all &amp;#45;-analyze-only&lt;/command&gt; to ensure
     all relations have updated cumulative statistics for triggering vacuum and
     analyze.  For both commands, the use of &lt;option&gt;&amp;#45;-jobs&lt;/option&gt; can speed
     it up.
     If &lt;varname&gt;vacuum_cost_delay&lt;/varname&gt; is set to a non-zero
     value, this can be overridden to speed up statistics generation
     using &lt;envar&gt;PGOPTIONS&lt;/envar&gt;, e.g., &lt;literal&gt;PGOPTIONS='-c
     vacuum_cost_delay=0' vacuumdb ...&lt;/literal&gt;.
</span>
《マッチ度[55.194805]》<code class="command">vacuumdb --all --analyze-only</code>を使用すると、このような統計情報を効率的に生成できます。
<code class="option">--jobs</code>を使用すると、統計情報を迅速に生成できます。
<code class="option">--analyze-in-stages</code>オプションを使用すると、最小限の統計情報を迅速に生成できます。
<code class="varname">vacuum_cost_delay</code>が0以外の値に設定されている場合、<code class="envar">PGOPTIONS</code>を使用して、例えば<code class="literal">PGOPTIONS='-c vacuum_cost_delay=0' vacuumdb ...</code>のように、これを上書きして統計情報の生成を高速化できます。
《機械翻訳》まず、<code class="command">vacuumdb--all--ANALYZE-in-stages--missing-stats-only</code>を使用して、オプティマイザ用の最小限のリレーション統計処理を生成します。
次に、<code class="command">vacuumdb--all--ANALYZE-only</code>を使用して、すべてのリレーションがバキュームとANALYZEをトリガするために累積統計処理を更新したことを保証します。
どちらのコマンドでも、<code class="option">--jobs</code>を使用すると速度を上げることができます。
<code class="varname">バキューム_コスト_遅延</code>がゼロ以外の値に設定されている場合、<code class="envar">PGOPTIONS</code>を使用して統計処理の生成速度を上げるためにこれを上書きすることができます。
例えば<code class="literal">PGOPTIONS='-c vacuum_cost_delay=0' vacuumdb ...</code>.
    </p></li><li class="step"><span class="original">
    &lt;title&gt;Delete old cluster&lt;/title&gt;
</span><p class="title"><strong>古いクラスタの削除</strong></p><p>
<span class="original">
     Once you are satisfied with the upgrade, you can delete the old
     cluster's data directories by running the script mentioned when
     &lt;command&gt;pg_upgrade&lt;/command&gt; completes. (Automatic deletion is not
     possible if you have user-defined tablespaces inside the old data
     directory.)  You can also delete the old installation directories
     (e.g., &lt;filename&gt;bin&lt;/filename&gt;, &lt;filename&gt;share&lt;/filename&gt;).
</span>
アップグレード処理が満足いくものであれば、<code class="command">pg_upgrade</code>の終了時に示されたスクリプトを使用して、古いクラスタのデータディレクトリを削除することができます。
（古いデータディレクトリ内にユーザ定義のテーブル空間がある場合には、自動削除は不可能です。）
（<code class="filename">bin</code>、<code class="filename">share</code>など）古いインストレーションディレクトリも削除できます。
    </p></li><li class="step" id="PGUPGRADE-STEP-REVERT"><span class="original">
    &lt;title&gt;Reverting to old cluster&lt;/title&gt;
</span><p class="title"><strong>古いクラスタへの戻し</strong></p><p>
<span class="original">
     If, after running &lt;command&gt;pg_upgrade&lt;/command&gt;, you wish to revert to the old cluster,
     there are several options:
</span>
<code class="command">pg_upgrade</code>を実行した後に古いクラスタに戻したい場合、いくつかの選択肢があります。

     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
<span class="original">
        If the &lt;option&gt;&amp;#45;-check&lt;/option&gt; option was used, the old cluster
        was unmodified;  it can be restarted.
</span>
<code class="option">--check</code>オプションが使われた場合、古いクラスタは変更されません。再起動できます。
       </p></li><li class="listitem"><p>
<span class="original">
        If neither &lt;option&gt;&amp;#45;-link&lt;/option&gt; nor &lt;option&gt;&amp;#45;-swap&lt;/option&gt; was
        used, the old cluster was unmodified;  it can be restarted.
</span>
《マッチ度[64.000000]》<code class="option">--check</code>オプションが使われた場合、古いクラスタは変更されません。再起動できます。
《機械翻訳》も<code class="option">--swap</code>も使用されなかった場合、古いクラスタは変更されていないので、再起動することができる。
<code class="option">--link</code>
       </p></li><li class="listitem"><p>
<span class="original">
        If the &lt;option&gt;&amp;#45;-link&lt;/option&gt; option was used, the data
        files might be shared between the old and new cluster:
</span>
<code class="option">--link</code>オプションが使われた場合、データファイルは古いクラスタと新しいクラスタは共有されるかもしれません。

        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
<span class="original">
           If &lt;command&gt;pg_upgrade&lt;/command&gt; aborted before linking started,
           the old cluster was unmodified;  it can be restarted.
</span>
リンク処理が始まる前に<code class="command">pg_upgrade</code>が中断すれば、古いクラスタは変更されません。古いクラスタを再起動できます。
          </p></li><li class="listitem"><p>
<span class="original">
           If you did &lt;emphasis&gt;not&lt;/emphasis&gt; start the new cluster, the old
           cluster was unmodified except that, when linking started, a
           &lt;literal&gt;.old&lt;/literal&gt; suffix was appended to
           &lt;filename&gt;$PGDATA/global/pg_control&lt;/filename&gt;.  To reuse the old
           cluster, remove the &lt;filename&gt;.old&lt;/filename&gt; suffix from
           &lt;filename&gt;$PGDATA/global/pg_control&lt;/filename&gt;; you can then restart
           the old cluster.
</span>
新しいクラスタを開始し<span class="emphasis"><em>なかった</em></span>場合、リンク処理が始まる時に<code class="filename">$PGDATA/global/pg_control</code>に<code class="literal">.old</code>接尾辞が追加される点を除き、古いクラスタは変更されません。
古いクラスタを再度使用するためには、<code class="filename">$PGDATA/global/pg_control</code>から<code class="filename">.old</code>接尾辞を取り除きます。その後で古いクラスタを再起動できます。
          </p></li><li class="listitem"><p>
<span class="original">
           If you did start the new cluster, it has written to shared files
           and it is unsafe to use the old cluster.  The old cluster will
           need to be restored from backup in this case.
</span>
新しいクラスタを開始した場合、共有ファイルに書き込んでいますので古いクラスタを使うことは安全ではありません。
この場合、古いクラスタをバックアップからリストアすることが必要でしょう。
          </p></li></ul></div></li><li class="listitem"><p>
<span class="original">
        If the &lt;option&gt;&amp;#45;-swap&lt;/option&gt; option was used, the old cluster might
        be destructively modified:
</span>
《機械翻訳》<code class="option">--swap</code>オプションが使用された場合、古いクラスタは破壊的に変更される可能性があります。

        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
<span class="original">
           If &lt;command&gt;pg_upgrade&lt;/command&gt; aborts before reporting that the
           old cluster is no longer safe to start, the old cluster was
           unmodified; it can be restarted.
</span>
《マッチ度[63.291139]》リンク処理が始まる前に<code class="command">pg_upgrade</code>が中断すれば、古いクラスタは変更されません。古いクラスタを再起動できます。
《機械翻訳》古い前がスタートへのクラスタではなくなったことを報告するセーフが<code class="command">pg_upgrade</code>中止された場合、古いクラスタは変更されていないため、再起動できます。
          </p></li><li class="listitem"><p>
<span class="original">
           If &lt;command&gt;pg_upgrade&lt;/command&gt; has reported that the old cluster
           is no longer safe to start, the old cluster was destructively
           modified.  The old cluster will need to be restored from backup in
           this case.
</span>
《機械翻訳》<code class="command">pg_upgrade</code>が、セーフからスタートまでの古いクラスタがなくなったと報告した場合、古いクラスタは破壊的に修正されました。
このケースのバックアップから古いクラスタを復元する必要があります。
          </p></li></ul></div><p>
       </p></li></ul></div></li></ol></div></div><div class="refsect1" id="id-1.9.5.13.8"><h2>環境</h2><span class="original">
  &lt;title&gt;Environment&lt;/title&gt;
</span><p>
<span class="original">
   Some environment variables can be used to provide defaults for command-line options:
</span>
環境変数の中には、コマンドラインオプションのデフォルト値を提供するものがあります。

   </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="envar">PGBINOLD</code></span></dt><dd><p>
<span class="original">
       The old PostgreSQL executable directory; option
       &lt;option&gt;-b&lt;/option&gt;/&lt;option&gt;&amp;#45;-old-bindir&lt;/option&gt;.
</span>
古いPostgreSQLの実行ファイル格納ディレクトリ。
オプション<code class="option">-b</code>/<code class="option">--old-bindir</code>。
      </p></dd><dt><span class="term"><code class="envar">PGBINNEW</code></span></dt><dd><p>
<span class="original">
       The new PostgreSQL executable directory; option
       &lt;option&gt;-B&lt;/option&gt;/&lt;option&gt;&amp;#45;-new-bindir&lt;/option&gt;.
</span>
新しいPostgreSQLの実行ファイル格納ディレクトリ。
オプション<code class="option">-B</code>/<code class="option">--new-bindir</code>。
      </p></dd><dt><span class="term"><code class="envar">PGDATAOLD</code></span></dt><dd><p>
<span class="original">
       The old database cluster configuration directory; option
       &lt;option&gt;-d&lt;/option&gt;/&lt;option&gt;&amp;#45;-old-datadir&lt;/option&gt;.
</span>
古いデータベースクラスタの設定ディレクトリ。
オプション<code class="option">-d</code>/<code class="option">--old-datadir</code>。
      </p></dd><dt><span class="term"><code class="envar">PGDATANEW</code></span></dt><dd><p>
<span class="original">
       The new database cluster configuration directory; option
       &lt;option&gt;-D&lt;/option&gt;/&lt;option&gt;&amp;#45;-new-datadir&lt;/option&gt;.
</span>
新しいデータベースクラスタの設定ディレクトリ。
オプション<code class="option">-D</code>/<code class="option">--new-datadir</code>。
      </p></dd><dt><span class="term"><code class="envar">PGPORTOLD</code></span></dt><dd><p>
<span class="original">
       The old cluster port number; option
       &lt;option&gt;-p&lt;/option&gt;/&lt;option&gt;&amp;#45;-old-port&lt;/option&gt;.
</span>
古いクラスタのポート番号。
オプション<code class="option">-p</code>/<code class="option">--old-port</code>。
      </p></dd><dt><span class="term"><code class="envar">PGPORTNEW</code></span></dt><dd><p>
<span class="original">
       The new cluster port number; option
       &lt;option&gt;-P&lt;/option&gt;/&lt;option&gt;&amp;#45;-new-port&lt;/option&gt;.
</span>
新しいクラスタのポート番号。
オプション<code class="option">-P</code>/<code class="option">--new-port</code>。
      </p></dd><dt><span class="term"><code class="envar">PGSOCKETDIR</code></span></dt><dd><p>
<span class="original">
       Directory to use for postmaster sockets during upgrade; option
       &lt;option&gt;-s&lt;/option&gt;/&lt;option&gt;&amp;#45;-socketdir&lt;/option&gt;.
</span>
アップグレード中にpostmasterソケット用に利用するディレクトリ。
オプション<code class="option">-s</code>/<code class="option">--socketdir</code>。
      </p></dd><dt><span class="term"><code class="envar">PGUSER</code></span></dt><dd><p>
<span class="original">
       Cluster's install user name; option
       &lt;option&gt;-U&lt;/option&gt;/&lt;option&gt;&amp;#45;-username&lt;/option&gt;.
</span>
クラスタのインストールユーザ名。
オプション<code class="option">-U</code>/<code class="option">--username</code>。
      </p></dd></dl></div><p>
  </p></div><div class="refsect1" id="id-1.9.5.13.9"><h2>注釈</h2><span class="original">
  &lt;title&gt;Notes&lt;/title&gt;
</span><p>
<span class="original">
   &lt;application&gt;pg_upgrade&lt;/application&gt; creates various working files, such
   as schema dumps, stored within &lt;filename&gt;pg_upgrade_output.d&lt;/filename&gt; in
   the directory of the new cluster. Each run creates a new subdirectory named
   with a timestamp formatted as per ISO 8601
   (&lt;literal&gt;%Y%m%dT%H%M%S&lt;/literal&gt;), where all its generated files are
   stored.
   &lt;filename&gt;pg_upgrade_output.d&lt;/filename&gt; and its contained files will be
   removed automatically if &lt;application&gt;pg_upgrade&lt;/application&gt; completes
   successfully; but in the event of trouble, the files there may provide
   useful debugging information.
</span>
<span class="application">pg_upgrade</span>はスキーマのダンプなど様々な作業ファイルを作成し、新しいクラスタのディレクトリの<code class="filename">pg_upgrade_output.d</code>内に保存します。
実行するたびに、ISO 8601に従ってフォーマットされたタイムスタンプ(<code class="literal">%Y%m%dT%H%M%S</code>)の付いた名前の新しいサブディレクトリが作成されます。このサブディレクトリには、生成されたファイルがすべて保存されます。
<span class="application">pg_upgrade</span>が正常に完了した場合、<code class="filename">pg_upgrade_output.d</code>とそれに含まれるファイルは自動的に削除されます。
しかし、問題が発生した場合、そこにあるファイルは有用なデバッグ情報を提供する可能性があります。
  </p><p>
<span class="original">
   &lt;application&gt;pg_upgrade&lt;/application&gt; launches short-lived postmasters in
   the old and new data directories.  Temporary Unix socket files for
   communication with these postmasters are, by default, made in the current
   working directory.  In some situations the path name for the current
   directory might be too long to be a valid socket name.  In that case you
   can use the &lt;option&gt;-s&lt;/option&gt; option to put the socket files in some
   directory with a shorter path name.  For security, be sure that that
   directory is not readable or writable by any other users.
   (This is not supported on Windows.)
</span>
<span class="application">pg_upgrade</span>は新旧のデータディレクトリで短命なpostmasterを起動します。
このpostmasterの通信用の一時的なUnixのソケットファイルが、デフォルトでは現在の作業ディレクトリに作られます。
状況に依っては、カレントディレクトリのパス名が有効なソケット名には長過ぎる場合もあるでしょう。
その場合、<code class="option">-s</code>オプションを使ってソケットファイルをより短いパス名のディレクトリに置くことができます。
セキュリティのため、他のユーザがそのディレクトリを読んだり書いたりできないことを確実にしてください。
(これはWindowsではサポートされていません。)
  </p><p>
<span class="original">
   All failure, rebuild, and reindex cases will be reported by
   &lt;application&gt;pg_upgrade&lt;/application&gt; if they affect your installation;
   post-upgrade scripts to rebuild tables and indexes will be
   generated automatically.  If you are trying to automate the upgrade
   of many clusters, you should find that clusters with identical database
   schemas require the same post-upgrade steps for all cluster upgrades;
   this is because the post-upgrade steps are based on the database
   schemas, and not user data.
</span>
インストレーションに影響する場合、失敗、再構築、インデックス再作成はすべて<span class="application">pg_upgrade</span>により報告されます。
テーブルおよびインデックスを再構築するアップグレード後処理スクリプトは自動的に生成されます。
多くのクラスタのアップグレードを自動化することを考えているのであれば、
すべてのクラスタのアップグレードにおいて同一のデータベーススキーマを持つクラスタが同じアップグレード後処理を必要とすることが分かるはずです。
これはアップグレード後処理がデータ自体ではなくデータベーススキーマに基づいているためです。
  </p><p>
<span class="original">
   For deployment testing, create a schema-only copy of the old cluster,
   insert dummy data, and upgrade that.
</span>
展開試験を行うのであれば、古いクラスタのスキーマのみをコピーしたものを作成し、ダミーデータを挿入してから、アップグレードを行ってください。
  </p><p>
<span class="original">
   &lt;application&gt;pg_upgrade&lt;/application&gt; does not support upgrading of databases
   containing table columns using these &lt;type&gt;reg*&lt;/type&gt; OID-referencing system data types:
</span>
<span class="application">pg_upgrade</span>は次のOIDを参照する<code class="type">reg*</code>システムデータ型を使うテーブル列を含むデータベースのアップグレードをサポートしません。
   </p><table border="0" summary="Simple list" class="simplelist"><tr><td><code class="type">regcollation</code></td></tr><tr><td><code class="type">regconfig</code></td></tr><tr><td><code class="type">regdictionary</code></td></tr><tr><td><code class="type">regnamespace</code></td></tr><tr><td><code class="type">regoper</code></td></tr><tr><td><code class="type">regoperator</code></td></tr><tr><td><code class="type">regproc</code></td></tr><tr><td><code class="type">regprocedure</code></td></tr></table><p>
<span class="original">
   (&lt;type&gt;regclass&lt;/type&gt;, &lt;type&gt;regrole&lt;/type&gt;, and &lt;type&gt;regtype&lt;/type&gt; can be upgraded.)
</span>
(<code class="type">regclass</code>、<code class="type">regrole</code>、<code class="type">regtype</code>はアップグレード可能です。)
  </p><p>
<span class="original">
   If you want to use link mode and you do not want your old cluster
   to be modified when the new cluster is started, consider using the clone mode.
   If that is not available, make a copy of the
   old cluster and upgrade that in link mode. To make a valid copy
   of the old cluster, use &lt;command&gt;rsync&lt;/command&gt; to create a dirty
   copy of the old cluster while the server is running, then shut down
   the old server and run &lt;command&gt;rsync &amp;#45;-checksum&lt;/command&gt; again to update the
   copy with any changes to make it consistent.  (&lt;option&gt;&amp;#45;-checksum&lt;/option&gt;
   is necessary because &lt;command&gt;rsync&lt;/command&gt; only has file modification-time
   granularity of one second.)  You might want to exclude some
   files, e.g., &lt;filename&gt;postmaster.pid&lt;/filename&gt;, as documented in &lt;xref
   linkend="backup-lowlevel-base-backup"/&gt;.  If your file system supports
   file system snapshots or copy-on-write file copies, you can use that
   to make a backup of the old cluster and tablespaces, though the snapshot
   and copies must be created simultaneously or while the database server
   is down.
</span>
リンクモードを使用したいが、新しいクラスタを起動した時に古いクラスタを変更させたくない場合は、複製モードの使用を検討してください。
もしそれが利用可能でないなら、古いクラスタのコピーを取得してからリンクモードでアップグレードを行ってください。
有効な古いクラスタのコピーを取得するためには、サーバ稼働中に<code class="command">rsync</code>を使用して古いクラスタの変動があるかもしれないコピーを作成し、古いサーバを停止させた後に、<code class="command">rsync --checksum</code>を再度実行して一貫性を保つために何らかの変更をコピーに反映させます。
（<code class="command">rsync</code>はファイル更新時刻の粒度が1秒しかないので<code class="option">--checksum</code>が必要です。）
例えば<a class="xref" href="continuous-archiving.html#BACKUP-LOWLEVEL-BASE-BACKUP" title="25.3.4. 低レベルAPIを使用したベースバックアップの作成">25.3.4</a>で説明した<code class="filename">postmaster.pid</code>など、一部のファイルを除外したいと考えるかもしれません。
スナップショットやコピーは同時、もしくはデータベースサーバが停止しているときに作らなければなりませんが、ファイルシステムがファイルシステムのスナップショットやコピーオンライトファイルコピーをサポートしているのなら、それを古いクラスタとテーブル空間のバックアップをするのに使うことができます。
  </p></div><div class="refsect1" id="id-1.9.5.13.10"><h2>関連項目</h2><span class="original">
  &lt;title&gt;See Also&lt;/title&gt;
</span><span class="simplelist"><a class="xref" href="app-initdb.html" title="initdb"><span class="refentrytitle"><span class="application">initdb</span></span></a>, <a class="xref" href="app-pg-ctl.html" title="pg_ctl"><span class="refentrytitle"><span class="application">pg_ctl</span></span></a>, <a class="xref" href="app-pgdump.html" title="pg_dump"><span class="refentrytitle"><span class="application">pg_dump</span></span></a>, <a class="xref" href="app-postgres.html" title="postgres"><span class="refentrytitle"><span class="application">postgres</span></span></a></span></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="pgtesttiming.html" title="pg_test_timing">前へ</a> </td><td width="20%" align="center"><a accesskey="u" href="reference-server.html" title="PostgreSQLサーバアプリケーション">上へ</a></td><td width="40%" align="right"> <a accesskey="n" href="pgwaldump.html" title="pg_waldump">次へ</a></td></tr><tr><td width="40%" align="left" valign="top"><span class="application">pg_test_timing</span> </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="PostgreSQL 18.0文書">ホーム</a></td><td width="40%" align="right" valign="top"> <span class="application">pg_waldump</span></td></tr></table></div></body></html>