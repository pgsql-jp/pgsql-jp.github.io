<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>25.1. SQLによるダンプ</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="backup.html" title="Chapter 25. バックアップとリストア" /><link rel="next" href="backup-file.html" title="25.2. ファイルシステムレベルのバックアップ" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">25.1. <acronym xmlns="http://www.w3.org/1999/xhtml" class="acronym">SQL</acronym>によるダンプ</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="backup.html" title="Chapter 25. バックアップとリストア">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="backup.html" title="Chapter 25. バックアップとリストア">Up</a></td><th width="60%" align="center">Chapter 25. バックアップとリストア</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="backup-file.html" title="25.2. ファイルシステムレベルのバックアップ">Next</a></td></tr></table><hr></hr></div><div class="sect1" id="BACKUP-DUMP"><div class="titlepage"><div><div><h2 class="title" style="clear: both">25.1. <acronym class="acronym">SQL</acronym>によるダンプ</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="backup-dump.html#BACKUP-DUMP-RESTORE">25.1.1. ダンプのリストア</a></span></dt><dt><span class="sect2"><a href="backup-dump.html#BACKUP-DUMP-ALL">25.1.2. <span class="application">pg_dumpall</span>の使用</a></span></dt><dt><span class="sect2"><a href="backup-dump.html#BACKUP-DUMP-LARGE">25.1.3. 大規模データベースの扱い</a></span></dt></dl></div><p>このダンプ方法の背景にはSQLコマンドでファイルを生成し、そのファイルをサーバが再度読み込みを行った時に、ダンプした時点と同じ状態が再構築されるという意図があります。
この目的のため、<span class="productname">PostgreSQL</span>は<a class="xref" href="app-pgdump.html" title="pg_dump"><span class="refentrytitle">pg_dump</span></a>ユーティリティプログラムを提供しています。
このコマンドの基本となる使い方は以下の通りです。
</p><pre class="synopsis">pg_dump <em class="replaceable"><code>dbname</code></em> &gt; <em class="replaceable"><code>dumpfile</code></em></pre><p>
見てわかる通り、<span class="application">pg_dump</span>は結果を標準出力に書き出します。
これがどのように活用できるかをこれから説明します。
上記のコマンドはテキストファイルを作成しますが、<span class="application">pg_dump</span>は並列処理を可能にしたり、オブジェクトのリストアをより細かく制御できる他のフォーマットでファイルを作れます。
  </p><p><span class="application">pg_dump</span>は、<span class="productname">PostgreSQL</span>の通常のクライアントアプリケーションです（その中でも特に優れた機能を発揮するものですが）。
ということは、データベースに接続可能なあらゆるリモートホストからこのバックアップ手順を実行できます。
しかし、<span class="application">pg_dump</span>は特別な権限で実行される訳ではないことを忘れないでください。
特に、バックアップを行う全てのテーブルに対して読み取り権限が必要ですので、データベース全体のバックアップを実行する場合、ほとんど常にデータベースのスーパーユーザとして実行しなければなりません。
(もしデータベース全体のバックアップを取るのに十分な権限を持っていない場合には、<code class="option">-n <em class="replaceable"><code>schema</code></em></code>もしくは、<code class="option">-t <em class="replaceable"><code>table</code></em></code>のようなオプションを使って、データベースのアクセス権のある部分をバックアップできます。)
  </p><p><span class="application">pg_dump</span>を行うデータベースサーバを特定するにはコマンドラインの<code class="option">-h <em class="replaceable"><code>host</code></em></code>オプションと<code class="option">-p <em class="replaceable"><code>port</code></em></code>オプションを使用します。
デフォルトのホストはローカルホスト、または<code class="envar">PGHOST</code>環境変数で指定したものです。
同様に、デフォルトのポートは<code class="envar">PGPORT</code>環境変数で指定されているか、うまく行かない場合にはコンパイル時の設定がデフォルトとなります（そこはうまくできていて、サーバは通常コンパイル時の設定をデフォルトとします）。
  </p><p>他の<span class="productname">PostgreSQL</span>のクライアントアプリケーションのように、<span class="application">pg_dump</span>はデフォルトでオペレーティングシステムの現在のユーザ名と同じデータベースユーザ名で接続します。
これを書き換えるには<code class="option">-U</code>オプションを付けるか<code class="envar">PGUSER</code>環境変数を設定します。
<span class="application">pg_dump</span>の接続は（<a class="xref" href="client-authentication.html" title="Chapter 20. クライアント認証">Chapter 20</a>で説明されている）通常のクライアント認証方法によることを思い出してください。
  </p><p>後で述べる他のバックアップ手法に対する<span class="application">pg_dump</span>の重要な利点は、<span class="application">pg_dump</span>の出力は一般に新しいバージョンの<span class="productname">PostgreSQL</span>に再ロードできるということです。
一方、ファイルレベルのバックアップと継続的アーカイブは両方とも非常にサーバ、バージョン依存です。
<span class="application">pg_dump</span>は、32ビットから64ビットのサーバに移行するなどの異なるマシンアーキテクチャにデータベースを移す場合に上手くいく唯一の方法でもあります。
  </p><p><span class="application">pg_dump</span>で作成されたダンプは、内部的に整合性があります。
つまり、ダンプは<span class="application">pg_dump</span>が開始された際のデータベースのスナップショットを示しています。
<span class="application">pg_dump</span>の操作はデータベースに対する他の作業を妨げません（<code class="command">ALTER TABLE</code>のほとんどの形態であるような排他的ロックが必要な作業は例外です）。
  </p><div class="sect2" id="BACKUP-DUMP-RESTORE"><div class="titlepage"><div><div><h3 class="title">25.1.1. ダンプのリストア</h3></div></div></div><p><span class="application">pg_dump</span>で作成されたテキストファイルは<span class="application">psql</span>プログラムで読み込まれることを意図しています。
以下に、ダンプをリストアする一般的なコマンドを示します。
</p><pre class="synopsis">psql <em class="replaceable"><code>dbname</code></em> &lt; <em class="replaceable"><code>dumpfile</code></em></pre><p>
ここで<em class="replaceable"><code>dumpfile</code></em>は<span class="application">pg_dump</span>コマンドにより出力されたファイルです。
<em class="replaceable"><code>dbname</code></em>データベースはこのコマンドでは作成されません。
（例えば<code class="literal">createdb -T template0 <em class="replaceable"><code>dbname</code></em></code> のようにして）<span class="application">psql</span>を実行する前に自分で<code class="literal">template0</code>から作成してください。
<span class="application">psql</span>は<span class="application">pg_dump</span>と似たような、接続データベースサーバと使用するユーザ名を指定するオプションに対応しています。
詳細については、<a class="xref" href="app-psql.html" title="psql"><span class="refentrytitle"><span class="application">psql</span></span></a>のリファレンスページを参照してください。
テキスト形式ではないダンプファイルは<a class="xref" href="app-pgrestore.html" title="pg_restore"><span class="refentrytitle">pg_restore</span></a> ユーティリティを使いリストアします。
   </p><p>SQLダンプのリストアを実行する前に、ダンプされたデータベース内のオブジェクトを所有するユーザやそのオブジェクト上に権限を与えられたユーザも存在しなければなりません。
存在していない場合、リストアはそのオブジェクトの元々の所有権や付与された権限を再作成することができません
（このようにしたい場合もあるでしょうが、通常そうではありません）。
   </p><p>デフォルトで<span class="application">psql</span>スクリプトは、SQLエラーが起きた後も実行を継続します。
<code class="literal">ON_ERROR_STOP</code>変数を設定して<span class="application">psql</span>を実行することで、その動作を変更し、SQLエラーが起きた場合に<span class="application">psql</span>が、終了ステータス3で終了するようにしたいと思うかもしれません。
</p><pre class="programlisting">psql --set ON_ERROR_STOP=on <em class="replaceable"><code>dbname</code></em> &lt; <em class="replaceable"><code>dumpfile</code></em></pre><p>
どちらにしても、部分的にリストアされたデータベースにしかなりません。
他に、ダンプ全体を1つのトランザクションとしてリストアするように指定することができます。
こうすれば、リストアが完全に終わるか、完全にロールバックされるかのどちらかになります。
このモードは、<span class="application">psql</span>のコマンドラインオプションに<code class="option">-1</code>または<code class="option">--single-transaction</code>を渡すことで指定できます。
このモードを使用する場合、数時間かけて実行していたリストアが軽微なエラーでロールバックしてしまうことに注意してください。
しかし、部分的にリストアされたダンプから手作業で複雑なデータベースを整理するよりまだましかもしれません。
   </p><p><span class="application">pg_dump</span>と<span class="application">psql</span>ではパイプから読み書きができるので、あるサーバから別のサーバへデータベースを直接ダンプできます。
以下に例を示します。
</p><pre class="programlisting">pg_dump -h <em class="replaceable"><code>host1</code></em> <em class="replaceable"><code>dbname</code></em> | psql -h <em class="replaceable"><code>host2</code></em> <em class="replaceable"><code>dbname</code></em></pre><p>
   </p><div class="important"><h3 class="title">Important</h3><p><span class="application">pg_dump</span>で作成されるダンプは<code class="literal">template0</code>と相対関係にあります。
つまり<code class="literal">template1</code>を経由して追加されたあらゆる言語、プロシージャなども<span class="application">pg_dump</span>によりダンプされます。
その結果としてリストアする際に、カスタマイズされた<code class="literal">template1</code>を使用している場合は、上記の例のように、<code class="literal">template0</code>から空のデータベースを作成する必要があります。
    </p></div><p>バックアップをリストアした後、問い合わせオプティマイザが有用な統計情報を使用できるように、各データベースに対して<a class="xref" href="sql-analyze.html" title="ANALYZE"><span class="refentrytitle">ANALYZE</span></a>を実行することを勧めます。
より詳しくは、<a class="xref" href="routine-vacuuming.html#VACUUM-FOR-STATISTICS" title="24.1.3. プランナ用の統計情報の更新">Section 24.1.3</a> と <a class="xref" href="routine-vacuuming.html#AUTOVACUUM" title="24.1.6. 自動バキュームデーモン">Section 24.1.6</a>を参照してください。
効率的に大規模なデータを<span class="productname">PostgreSQL</span>にロードする方法に関するより多くの勧告については、<a class="xref" href="populate.html" title="14.4. データベースへのデータ投入">Section 14.4</a>を参照してください。
   </p></div><div class="sect2" id="BACKUP-DUMP-ALL"><div class="titlepage"><div><div><h3 class="title">25.1.2. <span class="application">pg_dumpall</span>の使用</h3></div></div></div><p><span class="application">pg_dump</span>は一度に単一のデータベースのみをダンプします。
また、ロールやテーブル空間についての情報はダンプしません。
（これらはテーブル毎ではなくクラスタ全体のものだからです。）
データベースクラスタの全内容の簡便なダンプをサポートするために、<a class="xref" href="app-pg-dumpall.html" title="pg_dumpall"><span class="refentrytitle"><span class="application">pg_dumpall</span></span></a>プログラムが提供されています。
<span class="application">pg_dumpall</span>は指定されたクラスタの各データベースのバックアップを行い、そして、ロールやテーブル空間定義などのクラスタ全体にわたるデータを保存します。
このコマンドの基本的な使用方法は
</p><pre class="synopsis">pg_dumpall &gt; <em class="replaceable"><code>dumpfile</code></em></pre><p>
です。
ダンプの結果は<span class="application">psql</span>でリストアできます。
</p><pre class="synopsis">psql -f <em class="replaceable"><code>dumpfile</code></em> postgres</pre><p>
（実際、開始時に任意の既存のデータベース名を指定することができますが、空のクラスタ内にロードする場合は、通常 <code class="literal">postgres</code> を使用すべきです。）
ロールやテーブル空間の情報をリストアしなければならないので、<span class="application">pg_dumpall</span>のダンプをリストアする時には、データベーススーパーユーザのアクセス権限を確実に必要とします。
テーブル空間を使用している場合、ダンプ内のテーブル空間のパスが新しいインストレーションで適切であることを確認してください。
   </p><p><span class="application">pg_dumpall</span>はコマンドを発令することによりロール、テーブル空間、およびデータベースを再作成し、それぞれのデータベースに対して<span class="application">pg_dump</span>を起動します。
このことは、それぞれのデータベースには内部的に矛盾がない一方、異なるデータベースのスナップショットは完全に同期しないことを示しています。
   </p><p>クラスタレベルでのデータは<span class="application">pg_dumpall</span> の<code class="option">--globals-only</code> オプションを使用して出力することができます。
このコマンドは個々のデータベースに<span class="application">pg_dump</span> コマンドを実行しつつ、フルバックアップを取得する際に必要です。
   </p></div><div class="sect2" id="BACKUP-DUMP-LARGE"><div class="titlepage"><div><div><h3 class="title">25.1.3. 大規模データベースの扱い</h3></div></div></div><p>オペレーティングシステムの中には最大ファイルサイズに制限があるものがあり、大きな<span class="application">pg_dump</span>出力ファイルを作成しているときに問題を引き起こします。
幸運なことに、<span class="application">pg_dump</span>は標準出力に書き出すことができますので、Unix標準のツールを使ってこの潜在的な問題を解決できます。
取りうる方法がいくつか存在します。
   </p><p><strong>圧縮ダンプの使用. </strong>たとえば、自分が愛用している<span class="application">gzip</span>のような圧縮プログラムが使えます。

</p><pre class="programlisting">pg_dump <em class="replaceable"><code>dbname</code></em> | gzip &gt; <em class="replaceable"><code>filename</code></em>.gz</pre><p>

元に戻すには次のようにします。

</p><pre class="programlisting">gunzip -c <em class="replaceable"><code>filename</code></em>.gz | psql <em class="replaceable"><code>dbname</code></em></pre><p>

あるいは次のようにもできます。

</p><pre class="programlisting">cat <em class="replaceable"><code>filename</code></em>.gz | gunzip | psql <em class="replaceable"><code>dbname</code></em></pre><p>
    </p><p><strong><code class="command">split</code>の使用. </strong><code class="command">split</code>コマンドで結果を使用しているファイルシステムが受け付けられる大きさに分割することができます。
例えば1メガバイトずつに分割するには次のようにします。

</p><pre class="programlisting">pg_dump <em class="replaceable"><code>dbname</code></em> | split -b 1m - <em class="replaceable"><code>filename</code></em></pre><p>

元に戻すには次のようにします。

</p><pre class="programlisting">cat <em class="replaceable"><code>filename</code></em>* | psql <em class="replaceable"><code>dbname</code></em></pre><p>
    </p><p><strong><span class="application">pg_dump</span>のカスタムダンプ書式の使用. </strong>もし<span class="productname">PostgreSQL</span>が<span class="application">zlib</span>圧縮ライブラリインストール済みのシステム上で構築されたのなら、カスタムダンプ書式では出力ファイルに書き出す時にデータを圧縮します。
<code class="command">gzip</code>を使用した時と似通ったダンプサイズとなりますが、テーブルの復元を部分的に行えるという点で優れていると言えます。
以下のコマンドは、カスタムダンプ書式でのデータベースのダンプを行います。

</p><pre class="programlisting">pg_dump -Fc <em class="replaceable"><code>dbname</code></em> &gt; <em class="replaceable"><code>filename</code></em></pre><p>

カスタム書式のダンプは<span class="application">psql</span>用のスクリプトではありませんので、代わりに<span class="application">pg_restore</span>でリストアしなければなりません。
例えば以下のようにします。

</p><pre class="programlisting">pg_restore -d <em class="replaceable"><code>dbname</code></em> <em class="replaceable"><code>filename</code></em></pre><p>

詳細は<a class="xref" href="app-pgdump.html" title="pg_dump"><span class="refentrytitle">pg_dump</span></a>と<a class="xref" href="app-pgrestore.html" title="pg_restore"><span class="refentrytitle">pg_restore</span></a>のリファレンスページを参照してください。
    </p><p>巨大なデータベースに対しては、そのほかの２つの手法のうちの１つと一緒に<code class="command">split</code>を組み合わせる必要があるかもしれません。
   </p><p><strong><span class="application">pg_dump</span>の並列実行. </strong><span class="application">pg_dump</span>を並列実行することで、大きなデータベースのダンプを高速に実行することができます。
これは同時に複数テーブルのダンプを実行します。
並列度は<code class="command">-j</code>パラメータを指定することで制御できます。
並列ダンプはディレクトリダンプ書式のみサポートします。

</p><pre class="programlisting">pg_dump -j <em class="replaceable"><code>num</code></em> -F d -f <em class="replaceable"><code>out.dir</code></em> <em class="replaceable"><code>dbname</code></em></pre><p>

<code class="command">pg_restore -j</code>コマンドでダンプファイルを並列でリストアすることができます。
これは<code class="command">pg_dump -j</code>でダンプファイルが作成されたか、否かにかかわらず、カスタムもしくはディレクトリダンプ書式で作成されたダンプファイルに使用できます。
    </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="backup.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="backup.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="backup-file.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter 25. バックアップとリストア </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 25.2. ファイルシステムレベルのバックアップ</td></tr></table></div></body></html>