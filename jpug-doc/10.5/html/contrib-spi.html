<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>F.37. spi</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="sepgsql.html" title="F.36. sepgsql" /><link rel="next" href="sslinfo.html" title="F.38. sslinfo" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">F.37. spi</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="sepgsql.html" title="F.36. sepgsql">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="contrib.html" title="Appendix F. 追加で提供されるモジュール">Up</a></td><th width="60%" align="center">Appendix F. 追加で提供されるモジュール</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="sslinfo.html" title="F.38. sslinfo">Next</a></td></tr></table><hr></hr></div><div class="sect1" id="CONTRIB-SPI"><div class="titlepage"><div><div><h2 class="title" style="clear: both">F.37. spi</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="contrib-spi.html#id-1.11.7.46.5">F.37.1. refint — 参照整合性を実装する関数</a></span></dt><dt><span class="sect2"><a href="contrib-spi.html#id-1.11.7.46.6">F.37.2. timetravel — 時間旅行を実装する関数</a></span></dt><dt><span class="sect2"><a href="contrib-spi.html#id-1.11.7.46.7">F.37.3. autoinc — フィールド自動増分用の関数</a></span></dt><dt><span class="sect2"><a href="contrib-spi.html#id-1.11.7.46.8">F.37.4. insert_username — 誰がテーブルを変更したかを追跡する関数</a></span></dt><dt><span class="sect2"><a href="contrib-spi.html#id-1.11.7.46.9">F.37.5. moddatetime — 最終更新時刻を追跡する関数</a></span></dt></dl></div><a id="id-1.11.7.46.2" class="indexterm"></a><p><span class="application">spi</span>モジュールは、<a class="link" href="spi.html" title="Chapter 46. サーバプログラミングインタフェース">サーバプログラミングインタフェース</a>(<acronym class="acronym">SPI</acronym>)およびトリガを使用した、動作可能な例を複数提供します。
これらの関数は独自の何らかの価値を持つものですが、目的に応じて変更するための例としてより有用です。
関数は任意のテーブルと使用できるほど一般的なものですが、トリガを作成する場合は（後述のように）テーブル名とフィールド名を指定する必要があります。
 </p><p>以下で説明する関数グループのそれぞれは、別々にインストールすることができる拡張として提供されます。
 </p><div class="sect2" id="id-1.11.7.46.5"><div class="titlepage"><div><div><h3 class="title">F.37.1. refint — 参照整合性を実装する関数</h3></div></div></div><p><code class="function">check_primary_key()</code>および<code class="function">check_foreign_key()</code>は、外部キー制約を検査するために使用されます。
（当然ながら、この機能はかなり前に組み込みの外部キー機能に取って代わりました。しかし例としてはまだ有用です。）
  </p><p><code class="function">check_primary_key()</code>は参照テーブルを検査します。
使用方法は、この関数を使用する<code class="literal">BEFORE INSERT OR UPDATE</code>トリガを他のテーブルを参照するテーブルに作成することです。
トリガ引数は、外部キーを形成する参照テーブルの列名、被参照テーブル名、プライマリ/一意キーを形成する被参照テーブルの列名です。
複数の外部キーを扱うためには、各参照に対してトリガを作成してください。
  </p><p><code class="function">check_foreign_key()</code>は被参照テーブルを検査します。
使用方法は、この関数を使用する<code class="literal">BEFORE DELETE OR UPDATE</code>トリガを他のテーブルで参照されるテーブルに作成することです。
トリガ引数は、この関数が検査を実行しなければならない参照テーブル数、参照キーが見つかった場合の動作（<code class="literal">cascade</code> — 参照行を削除、<code class="literal">restrict</code> — 参照キーが存在する場合トランザクションをアボート、<code class="literal">setnull</code> —参照キーフィールドをNULLに設定）、プライマリ/一意キーを形成するトリガを発行したテーブルの列名、参照テーブルの名前と列名（最初の引数で指定された数のテーブル分繰り返す）です。
プライマリ/一意キー列はNOT NULLと指定されていなければならず、また、一意性インデックスを持つべきであることに注意してください。
  </p><p><code class="filename">refint.example</code>に例があります。
  </p></div><div class="sect2" id="id-1.11.7.46.6"><div class="titlepage"><div><div><h3 class="title">F.37.2. timetravel — 時間旅行を実装する関数</h3></div></div></div><p>かなり前に<span class="productname">PostgreSQL</span>は各タプルで挿入時間、削除時間を保持する時間旅行機能が組み込まれました。
これをこれらの関数を使用して模擬することができます。
これらの関数を使用するためには、<code class="type">abstime</code>型の、タプルの挿入日付（start_date）および変更/削除日付（stop_date）を格納するために2つの列をテーブルに追加しなければなりません。

</p><pre class="programlisting">CREATE TABLE mytab (
        ...             ...
        start_date      abstime,
        stop_date       abstime
        ...             ...
);</pre><p>

この列には好みの名前を付けることができますが、以下の説明ではstart_date、stop_dateを使用します。
  </p><p>新しく行が挿入される時、start_dateは通常現在時刻に、stop_dateは<code class="literal">infinity</code>に設定されるはずです。
挿入されるデータにおけるこれらの列がNULLの場合、トリガは自動的にこれらの値を置き換えます。
一般的には、これらの列に非NULLのデータを明示的に挿入することは、ダンプデータの再ロードを行う時にしかないはずです。
  </p><p>stop_dateが<code class="literal">infinity</code>のstop_dateを持つタプルは<span class="quote">“<span class="quote">現在有効</span>”</span>で、変更可能です。
トリガが防止するため、有限のstop_dateを持つタプルを変更することはできません。
（変更する必要がある場合は、以下のように時間旅行を無効にすることができます。）
  </p><p>変更可能な行では、更新時、更新されようとしているタプルのstop_dateのみが（現在時刻に）変更され、変更されたデータを持った新しいタプルが挿入されます。
この新しいタプルのstart_dateは現在時刻となり、stop_dateは<code class="literal">infinity</code>になります。
  </p><p>削除では実際にタプルの削除は行われず、そのstop_dateが現在時刻になります。
  </p><p><span class="quote">“<span class="quote">現在有効</span>”</span>なタプルを問い合わせるには、問い合わせのWHERE条件に<code class="literal">stop_date = 'infinity'</code>を含めてください。
（これをビューに組み込もうと考えるかもしれません。）
同様に、start_dateとstop_dateに適切な条件を付けることで任意の時点で有効だったタプルを問い合わせることもできます。
  </p><p><code class="function">timetravel()</code>は、こうした動作をサポートする、一般的なトリガ関数です。
時間旅行を行うテーブル毎にこの関数を使用した<code class="literal">BEFORE INSERT OR UPDATE OR DELETE</code>トリガを作成してください。
2つのトリガ引数で、start_dateとstop_date列の実際の名前を指定してください。
省略可能ですが、1から3つの引数を追加して指定することもできます。
これらは<code class="type">text</code>型の列を参照しなければなりません。
トリガは現在のユーザ名を、INSERT時に最初の列、UPDATE時に2番目の列、DELETE時に3番目の列に格納します。
  </p><p><code class="function">set_timetravel()</code>により、テーブル単位で時間旅行を有効または無効にすることができます。
<code class="literal">set_timetravel('mytab', 1)</code>は<code class="literal">mytab</code>テーブルの時間旅行を有効にします。
<code class="literal">set_timetravel('mytab', 0)</code>は<code class="literal">mytab</code>テーブルの時間旅行を無効にします。
時間旅行が無効な時、start_dateとstop_date列を自由に変更することができます。
有効状態は現在のデータベースセッション内で局所的な状態であることに注意してください。
新規セッションでは常に、すべてのテーブルの時間旅行は有効状態で始まります。
  </p><p><code class="function">get_timetravel()</code>は、状態変更を行うことなく、時間旅行の状態を返します。
  </p><p><code class="filename">timetravel.example</code>に例が存在します。
  </p></div><div class="sect2" id="id-1.11.7.46.7"><div class="titlepage"><div><div><h3 class="title">F.37.3. autoinc — フィールド自動増分用の関数</h3></div></div></div><p><code class="function">autoinc()</code>は、整数型フィールドにシーケンスの次の値を格納するトリガです。
これは、組み込みの<span class="quote">“<span class="quote">連番列</span>”</span>機能と一部重複しますが、同一ではありません。
<code class="function">autoinc()</code>は挿入時に別のフィールド値に置き換える試みを上書きし、さらに省略可能ですが、更新時にフィールドを増加させるために使用することもできます。
  </p><p>使用方法は、この関数を使用する<code class="literal">BEFORE INSERT</code>（または <code class="literal">BEFORE INSERT OR UPDATE</code>）トリガを作成することです。
2つのトリガ引数、変更する整数型列の名前と値を生み出すシーケンスオブジェクトの名前を指定します。
（実際、自動増分列を複数更新したい場合、これらの名前の組み合わせを任意の数指定することができます。）
  </p><p><code class="filename">autoinc.example</code>に例があります。
  </p></div><div class="sect2" id="id-1.11.7.46.8"><div class="titlepage"><div><div><h3 class="title">F.37.4. insert_username — 誰がテーブルを変更したかを追跡する関数</h3></div></div></div><p><code class="function">insert_username()</code>は現在のユーザ名をテキスト型のフィールドに格納するトリガです。
これはテーブル内のある行を最後に変更したユーザを追跡する際に有用です。
  </p><p>使用方法は、この関数を使用する<code class="literal">BEFORE INSERT</code>、<code class="literal">UPDATE</code>またはその両方のトリガを作成することです。
1つのトリガ引数、変更するテキスト型の列の名前を指定してください。
  </p><p><code class="filename">insert_username.example</code>に例があります。
  </p></div><div class="sect2" id="id-1.11.7.46.9"><div class="titlepage"><div><div><h3 class="title">F.37.5. moddatetime — 最終更新時刻を追跡する関数</h3></div></div></div><p><code class="function">moddatetime()</code>は現在時刻を<code class="type">timestamp</code>型のフィールドに格納するトリガです。
これは、テーブル内のある行の最終更新時刻を追跡する際に有用です。
  </p><p>使用方法は、この関数を使用する<code class="literal">BEFORE UPDATE</code>トリガを作成することです。
1つのトリガ引数、変更する列名を指定してください。
この列は<code class="type">timestamp</code>型または<code class="type">timestamp with time zone</code>型でなければなりません。
  </p><p><code class="filename">moddatetime.example</code>に例があります。
  </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="sepgsql.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="contrib.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="sslinfo.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">F.36. sepgsql </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> F.38. sslinfo</td></tr></table></div></body></html>