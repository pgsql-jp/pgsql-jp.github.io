<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>48.6. ロジカルデコーディングの出力プラグイン</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="logicaldecoding-catalogs.html" title="48.5. ロジカルデコーディング関連のシステムカタログ" /><link rel="next" href="logicaldecoding-writer.html" title="48.7. ロジカルデコーディング出力ライター" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">48.6. ロジカルデコーディングの出力プラグイン</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="logicaldecoding-catalogs.html" title="48.5. ロジカルデコーディング関連のシステムカタログ">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="logicaldecoding.html" title="Chapter 48. ロジカルデコーディング">Up</a></td><th width="60%" align="center">Chapter 48. ロジカルデコーディング</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="logicaldecoding-writer.html" title="48.7. ロジカルデコーディング出力ライター">Next</a></td></tr></table><hr></hr></div><div class="sect1" id="LOGICALDECODING-OUTPUT-PLUGIN"><div class="titlepage"><div><div><h2 class="title" style="clear: both">48.6. ロジカルデコーディングの出力プラグイン</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="logicaldecoding-output-plugin.html#LOGICALDECODING-OUTPUT-INIT">48.6.1. 初期化関数</a></span></dt><dt><span class="sect2"><a href="logicaldecoding-output-plugin.html#LOGICALDECODING-CAPABILITIES">48.6.2. 機能</a></span></dt><dt><span class="sect2"><a href="logicaldecoding-output-plugin.html#LOGICALDECODING-OUTPUT-MODE">48.6.3. 出力モード</a></span></dt><dt><span class="sect2"><a href="logicaldecoding-output-plugin.html#LOGICALDECODING-OUTPUT-PLUGIN-CALLBACKS">48.6.4. 出力プラグインコールバック</a></span></dt><dt><span class="sect2"><a href="logicaldecoding-output-plugin.html#LOGICALDECODING-OUTPUT-PLUGIN-OUTPUT">48.6.5. 出力生成関数</a></span></dt></dl></div><p>PostgreSQLのソースコードのサブディレクトリ<a class="link" href="test-decoding.html" title="F.41. test_decoding">     <code class="filename">contrib/test_decoding</code>
    </a>にサンプル出力プラグインがあります。
   </p><div class="sect2" id="LOGICALDECODING-OUTPUT-INIT"><div class="titlepage"><div><div><h3 class="title">48.6.1. 初期化関数</h3></div></div></div><a id="id-1.8.14.12.3.2" class="indexterm"></a><p>出力プラグインは、出力プラグインの名前をライブラリのベース名として持つ共有ライブラリを動的にロードすることによってロードされます。
必要な出力プラグインコールバックを提供し、そのライブラリが実際に出力プラグインであることを示すために、<code class="function">_PG_output_plugin_init</code>という名前の関数を作成しなければなりません。
この関数には、各々のアクションに対応するコールバック関数へのポインタを持つ構造体が渡されます。
</p><pre class="programlisting">typedef struct OutputPluginCallbacks
{
    LogicalDecodeStartupCB startup_cb;
    LogicalDecodeBeginCB begin_cb;
    LogicalDecodeChangeCB change_cb;
    LogicalDecodeCommitCB commit_cb;
    LogicalDecodeMessageCB message_cb;
    LogicalDecodeFilterByOriginCB filter_by_origin_cb;
    LogicalDecodeShutdownCB shutdown_cb;
} OutputPluginCallbacks;

typedef void (*LogicalOutputPluginInit) (struct OutputPluginCallbacks *cb);</pre><p>
     コールバック関数の<code class="function">begin_cb</code>、<code class="function">change_cb</code>
     <code class="function">commit_cb</code>は必須ですが、
     <code class="function">startup_cb</code>、     <code class="function">filter_by_origin_cb</code>、それに<code class="function">shutdown_cb</code>必須ではありません。
    </p></div><div class="sect2" id="LOGICALDECODING-CAPABILITIES"><div class="titlepage"><div><div><h3 class="title">48.6.2. 機能</h3></div></div></div><p>更新データをデコード、整形、出力するために、出力関数を呼び出すことを含め、出力プラグインはバックエンドの通常のインフラストラクチャのほとんどを利用できます。
テーブルは、<code class="command">initdb</code>で作られ、<code class="literal">pg_catalog</code>スキーマに含まれているか、以下のコマンドでユーザ定義のカタログテーブルであると印が付けられている限り、読み込み専用のアクセスが許可されます。

</p><pre class="programlisting">ALTER TABLE user_catalog_table SET (user_catalog_table = true);
CREATE TABLE another_catalog_table(data text) WITH (user_catalog_table = true);</pre><p>
トランザクションIDの割り当てが発生するような動作は許可されていません。
そのような動作としては、テーブルへの書き込み、DDLの変更操作、<code class="literal">txid_current()</code>の呼び出しなどがあります。
    </p></div><div class="sect2" id="LOGICALDECODING-OUTPUT-MODE"><div class="titlepage"><div><div><h3 class="title">48.6.3. 出力モード</h3></div></div></div><p>出力プラグインコールバックは、かなり自由な形式で消費者にデータを渡すことができます。
SQLで変更データを見るような場合、任意のかたちでデータを返すことのできるデータ型(たとえば<code class="type">bytea</code>)は扱いにくいです。
出力プラグインがサーバエンコーディングのテキストデータのみを含むことにするには、
<code class="literal">OutputPluginOptions.output_type</code>に
<code class="literal">OUTPUT_PLUGIN_BINARY_OUTPUT</code>ではなく、<code class="literal">OUTPUT_PLUGIN_TEXTUAL_OUTPUT</code>を設定することによって宣言できます。
この場合、<code class="type">text</code>datumが格納することができるように、すべてのデータはサーバエンコーディングでエンコードされていなければなりません。
    </p></div><div class="sect2" id="LOGICALDECODING-OUTPUT-PLUGIN-CALLBACKS"><div class="titlepage"><div><div><h3 class="title">48.6.4. 出力プラグインコールバック</h3></div></div></div><p>出力プラグインには、必要に応じて発生した更新に関する通知が様々なコールバックを通じて送られます。
    </p><p>同時に実行されたトランザクションは、コミットした順番にデコードされます。
指定したトランザクションに含まれる更新だけが<code class="literal">begin</code>と<code class="literal">commit</code>の間のコールバックによってデコードされます。
明示的あるいは暗黙的にロールバックされたトランザクションは、決してデコードされません。
成功したセーブポイントは、実行された順番にセーブポイントが実行されたトランザクションの中に折り込まれます。
    </p><div class="note"><h3 class="title">Note</h3><p>ディスクに安全に書きだされたトランザクションだけがデコードされます。
そのため、<code class="varname">synchronous_commit</code>が<code class="literal">off</code>の場合には、直後に呼び出された<code class="literal">pg_logical_slot_get_changes()</code>がその<code class="command">COMMIT</code>をデコードしないことがあります。
     </p></div><div class="sect3" id="LOGICALDECODING-OUTPUT-PLUGIN-STARTUP"><div class="titlepage"><div><div><h4 class="title">48.6.4.1. 開始コールバック</h4></div></div></div><p>ストリームに投入可能な更新の数に関係なく、レプリケーションスロットが作られるか、ストリームの変更がリクエストされた場合にオプションの<code class="function">startup_cb</code>コールバック呼び出されます。
</p><pre class="programlisting">typedef void (*LogicalDecodeStartupCB) (struct LogicalDecodingContext *ctx,
                                        OutputPluginOptions *options,
                                        bool is_init);</pre><p>
<code class="literal">is_init</code> パラメータは、レプリケーションスロットが作られる際にはtrue、それ以外ではfalseになります。
<em class="parameter"><code>options</code></em>は、出力プラグインが書き込む以下の構造体を指します。
</p><pre class="programlisting">typedef struct OutputPluginOptions
{
    OutputPluginOutputType output_type;
} OutputPluginOptions;</pre><p>
      <code class="literal">output_type</code>は<code class="literal">OUTPUT_PLUGIN_TEXTUAL_OUTPUT</code>か<code class="literal">OUTPUT_PLUGIN_BINARY_OUTPUT</code>のどちらかです。
      <a class="xref" href="logicaldecoding-output-plugin.html#LOGICALDECODING-OUTPUT-MODE" title="48.6.3. 出力モード">Section 48.6.3</a>を参照してください。
     </p><p>開始コールバックでは、<code class="literal">ctx-&gt;output_plugin_options</code>で指定されるオプションを検証しましょう。
出力プラグインが状態を持つ必要がある場合には、<code class="literal">ctx-&gt;output_plugin_private</code>を利用できます。
     </p></div><div class="sect3" id="LOGICALDECODING-OUTPUT-PLUGIN-SHUTDOWN"><div class="titlepage"><div><div><h4 class="title">48.6.4.2. 終了コールバック</h4></div></div></div><p>以前アクティブだったレプリケーションスロットが使われなくなったら、いつでも<code class="function">shutdown_cb</code>コールバックが呼び出され、出力プラグインのプライベートリソースが解放されます。
スロットは削除される必要はありません。単にストリームが停止します。
</p><pre class="programlisting">typedef void (*LogicalDecodeShutdownCB) (struct LogicalDecodingContext *ctx);</pre><p>
     </p></div><div class="sect3" id="LOGICALDECODING-OUTPUT-PLUGIN-BEGIN"><div class="titlepage"><div><div><h4 class="title">48.6.4.3. トランザクション開始コールバック</h4></div></div></div><p>必須である<code class="function">begin_cb</code>コールバックは、コミットしたトランザクションの開始がデコードされる際に必ず呼び出されます。
アボートしたトランザクションとその内容は決してデコードされません。
</p><pre class="programlisting">typedef void (*LogicalDecodeBeginCB) (struct LogicalDecodingContext *ctx,
                                      ReorderBufferTXN *txn);</pre><p>
<em class="parameter"><code>txn</code></em>引数は、コミット時のタイムスタンプやトランザクションIDなどのトランザクションに関するメタ情報を含みます。
     </p></div><div class="sect3" id="LOGICALDECODING-OUTPUT-PLUGIN-COMMIT"><div class="titlepage"><div><div><h4 class="title">48.6.4.4. トランザクション終了コールバック</h4></div></div></div><p>必須である<code class="function">commit_cb</code>コールバックは、トランザクションのコミットがデコードされる際に必ず呼び出されます。
行が更新された場合は、それぞれの行に対して<code class="function">change_cb</code>コールバックが、<code class="function">commit_cb</code>の前に呼び出されます。

</p><pre class="programlisting">typedef void (*LogicalDecodeCommitCB) (struct LogicalDecodingContext *ctx,
                                       ReorderBufferTXN *txn,
                                       XLogRecPtr commit_lsn);</pre><p>
     </p></div><div class="sect3" id="LOGICALDECODING-OUTPUT-PLUGIN-CHANGE"><div class="titlepage"><div><div><h4 class="title">48.6.4.5. 更新コールバック</h4></div></div></div><p>トランザクション内の<code class="command">INSERT</code>、<code class="command">UPDATE</code>、<code class="command">DELETE</code>の更新に対して、必須コールバックである<code class="function">change_cb</code>が呼び出されます。
元の更新コマンドが複数の行を一度に更新する場合は、それぞれの行に対してこのコールバックが呼び出されます。
</p><pre class="programlisting">typedef void (*LogicalDecodeChangeCB) (struct LogicalDecodingContext *ctx,
                                       ReorderBufferTXN *txn,
                                       Relation relation,
                                       ReorderBufferChange *change);</pre><p>
<em class="parameter"><code>ctx</code></em>と<em class="parameter"><code>txn</code></em>は、<code class="function">begin_cb</code>、<code class="function">commit_cb</code>コールバックでは同じ内容になります。
これに加えて<em class="parameter"><code>relation</code></em>は行が属するリレーションを指定し、行の変更を記述する<em class="parameter"><code>change</code></em>パラメータが渡されます。
     </p><div class="note"><h3 class="title">Note</h3><p>unloggedテーブル(<a class="xref" href="sql-createtable.html#SQL-CREATETABLE-UNLOGGED"><code class="literal">UNLOGGED</code></a>参照)と(<a class="xref" href="sql-createtable.html#SQL-CREATETABLE-TEMPORARY"><code class="literal">TEMPORARY</code>または<code class="literal">TEMP</code></a>参照)以外のユーザ定義テーブルだけが、ロジカルデコーディングを使って更新データを取得できます。

      </p></div></div><div class="sect3" id="LOGICALDECODING-OUTPUT-PLUGIN-FILTER-ORIGIN"><div class="titlepage"><div><div><h4 class="title">48.6.4.6. オリジンフィルターコールバック</h4></div></div></div><p>オプションの<code class="function">filter_by_origin_cb</code>コールバックは、<em class="parameter"><code>origin_id</code></em>からリプレイされたデータがアウトプットプラグインの対象となるかどうかを判定するために呼び出されます。
</p><pre class="programlisting">typedef bool (*LogicalDecodeFilterByOriginCB) (struct LogicalDecodingContext *ctx,
                                               RepOriginId origin_id);</pre><p>
<em class="parameter"><code>ctx</code></em>パラメータは、他のコールバックと同じ内容を持ちます。
オリジンの情報だけが得られます。
渡されたノードで発生した変更が無関係であることを伝えるには、trueを返します。
これにより、その変更は無視されることになります。
無視されたトランザクション変更に関わる他のコールバックは呼び出されません。
     </p><p>これは、カスケード、あるいは双方向レプリケーションソリューションを実装する際に有用です。
オリジンでフィルターすることにより、そのような構成で、同じ変更のレプリケーションが往復するのを防ぐことができます。
トランザクションや変更もオリジンに関する情報を持っていますが、このコールバックでフィルターするほうがずっと効率的です。
     </p></div><div class="sect3" id="LOGICALDECODING-OUTPUT-PLUGIN-MESSAGE"><div class="titlepage"><div><div><h4 class="title">48.6.4.7. 汎用メッセージコールバック</h4></div></div></div><p>オプションの<code class="function">message_cb</code>コールバックは、ロジカルデコーディングメッセージがデコードされる度に呼び出されます。
</p><pre class="programlisting">typedef void (*LogicalDecodeMessageCB) (struct LogicalDecodingContext *ctx,
                                        ReorderBufferTXN *txn,
                                        XLogRecPtr message_lsn,
                                        bool transactional,
                                        const char *prefix,
                                        Size message_size,
                                        const char *message);</pre><p>
<em class="parameter"><code>txn</code></em>パラメータは、コミット時のタイムスタンプとXIDのような、トランザクションに関するメタ情報を含んでいます。
ただし、そのメッセージがトランザクション扱いではなく、メッセージをログしたトランザクションにXIDが割り当てられてない場合はNULLになることに注意してください。
<em class="parameter"><code>lsn</code></em>は、メッセージに対応するWALの位置です。
<em class="parameter"><code>transactional</code></em>は、メッセージがトランザクションとして送られたものかどうかを表しています。
<em class="parameter"><code>prefix</code></em>はnull終端された任意の接頭辞で、現在のプラグインが興味のあるメッセージを特定するために利用できます。
最後に、<em class="parameter"><code>message</code></em>パラメータは、大きさが<em class="parameter"><code>message_size</code></em>の、実際のメッセージを保持します。
     </p><p>出力プラグインが利用を考慮している接頭辞が一意になるように、特に注意を払ってください。
拡張の名前か、出力プラグインの名前を使うのが良い場合が多いです。
     </p></div></div><div class="sect2" id="LOGICALDECODING-OUTPUT-PLUGIN-OUTPUT"><div class="titlepage"><div><div><h3 class="title">48.6.5. 出力生成関数</h3></div></div></div><p><code class="function">begin_cb</code>、<code class="function">commit_cb</code>、<code class="function">change_cb</code>コールバックにおいて、出力プラグインは実際にデータ出力するために<code class="literal">ctx-&gt;out</code>の<code class="literal">StringInfo</code>出力バッファに書き込みます。
出力バッファに書き込む前に、<code class="function">OutputPluginPrepareWrite(ctx, last_write)</code>を呼び出します。
また、書き込みバッファにデータを書き終えたら、<code class="function">OutputPluginWrite(ctx, last_write)</code>を呼び出してデータの書き込みを実施します。
<em class="parameter"><code>last_write</code></em>引数により、その書き込みがコールバックの最終的な書き込みであるかどうかを指定します。
    </p><p>以下の例では、出力プラグインにおいて消費者に向けてデータを出力する方法を示します。
</p><pre class="programlisting">OutputPluginPrepareWrite(ctx, true);
appendStringInfo(ctx-&gt;out, "BEGIN %u", txn-&gt;xid);
OutputPluginWrite(ctx, true);</pre><p>
    </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="logicaldecoding-catalogs.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="logicaldecoding.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="logicaldecoding-writer.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">48.5. ロジカルデコーディング関連のシステムカタログ </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 48.7. ロジカルデコーディング出力ライター</td></tr></table></div></body></html>