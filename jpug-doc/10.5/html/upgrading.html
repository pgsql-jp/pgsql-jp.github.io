<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>18.6. PostgreSQLクラスタのアップグレード処理</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="server-shutdown.html" title="18.5. サーバのシャットダウン" /><link rel="next" href="preventing-server-spoofing.html" title="18.7. サーバのなりすまし防止" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">18.6. <span xmlns="http://www.w3.org/1999/xhtml" class="productname">PostgreSQL</span>クラスタのアップグレード処理</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="server-shutdown.html" title="18.5. サーバのシャットダウン">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="runtime.html" title="Chapter 18. サーバの準備と運用">Up</a></td><th width="60%" align="center">Chapter 18. サーバの準備と運用</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="preventing-server-spoofing.html" title="18.7. サーバのなりすまし防止">Next</a></td></tr></table><hr></hr></div><div class="sect1" id="UPGRADING"><div class="titlepage"><div><div><h2 class="title" style="clear: both">18.6. <span class="productname">PostgreSQL</span>クラスタのアップグレード処理</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="upgrading.html#UPGRADING-VIA-PGDUMPALL">18.6.1. <span class="application">pg_dumpall</span>を介したデータのアップグレード</a></span></dt><dt><span class="sect2"><a href="upgrading.html#UPGRADING-VIA-PG-UPGRADE">18.6.2. <span class="application">pg_upgrade</span>を使用したアップグレード方法</a></span></dt><dt><span class="sect2"><a href="upgrading.html#UPGRADING-VIA-REPLICATION">18.6.3. レプリケーション経由のアップグレード</a></span></dt></dl></div><a id="id-1.6.5.8.2" class="indexterm"></a><a id="id-1.6.5.8.3" class="indexterm"></a><p>本節では<span class="productname">PostgreSQL</span>リリースからより新しいリリースにデータベースデータをアップグレードする方法を説明します。
  </p><p>現在の<span class="productname">PostgreSQL</span>メジャーバージョンとマイナーバージョンのバージョン番号で構成されます。
例えばバージョン番号は10.1は、10がメジャーバージョンで、1がマイナーバージョンです。メジャーリリース10の最初のマイナーリリースを意味します。
<span class="productname">PostgreSQL</span>の10.0より前のバージョンは, ３つの番号で構成されています。例えば9.5.3です。
この場合は、最初のメジャーバージョンが２つのグループのバージョン番号、例えば9.5で構成されています。
そしてマイナーバージョンは３つ目の番号で例えば3です。これはメジャーリリース9.5の３番めのマイナーリリースを意味します。
  </p><p>マイナーリリースでは内部格納書式が変わることは決してありませんので、同じメジャーバージョンにおける前後のマイナーリリースとの間で常に互換性があります。
例えばバージョン10.1はバージョン10.0やバージョン10.6と互換性があります。
同様に、例えば9.5.3は9.5.0、9.5.1、9.5.6と互換性があります
互換性があるバージョンとの間で更新するためには、サーバを停止させ、実行ファイルを置き換え、サーバを再起動させるだけです。
データディレクトリはまったく変更されません。
マイナーリリースのアップグレードは簡単です。
  </p><p><span class="productname">PostgreSQL</span>の<span class="emphasis"><em>メジャー</em></span>リリースでは、内部データ格納書式は変更されがちです。
したがって、アップグレードは複雑になります。
新しいメジャーバージョンにデータを移行する伝統的な方法は、遅くなることがありますが、データベースをダンプしてリロードすることです。より速い方法については、<a class="xref" href="pgupgrade.html" title="pg_upgrade"><span class="refentrytitle"><span class="application">pg_upgrade</span></span></a>を参照してください。以下で説明するようにレプリケーションを使用する方法もあります。
  </p><p>新しいメジャーバージョンは通常、ユーザにも影響する非互換性がいくつか導入されます。
このためアプリケーションのプログラム変更が必要になる可能性があります。
ユーザに影響する変更はすべてリリースノート（<a class="xref" href="release.html" title="Appendix E. リリースノート">Appendix E</a>）に列挙されています。
「移行」という名前の節に特に注意してください。
複数のメジャーバージョンをまたいでアップグレードする場合は、関連するバージョンそれぞれのリリースノートを確認してください。
  </p><p>用心深いユーザは、完全に切り替える前に新しいバージョンにおける自身のクライアントアプリケーションを試験したいと考えるでしょう。
このため古いバージョンと新しいバージョンを並行してインストールさせるというのは、よく良い考えとなります。
<span class="productname">PostgreSQL</span>メジャーアップグレードを試験する時、以下に示す変更があり得る分野を検討してください。
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">管理</span></dt><dd><p>各メジャーリリースにおいて、管理者が利用できるサーバの監視、制御機能はよく変更、向上されます。
     </p></dd><dt><span class="term">SQL</span></dt><dd><p>通常、これには新しいSQLコマンド機能が含まれます。
リリースノートに特に記載がない限りその動作には変更はありません。
     </p></dd><dt><span class="term">ライブラリAPI</span></dt><dd><p>繰り返しになりますが、リリースノートに記載がない場合のみですが、通常<span class="application">libpq</span>のようなライブラリには新しい機能が追加されるだけです。
     </p></dd><dt><span class="term">システムカタログ</span></dt><dd><p>システムカタログの変更は通常データベース管理用ツールにのみ影響します。
     </p></dd><dt><span class="term">サーバC言語API</span></dt><dd><p>ここには、Cプログラム言語で作成されたバックエンド関数APIにおける変更が含まれます。
こうした変更は、サーバ内部深くにあるバックエンド関数を参照するコードに影響します。
     </p></dd></dl></div><div class="sect2" id="UPGRADING-VIA-PGDUMPALL"><div class="titlepage"><div><div><h3 class="title">18.6.1. <span class="application">pg_dumpall</span>を介したデータのアップグレード</h3></div></div></div><p><span class="productname">PostgreSQL</span>のアップグレードの一つの方法は、<span class="productname">PostgreSQL</span>の１メジャーバージョンからデータをダンプし、別のバージョンにリロードすることです - これを行うには、<span class="application">pg_dumpall</span>のような<span class="emphasis"><em>論理</em></span>バックアップツールを使用しなければなりません。
ファイルシステムレベルのバックアップ方法は動作しません。
（あるデータディレクトリ間違ったバージョンのサーバを起動しようとして、大きな損害が起こることがないように、適所に互換性がないバージョンの<span class="productname">PostgreSQL</span>のデータディレクトリが使用されないようにするための検査があります。）
   </p><p>新しいバージョンの<span class="productname">PostgreSQL</span>の<span class="application">pg_dump</span>と<span class="application">pg_dumpall</span>を使用することを勧めます。
これらのプログラムで拡張された機能を利用する可能性があるためです。
現在のリリースのダンププログラムは7.0以降のバージョンのサーバからデータを読み取ることができます。
   </p><p>以下の手順では、既存のインストレーションが<code class="filename">/usr/local/pgsql</code>以下にあり、そのデータ領域が<code class="filename">/usr/local/pgsql/data</code>にあることを前提としています。
使用しているパスに適切に置き換えてください。
   </p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>バックアップを作成する場合、使用しているデータベースが確実に更新されないようにしてください。
これはバックアップの整合性には影響しませんが、当然ながら変更されたデータがバックアップに含まれません。
必要に応じて、<code class="filename">/usr/local/pgsql/data/pg_hba.conf</code>（またはこれと等価なファイル）における権限を変更して、バックアップを行うユーザ以外からのアクセスを禁止してください。
アクセス制御に関する情報は<a class="xref" href="client-authentication.html" title="Chapter 20. クライアント認証">Chapter 20</a>を参照してください。
     </p><p>      <a id="id-1.6.5.8.11.5.1.2.1" class="indexterm"></a>

データベースインストレーションをバックアップするためには以下を入力してください。
</p><pre class="screen"><strong class="userinput"><code>pg_dumpall &gt; <em class="replaceable"><code>outputfile</code></em></code></strong></pre><p>
     </p><p>バックアップを作成するために、現在起動中のバージョンの<span class="application">pg_dumpall</span>コマンドを使用することができます。詳細は<a class="xref" href="backup-dump.html#BACKUP-DUMP-ALL" title="25.1.2. pg_dumpallの使用">Section 25.1.2</a> を参照してください。
しかし最善の結果を得るためには、<span class="productname">PostgreSQL</span> 10.5の<span class="application">pg_dumpall</span>コマンドを試してください。
このバージョンでは、過去のバージョンに対して、不具合の修正や改良が含まれているからです。
新しいバージョンをまだインストールしていませんので、この勧告は奇異に思えるかもしれませんが、古いバージョンと並行して新しいバージョンをインストールすることを計画しているのであれば、これに従うことを推奨します。
この場合、インストールを普通に完了させてからデータを移行することができます。
これは同時に停止時間を短縮します。
     </p></li><li class="step"><p>古いサーバを停止します。
</p><pre class="screen"><strong class="userinput"><code>pg_ctl stop</code></strong></pre><p>
起動時に<span class="productname">PostgreSQL</span>を実行させるようにしているシステムではおそらく、同じことを達成する起動ファイルがあります。
例えば<span class="systemitem">Red Hat Linux</span>システムでは、以下が動作することが分かります。
</p><pre class="screen"><strong class="userinput"><code>/etc/rc.d/init.d/postgresql stop</code></strong></pre><p>
サーバの起動と停止については<a class="xref" href="runtime.html" title="Chapter 18. サーバの準備と運用">Chapter 18</a>を参照してください。
     </p></li><li class="step"><p>バックアップからリストアする場合、名前を変更、またはバージョン固有でない場合は古いインストレーションディレクトリを削除してください。
問題があった場合に戻さなければならない場合に備え、削除するよりディレクトリの名前を変更する方を勧めます。
このディレクトリが多くのディスク容量を占めている可能性があることに注意してください。
ディレクトリの名前を変更するためには、以下のようなコマンドを使用してください。
</p><pre class="screen"><strong class="userinput"><code>mv /usr/local/pgsql /usr/local/pgsql.old</code></strong></pre><p>
（相対パスが維持されるように確実にディレクトリ単位で移動してください。）
     </p></li><li class="step"><p>概要を <a class="xref" href="install-procedure.html" title="16.4. インストール手順">Section 16.4</a>.で示すように、新しいバージョンの<span class="productname">PostgreSQL</span>をインストールしてください。
     </p></li><li class="step"><p>必要に応じて新しいデータベースクラスタを作成してください。
（アップグレードの場合はすでに存在している）特別なデータベースユーザアカウントでログインして、このコマンドを実行しなければならないことに注意してください。
</p><pre class="programlisting"><strong class="userinput"><code>/usr/local/pgsql/bin/initdb -D /usr/local/pgsql/data</code></strong></pre><p>
     </p></li><li class="step"><p>以前の<code class="filename">pg_hba.conf</code>と<code class="filename">postgresql.conf</code>に加えた何らかの変更を戻してください。
     </p></li><li class="step"><p>繰り返しになりますが、特別なデータベースユーザアカウントを使用して、データベースサーバを起動してください。
</p><pre class="programlisting"><strong class="userinput"><code>/usr/local/pgsql/bin/postgres -D /usr/local/pgsql/data</code></strong></pre><p>
     </p></li><li class="step"><p>最後に、<span class="emphasis"><em>新しい</em></span><span class="application">psql</span>を用いて、バックアップからデータをリストアしてください。
</p><pre class="screen"><strong class="userinput"><code>/usr/local/pgsql/bin/psql -d postgres -f <em class="replaceable"><code>outputfile</code></em></code></strong></pre><p>
     </p></li></ol></div><p>新しいサーバを異なるディレクトリにインストールし、古いサーバと新しいサーバを別のポートで並行して実行させることで、停止時間を最小にすることができます。
この場合、データを移行するために以下のようなコマンドを使用することができます。

</p><pre class="programlisting">pg_dumpall -p 5432 | psql -d postgres -p 5433</pre><p>
   </p></div><div class="sect2" id="UPGRADING-VIA-PG-UPGRADE"><div class="titlepage"><div><div><h3 class="title">18.6.2. <span class="application">pg_upgrade</span>を使用したアップグレード方法</h3></div></div></div><p><a class="xref" href="pgupgrade.html" title="pg_upgrade"><span class="refentrytitle"><span class="application">pg_upgrade</span></span></a>モジュールにより、<span class="productname">PostgreSQL</span>のあるバージョンから次のバージョンにインストレーションをその場で移行することができます。
特に<code class="option">--link</code>オプションを使用することで、アップグレードは数分で行うことができます。
これは、<span class="application">pg_dumpall</span>と同様の工程を必要とします。
例えば、<span class="application">initdb</span>を実行し、サーバの起動／停止をおこないます。
<span class="application">pg_upgrade</span> <a class="link" href="pgupgrade.html" title="pg_upgrade">ドキュメント</a>で必要な手順を説明します。
   </p></div><div class="sect2" id="UPGRADING-VIA-REPLICATION"><div class="titlepage"><div><div><h3 class="title">18.6.3. レプリケーション経由のアップグレード</h3></div></div></div><p>更新対象のバージョンの<span class="productname">PostgreSQL</span>をスタンバイサーバとして作成して、<span class="productname">Slony</span>などの特定のレプリケーション方式を使用することもできます。
Slonyが異なるメジャーバージョンの<span class="productname">PostgreSQL</span>との間でレプリケーションすることができるため、これが実現できます。
スタンバイは同じコンピュータで作成することも異なるコンピュータで作成することもできます。
（古いバージョンの<span class="productname">PostgreSQL</span>で実行している）マスタサーバと同期した後、マスタを切り替え、スタンバイをマスタにし、古いデータベースインスタンスを停止することができます。
このようなスイッチオーバの結果、数秒の停止時間でアップグレードされます。
   </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="server-shutdown.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="runtime.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="preventing-server-spoofing.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">18.5. サーバのシャットダウン </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 18.7. サーバのなりすまし防止</td></tr></table></div></body></html>