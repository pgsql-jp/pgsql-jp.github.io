<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>pg_receivewal</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="app-pg-isready.html" title="pg_isready" /><link rel="next" href="app-pgrecvlogical.html" title="pg_recvlogical" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">pg_receivewal</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="app-pg-isready.html" title="pg_isready">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="reference-client.html" title="PostgreSQLクライアントアプリケーション">Up</a></td><th width="60%" align="center">PostgreSQLクライアントアプリケーション</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="app-pgrecvlogical.html" title="pg_recvlogical">Next</a></td></tr></table><hr></hr></div><div class="refentry" id="APP-PGRECEIVEWAL"><div class="titlepage"></div><a id="id-1.9.4.15.1" class="indexterm"></a><div class="refnamediv"><h2><span class="refentrytitle">pg_receivewal</span></h2><p>pg_receivewal — <span class="productname">PostgreSQL</span>サーバから先行書き込みログをストリームする</p></div><div class="refsynopsisdiv"><h2>Synopsis</h2><div class="cmdsynopsis"><p id="id-1.9.4.15.4.1"><code class="command">pg_receivewal</code> [<em class="replaceable"><code>option</code></em>...]</p></div></div><div class="refsect1" id="id-1.9.4.15.5"><h2>説明
  </h2><p><span class="application">pg_receivewal</span>は実行中の<span class="productname">PostgreSQL</span>クラスタから先行書き込みログをストリームするために使用されます。
先行書き込みログはストリーミングレプリケーションプロトコルを使用してストリームされ、ローカルディレクトリのファイルとして書き出されます。
このディレクトリはポイントインタイムリカバリ（<a class="xref" href="continuous-archiving.html" title="25.3. 継続的アーカイブとポイントインタイムリカバリ（PITR）">Section 25.3</a>参照）を用いてリストアする際のアーカイブ場所として使用することができます。
  </p><p><span class="application">pg_receivewal</span>は先行書き込みログをサーバで生成に合わせてリアルタイムでストリームし、<a class="xref" href="runtime-config-wal.html#GUC-ARCHIVE-COMMAND">archive_command</a>とは異なり、セグメントが完了するまで待機することはありません。
このため、<span class="application">pg_receivewal</span>を使用する場合には<a class="xref" href="runtime-config-wal.html#GUC-ARCHIVE-TIMEOUT">archive_timeout</a>を設定する必要はありません。
  </p><p>PostgreSQLのスタンバイサーバのWALレシーバと異なり、<span class="application">pg_receivewal</span>はデフォルトでは、WALファイルがクローズされた時にのみ、WALデータをフラッシュします。
WALデータをリアルタイムでフラッシュするには<code class="option">--synchronous</code>オプションを指定する必要があります。
  </p><p>先行書き込みログは通常の<span class="productname">PostgreSQL</span>接続を経由して、そしてレプリケーションプロトコルを使用して、ストリームされます。
この接続はスーパーユーザまたは<code class="literal">REPLICATION</code>権限（<a class="xref" href="role-attributes.html" title="21.2. ロールの属性">Section 21.2</a>参照）を持つユーザで確立されなければなりません。
そして<code class="filename">pg_hba.conf</code>でレプリケーション用の接続を許可しなければなりません。
またサーバではストリーム用に利用できるセッションが少なくとも１つ存在できるために<a class="xref" href="runtime-config-replication.html#GUC-MAX-WAL-SENDERS">max_wal_senders</a>を十分大きく設定しなければなりません。
  </p><p>接続が失われた場合、または、致命的ではないエラーで初期確立ができなかった場合、<span class="application">pg_receivewal</span>は無期限に接続を再試行しできるだけ早くストリーミングを再確立します。
この動作を止めるためには<code class="literal">-n</code>パラメータを使用してください。
  </p></div><div class="refsect1" id="id-1.9.4.15.6"><h2>オプション</h2><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-D <em class="replaceable"><code>directory</code></em></code><br /></span><span class="term"><code class="option">--directory=<em class="replaceable"><code>directory</code></em></code></span></dt><dd><p>出力を書き出すディレクトリです。
       </p><p>このパラメータは必須です。
       </p></dd><dt><span class="term"><code class="option">--if-not-exists</code></span></dt><dd><p><code class="option">--create-slot</code>が指定され、指定された名前のスロットが既に存在していた場合に、エラーを発生させません。
       </p></dd><dt><span class="term"><code class="option">-n</code><br /></span><span class="term"><code class="option">--no-loop</code></span></dt><dd><p>接続エラー時に繰り返しません。
代わりにエラーですぐに終了します。
       </p></dd><dt><span class="term"><code class="option">-s <em class="replaceable"><code>interval</code></em></code><br /></span><span class="term"><code class="option">--status-interval=<em class="replaceable"><code>interval</code></em></code></span></dt><dd><p>サーバに状態パケットを返答する間隔を秒単位で指定します。
これによりサーバからより簡単に進行状況を監視することができます。
ゼロという値は状態の定期的な更新を完全に無効にします。
しかしタイムアウトによる切断を防ぐために、サーバから要求された時には更新を送信します。
デフォルト値は１０秒です。
       </p></dd><dt><span class="term"><code class="option">-S <em class="replaceable"><code>slotname</code></em></code><br /></span><span class="term"><code class="option">--slot=<em class="replaceable"><code>slotname</code></em></code></span></dt><dd><p><span class="application">pg_receivewal</span>が既存のレプリケーションスロットを使うようにします(<a class="xref" href="warm-standby.html#STREAMING-REPLICATION-SLOTS" title="26.2.6. レプリケーションスロット">Section 26.2.6</a>を参照してください)。
このオプションが使われると、<span class="application">pg_receivewal</span>はフラッシュ位置をサーバに報告します。
これは、各セグメントがいつディスクに同期されたかを示し、それによりサーバが必要のなくなったセグメントを削除できるようになります。
        </p><p><span class="application">pg_receivewal</span>のレプリケーションクライアントが同期スタンバイとしてサーバ上で構成されている場合、レプリケーションスロットを利用するとフラッシュ位置がサーバに報告されますが、それはWALファイルがクローズされる時のみです。
したがって、その構成ではプライマリ上のトランザクションが長時間待たされることになり、結果的に満足する動作を得られません。
これを正しく動作させるには、追加で<code class="literal">--synchronous</code>オプション（以下を参照）を指定する必要があります。
        </p></dd><dt><span class="term"><code class="option">--synchronous</code></span></dt><dd><p>WALデータを受け取ると即座にディスクにフラッシュします。
またフラッシュした直後に、<code class="literal">--status-interval</code>の値が何であれ、ステータスパケットをサーバに送り返します。
       </p><p><span class="application">pg_receivewal</span>のレプリケーションクライアントが同期スタンバイとしてサーバ上で構成されている場合、フィードバックが遅延なくサーバに送り返されることを確実にするため、このオプションを指定すべきです。
       </p></dd><dt><span class="term"><code class="option">-v</code><br /></span><span class="term"><code class="option">--verbose</code></span></dt><dd><p>冗長モードを有効にします。
       </p></dd><dt><span class="term"><code class="option">-Z <em class="replaceable"><code>level</code></em></code><br /></span><span class="term"><code class="option">--compress=<em class="replaceable"><code>level</code></em></code></span></dt><dd><p>先行書き込みログのgzip圧縮を有効にし、圧縮レベルを指定します（0から9まで、0は圧縮なし、9が最大圧縮）。
すべてのファイル名に、拡張子<code class="filename">.gz</code>が自動的に追加されます。
       </p></dd></dl></div><p>以下のコマンドラインオプションはデータベース接続パラメータを制御します。

    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-d <em class="replaceable"><code>connstr</code></em></code><br /></span><span class="term"><code class="option">--dbname=<em class="replaceable"><code>connstr</code></em></code></span></dt><dd><p>サーバに接続するために使用するパラメータを、接続文字列として指定します。
詳細については<a class="xref" href="libpq-connect.html#LIBPQ-CONNSTRING" title="33.1.1. 接続文字列">Section 33.1.1</a>を参照してください。
       </p><p>このオプションは他のクライアントアプリケーションとの整合性のために<code class="literal">--dbname</code>と呼ばれます。
しかし、<span class="application">pg_receivewal</span>はクラスタ内のどの特定のデータベースにも接続しませんので、接続文字列内のデータベース名は無視されます。
       </p></dd><dt><span class="term"><code class="option">-h <em class="replaceable"><code>host</code></em></code><br /></span><span class="term"><code class="option">--host=<em class="replaceable"><code>host</code></em></code></span></dt><dd><p>サーバが稼働しているマシンのホスト名を指定します。
名前がスラッシュから始まる場合、Unixドメインソケット用のディレクトリとして使用されます。
デフォルトは環境変数<code class="envar">PGHOST</code>が設定されていればその値から取られ、設定されていない場合はUnixドメインソケット接続が試行されます。
       </p></dd><dt><span class="term"><code class="option">-p <em class="replaceable"><code>port</code></em></code><br /></span><span class="term"><code class="option">--port=<em class="replaceable"><code>port</code></em></code></span></dt><dd><p>サーバが接続を待ち受けるTCPポートまたはUnixドメインソケットファイルの拡張子を指定します
デフォルトは環境変数<code class="envar">PGPORT</code>が指定されていればその値から取られ、設定されていない場合はコンパイル時のデフォルト値から取られます。
       </p></dd><dt><span class="term"><code class="option">-U <em class="replaceable"><code>username</code></em></code><br /></span><span class="term"><code class="option">--username=<em class="replaceable"><code>username</code></em></code></span></dt><dd><p>接続するユーザ名です。
       </p></dd><dt><span class="term"><code class="option">-w</code><br /></span><span class="term"><code class="option">--no-password</code></span></dt><dd><p>パスワード入力を促しません。
サーバがパスワード認証を必要とし、かつ、<code class="filename">.pgpass</code>ファイルなど他の手段でパスワードが入手できない場合、接続試行は失敗します。
このオプションは、パスワードを入力するユーザが存在しないバッチジョブやスクリプトで有用になります。
       </p></dd><dt><span class="term"><code class="option">-W</code><br /></span><span class="term"><code class="option">--password</code></span></dt><dd><p><span class="application">pg_receivewal</span>はデータベースに接続する前にパスワード入力を強制的に促します。
       </p><p>このオプションは重要ではありません。
<span class="application">pg_receivewal</span>は、サーバがパスワード認証を要求した場合に自動的にパスワードを促すためです。
しかし<span class="application">pg_receivewal</span>は、サーバがパスワードを要求するかどうかを確認するために接続試行を浪費します。
<code class="option">-W</code>と入力して無駄な接続試行を防止することが有意である場合があります。
       </p></dd></dl></div><p>
   </p><p><span class="application">pg_receivewal</span>は物理的なレプリケーションスロットを制御するため、以下の2つの動作のうちの1つを実行できます。

    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">--create-slot</code></span></dt><dd><p><code class="option">--slot</code>で指定された名前の新しい物理的なレプリケーションスロットを作成して終了します。
       </p></dd><dt><span class="term"><code class="option">--drop-slot</code></span></dt><dd><p><code class="option">--slot</code>で指定された名前の物理的なレプリケーションスロットを削除して終了します。
       </p></dd></dl></div><p>
   </p><p>この他に以下のオプションも使用することができます。

    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-V</code><br /></span><span class="term"><code class="option">--version</code></span></dt><dd><p><span class="application">pg_receivewal</span>のバージョンを表示し、終了します。
       </p></dd><dt><span class="term"><code class="option">-?</code><br /></span><span class="term"><code class="option">--help</code></span></dt><dd><p><span class="application">pg_receivewal</span>コマンドライン引数についてのヘルプを表示し、終了します。
       </p></dd></dl></div><p>
   </p></div><div class="refsect1" id="id-1.9.4.15.7"><h2>環境</h2><p>他のほとんどの<span class="productname">PostgreSQL</span>ユーティリティと同様、このユーティリティは<span class="application">libpq</span>でサポートされる環境変数（<a class="xref" href="libpq-envars.html" title="33.14. 環境変数">Section 33.14</a>参照）を使用します。
  </p></div><div class="refsect1" id="id-1.9.4.15.8"><h2>注釈</h2><p><a class="xref" href="runtime-config-wal.html#GUC-ARCHIVE-COMMAND">archive_command</a>の代わりに<span class="application">pg_receivewal</span>をWALのバックアップのメインの方法として使用する場合、レプリケーションスロットを使用することを強く推奨します。
そうしなければ、サーバは<a class="xref" href="runtime-config-wal.html#GUC-ARCHIVE-COMMAND">archive_command</a>とレプリケーションスロットのいずれからもWALのストリームがどこまでアーカイブされているかの情報を得られないため、先行書き込みログファイルがバックアップされる前にそれを再利用または削除するかもしれないのです。
しかし、WALデータを受け取る側がそのフェッチに追いつけない場合、レプリケーションスロットがサーバのディスクスペースを一杯にしてしまうかもしれないことに注意してください。
  </p></div><div class="refsect1" id="id-1.9.4.15.9"><h2>例</h2><p>先行書き込みログを<code class="literal">mydbserver</code>にあるサーバからストリームし、それをローカルディレクトリ<code class="filename">/usr/local/pgsql/archive</code>に格納します。
</p><pre class="screen"><code class="prompt">$</code> <strong class="userinput"><code>pg_receivewal -h mydbserver -D /usr/local/pgsql/archive</code></strong></pre></div><div class="refsect1" id="id-1.9.4.15.10"><h2>関連項目</h2><span class="simplelist"><a class="xref" href="app-pgbasebackup.html" title="pg_basebackup"><span class="refentrytitle">pg_basebackup</span></a></span></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="app-pg-isready.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="reference-client.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="app-pgrecvlogical.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top"><span class="application">pg_isready</span> </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> <span class="application">pg_recvlogical</span></td></tr></table></div></body></html>