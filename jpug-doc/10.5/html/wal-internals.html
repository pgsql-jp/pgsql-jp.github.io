<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>30.5. WALの内部</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="wal-configuration.html" title="30.4. WALの設定" /><link rel="next" href="logical-replication.html" title="Chapter 31. 論理レプリケーション" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">30.5. WALの内部</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="wal-configuration.html" title="30.4. WALの設定">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="wal.html" title="Chapter 30. 信頼性とログ先行書き込み">Up</a></td><th width="60%" align="center">Chapter 30. 信頼性とログ先行書き込み</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="logical-replication.html" title="Chapter 31. 論理レプリケーション">Next</a></td></tr></table><hr></hr></div><div class="sect1" id="WAL-INTERNALS"><div class="titlepage"><div><div><h2 class="title" style="clear: both">30.5. WALの内部</h2></div></div></div><a id="id-1.6.17.7.2" class="indexterm"></a><p><acronym class="acronym">WAL</acronym>は自動的に有効になります。
<acronym class="acronym">WAL</acronym>ログが必要とするディスク容量を確保すること、そして必要ならばチューニングすることを除いては（<a class="xref" href="wal-configuration.html" title="30.4. WALの設定">Section 30.4</a>を参照）、管理者は何もする必要はありません。
  </p><p>新しいレコードが作成されるごとに、<acronym class="acronym">WAL</acronym>レコードが<acronym class="acronym">WAL</acronym>ログに追加されます。
挿入位置はログシーケンス番号(<acronym class="acronym">LSN</acronym>)によって記録されます。LSNはログのバイトオフセットで、単調増加します。
<acronym class="acronym">LSN</acronym>値は、<a class="link" href="datatype-pg-lsn.html" title="8.19. pg_lsn 型"><code class="type">pg_lsn</code></a>データ型として返されます。
2つの<acronym class="acronym">LSN</acronym>値を比較することで<acronym class="acronym">WAL</acronym>データの差分量を計算することができるので、レプリケーションやリカバリーの進捗状況を測定できます。
  </p><p><acronym class="acronym">WAL</acronym>ログは、データディレクトリ以下の<code class="filename">pg_wal</code>ディレクトリに、通常16メガバイトのサイズを持つセグメントファイルの集合として格納されています(ただし、このサイズはサーバ構築時の<code class="option">--with-wal-segsize</code>というconfigureオプションで変更できます)。各セグメントは通常8キロバイトのページに分割されます(このサイズは<code class="option">--with-wal-blocksize</code>というconfigureオプションで変更できます)。
ログレコード用のヘッダは<code class="filename">access/xlogrecord.h</code>に記述されています。
レコードの内容は、ログの対象となる事象の種類によって異なります。
セグメントファイルは名前として<code class="filename">000000010000000000000000</code>から始まる、常に増加する数が与えられています。
数字は巡回しませんが、利用可能な数字を使い尽くすには非常に長い時間がかかるはずです。
  </p><p>主要なデータベースファイルが置いてあるディスクとは別のディスクにログを置くと利点があります。
これは<code class="filename">pg_wal</code>ディレクトリを別の場所に（もちろんサーバを終了しておいてから）移動し、主データディレクトリ以下の元々の場所から新しい場所へのシンボリックリンクを張ることによって可能となります。
  </p><p><acronym class="acronym">WAL</acronym>の目的である、確実にデータベースレコードが変更される前にログが書き出されることは、実際にはキャッシュにしかデータがなく、ディスクには格納されていない時にディスクドライブ<a id="id-1.6.17.7.7.2" class="indexterm"></a>が格納に成功したとカーネルに虚偽の報告を行うことによって失われる可能性があります。
そのような状況では、電源が落ちた際に、復旧不可能なデータの破壊が起こることがあります。
管理者は、<span class="productname">PostgreSQL</span>の<acronym class="acronym">WAL</acronym>ログを保持しているディスク装置がそのような嘘の報告をしないように保証するべきです。(<a class="xref" href="wal-reliability.html" title="30.1. 信頼性">Section 30.1</a>を参照して下さい。)
  </p><p>チェックポイントが実行され、ログが吐き出された後、チェックポイントの位置は<code class="filename">pg_control</code>に保存されます。
したがって、リカバリの開始の際は、サーバはまず<code class="filename">pg_control</code>を読み、次にチェックポイントレコードを読みます。
そして、チェックポイントレコード内で示されたログの位置から前方をスキャンすることでREDO処理を行います。
データページの内容全体は、チェックポイント後の最初のページ変更時にログ内に保存されますので(<a class="xref" href="runtime-config-wal.html#GUC-FULL-PAGE-WRITES">full_page_writes</a>パラメータが無効にされていないという前提です)、そのチェックポイント以降に変更された全てのページは一貫した状態に復旧されます。
  </p><p><code class="filename">pg_control</code>が壊れた場合に備え、ログセグメントを逆順に読み（すなわち新しいものから古いものへと）、最終チェックポイントを見つける方法を実際には実装した方が良いと思われます。
まだこれはできていません。
<code class="filename">pg_control</code>はかなり小さなもの（1ディスクページ未満）ですので、一部のみ書き込みされるという問題は起こりません。
またこの書き込みの時点では、<code class="filename">pg_control</code>自体の読み込みができないことによるデータベースエラーという報告はありません。
このため、<code class="filename">pg_control</code>は理屈では弱点ですが、実質問題になりません。
  </p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="wal-configuration.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="wal.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="logical-replication.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">30.4. <acronym class="acronym">WAL</acronym>の設定 </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 31. 論理レプリケーション</td></tr></table></div></body></html>