<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>EXPLAIN</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="sql-execute.html" title="EXECUTE" /><link rel="next" href="sql-fetch.html" title="FETCH" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">EXPLAIN</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="sql-execute.html" title="EXECUTE">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="sql-commands.html" title="SQLコマンド">Up</a></td><th width="60%" align="center">SQLコマンド</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="sql-fetch.html" title="FETCH">Next</a></td></tr></table><hr></hr></div><div class="refentry" id="SQL-EXPLAIN"><div class="titlepage"></div><a id="id-1.9.3.142.1" class="indexterm"></a><a id="id-1.9.3.142.2" class="indexterm"></a><a id="id-1.9.3.142.3" class="indexterm"></a><div class="refnamediv"><h2><span class="refentrytitle">EXPLAIN</span></h2><p>EXPLAIN — 問い合わせ文の実行計画を表示する</p></div><div class="refsynopsisdiv"><h2>Synopsis</h2><pre class="synopsis">EXPLAIN [ ( <em class="replaceable"><code>option</code></em> [, ...] ) ] <em class="replaceable"><code>statement</code></em>
EXPLAIN [ ANALYZE ] [ VERBOSE ] <em class="replaceable"><code>statement</code></em>

<span class="phrase">ここで<em class="replaceable"><code>option</code></em>は以下のいずれかを取ることができます。</span>

    ANALYZE [ <em class="replaceable"><code>boolean</code></em> ]
    VERBOSE [ <em class="replaceable"><code>boolean</code></em> ]
    COSTS [ <em class="replaceable"><code>boolean</code></em> ]
    BUFFERS [ <em class="replaceable"><code>boolean</code></em> ]
    TIMING [ <em class="replaceable"><code>boolean</code></em> ]
    SUMMARY [ <em class="replaceable"><code>boolean</code></em> ]
    FORMAT { TEXT | XML | JSON | YAML }</pre></div><div class="refsect1" id="id-1.9.3.142.7"><h2>説明</h2><p>与えられた文に対して、<span class="productname">PostgreSQL</span>プランナが生成する実行計画を表示します。
実行計画は、問い合わせ文が参照するテーブル（複数の場合もある）をスキャンする方法（単純なシーケンシャルスキャン、インデックススキャンなど）、複数のテーブルを参照する場合に、各テーブルから取り出した行を結合するために使用する結合アルゴリズムを示すものです。

  </p><p>表示内容の中でも、最も重要なのは、文の実行にかかるコストの見積もりです。
これは、プランナが文の実行にかかる時間（任意の、しかし慣習的にはディスクページ抽出を意味するコスト単位で計測）を推測したものです。
具体的には、2つの数が表示されます。
1つは最初の行が返されるまでのスタートアップコスト、もう1つはすべての行が返されるまでの合計コストです。
ほとんどの問い合わせにとって問題となるのは合計コストの方ですが、<code class="literal">EXISTS</code>副問い合わせなどのコンテキストでは、プランナは合計コストが最も短くなるプランよりも、スタートアップコストが最も短くなるプランを選びます（エクゼキュータは行を1つ取得した後に停止するからです）。
また、<code class="literal">LIMIT</code>句を使って問い合わせが返す行数を制限する場合、プランナは実際にはどの計画が一番低コストになるかを概算するため、全体を処理した場合のコストの間で適切な補間を行います。
  </p><p><code class="literal">ANALYZE</code>オプションを付けると、計画を作るだけでなく、文が実際に実行されます。
この場合は、各計画ノードで費された総経過時間（ミリ秒単位）と実際に返された全行数など、実際の実行時の統計情報が追加表示されます。
プランナの推測と実際の値が近いかどうかを確認するために、このオプションは有用です。
  </p><div class="important"><h3 class="title">Important</h3><p><code class="literal">ANALYZE</code>を使用した場合は、文が実際に実行されることを忘れないでください。
<code class="command">EXPLAIN</code>は<code class="command">SELECT</code>が返す出力をまったく表示しませんが、文に伴う副作用は通常通り発生します。
<code class="command">INSERT</code>、<code class="command">UPDATE</code>、<code class="command">DELETE</code>、<code class="command">CREATE TABLE AS</code>、<code class="command">EXECUTE</code>文に対して、データに影響を与えないように<code class="command">EXPLAIN ANALYZE</code>を実行したい場合は、以下の方法を使用してください。
</p><pre class="programlisting">BEGIN;
EXPLAIN ANALYZE ...;
ROLLBACK;</pre><p>
   </p></div><p><code class="literal">ANALYZE</code>および<code class="literal">VERBOSE</code>オプションのみが、この順序でのみ、オプションリストを括弧で括ることなく、指定可能です。
<span class="productname">PostgreSQL</span> 9.0より前までは、括弧がない構文のみがサポートされていました。
すべての新しいオプションは括弧付き構文のみでサポートされることを想定しています。
  </p></div><div class="refsect1" id="id-1.9.3.142.8"><h2>パラメータ</h2><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">ANALYZE</code></span></dt><dd><p>コマンドを実行し、実際の実行時間やその他の統計情報を表示します。
このパラメータのデフォルトは<code class="literal">FALSE</code>です。
     </p></dd><dt><span class="term"><code class="literal">VERBOSE</code></span></dt><dd><p>計画についての追加情報を出力します。
具体的には、計画ツリー、スキーマ修飾テーブル、関数名内の各ノードに対して出力列リストを含めます。
常に範囲テーブルの別名を付けて式内の変数を命名し、また常に統計情報が表示される各トリガの名前を出力します。
このパラメータのデフォルトは<code class="literal">FALSE</code>です。
     </p></dd><dt><span class="term"><code class="literal">COSTS</code></span></dt><dd><p>各計画ノードの推定起動コストと総コスト、さらに推定行数と各行の推定幅に関する情報を含めます。
このパラメータのデフォルトは<code class="literal">TRUE</code>です。
     </p></dd><dt><span class="term"><code class="literal">BUFFERS</code></span></dt><dd><p>バッファの使用状況に関する情報を含めます。
具体的には、共有ブロックのヒット数、読み取り数、ダーティブロック数、書き出し数、ローカルブロックのヒット数、ダーティブロック数、読み取り数、書き出し数、一時ブロックの読み取り数、書き出し数が含められます。
<span class="emphasis"><em>ヒット</em></span>とは、必要な時にキャッシュ内にそのブロックが見つかったため読み取りが避けられたことを意味します。
共有ブロックには、通常のテーブルとインデックスからのデータが含まれます。
ローカルブロックには、一時テーブルとそのインデックスからのデータが含まれます。
一時ブロックには、ソートやハッシュ、マテリアライズ計画ノードなどで使用される短期間有効なデータが含まれます。
<span class="emphasis"><em>ダーティ</em></span>ブロック数は、これまでは変更がなかったがその問い合わせによって変更されたブロックの数を示します。
<span class="emphasis"><em>書き出し</em></span>ブロック数は、問い合わせ処理の間にバックエンドにより、ダーティ状態だったブロックの内キャッシュから追い出されたブロックの数を示します。
上位レベルのノードで表示されるブロック数には、その子ノードすべてで使用されるブロックが含まれます。
テキスト形式では、非ゼロの値のみが出力されます。
このパラメータは<code class="literal">ANALYZE</code>パラメータも有効である場合にのみ使用することができます。
デフォルトは<code class="literal">FALSE</code>です。
     </p></dd><dt><span class="term"><code class="literal">TIMING</code></span></dt><dd><p>実際のスタートアップ時間とノードで費やされた時間が追加表示されます。
一部のシステムでは、システムクロックを何度も読み取るオーバーヘッドのため問い合わせがかなり低速になる可能性があります。
このため、実際の時間ではなく実際の行数のみが必要であるのであれば、このパラメータは<code class="literal">FALSE</code>に設定する方が有益でしょう。
文全体の実行時間は、このオプションによってノードレベルの時間計測が無効であった場合であっても、常に計測されます。
このパラメータは<code class="literal">ANALYZE</code>パラメータも有効である場合にのみ使用することができます。
デフォルトは<code class="literal">TRUE</code>です。
     </p></dd><dt><span class="term"><code class="literal">SUMMARY</code></span></dt><dd><p>要約情報（例えば、時間の情報の合計）を問い合わせ計画の後に出力します。
要約情報は<code class="literal">ANALYZE</code>が使われるときはデフォルトで含まれ、それ以外の場合はデフォルトでは含まれませんが、このオプションを使えば有効にできます。
<code class="command">EXPLAIN EXECUTE</code>の計画時間には、計画をキャッシュから取得するのに要する時間、および必要なら再計画するのに要する時間も含まれます。
     </p></dd><dt><span class="term"><code class="literal">FORMAT</code></span></dt><dd><p>出力形式を指定します。
TEXT、XML、JSON、YAMLを指定可能です。
TEXT以外の出力にはTEXT出力と同じ情報が含まれていますが、プログラムによる解析がより容易になります。
このパラメータのデフォルトは<code class="literal">TEXT</code>です。
     </p></dd><dt><span class="term"><em class="replaceable"><code>boolean</code></em></span></dt><dd><p>選択したオプションを有効とするか無効とするかを指定します。
オプションを有効にするためには<code class="literal">TRUE</code>、<code class="literal">ON</code>、<code class="literal">1</code>のいずれかを書きます。
無効にするには<code class="literal">FALSE</code>、<code class="literal">OFF</code>、 <code class="literal">0</code>のいずれかを書きます。
<em class="replaceable"><code>boolean</code></em>値は省略可能です。
省略時は<code class="literal">TRUE</code>とみなされます。
     </p></dd><dt><span class="term"><em class="replaceable"><code>statement</code></em></span></dt><dd><p>実行計画の表示対象となる、<code class="command">SELECT</code>、<code class="command">INSERT</code>、<code class="command">UPDATE</code>、<code class="command">DELETE</code>、<code class="command">VALUES</code>、<code class="command">EXECUTE</code>、<code class="command">DECLARE</code>、<code class="command">CREATE TABLE AS</code>、<code class="command">CREATE MATERIALIZED VIEW AS</code>のいずれかの文です。
     </p></dd></dl></div></div><div class="refsect1" id="id-1.9.3.142.9"><h2>出力</h2><p>コマンドの結果は、<em class="replaceable"><code>statement</code></em>に対して選択された計画をテキストで説明します。
オプションで、実行時の統計情報で注釈が付けられます。
<a class="xref" href="using-explain.html" title="14.1. EXPLAINの利用">Section 14.1</a>では出力される情報について説明します。
   </p></div><div class="refsect1" id="id-1.9.3.142.10"><h2>注釈</h2><p><span class="productname">PostgreSQL</span>問い合わせプランナが十分な情報を使って問合せを最適化できるようにするには、問い合わせ内で使用されるすべてのテーブルに関する<a class="link" href="catalog-pg-statistic.html" title="51.50. pg_statistic"><code class="structname">pg_statistic</code></a>のデータを最新状態にしなければなりません。
通常<a class="link" href="routine-vacuuming.html#AUTOVACUUM" title="24.1.6. 自動バキュームデーモン">自動バキュームデーモン</a>により自動的に処理されます。
しかし最近その内容が大きく変更されたテーブルでは、自動バキュームがその変更に追いつくまで待つのではなく、手作業による<a class="xref" href="sql-analyze.html" title="ANALYZE"><span class="refentrytitle">ANALYZE</span></a>を実行する必要があるかもしれません。
  </p><p>実行計画内の各ノードの実行時コストを測定するために、現在の<code class="command">EXPLAIN ANALYZE</code>実装は、問い合わせ実行に対し、情報収集のためのオーバーヘッドを加えます。
この結果、ある問い合わせについての<code class="command">EXPLAIN ANALYZE</code>実行が、普通に問い合わせを実行した場合より非常に時間がかかることがあります。
このオーバーヘッドの量は問い合わせの性質と使用するプラットフォームに依存します。
実行の間非常に短い時間を必要とする計画ノードに関して、時刻を得るためのシステムコールの操作が相対的に低速なプラットフォーム上で最悪な場合が発生します。
  </p></div><div class="refsect1" id="id-1.9.3.142.11"><h2>例</h2><p><code class="type">integer</code>列を1つ持ち、10000行が存在するテーブルに対して、単純な問い合わせを行った場合の問い合わせ計画を表示します。

</p><pre class="programlisting">EXPLAIN SELECT * FROM foo;

                       QUERY PLAN
---------------------------------------------------------
 Seq Scan on foo  (cost=0.00..155.00 rows=10000 width=4)
(1 row)</pre><p>
  </p><p>以下は同じ問い合わせをJSON出力形式で出力したものです。
</p><pre class="programlisting">EXPLAIN (FORMAT JSON) SELECT * FROM foo;
           QUERY PLAN
--------------------------------
 [                             +
   {                           +
     "Plan": {                 +
       "Node Type": "Seq Scan",+
       "Relation Name": "foo", +
       "Alias": "foo",         +
       "Startup Cost": 0.00,   +
       "Total Cost": 155.00,   +
       "Plan Rows": 10000,     +
       "Plan Width": 4         +
     }                         +
   }                           +
 ]
(1 row)</pre><p>
  </p><p>インデックスが存在し、問い合わせの<code class="literal">WHERE</code>条件でインデックスを利用できる場合、<code class="command">EXPLAIN</code>は異なる計画を表示する可能性があります。

</p><pre class="programlisting">EXPLAIN SELECT * FROM foo WHERE i = 4;

                         QUERY PLAN
--------------------------------------------------------------
 Index Scan using fi on foo  (cost=0.00..5.98 rows=1 width=4)
   Index Cond: (i = 4)
(2 rows)</pre><p>
  </p><p>以下は同じ問い合わせをYAML形式で表したものです。
</p><pre class="programlisting">EXPLAIN (FORMAT YAML) SELECT * FROM foo WHERE i='4';
          QUERY PLAN
-------------------------------
 - Plan:                      +
     Node Type: "Index Scan"  +
     Scan Direction: "Forward"+
     Index Name: "fi"         +
     Relation Name: "foo"     +
     Alias: "foo"             +
     Startup Cost: 0.00       +
     Total Cost: 5.98         +
     Plan Rows: 1             +
     Plan Width: 4            +
     Index Cond: "(i = 4)"    
(1 row)</pre><p>

読者への演習としてXML形式については記載しません。
  </p><p>以下は同じ計画ですが、コスト推定値を出力しません。

</p><pre class="programlisting">EXPLAIN (COSTS FALSE) SELECT * FROM foo WHERE i = 4;

        QUERY PLAN
----------------------------
 Index Scan using fi on foo
   Index Cond: (i = 4)
(2 rows)</pre><p>
  </p><p>次に、集約関数を使用した問い合わせに対する問い合わせ計画の例を示します。

</p><pre class="programlisting">EXPLAIN SELECT sum(i) FROM foo WHERE i &lt; 10;

                             QUERY PLAN
---------------------------------------------------------------------
 Aggregate  (cost=23.93..23.93 rows=1 width=4)
   -&gt;  Index Scan using fi on foo  (cost=0.00..23.92 rows=6 width=4)
         Index Cond: (i &lt; 10)
(3 rows)</pre><p>
  </p><p>以下は、<code class="command">EXPLAIN EXECUTE</code>によってプリペアド文に対する実行計画を表示する例です。

</p><pre class="programlisting">PREPARE query(int, int) AS SELECT sum(bar) FROM test
    WHERE id &gt; $1 AND id &lt; $2
    GROUP BY foo;

EXPLAIN ANALYZE EXECUTE query(100, 200);

                                                       QUERY PLAN                                                       
------------------------------------------------------------------------------------------------------------------------
 HashAggregate  (cost=9.54..9.54 rows=1 width=8) (actual time=0.156..0.161 rows=11 loops=1)
   Group Key: foo
   -&gt;  Index Scan using test_pkey on test  (cost=0.29..9.29 rows=50 width=8) (actual time=0.039..0.091 rows=99 loops=1)
         Index Cond: ((id &gt; $1) AND (id &lt; $2))
 Planning time: 0.197 ms
 Execution time: 0.225 ms
(6 rows)</pre><p>
  </p><p>もちろん、ここで示した具体的な数値は対象とするテーブルの実際の中身によって変わります。
また、この数値や選択された問い合わせ戦略は、プランナの改良のため、<span class="productname">PostgreSQL</span>のリリース間で異なる可能性がありますので注意してください。
さらに、<code class="command">ANALYZE</code>コマンドは、データの統計情報を推定する際にランダムなサンプリングを行うため、実際のテーブル内の分布が変わっていなくても、新たに<code class="command">ANALYZE</code>を実行すると推定コストが変わることがあります。
  </p></div><div class="refsect1" id="id-1.9.3.142.12"><h2>互換性</h2><p>標準SQLでは<code class="command">EXPLAIN</code>文は定義されていません。
  </p></div><div class="refsect1" id="id-1.9.3.142.13"><h2>関連項目</h2><span class="simplelist"><a class="xref" href="sql-analyze.html" title="ANALYZE"><span class="refentrytitle">ANALYZE</span></a></span></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="sql-execute.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="sql-commands.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="sql-fetch.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">EXECUTE </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> FETCH</td></tr></table></div></body></html>