<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>LOCK</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="sql-load.html" title="LOAD" /><link rel="next" href="sql-move.html" title="MOVE" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">LOCK</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="sql-load.html" title="LOAD">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="sql-commands.html" title="SQLコマンド">Up</a></td><th width="60%" align="center">SQLコマンド</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="sql-move.html" title="MOVE">Next</a></td></tr></table><hr></hr></div><div class="refentry" id="SQL-LOCK"><div class="titlepage"></div><a id="id-1.9.3.149.1" class="indexterm"></a><div class="refnamediv"><h2><span class="refentrytitle">LOCK</span></h2><p>LOCK — テーブルをロックする</p></div><div class="refsynopsisdiv"><h2>Synopsis</h2><pre class="synopsis">LOCK [ TABLE ] [ ONLY ] <em class="replaceable"><code>name</code></em> [ * ] [, ...] [ IN <em class="replaceable"><code>lockmode</code></em> MODE ] [ NOWAIT ]

<span class="phrase">ここで<em class="replaceable"><code>lockmode</code></em>には以下のいずれかが入ります。</span>

    ACCESS SHARE | ROW SHARE | ROW EXCLUSIVE | SHARE UPDATE EXCLUSIVE
    | SHARE | SHARE ROW EXCLUSIVE | EXCLUSIVE | ACCESS EXCLUSIVE</pre></div><div class="refsect1" id="id-1.9.3.149.5"><h2>説明</h2><p><code class="command">LOCK TABLE</code>はテーブルレベルのロックを取得します。必要であれば競合するロックが解除されるまで待機します。
<code class="literal">NOWAIT</code>が指定された場合は、対象のロックを取得できるまで待機せず、すぐにロックが取得できなければ、このコマンドを中止し、エラーを出力します。
ロックは、一度取得されると現行のトランザクションが完了するまで保持されます
（<code class="command">UNLOCK TABLE</code>といったコマンドはありません。
ロックが解除されるのは常にトランザクションの終了時です）。
  </p><p>テーブルを参照するコマンドのために自動的にロックを取得する場合、<span class="productname">PostgreSQL</span>は使用可能な一番弱いロックモードを常に使用します。
<code class="command">LOCK TABLE</code>はより制限の強いロックが必要な場合のために用意されています。
例えば、隔離レベル<code class="literal">READ COMMITTED</code>でトランザクションを実行するアプリケーションで、トランザクションの間中、テーブルのデータを確実に安定させる必要がある場合を考えます。
この場合、問い合わせ実行前にテーブル全体に<code class="literal">SHARE</code>ロックモードを使用します。
これにより、データが同時に変更されるのを防ぎ、それ以降のテーブルの読み取りは、コミット済みの安定したデータが見えるようになります。
なぜなら<code class="literal">SHARE</code>ロックモードは書き込み側が取得する<code class="literal">ROW EXCLUSIVE</code>ロックと競合するので、<code class="command">LOCK TABLE <em class="replaceable"><code>name</code></em> IN SHARE MODE</code>文は、<code class="literal">ROW EXCLUSIVE</code>を保持しているトランザクションがコミットまたはロールバックされるのを待つからです。
したがって、一度ロックを取得してしまえば、コミットされていない状態の書き込みは存在しないことになります。さらに、ロックを解除するまで他のアプリケーションは書き込みを開始することができません。

  </p><p><code class="literal">REPEATABLE READ</code>または<code class="literal">SERIALIZABLE</code>隔離レベルで実行しているトランザクションで同様の効果を得るには、全ての<code class="command">SELECT</code>文とデータを更新する文を実行する前に<code class="command">LOCK TABLE</code>文を実行する必要があります。
<code class="literal">REPEATABLE READ</code>または<code class="literal">SERIALIZABLE</code>トランザクション側から参照するデータの状態は、最初に<code class="command">SELECT</code>文またはデータ更新用文が開始された時点で固定されます。
後からトランザクション内で<code class="command">LOCK TABLE</code>を実行した場合も同時書き込みを防ぐことはできますが、トランザクションの読み込み対象データの値がコミットされた最新の値であることは保証されません。
  </p><p>このようなトランザクションでテーブルのデータを変更する場合は、<code class="literal">SHARE</code>モードではなく<code class="literal">SHARE ROW EXCLUSIVE</code>ロックモードを使用する必要があります。
これによって、この種のトランザクションが同時に複数実行されることがなくなります。
<code class="literal">SHARE ROW EXCLUSIVE</code>を使用しないと、デッドロックが発生する可能性があります。
2つのトランザクションの両方が、<code class="literal">SHARE</code>モードを取得していながら、実際の更新に必要な<code class="literal">ROW EXCLUSIVE</code>モードを取得できない状態になる可能性があるためです
（トランザクション自身が所有しているロック間は競合しないので、トランザクションは<code class="literal">SHARE</code>モードを保持している間も<code class="literal">ROW EXCLUSIVE</code>を獲得することができます。
しかし、他のトランザクションが<code class="literal">SHARE</code>モードを保持している時には<code class="literal">ROW EXCLUSIVE</code>を獲得することはできません）。
デッドロックを回避するには、全てのトランザクションが、必ず同一オブジェクトに対して同一の順番でロックを取得するようにしてください。
また、1つのオブジェクトに対して複数のロックモードを呼び出す場合、トランザクションは常に最も制限の強いモードを最初に取得するべきです。
  </p><p>ロックモードとロック取得方針についてのより詳細については<a class="xref" href="explicit-locking.html" title="13.3. 明示的ロック">Section 13.3</a>を参照してください。
  </p></div><div class="refsect1" id="id-1.9.3.149.6"><h2>パラメータ</h2><div class="variablelist"><dl class="variablelist"><dt><span class="term"><em class="replaceable"><code>name</code></em></span></dt><dd><p>ロックする既存のテーブルの名前です（スキーマ修飾名も可）。
テーブル名の前に<code class="literal">ONLY</code>が指定された場合、そのテーブルのみをロックします。
<code class="literal">ONLY</code>が指定されない場合、そのテーブルとすべての子テーブル（もしあれば）をロックします。
オプションで、テーブル名の後に<code class="literal">*</code>を指定することで、明示的に継承するテーブルも含まれることを示すことができます。
     </p><p><code class="literal">LOCK a, b;</code>というコマンドは<code class="literal">LOCK TABLE a; LOCK TABLE b;</code>と同じです。
テーブルは1つひとつ<code class="command">LOCK</code>で指定された順番でロックされます。
     </p></dd><dt><span class="term"><em class="replaceable"><code>lockmode</code></em></span></dt><dd><p>ロックモードには、取得するロックと競合するロックを指定します。
ロックモードについては、<a class="xref" href="explicit-locking.html" title="13.3. 明示的ロック">Section 13.3</a>で説明します。
     </p><p>ロックモードを指定しない場合、最も制限が強い<code class="literal">ACCESS EXCLUSIVE</code>が使用されます。
     </p></dd><dt><span class="term"><code class="literal">NOWAIT</code></span></dt><dd><p><code class="command">LOCK TABLE</code>が競合するロックの解放まで待機しないことを指定します。
指定したロックがすぐに取得できない場合、トランザクションはアボートされます。
     </p></dd></dl></div></div><div class="refsect1" id="id-1.9.3.149.7"><h2>注釈</h2><p><code class="literal">LOCK TABLE ... IN ACCESS SHARE MODE</code>には、対象テーブルの<code class="literal">SELECT</code>権限が必要です。
<code class="literal">LOCK TABLE ... IN ROW EXCLUSIVE MODE</code>には、対象テーブルの<code class="literal">INSERT</code>、<code class="literal">UPDATE</code>、<code class="literal">DELETE</code>または<code class="literal">TRUNCATE</code>権限が必要です。
他の形式の<code class="command">LOCK</code>には、テーブルレベルの<code class="literal">UPDATE</code>、<code class="literal">DELETE</code>あるいは<code class="literal">TRUNCATE</code>権限を持たなければなりません。
   </p><p><code class="command">LOCK TABLE</code>はトランザクションブロックの外側では意味がありません。
文が完了するまでしかロックは保持されません。
したがって<span class="productname">PostgreSQL</span>は<code class="command">LOCK</code>がトランザクションブロックの外側で使用された場合にエラーを報告します。
トランザクションブロックを定義するためには<a class="xref" href="sql-begin.html" title="BEGIN"><span class="refentrytitle">BEGIN</span></a>および<a class="xref" href="sql-commit.html" title="COMMIT"><span class="refentrytitle">COMMIT</span></a>（または<a class="xref" href="sql-rollback.html" title="ROLLBACK"><span class="refentrytitle">ROLLBACK</span></a>）を使用してください。
   </p><p><code class="command">LOCK</code>が扱うのはテーブルレベルのロックのみです。
そのため、モード名に<code class="literal">ROW</code>が含まれるのは適切ではありません。
これらのモード名は、普通は、ロックされたテーブル内で行レベルのロックを取得する意図と解釈されるでしょう。
また、<code class="literal">ROW EXCLUSIVE</code>モードは共有可能なテーブルロックです。
<code class="command">LOCK TABLE</code>に関しては、全てのロックモードが同じ意味を持っており、違うのは、どのモードがどのモードと競合するかという規則だけであることに注意して下さい。
行レベルでのロックを獲得する方法については<code class="command">SELECT</code>参照マニュアルの<a class="xref" href="explicit-locking.html#LOCKING-ROWS" title="13.3.2. 行レベルロック">Section 13.3.2</a>と<a class="xref" href="sql-select.html#SQL-FOR-UPDATE-SHARE" title="ロック処理句">ロック処理句</a>を参照してください。
  </p></div><div class="refsect1" id="id-1.9.3.149.8"><h2>例</h2><p>外部キーテーブルへの挿入を行う際に、主キーテーブルへの<code class="literal">SHARE</code>ロックを獲得します。

</p><pre class="programlisting">BEGIN WORK;
LOCK TABLE films IN SHARE MODE;
SELECT id FROM films
    WHERE name = 'Star Wars: Episode I - The Phantom Menace';
-- レコードがなければROLLBACKしてください。
INSERT INTO films_user_comments VALUES
    (_id_, 'GREAT! I was waiting for it for so long!');
COMMIT WORK;</pre><p>
  </p><p>削除操作を行う際に主キーテーブルの<code class="literal">SHARE ROW EXCLUSIVE</code>ロックを取得します。

</p><pre class="programlisting">BEGIN WORK;
LOCK TABLE films IN SHARE ROW EXCLUSIVE MODE;
DELETE FROM films_user_comments WHERE id IN
    (SELECT id FROM films WHERE rating &lt; 5);
DELETE FROM films WHERE rating &lt; 5;
COMMIT WORK;</pre></div><div class="refsect1" id="id-1.9.3.149.9"><h2>互換性</h2><p>標準SQLには<code class="command">LOCK TABLE</code>はありません。
その代わりにトランザクションの同時性レベルを指定する<code class="command">SET TRANSACTION</code>が使用されます。
<span class="productname">PostgreSQL</span>はこのコマンドもサポートしています。
詳細は<a class="xref" href="sql-set-transaction.html" title="SET TRANSACTION"><span class="refentrytitle">SET TRANSACTION</span></a>を参照してください。
  </p><p><code class="literal">ACCESS SHARE</code>、<code class="literal">ACCESS EXCLUSIVE</code>、<code class="literal">SHARE UPDATE EXCLUSIVE</code>ロックモードを除き、<span class="productname">PostgreSQL</span>のロックモードと<code class="command">LOCK TABLE</code>構文は<span class="productname">Oracle</span>のものと互換性があります。
  </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="sql-load.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="sql-commands.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="sql-move.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">LOAD </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> MOVE</td></tr></table></div></body></html>