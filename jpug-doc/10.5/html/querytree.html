<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>40.1. 問い合わせツリーとは</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="rules.html" title="Chapter 40. ルールシステム" /><link rel="next" href="rules-views.html" title="40.2. ビューとルールシステム" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">40.1. 問い合わせツリーとは</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="rules.html" title="Chapter 40. ルールシステム">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="rules.html" title="Chapter 40. ルールシステム">Up</a></td><th width="60%" align="center">Chapter 40. ルールシステム</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="rules-views.html" title="40.2. ビューとルールシステム">Next</a></td></tr></table><hr></hr></div><div class="sect1" id="QUERYTREE"><div class="titlepage"><div><div><h2 class="title" style="clear: both">40.1. 問い合わせツリーとは</h2></div></div></div><a id="id-1.8.6.6.2" class="indexterm"></a><p>どのようにルールシステムが機能するかを理解するためには、ルールがどのように起動され、その入力と結果は何かを理解しなければなりません。</p><p>ルールシステムは問い合わせパーサとプランナの中間に位置します。
ルールシステムは、入力としてパーサの出力、単一の問い合わせツリー、および何らかの特別な情報を持つ問い合わせツリーでもあるユーザ定義の書き換えルールを取り、結果として0個以上の問い合わせツリーを生成します。
ルールシステムの入力と出力は常にパーサ自体でも生成することができるもので、参照する対象は基本的に<acronym class="acronym">SQL</acronym>文として表現できるものです。</p><p>では問い合わせツリーとは何でしょうか。
それは、<acronym class="acronym">SQL</acronym>文を構成する個々の部品を別々に記憶した、<acronym class="acronym">SQL</acronym>文の内部表現です。
<code class="varname">debug_print_parse</code>、<code class="varname">debug_print_rewritten</code>、もしくは<code class="varname">debug_print_plan</code>設定パラメータを設定していれば、サーバログ内で問い合わせツリーを見ることができます。
ルールアクションも<code class="structname">pg_rewrite</code>システムカタログ内に問い合わせツリーとして格納されています。
これはログ出力のように整形されていませんが、まったく同じ情報を持っています。</p><p>問い合わせツリーそのものを読むためにはある程度の経験が必要です。
ルールシステムを理解するためには問い合わせツリーの<acronym class="acronym">SQL</acronym>表現で十分ですので、ここではその読み方までは教えません。</p><p>本章の問い合わせツリーの<acronym class="acronym">SQL</acronym>表現形式を読む時に必要なのは、問い合わせツリー構造の中に分解された、ある文の部品を識別できることです。
問い合わせツリーには以下の部品があります。

</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">コマンド種類
    </span></dt><dd><p>これはどのコマンド（<code class="command">SELECT</code>、<code class="command">INSERT</code>、<code class="command">UPDATE</code>、<code class="command">DELETE</code>）が構文解析ツリーを作ったかを示す単純な値です。
    </p></dd><dt><span class="term">範囲テーブル
      <a id="id-1.8.6.6.7.2.2.1.1" class="indexterm"></a>
    </span></dt><dd><p>範囲テーブルは問い合わせで使われるリレーションのリストです。
<code class="command">SELECT</code>文ではこれは<code class="literal">FROM</code>キーワードの後で与えられるリレーションになります。
    </p><p>範囲テーブルのそれぞれの項目はテーブルもしくはビューを識別し、問い合わせの別の部品ではどんな名前で呼び出されるかを示します。
問い合わせツリーでは範囲テーブルの項目は名前よりも番号で参照されることが多いため、ここでは<acronym class="acronym">SQL</acronym>文とは違い、重複する名前があるかということは問題になりません。
これはルールの範囲テーブルがマージされた後に起こる可能性があります。
本章の例ではその状況を含んでいません。
    </p></dd><dt><span class="term">結果リレーション
    </span></dt><dd><p>問い合わせの結果が格納されるリレーションを識別する範囲テーブルへのインデックスです。
    </p><p><code class="command">SELECT</code>問い合わせは結果リレーションを持ちません。
（<code class="command">SELECT INTO</code>の場合は特別ですが、<code class="literal">INSERT ... SELECT</code>が付いた<code class="command">CREATE TABLE</code>とほぼ同じですので、ここでは個別には説明しません。）
    </p><p><code class="command">INSERT</code>、<code class="command">UPDATE</code>、<code class="command">DELETE</code>コマンドでは、結果リレーションは変更が有効になるテーブル（もしくはビュー）です。
    </p></dd><dt><span class="term">目的リスト
    <a id="id-1.8.6.6.7.2.4.1.1" class="indexterm"></a>
    </span></dt><dd><p>目的リストは問い合わせの結果を定義する式のリストです。
<code class="command">SELECT</code>の場合、この式は問い合わせの最終結果を構築するものです。
これらは<code class="command">SELECT</code>と<code class="command">FROM</code>キーワードの間にある式に対応します
（<code class="literal">*</code>は単にリレーションの全ての列名の省略です。
これはパーサによって個別の列に展開されますので、ルールシステムが見ることはありません）。
    </p><p><code class="command">DELETE</code>コマンドは結果を返しませんので、通常の目的リストは必要ありません。
その代わり、プランナは空の目的リストに特別な<acronym class="acronym">CTID</acronym>項目を追加し、エクゼキュータが削除すべき行を見つけられるようにします。
（<acronym class="acronym">CTID</acronym>は結果リレーションが通常のテーブルの場合に追加されます。
もしビューであれば<a class="xref" href="rules-views.html#RULES-VIEWS-UPDATE" title="40.2.4. ビューの更新について">Section 40.2.4</a>で述べるように、代わりに行全体の変数がルールシステムによって追加されます。）
    </p><p><code class="command">INSERT</code>問い合わせでは、目的リストは結果リレーションへ入る新規の行を示します。
これは<code class="literal">VALUES</code>句か<code class="literal">INSERT ... SELECT</code>の中の<code class="command">SELECT</code>句の式です。
書き換え処理の最初のステップでは、元の問い合わせでは割り当てられず、デフォルト値となっている列の目的リストの項目を追加します。
残った列（値が与えられていない列、かつデフォルト値を持たない列）は全て、プランナによって定数NULL式で埋められます。
    </p><p><code class="command">UPDATE</code>コマンドでは、目的リストは古いものを置き換えるべき新しい行を示します。
ルールシステムではコマンド内の<code class="literal">SET column = expression</code>部分にある式だけを持っています。
プランナは、古い行から新しい行へ値をコピーする式を挿入することにより、抜けている列を処理します。
<code class="command">DELETE</code>の場合と同様、エクゼキュータが更新すべき行を見つけられるように、<acronym class="acronym">CTID</acronym>もしくは行全体の変数が追加されます。
    </p><p>目的リストの各項目は、定数値、範囲テーブル内のリレーション中の1つの列を指し示す変数、パラメータ等の式を保持するか、または、関数呼び出し、定数、変数、演算子などにより作られた式のツリーを保持します。
    </p></dd><dt><span class="term">条件
    </span></dt><dd><p>問い合わせの条件は目的リストの項目に含まれている式によく似た式です。
この式の結果は、最終的な結果の行を得るための（<code class="command">INSERT</code>、<code class="command">UPDATE</code>、<code class="command">DELETE</code>または<code class="command">SELECT</code>）演算を実行すべきかどうかを示すブール値です。
それは<acronym class="acronym">SQL</acronym>文の中の<code class="literal">WHERE</code>句に対応します。
    </p></dd><dt><span class="term">結合ツリー
    </span></dt><dd><p>問い合わせの結合ツリーは<code class="literal">FROM</code>句の構造を表します。
<code class="literal">SELECT ... FROM a, b, c</code>のような単純な問い合わせでは、結合ツリーは単なる<code class="literal">FROM</code>項目のリストです。
なぜならこれらはどんな順番で結合しても構わないためです。
しかし<code class="literal">JOIN</code>式、特に外部結合が使われた場合は、その結合が示す順番通りに結合しなければいけません。
この場合結合ツリーは<code class="literal">JOIN</code>式の構造を表します。
特定の<code class="literal">JOIN</code>句と関連付けられた制約（<code class="literal">ON</code>もしくは<code class="literal">USING</code>式からのもの）はこれらの結合ツリーノードに付加された条件として格納されます。
頂点レベルの<code class="literal">WHERE</code>式を頂点レベルの結合ツリー項目に付加された条件として格納することも便利です。
ですから、結合ツリーは<code class="command">SELECT</code>の<code class="literal">FROM</code>句と<code class="literal">WHERE</code>句の両方を表しているわけです。
    </p></dd><dt><span class="term">その他
    </span></dt><dd><p><code class="literal">ORDER BY</code>句のような、問い合わせツリーのその他の部品は、ここでは取り上げません。
ルールシステムはルールを適用している時にそこで項目を入れ替えることもありますが、これはルールシステムの基本とはあまり関係しません。
    </p></dd></dl></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="rules.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="rules.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="rules-views.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter 40. ルールシステム </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 40.2. ビューとルールシステム</td></tr></table></div></body></html>