<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>44.8. PL/Perlの内部</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="plperl-event-triggers.html" title="44.7. PL/Perlイベントトリガ" /><link rel="next" href="plpython.html" title="Chapter 45. PL/Python - Python手続き言語" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">44.8. PL/Perlの内部</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="plperl-event-triggers.html" title="44.7. PL/Perlイベントトリガ">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="plperl.html" title="Chapter 44. PL/Perl - Perl手続き言語">Up</a></td><th width="60%" align="center">Chapter 44. PL/Perl - Perl手続き言語</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="plpython.html" title="Chapter 45. PL/Python - Python手続き言語">Next</a></td></tr></table><hr></hr></div><div class="sect1" id="PLPERL-UNDER-THE-HOOD"><div class="titlepage"><div><div><h2 class="title" style="clear: both">44.8. PL/Perlの内部</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="plperl-under-the-hood.html#PLPERL-CONFIG">44.8.1. 設定</a></span></dt><dt><span class="sect2"><a href="plperl-under-the-hood.html#PLPERL-MISSING">44.8.2. 制限および存在しない機能</a></span></dt></dl></div><div class="sect2" id="PLPERL-CONFIG"><div class="titlepage"><div><div><h3 class="title">44.8.1. 設定</h3></div></div></div><p>本節では<span class="application">PL/Perl</span>に影響する設定パラメータを列挙します。
  </p><div class="variablelist"><dl class="variablelist"><dt id="GUC-PLPERL-ON-INIT"><span class="term">       <code class="varname">plperl.on_init</code> (<code class="type">string</code>)
      <a id="id-1.8.10.16.2.3.1.1.3" class="indexterm"></a>
      </span></dt><dd><p>Perlインタプリタが最初に初期化され、<code class="literal">plperl</code>または<code class="literal">plperlu</code>での使用のための準備がなされる前に実行されるperlコードを指定します。
このコードが実行される時にはSPI関数を利用できません。
このコードがエラーで失敗した場合、インタプリタの初期化は中断され、呼び出し元の問い合わせに伝わり、現在のトランザクションまたはサブトランザクションがアボートすることになります。
       </p><p>このPerlコードは単一文字列に制限されます。
長いコードをモジュール化し、<code class="literal">on_init</code>文字列でロードすることができます。
以下に例を示します。
</p><pre class="programlisting">plperl.on_init = 'require "plperlinit.pl"'
plperl.on_init = 'use lib "/my/app"; use MyApp::PgInit;'</pre><p>
       </p><p><code class="literal">plperl.on_init</code>により直接または間接的に読み込まれるモジュールはすべて、<code class="literal">plperl</code>により使用可能になります。
これはセキュリティの危険性が発生する可能性があります。
どんなモジュールが読み込まれたかを確認するためには以下を使用します。
</p><pre class="programlisting">DO 'elog(WARNING, join ", ", sort keys %INC)' LANGUAGE plperl;</pre><p>
       </p><p><code class="literal">plperl</code>ライブラリが<a class="xref" href="runtime-config-client.html#GUC-SHARED-PRELOAD-LIBRARIES">shared_preload_libraries</a>に含まれている場合、初期化はpostmaster内部で起こります。
この場合、postmasterが不安定になる危険が出てくるため、一層の考慮が必要です。
この機能を使用できるようにした大きな理由は、<code class="literal">plperl.on_init</code>でロードされるPerlモジュールはpostmaster起動時点のみでロードされなければならないためです。
このため個々のデータベースセッション内にロードというオーバーヘッドをもたらすことなく即座に利用できるようになります。
しかし、データベースセッションで最初に使用されるPerlインタプリタ（PL/PerlUまたはPL/Perl関数を呼び出す最初のSQLロール用のPL/Perl）に対してのみ、このオーバーヘッドを防ぐことができる点に注意してください。
データベースセッション内でその後に作成されるPerlインタプリタはすべて、新たに<code class="literal">plperl.on_init</code>を実行する必要があります。
また、postmasterプロセス内で作成されるPerlインタプリタは子プロセスに伝播されませんので、Windowsにおける事前ロードには何かを節約することはまったくありません。
       </p><p>このパラメータは<code class="filename">postgresql.conf</code>ファイルまたはサーバのコマンドラインでのみ設定可能です。
       </p></dd><dt id="GUC-PLPERL-ON-PLPERL-INIT"><span class="term">       <code class="varname">plperl.on_plperl_init</code> (<code class="type">string</code>)
       <a id="id-1.8.10.16.2.3.2.1.3" class="indexterm"></a>
      <br /></span><span class="term">       <code class="varname">plperl.on_plperlu_init</code> (<code class="type">string</code>)
       <a id="id-1.8.10.16.2.3.2.2.3" class="indexterm"></a>
      </span></dt><dd><p>これらのパラメータはそれぞれ、<code class="literal">plperl</code>または<code class="literal">plperlu</code>用にPerlインタプリタを特化する時に実行されるPerlコードを指定します。
これは、データベースセッション内でPL/PerlまたはPL/PerlU関数が最初に実行される時、または、他の言語が呼び出されたため、あるいは新しいSQLロールでPL/Perl関数が呼び出されたために追加のインタプリタを呼び出す必要があった時に起こります。
この後に<code class="literal">plperl.on_init</code>による初期化が行われます。
このコードを実行する時にはSPI関数は利用できません。
<code class="literal">plperl.on_plperl_init</code>内のPerlコードはインタプリタを<span class="quote">“<span class="quote">権限で制限した</span>”</span>後に実行されます。
このためPerlコードは信頼できる操作のみを行うことができます。
       </p><p>コードがエラーで失敗した場合、初期化は中断され、呼び出し元にエラーが伝わります。
その結果現在のトランザクションまたはサブトランザクションはアボートします。
Perl内ですでに行われた処理は取り消されません。
言語が再度使用される時、初期化は新しいインタプリタの中で再度試行されます。
       </p><p>スーパーユーザのみがこれらの設定を変更することができます。
これらの設定はセッション内で変更することができますが、このような変更は関数を実行するためにすでに使用されたPerlインタプリタには影響を与えません。
       </p></dd><dt id="GUC-PLPERL-USE-STRICT"><span class="term">       <code class="varname">plperl.use_strict</code> (<code class="type">boolean</code>)
       <a id="id-1.8.10.16.2.3.3.1.3" class="indexterm"></a>
      </span></dt><dd><p>真の場合、その後のPL/Perl関数のコンパイルは<code class="literal">strict</code>プラグマが有効になります。
このパラメータは現在のセッションでコンパイル済みの関数には影響しません。
       </p></dd></dl></div></div><div class="sect2" id="PLPERL-MISSING"><div class="titlepage"><div><div><h3 class="title">44.8.2. 制限および存在しない機能</h3></div></div></div><p>現時点では、以下の機能はPL/Perlにありません。
各機能の寄稿を歓迎します。

   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>PL/Perl関数は互いに直接呼び出すことができません。
     </p></li><li class="listitem"><p>SPIはまだ完全に実装されていません。
     </p></li><li class="listitem"><p><code class="literal">spi_exec_query</code>を使用して、非常に大規模なデータセットを取り出そうとする場合、これらがすべてメモリ内に保存されることに注意しなければなりません。
上で示した通り、<code class="literal">spi_query</code>/<code class="literal">spi_fetchrow</code>を使用することで、これを避けることができます。
     </p><p>集合を返す関数が大規模な行セットを<code class="literal">return</code>を介してPostgreSQLに返す場合、同様の問題が起こります。
前述の通り、この問題も<code class="literal">return_next</code>を使用して行毎に返すことで避けることができます。
     </p></li><li class="listitem"><p>セッションが正常に終了した時、致命的なエラーによるものでなければ、定義された任意の<code class="literal">END</code>ブロックが実行されます。
現在、その他の動作は行われません。
特にファイルハンドルは自動的に吐き出されません。
またオブジェクトも自動的に破棄されません。
      </p></li></ul></div><p>
  </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="plperl-event-triggers.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="plperl.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="plpython.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">44.7. PL/Perlイベントトリガ </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 45. PL/Python - Python手続き言語</td></tr></table></div></body></html>