<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>30.3. 非同期コミット</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="wal-intro.html" title="30.2. ログ先行書き込み(WAL)" /><link rel="next" href="wal-configuration.html" title="30.4. WALの設定" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">30.3. 非同期コミット</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="wal-intro.html" title="30.2. ログ先行書き込み(WAL)">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="wal.html" title="Chapter 30. 信頼性とログ先行書き込み">Up</a></td><th width="60%" align="center">Chapter 30. 信頼性とログ先行書き込み</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="wal-configuration.html" title="30.4. WALの設定">Next</a></td></tr></table><hr></hr></div><div class="sect1" id="WAL-ASYNC-COMMIT"><div class="titlepage"><div><div><h2 class="title" style="clear: both">30.3. 非同期コミット</h2></div></div></div><a id="id-1.6.17.5.2" class="indexterm"></a><a id="id-1.6.17.5.3" class="indexterm"></a><p><em class="firstterm">非同期コミット</em>とは、トランザクションをより高速に完了することができるオプションです。
もっとも最近のトランザクションがデータベースがクラッシュしてしまった場合に失われるという危険があります。
これは、多くのアプリケーションで受け入れられるトレードオフです。
  </p><p>前節で説明した通り、通常トランザクションのコミットは<em class="firstterm">同期的</em>です。
サーバはトランザクションの<acronym class="acronym">WAL</acronym>レコードが永続的格納領域に記録されるまで、クライアントに成功したことを通知することを待機します。
従って、直後にサーバクラッシュといった障害があったとしても、コミットされたと報告されたトランザクションは保持されることをクライアントは保証されます。
しかし、短期のトランザクションでは、この遅延はトランザクションの処理時間の大半を占める要素となります。
非同期コミットモードを選択することは、サーバが<acronym class="acronym">WAL</acronym>記録が実際に作成された通りにディスクに書き込まれるより前に、トランザクションの論理的な完了をもって成功したと通知することを意味します。
これにより、小規模なトランザクションでスループットがかなり向上します。
  </p><p>非同期コミットにはデータ損失の危険があります。
トランザクションの完了をクライアントに通知してからトランザクションが本当に完了する（つまり、サーバクラッシュしても損失がないことが保証される）までの間にわずかな時間が存在します。
したがって、クライアントがトランザクションが記録されているという仮定を元に外部的な動作を行う場合は、非同期コミットを使用すべきではありません。
例えば、銀行では、ATMの現金分配を記録するトランザクションで非同期コミットを使用してはいけません。
しかし、イベント記録など多くのシナリオでは、この種の保証を持って格納する必要はありません。
  </p><p>非同期コミットによりもたらされる危険性は、データの破壊ではなくデータの損失です。
データベースがクラッシュした場合、最後にフラッシュされた記録まで<acronym class="acronym">WAL</acronym>を再生することで復旧が行われます。
このため、データベースは内部で一貫性を持った状態に復旧されますが、ディスクにフラッシュされていないトランザクションはすべてそこには反映されません。
したがって、影響を受けるのは、最後に行われたいくつかのトランザクションの損失です。
トランザクションはコミットされた順に再生されますので、一貫性が失われることはありません。
例えば、トランザクションBが以前に行われたトランザクションAの結果に依存した変更を行った場合、Bの影響が保存されている限り、Aの影響が失われることは起こり得ません。
  </p><p>ユーザは各トランザクションでコミットモードを選択することができます。
このため、同時実行されるトランザクションを同期的、および非同期の両方でコミットさせることができます。
これにより、性能とトランザクションの信頼性の確実性との間で柔軟な選択を行うことができます。
コミットモードはユーザによる設定が可能なパラメータ<a class="xref" href="runtime-config-wal.html#GUC-SYNCHRONOUS-COMMIT">synchronous_commit</a>で制御されます。
このパラメータは、設定パラメータを設定することができる全ての方法で変更することが可能です。
あるひとつのトランザクションで使用されるモードは、トランザクションのコミットが始まった時の<code class="varname">synchronous_commit</code>の値に依存します。
  </p><p>例えば<code class="command">DROP TABLE</code>などの特定のユーティリティコマンドでは、<code class="varname">synchronous_commit</code>の設定に関わらず、強制的に同期的コミットが行われます。
これにより、サーバのファイルシステムとデータベースの論理的な状態との間の一貫性が保証されます。
<code class="command">PREPARE TRANSACTION</code>などの2相コミットをサポートするコマンドもまた、常に同期的です。
  </p><p>もし非同期コミットとそのトランザクションの<acronym class="acronym">WAL</acronym>記録の書き込みの間の危険期間にデータベースがクラッシュしたとすると、そのトランザクションでなされた変更は失われる<span class="emphasis"><em>でしょう</em></span>。
バックグラウンドプロセス（<span class="quote">“<span class="quote">WALライタ</span>”</span>）が未書き込みの<acronym class="acronym">WAL</acronym>記録を<a class="xref" href="runtime-config-wal.html#GUC-WAL-WRITER-DELAY">wal_writer_delay</a>ミリ秒毎にディスクに吐き出しますので、この危険期間は制限されます。
WALライタは稼働中に一回ページ全体を書き込むように設計されているため、危険期間の実際の最大の長さは<code class="varname">wal_writer_delay</code>の３倍です。
  </p><div class="caution"><h3 class="title">Caution</h3><p>即時モードのシャットダウンはサーバクラッシュと同じことですので、吐き出されていない非同期コミットが失われることになります。
   </p></div><p>非同期コミットでは<a class="xref" href="runtime-config-wal.html#GUC-FSYNC">fsync</a> = offという設定とは異なる動作になります。
<code class="varname">fsync</code>はサーバ全体に関する設定であり、すべてのトランザクションの動作を変更します。
これは、<span class="productname">PostgreSQL</span>における、データベースの別の場所への同期書き込みの試行に関するすべてのロジックを無効にします。
このため、システムクラッシュ（<span class="productname">PostgreSQL</span>自体の失敗ではなくハードウェアやオペレーティングシステムのクラッシュ）の結果、予測できないデータベース状態の破壊が起こります。
非同期コミットはデータ破壊の危険性はなく、多くの状況では<code class="varname">fsync</code>を無効にした場合に得られる性能向上とほぼ同等の性能を提供します。
  </p><p>また<a class="xref" href="runtime-config-wal.html#GUC-COMMIT-DELAY">commit_delay</a>も非同期コミットと類似のように見えますが、これは実のところ同期コミットの一方法です。
（実際、非同期コミット時<code class="varname">commit_delay</code>は無視されます。）
トランザクションが<acronym class="acronym">WAL</acronym>をディスクに吐き出す直前に、こうしたトランザクションによって実行される一度の吐き出しにより、ほぼ同時期にコミットを行う他のトランザクションの分も処理できるようにすることを目的とした遅延が<code class="varname">commit_delay</code>により発生します。
この設定は、一回のフラッシュに参画するグループに、複数のトランザクションの中でフラッシュのコストを償却し、加わることが可能なトランザクションの時間的猶予を広げる方法の一つとして考えることができます。
  </p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="wal-intro.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="wal.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="wal-configuration.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">30.2. ログ先行書き込み(<acronym class="acronym">WAL</acronym>) </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 30.4. <acronym class="acronym">WAL</acronym>の設定</td></tr></table></div></body></html>