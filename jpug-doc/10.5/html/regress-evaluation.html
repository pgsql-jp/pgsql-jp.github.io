<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>32.2. テストの評価</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="regress-run.html" title="32.1. テストの実行" /><link rel="next" href="regress-variant.html" title="32.3. 各種の比較用ファイル" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">32.2. テストの評価</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="regress-run.html" title="32.1. テストの実行">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="regress.html" title="Chapter 32. リグレッションテスト">Up</a></td><th width="60%" align="center">Chapter 32. リグレッションテスト</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="regress-variant.html" title="32.3. 各種の比較用ファイル">Next</a></td></tr></table><hr></hr></div><div class="sect1" id="REGRESS-EVALUATION"><div class="titlepage"><div><div><h2 class="title" style="clear: both">32.2. テストの評価</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="regress-evaluation.html#id-1.6.19.6.6">32.2.1. エラーメッセージの違い</a></span></dt><dt><span class="sect2"><a href="regress-evaluation.html#id-1.6.19.6.7">32.2.2. ロケールの違い</a></span></dt><dt><span class="sect2"><a href="regress-evaluation.html#id-1.6.19.6.8">32.2.3. 日付と時刻の違い</a></span></dt><dt><span class="sect2"><a href="regress-evaluation.html#id-1.6.19.6.9">32.2.4. 浮動小数点数の違い</a></span></dt><dt><span class="sect2"><a href="regress-evaluation.html#id-1.6.19.6.10">32.2.5. 行の順序の違い</a></span></dt><dt><span class="sect2"><a href="regress-evaluation.html#id-1.6.19.6.11">32.2.6. スタック長の不足</a></span></dt><dt><span class="sect2"><a href="regress-evaluation.html#id-1.6.19.6.12">32.2.7. <span class="quote">“<span class="quote">乱数</span>”</span> テスト</a></span></dt><dt><span class="sect2"><a href="regress-evaluation.html#id-1.6.19.6.13">32.2.8. 設定パラメータ</a></span></dt></dl></div><p>適正にインストールされ、かつ、すべての機能が使用できるような<span class="productname">PostgreSQL</span>インストレーションであっても、浮動小数点の表現やメッセージ内の単語順など、プラットフォーム特有の誤差のために<span class="quote">“<span class="quote">失敗</span>”</span>することがあります。
現在のテストは単純に、（基準となる）参照用システムで生成した出力との<code class="command">diff</code>を取ることで結果の検証を行っているため、システムの些細な違いにも反応します。
結果が<span class="quote">“<span class="quote">失敗</span>”</span>となった場合は、予測された結果と実際の結果との差分を必ず評価してください。
それらの差異が重大ではないことが判明することもあります。
なお、すべてのテストが成功するように、サポートするすべてのプラットフォームに対する正確な参照ファイルの保守に努めています。
   </p><p>実際のリグレッションテストの出力は、<code class="filename">src/test/regress/results</code>ディレクトリ内のファイルに書き込まれます。
テストスクリプトは<code class="command">diff</code>を使用して、各出力ファイルと<code class="filename">src/test/regress/expected</code>ディレクトリ内の参照用出力とを比較します。
あらゆる差異は調査用に<code class="filename">src/test/regress/regression.diffs</code>に保存されます。
（コアテスト以外のテストスイートを実行する場合には、上記のファイルはもちろん<code class="filename">src/test/regress</code>ではなく適切なサブディレクトリに現れます。）
   </p><p>デフォルトで利用されている<code class="command">diff</code>オプションが気に入らなければ、例えば<code class="literal">PG_REGRESS_DIFF_OPTS='-u'</code>のように、環境変数<code class="envar">PG_REGRESS_DIFF_OPTS</code>を設定して下さい。
（あるいは、自分で<code class="command">diff</code>を実行することもできます。）
   </p><p>何らかの理由で、特定のプラットフォームが指定した試験で<span class="quote">“<span class="quote">失敗</span>”</span>し、その出力の調査により結果の方が有効であると確信できた場合、新しい比較用ファイルを追加し、今後の試験で失敗の報告が発生しないようにすることができます。
詳細は<a class="xref" href="regress-variant.html" title="32.3. 各種の比較用ファイル">Section 32.3</a>を参照してください。
   </p><div class="sect2" id="id-1.6.19.6.6"><div class="titlepage"><div><div><h3 class="title">32.2.1. エラーメッセージの違い</h3></div></div></div><p>リグレッションテストのいくつかは、意図的に無効な入力値を使用します。
エラーメッセージは<span class="productname">PostgreSQL</span>のコードによるもの、または使用しているプラットフォームの関数によるものがあります。
後者の場合、プラットフォームによって違いがあるかもしれませんが、似たような内容になるはずです。
これらのメッセージの違いによりリグレッションテストは<span class="quote">“<span class="quote">失敗</span>”</span>する可能性がありますが、これらは検査で確認できます。
    </p></div><div class="sect2" id="id-1.6.19.6.7"><div class="titlepage"><div><div><h3 class="title">32.2.2. ロケールの違い</h3></div></div></div><p>Cロケール以外の照合順序のロケールで初期化されたサーバに対してテストを実行する際には、ソート順やその後に発生する失敗に違いが生じる可能性があります。
リグレッションテストスイートはこの問題を解決するために、多くのロケールを処理するための代替の結果ファイルを提供するように設定されています。
    </p><p>一時的なインストレーションを使用して、異なるロケールのテストを実行するためには、以下の例のように、<code class="command">make</code>コマンドラインに適切なロケール関連の環境変数を渡してください。
</p><pre class="programlisting">make check LANG=de_DE.utf8</pre><p>
（リグレッションテストのドライバは<code class="envar">LC_ALL</code>を設定しないため、この変数を使ってロケールを選択することはできません。）
ロケール無しを使用するためには、すべてのロケール関連の環境変数を設定しない（または、それらを<code class="literal">C</code>に設定する）か、もしくは以下の特殊な起動を行います。
</p><pre class="programlisting">make check NO_LOCALE=1</pre><p>
既存のインストレーションに対してテストを実行する場合は、ロケール設定は既存のインストレーションによって決まります。
変更するためには、<code class="command">initdb</code>に適切なオプションを渡して、異なるロケールでデータベースクラスタを初期化してください。
    </p><p>実際に実運用で使用されるロケールおよび符号化方式に関連した部分のコードが検証されますので、一般的には、実運用で使用されるロケール設定でリグレッションテストを実行することを推奨します。
オペレーティングシステム環境に依存して、結果が失敗する場合もありますが、少なくとも実際のアプリケーションを実行する時に想定されるロケール固有の動作を知ることができます。
    </p></div><div class="sect2" id="id-1.6.19.6.8"><div class="titlepage"><div><div><h3 class="title">32.2.3. 日付と時刻の違い</h3></div></div></div><p>日付と時刻の結果のほとんどはタイムゾーンの環境に依存します。
参照ファイルはタイムゾーン <code class="literal">PST8PDT</code> (Berkeley, California) 用に生成されているため、このタイムゾーン設定で実行されていないテストは明らかに失敗します。
リグレッションテストのドライバは、適切な結果を保証するために、環境変数<code class="envar">PGTZ</code>に<code class="literal">PST8PDT</code>を設定します。
    </p></div><div class="sect2" id="id-1.6.19.6.9"><div class="titlepage"><div><div><h3 class="title">32.2.4. 浮動小数点数の違い</h3></div></div></div><p>いくつかのテストでは、64ビット（<code class="type">double precision</code>型）の浮動小数点数値をテーブルの列から取り出して計算を行います。
<code class="type">double precision</code>列における数学演算関数では、異なった結果が発生する場合があることが知られています。
<code class="literal">float8</code>と<code class="literal">geometry</code>テストは特に、プラットフォーム間、またはコンパイラの最適化の設定による小さな違いが起こりやすくなります。
これらの違い、通常は小数点以下10桁目以降の相違の、実際の影響度を判断するためには、人間の目で実際に確認する必要があります。
    </p><p>いくつかのシステムではマイナス0を<code class="literal">-0</code>と表示することがあり、その他のシステムでは単に<code class="literal">0</code>と表示します。
    </p><p>いくつかのシステムでは、現在の<span class="productname">PostgreSQL</span>のコードが想定しているメカニズムと異なるために、<code class="function">pow()</code>と<code class="function">exp()</code>でエラーを発生する場合があります。
    </p></div><div class="sect2" id="id-1.6.19.6.10"><div class="titlepage"><div><div><h3 class="title">32.2.5. 行の順序の違い</h3></div></div></div><p>同じ行の出力が、参照ファイルで記述されている順序とは異なっている場合があります。
ほとんどの場合、これは厳密に言ってバグではありません。
ほとんどのリグレッションテストは、各<code class="literal">SELECT</code>文に対して<code class="literal">ORDER BY</code>を使用するほど規則に厳しくなく、そのため、結果の行の順序はSQLの仕様に従って、明確に決まっていません。
実際には、同じソフトウェアで同じデータを用いて同じ問い合わせで参照しているので、すべてのプラットフォームで同じ順序の結果が返されるため、<code class="literal">ORDER BY</code>がないことは問題ではないと言えます。
しかし、問い合わせによっては、プラットフォーム間の順序の違いが起こる可能性があります。
インストール済みのサーバに対して試験を行う場合、C以外のロケール、独自の<code class="varname">work_mem</code>や独自のプランナ用のコストパラメータなどデフォルト以外のパラメータ設定により順序の違いが生じる可能性があります。
    </p><p>したがって、順序の違いを見つけた場合、問い合わせに<code class="literal">ORDER BY</code>が含まれていて順序が影響を及ぼす場合以外は、気にする必要はありません。
ただし、その場合にもとにかくご一報ください。特定の問い合わせから偽の<span class="quote">“<span class="quote">失敗</span>”</span>を取り除くために、将来のリリースにおいて、<code class="literal">ORDER BY</code>を追加します。
    </p><p>このような問題を避けるために、なぜ我々がすべてのリグレッションテストに対して明示的に順序を指定しないのか、疑問に思うかもしれません。
その理由は、ソートが必要がない場合であってもソートされた結果を生成する問い合わせ計画を実行しようとすることによって、リグレッションテストの意義が増すわけではなく、むしろ減るからです。
    </p></div><div class="sect2" id="id-1.6.19.6.11"><div class="titlepage"><div><div><h3 class="title">32.2.6. スタック長の不足</h3></div></div></div><p><code class="literal">errors</code>テストが<code class="literal">select infinite_recurse()</code>コマンドでサーバをクラッシュさせた場合、プラットフォームのプロセススタックサイズが<a class="xref" href="runtime-config-resource.html#GUC-MAX-STACK-DEPTH">max_stack_depth</a>パラメータが示す値よりも小さいことを意味します。
これは、スタックサイズ制限を高くして（デフォルトの<code class="varname">max_stack_depth</code>での推奨値は4メガバイト）サーバを実行することで修正することができます。
これを行うことができない場合、<code class="varname">max_stack_depth</code>の値を少なくすることが代替方法です。
    </p><p><code class="function">getrlimit()</code>をサポートするプラットフォームでは、サーバは自動的に<code class="varname">max_stack_depth</code>の安全な値を選ぶべきです。
この設定を手で上書きしたのでない限り、この種の失敗は報告する価値のあるバグです。
    </p></div><div class="sect2" id="id-1.6.19.6.12"><div class="titlepage"><div><div><h3 class="title">32.2.7. <span class="quote">“<span class="quote">乱数</span>”</span> テスト</h3></div></div></div><p><code class="literal">random</code>テストスクリプトは、無作為な結果を生成することを目的としています。
非常に稀ですが、これがリグレッションテストが失敗する原因になることがあります。
次のように、
</p><pre class="programlisting">diff results/random.out expected/random.out</pre><p>
と入力すると、ほんの数行だけの差異が生じるはずです。
繰り返し失敗しない限り、気に留める必要はありません。
    </p></div><div class="sect2" id="id-1.6.19.6.13"><div class="titlepage"><div><div><h3 class="title">32.2.8. 設定パラメータ</h3></div></div></div><p>既存のインストレーションに対してテストを実行する場合、デフォルトでないパラメータ設定はテストが失敗する原因になり得ます。
例えば、<code class="varname">enable_seqscan</code>や<code class="varname">enable_indexscan</code>のようなパラメータの変更は、<code class="command">EXPLAIN</code>を使うテストの結果に影響する計画の変更の原因となり得ます。
    </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="regress-run.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="regress.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="regress-variant.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">32.1. テストの実行 </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 32.3. 各種の比較用ファイル</td></tr></table></div></body></html>