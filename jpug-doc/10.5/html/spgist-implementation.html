<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>63.4. 実装</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="spgist-extensibility.html" title="63.3. 拡張性" /><link rel="next" href="spgist-examples.html" title="63.5. 例" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">63.4. 実装</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="spgist-extensibility.html" title="63.3. 拡張性">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="spgist.html" title="Chapter 63. SP-GiSTインデックス">Up</a></td><th width="60%" align="center">Chapter 63. SP-GiSTインデックス</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="spgist-examples.html" title="63.5. 例">Next</a></td></tr></table><hr></hr></div><div class="sect1" id="SPGIST-IMPLEMENTATION"><div class="titlepage"><div><div><h2 class="title" style="clear: both">63.4. 実装</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="spgist-implementation.html#SPGIST-LIMITS">63.4.1. SP-GiSTの制限</a></span></dt><dt><span class="sect2"><a href="spgist-implementation.html#SPGIST-NULL-LABELS">63.4.2. ノードラベルのないSP-GiST</a></span></dt><dt><span class="sect2"><a href="spgist-implementation.html#SPGIST-ALL-THE-SAME">63.4.3. <span class="quote">“<span class="quote">All-the-same</span>”</span>内部タプル</a></span></dt></dl></div><p>この節では、<acronym class="acronym">SP-GiST</acronym>の演算子クラスを実装する人にとって知っていると役に立つ、実装についての詳細とその他の秘訣について説明します。
  </p><div class="sect2" id="SPGIST-LIMITS"><div class="titlepage"><div><div><h3 class="title">63.4.1. SP-GiSTの制限</h3></div></div></div><p>それぞれのリーフタプルおよび内部タプルは1つのインデックスページ内(デフォルトで8kB)に収まらなければなりません。
従って、可変長のデータ型の値をインデックス付けするときは、長い値は基数木のようなメソッドによってのみサポートされます。つまり、ツリーのそれぞれのレベルではページに収まる短さの接頭辞を含み、最後のリーフレベルでは、やはりページに収まる短さの接尾辞を含む、というようなものです。
このようなことが発生する場合の対応の準備ができている場合のみ、演算子クラスは<code class="structfield">longValuesOK</code>をTRUEにセットするべきです。
そうでなければ、<acronym class="acronym">SP-GiST</acronym>のコアは、インデックスページに収めるには大きすぎる値についてのインデックス付け要求を拒絶します。
  </p><p>同様に、内部タプルが大きくなりすぎてインデックスページに収まらない、ということにならないようにするのは、演算子クラスの責任です。
これにより、1つの内部タプルで使うことができる子ノードの数、および接頭辞の値の最大サイズが制限されます。
  </p><p>内部タプルのノードがリーフタプルの集合を指しているとき、それらのタプルはすべて同じインデックスページ内になければならない、という制限もあります。
(これは、シークの回数を減らし、そのようなタプルを一つにつなげるリンクに必要なスペースを減らす、という設計上の決定によるものです。)
リーフタプルの集合が大きくなって1ページに収まらなくなると、分割が実行され、中間の内部タプルが挿入されます。
これで問題を解決するためには、新しい内部タプルは、リーフの値の集合を2つ以上のノードのグループに分割し<span class="emphasis"><em>なければなりません</em></span>。
演算子クラスの<code class="function">picksplit</code>関数がそれをするのに失敗したときは、<acronym class="acronym">SP-GiST</acronym>のコアは、<a class="xref" href="spgist-implementation.html#SPGIST-ALL-THE-SAME" title="63.4.3. “All-the-same”内部タプル">Section 63.4.3</a>に記述されている特別な手段に頼ることになります。
  </p></div><div class="sect2" id="SPGIST-NULL-LABELS"><div class="titlepage"><div><div><h3 class="title">63.4.2. ノードラベルのないSP-GiST</h3></div></div></div><p>木構造のアルゴリズムには、それぞれの内部タプルに対して固定された集合のノードを使うものがあります。
例えば四分木では、内部タプルの中心点の周りの4つの象限に対応するちょうど4つのノードが必ずあります。
このような場合、コードは典型的には数字を使ったノードで動作し、明示的なノードラベルは必要ありません。
ノードラベルを使わない(そしてそれによりいくらかのスペースを節約する)ために、<code class="function">picksplit</code>関数は<code class="structfield">nodeLabels</code>配列としてNULLを返すことができ、同様に<code class="function">choose</code>関数は<code class="literal">spgSplitTuple</code>アクションの間<code class="structfield">prefixNodeLabels</code>配列としてNULLを返すことができます。
この結果、その後の<code class="function">choose</code>関数および<code class="function">inner_consistent</code>関数の呼び出しにおいても<code class="structfield">nodeLabels</code>はNULLになります。
原則として、ノードラベルは同じインデックス中の一部の内部タプルに使い、他の内部タプルには省略する、ということができます。
  </p><p>ラベルのないノードを持つ内部タプルを処理するときに、<code class="function">choose</code>が<code class="literal">spgAddNode</code>を返すのはエラーです。というのは、この場合、ノードの集合は固定されていると想定されるからです。
  </p></div><div class="sect2" id="SPGIST-ALL-THE-SAME"><div class="titlepage"><div><div><h3 class="title">63.4.3. <span class="quote">“<span class="quote">All-the-same</span>”</span>内部タプル</h3></div></div></div><p><code class="function">picksplit</code>が入力のリーフ値を少なくとも2つのノード分類に分割できなかった場合、<acronym class="acronym">SP-GiST</acronym>のコアは演算子クラスの<code class="function">picksplit</code>関数の結果を無効にすることがあります。
これが起きると、複数のノードを持つ新しい内部タプルが作成されます。それぞれのノードは、<code class="function">picksplit</code>が一つのノードに付与したもの(あれば)と同じラベルを持ち、リーフ値はこれらの等価なノード間でランダムに分割されます。
内部タプルには<code class="literal">allTheSame</code>のフラグがセットされ、<code class="function">choose</code>関数および<code class="function">inner_consistent</code>関数に対し、そのタプルが通常期待されるようなノードの集合を持っていないことを警告します。
  </p><p><code class="literal">allTheSame</code>の処理において、<code class="function">choose</code>の<code class="literal">spgMatchNode</code>という結果は、新しい値は等価なノードのどれに割り当てられても良い、という意味に解釈されます。
コアのコードは入力された<code class="structfield">nodeN</code>の値を無視し、(ツリーの平衡を保つために)ノードの1つにランダムに降りていきます。
<code class="function">choose</code>が<code class="literal">spgAddNode</code>を返すのはエラーです。というのは、そうするとすべてのノードが等価ではなくなるからです。
挿入する値が既存のノードとマッチしない時は、<code class="literal">spgSplitTuple</code>のアクションを使わなければなりません。
  </p><p><code class="literal">allTheSame</code>のタプルの処理において、すべてのノードは等価なので、<code class="function">inner_consistent</code>関数は、インデックス検索を続けるためのターゲットとして、すべてのノードを返すか、ノードを1つも返さないかのいずれかであるべきです。
このために、特殊ケースを扱うコードが必要になるかもしれませんし、必要ないかもしれません。それは、<code class="function">inner_consistent</code>関数が、通常、ノードの意味についてどの程度のことを仮定しているかに依存します。
  </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="spgist-extensibility.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="spgist.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="spgist-examples.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">63.3. 拡張性 </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 63.5. 例</td></tr></table></div></body></html>