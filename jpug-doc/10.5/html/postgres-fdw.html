<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>F.34. postgres_fdw</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="pgvisibility.html" title="F.33. pg_visibility" /><link rel="next" href="seg.html" title="F.35. seg" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">F.34. postgres_fdw</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="pgvisibility.html" title="F.33. pg_visibility">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="contrib.html" title="Appendix F. 追加で提供されるモジュール">Up</a></td><th width="60%" align="center">Appendix F. 追加で提供されるモジュール</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="seg.html" title="F.35. seg">Next</a></td></tr></table><hr></hr></div><div class="sect1" id="POSTGRES-FDW"><div class="titlepage"><div><div><h2 class="title" style="clear: both">F.34. postgres_fdw</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="postgres-fdw.html#id-1.11.7.43.10">F.34.1. postgres_fdwの外部データラッパオプション</a></span></dt><dt><span class="sect2"><a href="postgres-fdw.html#id-1.11.7.43.11">F.34.2. 接続管理</a></span></dt><dt><span class="sect2"><a href="postgres-fdw.html#id-1.11.7.43.12">F.34.3. トランザクション管理</a></span></dt><dt><span class="sect2"><a href="postgres-fdw.html#id-1.11.7.43.13">F.34.4. リモート問い合わせの最適化</a></span></dt><dt><span class="sect2"><a href="postgres-fdw.html#id-1.11.7.43.14">F.34.5. リモート問い合わせ実行環境</a></span></dt><dt><span class="sect2"><a href="postgres-fdw.html#id-1.11.7.43.15">F.34.6. バージョン間互換性</a></span></dt><dt><span class="sect2"><a href="postgres-fdw.html#id-1.11.7.43.16">F.34.7. 例</a></span></dt><dt><span class="sect2"><a href="postgres-fdw.html#id-1.11.7.43.17">F.34.8. 作者</a></span></dt></dl></div><a id="id-1.11.7.43.2" class="indexterm"></a><p><code class="filename">postgres_fdw</code>モジュールは、外部の<span class="productname">PostgreSQL</span>サーバに格納されたデータをアクセスするために使用する、<code class="literal">postgres_fdw</code>外部データラッパを提供します。
 </p><p>実質上、本モジュールの提供する機能は以前の<a class="xref" href="dblink.html" title="F.11. dblink">dblink</a>モジュールが提供する機能と重複していますが、<code class="filename">postgres_fdw</code>はリモートのテーブルにアクセスするためにより透過的で標準に準拠した構文を利用できるほか、多くの場合においてより良い性能を得る事ができます。
 </p><p><code class="filename">postgres_fdw</code>を使用したリモートアクセスを準備するには:
  </p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p><a class="xref" href="sql-createextension.html" title="CREATE EXTENSION"><span class="refentrytitle">CREATE EXTENSION</span></a>を使用して<code class="filename">postgres_fdw</code>拡張をインストールします。
    </p></li><li class="listitem"><p><a class="xref" href="sql-createserver.html" title="CREATE SERVER"><span class="refentrytitle">CREATE SERVER</span></a>を使用して、接続しようとする各リモートデータベースを定義する外部サーバオブジェクトを作成します。
<code class="literal">user</code>および<code class="literal">password</code>を除く接続パラメータを、外部サーバオブジェクトのオプションとして指定します。
    </p></li><li class="listitem"><p><a class="xref" href="sql-createusermapping.html" title="CREATE USER MAPPING"><span class="refentrytitle">CREATE USER MAPPING</span></a>を使用して、外部サーバへのアクセスを許可するデータベースユーザごとにユーザマッピングを作成します。
ユーザマッピングの<code class="literal">user</code>および<code class="literal">password</code>オプションを使用してリモートユーザのためのユーザ名とパスワードを指定します。
    </p></li><li class="listitem"><p><a class="xref" href="sql-createforeigntable.html" title="CREATE FOREIGN TABLE"><span class="refentrytitle">CREATE FOREIGN TABLE</span></a>もしくは<a class="xref" href="sql-importforeignschema.html" title="IMPORT FOREIGN SCHEMA"><span class="refentrytitle">IMPORT FOREIGN SCHEMA</span></a>を使用して、アクセスしたいリモートテーブルごとに外部テーブルを作成します。
外部テーブルのカラム定義は被参照側のリモートテーブルに一致していなければなりません。
しかしながら、外部テーブルのオプションとして正しいリモートの名前を外部テーブルのオプションに指定すれば、テーブルおよびカラム名はリモートのものと異なった名前を付ける事ができます。
    </p></li></ol></div><p>
 </p><p>今のところ、リモートテーブルに格納されているデータにアクセスするには少なくとも外部テーブルに対する<code class="command">SELECT</code>権限が必要です。
また、<code class="command">INSERT</code>や<code class="command">UPDATE</code>、<code class="command">DELETE</code>を使用してリモートテーブルを操作する事もできます。
（もちろん、ユーザマッピングで指定されたリモートユーザは、これらの操作を実行する権限を有している必要があります）
 </p><p><code class="filename">postgres_fdw</code>は今のところ、<code class="literal">ON CONFLICT DO UPDATE</code>句のある<code class="command">INSERT</code>文をサポートしていないことに注意して下さい。
しかし、一意インデックスの推定の指定を省略しているならば、<code class="literal">ON CONFLICT DO NOTHING</code>句はサポートされます。
 </p><p>一般的な推奨事項として、可能であれば外部テーブルのカラムを、被参照側のリモートテーブル側のカラムと全く同一のデータ型および照合順序によって定義してください。
<code class="filename">postgres_fdw</code>は必要に応じてデータ型の変換を行いますが、リモートサーバがローカルサーバとは少々違った<code class="literal">WHERE</code>句の解釈を行うため、データ型や照合順序が一致していないと、時には予期しない結果を得る事があるかもしれません。
 </p><p>リモートテーブルより少ないカラム数で、あるいは異なった順序であっても外部テーブルを定義できる事に留意してください。
リモートテーブル側のカラムとの対応付けは、その位置ではなく、名前によって行われます。
 </p><div class="sect2" id="id-1.11.7.43.10"><div class="titlepage"><div><div><h3 class="title">F.34.1. postgres_fdwの外部データラッパオプション</h3></div></div></div><div class="sect3" id="id-1.11.7.43.10.2"><div class="titlepage"><div><div><h4 class="title">F.34.1.1. 接続オプション</h4></div></div></div><p><code class="filename">postgres_fdw</code>外部データラッパを使用する外部サーバは、以下に記すものを除き、<a class="xref" href="libpq-connect.html#LIBPQ-PARAMKEYWORDS" title="33.1.2. パラメータキーワード">Section 33.1.2</a>に記載されている<span class="application">libpq</span>が接続文字列としてサポートするものと同一のオプションを使用する事ができます。

    </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">user</code>および<code class="literal">password</code>（これらは代わりにユーザマッピングのオプションの中で指定します）
      </p></li><li class="listitem"><p><code class="literal">client_encoding</code>（これはローカルサーバのエンコーディングが自動的にセットされます）
      </p></li><li class="listitem"><p><code class="literal">fallback_application_name</code>（自動的に<code class="literal">postgres_fdw</code>とセットされます）
      </p></li></ul></div><p>
   </p><p>特権ユーザのみが外部サーバに対してパスワードなしの認証で接続できます。
したがって、非特権ユーザのユーザマッピングには<code class="literal">password</code>を必ず指定するようにして下さい。
   </p></div><div class="sect3" id="id-1.11.7.43.10.3"><div class="titlepage"><div><div><h4 class="title">F.34.1.2. オブジェクト名オプション</h4></div></div></div><p>これらのオプションによりリモートの<span class="productname">PostgreSQL</span>サーバに送出されるSQL文で使用される名前を制御する事ができます。
外部テーブルがリモートテーブルとは異なった名前で定義されている場合、これらのオプションは必須です。
   </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">schema_name</code></span></dt><dd><p>外部テーブルに対して指定できるこのオプションは、リモートサーバ上のリモートテーブルのスキーマ名を与えます。
省略された場合、外部テーブルのスキーマ名が使用されます。
      </p></dd><dt><span class="term"><code class="literal">table_name</code></span></dt><dd><p>外部テーブルに対して指定できるこのオプションは、リモートサーバ上のリモートテーブル名を与えます。
省略された場合、外部テーブルのテーブル名が使用されます。
      </p></dd><dt><span class="term"><code class="literal">column_name</code></span></dt><dd><p>外部テーブルのカラムに対して指定できるこのオプションは、リモートサーバ上のカラム名を与えます。
省略された場合、外部テーブルのカラム名が使用されます。
      </p></dd></dl></div></div><div class="sect3" id="id-1.11.7.43.10.4"><div class="titlepage"><div><div><h4 class="title">F.34.1.3. コスト推定オプション</h4></div></div></div><p><code class="filename">postgres_fdw</code>はリモートサーバに対するクエリを実行しリモートのデータを受信します。したがって、理想的には外部テーブルをスキャンする推定コストは、それをリモートサーバで実行するコストと通信オーバーヘッドの和となります。
この推定を行うための最も信頼できる方法は、リモートサーバに問い合わせを行い、その結果にオーバーヘッド分を加算する事ですが、小さいクエリではコスト推定を得るための追加的な問い合わせに要するコストに見合わないかもしれません。
そこで、どのようにコスト推定を行うかを制御するため、<code class="filename">postgres_fdw</code>は以下のようなオプションを提供します。
   </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">use_remote_estimate</code></span></dt><dd><p>外部テーブルまたは外部サーバに指定できるこのオプションは、コスト推定を得るために<code class="filename">postgres_fdw</code>がリモートの<code class="command">EXPLAIN</code>コマンドを発行するかどうかを制御します。
外部テーブルに対する設定は、関連付けられた外部サーバに対する設定を上書きしますが、その効果は当該外部テーブルに限定されます。
デフォルト値は<code class="literal">false</code>です。
      </p></dd><dt><span class="term"><code class="literal">fdw_startup_cost</code></span></dt><dd><p>外部テーブルまたは外部サーバに指定できるこのオプションは、当該外部サーバに関連付けられた全ての外部テーブルスキャンの推定開始コストに加算される数値です。
これは、接続の確立、リモート側でのクエリのパース・最適化など、追加的なオーバーヘッドを表現します。
デフォルト値は<code class="literal">100</code>です。
      </p></dd><dt><span class="term"><code class="literal">fdw_tuple_cost</code></span></dt><dd><p>外部サーバに指定できるこのオプションは、このサーバでの外部テーブルのスキャンにおいて、各タプル毎に発生する追加的なコストとして使用される数値です。
これは、サーバ間のデータ転送における追加的なオーバーヘッドを表現し、リモートサーバへのネットワーク遅延の高低を反映するためにこの数値を増減することができます。
デフォルト値は<code class="literal">0.01</code>です。
      </p></dd></dl></div><p><code class="literal">use_remote_estimate</code>が<code class="literal">true</code>の時、<code class="filename">postgres_fdw</code>はリモートサーバから行数とコスト推定値を取得し、それを<code class="literal">fdw_startup_cost</code>と<code class="literal">fdw_tuple_cost</code>に加算します。
一方、<code class="literal">use_remote_estimate</code>が<code class="literal">false</code>の時、<code class="filename">postgres_fdw</code>はローカルの行数とコスト推定値を取得し<code class="literal">fdw_startup_cost</code>と<code class="literal">fdw_tuple_cost</code>をコスト推定値に加算します。
このローカルな推定は、リモートテーブルの統計情報のローカルコピーが利用可能でないと、正確である見込みはほとんどありません。
ローカルな統計情報を更新するには外部テーブルに対する<a class="xref" href="sql-analyze.html" title="ANALYZE"><span class="refentrytitle">ANALYZE</span></a>を実行します。これはリモートテーブルに対するスキャンを実行し、あたかもローカルなテーブルであるかのように統計情報の計算と保存を行います。
ローカルな統計情報を保存する事で、クエリの度にリモートテーブルの実行計画を作成するオーバヘッドを削減する事ができます。
しかしながら、リモートテーブルの更新頻度が高ければローカルの統計情報はすぐに実態を反映しなくなるでしょう。
   </p></div><div class="sect3" id="id-1.11.7.43.10.5"><div class="titlepage"><div><div><h4 class="title">F.34.1.4. リモート実行オプション</h4></div></div></div><p>デフォルトでは、組み込みの演算子および関数を使った<code class="literal">WHERE</code>句のみがリモートサーバでの実行を考慮されます。
組み込みでない関数を含む句は、行が取得された後、ローカルで検査されます。
そのような関数がリモートサーバで利用でき、かつローカルで実行するのと同じ結果を生成すると信頼できるときは、そのような<code class="literal">WHERE</code>句をリモートでの実行のために送出することでパフォーマンスを向上することができます。
この動作は以下のオプションを使うことで制御できます。
   </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">extensions</code></span></dt><dd><p>このオプションは、<span class="productname">PostgreSQL</span>の拡張で、ローカルとリモートの両方に、互換のバージョンがインストールされているものの名前のリストです。
IMMUTABLEで、列挙された拡張に属する関数と演算子は、リモートサーバに送出可能とみなされます。
このオプションは外部サーバについてのみ指定可能で、テーブル毎の指定ではありません。
      </p><p><code class="literal">extensions</code>オプションを使用する場合、列挙する拡張が存在し、かつローカルとリモートのサーバで同一の動作をするようにすることは<span class="emphasis"><em>ユーザの責任です</em></span>。
そうでない場合、リモートの問い合わせは失敗したり、期待と異なる動作をするかもしれません。
      </p></dd><dt><span class="term"><code class="literal">fetch_size</code></span></dt><dd><p>このオプションは、<code class="filename">postgres_fdw</code>が1回のフェッチの動作で何行のデータを取得するかを指定します。
これは外部テーブルあるいは外部サーバに対して指定できます。
テーブルに対して指定されたオプションは、サーバに対して指定されたオプションよりも優先します。
デフォルトは<code class="literal">100</code>です。
      </p></dd></dl></div></div><div class="sect3" id="id-1.11.7.43.10.6"><div class="titlepage"><div><div><h4 class="title">F.34.1.5. 更新機能オプション</h4></div></div></div><p>デフォルトでは<code class="filename">postgres_fdw</code>を使用する全ての外部テーブルは更新可能であると想定されます。以下のオプションにより、この挙動を上書きする事ができます。
   </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">updatable</code></span></dt><dd><p>このオプションは、<code class="filename">postgres_fdw</code>が<code class="command">INSERT</code>、<code class="command">UPDATE</code>あるいは<code class="command">DELETE</code>コマンドを使用して外部テーブルを操作する事を許可するかどうかを規定します。
外部テーブルで指定されたオプションは、外部サーバにおいて指定されたオプションを上書きします。
デフォルト値は<code class="literal">true</code>です。
      </p><p>もちろん、リモートテーブルが実際には更新可能ではなかった場合、いずれにしてもエラーが発生するでしょう。このオプションを使用することで、リモートサーバへの問い合わせを行う事なくローカルでエラーを発生させることができます。
また、<code class="literal">information_schema</code>ビューは、このオプションの値に従って<code class="filename">postgres_fdw</code>管理下の外部テーブルを更新可能（あるいは不可能）であるとレポートする事に留意してください。
リモートサーバ側のチェックは一切行われません。
      </p></dd></dl></div></div><div class="sect3" id="id-1.11.7.43.10.7"><div class="titlepage"><div><div><h4 class="title">F.34.1.6. インポートのオプション</h4></div></div></div><p><code class="filename">postgres_fdw</code>は<a class="xref" href="sql-importforeignschema.html" title="IMPORT FOREIGN SCHEMA"><span class="refentrytitle">IMPORT FOREIGN SCHEMA</span></a>を使って、外部テーブルの定義をインポートすることができます。
このコマンドは、リモートのサーバ上に存在するテーブルあるいはビューとマッチする外部テーブルの定義をローカルサーバ上に作成します。
インポートするリモートのテーブルにユーザ定義のデータ型の列がある場合、ローカルサーバにも同じ名前の互換性のある型がなければなりません。
   </p><p>インポートの動作は以下のオプションでカスタマイズできます（<code class="command">IMPORT FOREIGN SCHEMA</code>コマンドで指定します）。
   </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">import_collate</code></span></dt><dd><p>このオプションは、列の<code class="literal">COLLATE</code>オプションが、外部サーバからインポートする外部テーブルの定義に含まれているかどうかを制御します。
デフォルトは<code class="literal">true</code>です。
リモートサーバとローカルサーバで照合順序の名前の集合が異なる場合は、この設定を無効にする必要があるでしょう。
リモートサーバが異なるOSで動作しているなら、そういうことがありそうです。
      </p></dd><dt><span class="term"><code class="literal">import_default</code></span></dt><dd><p>このオプションは、列の<code class="literal">DEFAULT</code>式が外部サーバからインポートされる外部テーブルの定義に含まれているかどうかを制御します。
デフォルトは<code class="literal">false</code>です。
このオプションを有効にする場合は、ローカルサーバとリモートサーバで異なる計算をされるデフォルトに注意して下さい。
<code class="function">nextval()</code>はよくある問題の一つです。
インポートされるデフォルト式がローカルには存在しない関数または演算子を使っていた場合、<code class="command">IMPORT</code>は失敗します。
      </p></dd><dt><span class="term"><code class="literal">import_not_null</code></span></dt><dd><p>このオプションは、列の<code class="literal">NOT NULL</code>制約が、外部サーバからインポートされる外部テーブルの定義に含まれているかどうかを制御します。
デフォルトは<code class="literal">true</code>です。
      </p></dd></dl></div><p><code class="literal">NOT NULL</code>以外の制約は決してリモートのテーブルからインポートされないことに注意して下さい。
<span class="productname">PostgreSQL</span>は外部テーブルの<code class="literal">CHECK</code>制約をサポートしていますが、それを自動的にインポートする予定はありません。
なぜなら、制約の式はローカルとリモートのサーバで異なる評価をされる危険があるからです。
<code class="literal">CHECK</code>制約でそのような一貫しない動作があると、問い合わせの最適化で検知するのが難しい誤りが発生するかもしれません。
そのため、<code class="literal">CHECK</code>制約をインポートしたい場合は、それを手作業で実行する必要があり、またその一つ一つの意味を注意深く確認するべきです。
外部テーブルの<code class="literal">CHECK</code>制約の取扱いについて、詳しくは<a class="xref" href="sql-createforeigntable.html" title="CREATE FOREIGN TABLE"><span class="refentrytitle">CREATE FOREIGN TABLE</span></a>を参照して下さい。
   </p><p>他のテーブルのパーティションであるテーブルや外部テーブルは、自動的に除外されます。
パーティション化されたテーブルは、他のテーブルのパーティションでない限り、インポートされます。
パーティション化階層のルートであるパーティションテーブルを介してすべてのデータにアクセスできるため、この方法では余分なオブジェクトを作成せずにすべてのデータにアクセスできます。
   </p></div></div><div class="sect2" id="id-1.11.7.43.11"><div class="titlepage"><div><div><h3 class="title">F.34.2. 接続管理</h3></div></div></div><p><code class="filename">postgres_fdw</code>は、外部サーバに関連付けられた外部テーブルを参照するクエリを最初に実行する際に、外部サーバへの接続を確立します。
この接続は保持され、同じセッションで以降の問い合わせのために再利用されます。
しかし、外部サーバへのアクセスに対して複数のユーザ識別子（ユーザマッピング）が使用される場合には、接続はユーザマッピング毎に確立される事になります。
  </p></div><div class="sect2" id="id-1.11.7.43.12"><div class="titlepage"><div><div><h3 class="title">F.34.3. トランザクション管理</h3></div></div></div><p>外部サーバ上のリモートテーブルを参照する際に、まだトランザクションが開始されていなければ<code class="filename">postgres_fdw</code>はリモートサーバ上でトランザクションを開始します。
ローカルのトランザクションがコミット、あるいはアボートした時、リモートのトランザクションも同様にコミット、あるいはアボートします。
セーブポイントも同様に管理され、リモート側に関連付けられたセーブポイントが作成されます。
  </p><p>ローカルトランザクションが<code class="literal">SERIALIZABLE</code>隔離レベルを用いている時、リモートトランザクションも<code class="literal">SERIALIZABLE</code>隔離レベルを使用します。
それ以外の場合には<code class="literal">REPEATABLE READ</code>隔離レベルを使用します。
これは、あるクエリが複数のテーブルスキャンをリモート側で行う際に、確実に全てのスキャンにおいて一貫したスナップショットで結果を取り出すためです。
その結果、別の要求によってリモートサーバ側で競合する更新が発生したとしても、あるトランザクション内の問い合わせはリモートサーバからの一貫したデータを参照する事となります。
ローカルのトランザクションが<code class="literal">SERIALIZABLE</code>あるいは<code class="literal">REPEATABLE READ</code>隔離レベルを用いている場合、この動作は期待通りのものでしょう。
一方、ローカルのトランザクションが<code class="literal">READ COMMITTED</code>隔離レベルを使用している場合には、予想外の動作かもしれません。
将来の<span class="productname">PostgreSQL</span>リリースではこれらのルールに変更が加えられるかもしれません。
  </p></div><div class="sect2" id="id-1.11.7.43.13"><div class="titlepage"><div><div><h3 class="title">F.34.4. リモート問い合わせの最適化</h3></div></div></div><p>外部サーバからのデータ転送量を削減するため、<code class="filename">postgres_fdw</code>はリモート問い合わせを最適化しようと試みます。
これは問い合わせの<code class="literal">WHERE</code>句をリモートサーバに送出する事、およびクエリで必要とされていないカラムを取得しない事により行われます。
問い合わせの誤作動のリスクを下げるため、組み込みあるいは外部サーバの<code class="literal">extensions</code>オプションに列挙されている拡張に属するデータ型、演算子、関数だけを用いたものでない限り、リモートサーバに<code class="literal">WHERE</code>句は送出されません。
また、そのような<code class="literal">WHERE</code>句で使われる演算子と関数は<code class="literal">IMMUTABLE</code>でなければなりません。
<code class="command">UPDATE</code>あるいは<code class="command">DELETE</code>の問い合わせについては、リモートサーバに送出できない<code class="literal">WHERE</code>句がなく、問い合わせにローカルな結合がなく、対象のテーブルにローカルな行レベルの<code class="literal">BEFORE</code>あるいは<code class="literal">AFTER</code>トリガーがなく、親ビューからの<code class="literal">CHECK OPTION</code>制約がないのであれば、<code class="filename">postgres_fdw</code>は問い合わせ全体をリモートサーバに送出することで、問い合わせの実行の最適化を図ります。
<code class="command">UPDATE</code>では、問い合わせの誤った実行のリスクを低減するため、対象列への代入式では組み込みのデータ型、<code class="literal">IMMUTABLE</code>演算子、<code class="literal">IMMUTABLE</code>関数のみを使わなければなりません。
  </p><p>同一の外部サーバ上の外部テーブルの間の結合がある場合、<code class="filename">postgres_fdw</code>はその結合全体を外部サーバに送出します。
ただし、何らかの理由で各テーブルから個別に行を取得する方が効率的だと思われる場合、あるいは結合に含まれるテーブルの参照が異なるユーザマッピングに従う場合を除きます。
<code class="literal">JOIN</code>句を送出するにあたり、<code class="literal">WHERE</code>句に関して上で説明したことと同じ注意が払われます。
  </p><p>リモートサーバでの実行のために実際に送出される問い合わせは<code class="command">EXPLAIN VERBOSE</code>を用いて調べる事ができます。
  </p></div><div class="sect2" id="id-1.11.7.43.14"><div class="titlepage"><div><div><h3 class="title">F.34.5. リモート問い合わせ実行環境</h3></div></div></div><p><code class="filename">postgres_fdw</code>が開いたリモートセッションでは、<a class="xref" href="runtime-config-client.html#GUC-SEARCH-PATH">search_path</a>パラメータは<code class="literal">pg_catalog</code>にだけ設定されますので、スキーマで修飾しなければ組み込みオブジェクトだけが可視です。
<code class="filename">postgres_fdw</code>自身が生成した問い合わせでは、常にそのような修飾を行ないますので、これは問題になりません。
しかし、リモートテーブルのトリガやルールによってリモートサーバ上で実行された関数にとっては問題の原因となり得ます。
例えば、リモートテーブルが実際にはビューであれば、そのビューで使われている関数はすべて制限された検索パスで実行されるでしょう。
期待される検索パス環境を確立できるよう、そのような関数では名前はすべてスキーマ修飾するか、そのような関数に<code class="literal">SET search_path</code>オプション(<a class="xref" href="sql-createfunction.html" title="CREATE FUNCTION"><span class="refentrytitle">CREATE FUNCTION</span></a>参照)を付けることをお薦めします。
  </p><p><code class="filename">postgres_fdw</code>は、同様に様々なパラメータでリモートセッション設定を確立します。
   </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p><a class="xref" href="runtime-config-client.html#GUC-TIMEZONE">TimeZone</a>は<code class="literal">UTC</code>に設定されます。
     </p></li><li class="listitem"><p><a class="xref" href="runtime-config-client.html#GUC-DATESTYLE">DateStyle</a>は<code class="literal">ISO</code>に設定されます。
     </p></li><li class="listitem"><p><a class="xref" href="runtime-config-client.html#GUC-INTERVALSTYLE">IntervalStyle</a>は<code class="literal">postgres</code>に設定されます。
     </p></li><li class="listitem"><p><a class="xref" href="runtime-config-client.html#GUC-EXTRA-FLOAT-DIGITS">extra_float_digits</a>はリモートサーバが9.0以上では<code class="literal">3</code>に設定され、それより古いバージョンでは<code class="literal">2</code>に設定されます。
     </p></li></ul></div><p>
これは<code class="varname">search_path</code>ほど問題にはならないでしょうが、もし必要になったら関数の<code class="literal">SET</code>オプションで処理してください。
  </p><p>上のパラメータのセッションレベルの設定を変更することで、この振舞いを覆すことはお薦め<span class="emphasis"><em>しません</em></span>。<code class="filename">postgres_fdw</code>が正常に動作しない原因となるでしょう。
  </p></div><div class="sect2" id="id-1.11.7.43.15"><div class="titlepage"><div><div><h3 class="title">F.34.6. バージョン間互換性</h3></div></div></div><p><code class="filename">postgres_fdw</code>のリモートサーバには<span class="productname">PostgreSQL</span> 8.3以降のバージョンを使用する事ができます。
読み取り専用であれば、8.1以降のバージョンまで可能です。
一方、<code class="filename">postgres_fdw</code>は<code class="literal">IMMUTABLE</code>属性を持った組み込みの演算子と関数が外部テーブルの<code class="literal">WHERE</code>句に含まれる場合、リモート側で実行しても安全であると仮定します。そのため、リモートサーバのリリース後に追加された関数が実行のために送出されるかもしれず、結果として<span class="quote">“<span class="quote">関数が見つかりません</span>”</span>あるいは類するエラーを発生させる事になります。
この種の問題は問い合わせの書き換えによって対処する事ができます。
例えば、最適化を妨げるため、外部テーブルへの参照を<code class="literal">OFFSET 0</code>を付けて副問い合わせに埋め込み、問題のある関数や演算子を副問い合わせの外に配置するなどの方法があります。
  </p></div><div class="sect2" id="id-1.11.7.43.16"><div class="titlepage"><div><div><h3 class="title">F.34.7. 例</h3></div></div></div><p>これは<code class="literal">postgres_fdw</code>で外部テーブルを作成する例です。
まず、拡張をインストールします。
  </p><pre class="programlisting">CREATE EXTENSION postgres_fdw;</pre><p>次に、<a class="xref" href="sql-createserver.html" title="CREATE SERVER"><span class="refentrytitle">CREATE SERVER</span></a>を使って外部サーバを作成します。
この例では、ホスト<code class="literal">192.83.123.89</code>でポート<code class="literal">5432</code>を監視している<span class="productname">PostgreSQL</span>サーバに接続します。
接続されるデータベースはリモートサーバ上で<code class="literal">foreign_db</code>という名前です。

</p><pre class="programlisting">CREATE SERVER foreign_server
        FOREIGN DATA WRAPPER postgres_fdw
        OPTIONS (host '192.83.123.89', port '5432', dbname 'foreign_db');</pre><p>
  </p><p>リモートサーバで使われるロールを特定するためにユーザマッピングも必要です。ユーザマッピングは<a class="xref" href="sql-createusermapping.html" title="CREATE USER MAPPING"><span class="refentrytitle">CREATE USER MAPPING</span></a>で定義されます。

</p><pre class="programlisting">CREATE USER MAPPING FOR local_user
        SERVER foreign_server
        OPTIONS (user 'foreign_user', password 'password');</pre><p>
  </p><p>これで<a class="xref" href="sql-createforeigntable.html" title="CREATE FOREIGN TABLE"><span class="refentrytitle">CREATE FOREIGN TABLE</span></a>により外部テーブルが作成できるようになりました。
この例では、リモートサーバの<code class="structname">some_schema.some_table</code>という名前のテーブルにアクセスします。
対応するローカルの名前は<code class="structname">foreign_table</code>です。

</p><pre class="programlisting">CREATE FOREIGN TABLE foreign_table (
        id integer NOT NULL,
        data text
)
        SERVER foreign_server
        OPTIONS (schema_name 'some_schema', table_name 'some_table');</pre><p>

<code class="command">CREATE FOREIGN TABLE</code>で宣言した列のデータ型やその他の属性は、実際のリモートテーブルと一致していることが必須です。
リモートテーブルでどのような名前なのかを個々の列に対して<code class="literal">column_name</code>オプションで指定しない限り、列名も一致していなければなりません。
多くの場合、外部テーブルの定義を手作業で作成するよりも、<a class="xref" href="sql-importforeignschema.html" title="IMPORT FOREIGN SCHEMA"><span class="refentrytitle">IMPORT FOREIGN SCHEMA</span></a>を使用する方が望ましいです。
  </p></div><div class="sect2" id="id-1.11.7.43.17"><div class="titlepage"><div><div><h3 class="title">F.34.8. 作者</h3></div></div></div><p>花田 茂 <code class="email">&lt;<a class="email" href="mailto:shigeru.hanada@gmail.com">shigeru.hanada@gmail.com</a>&gt;</code>
  </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="pgvisibility.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="contrib.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="seg.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">F.33. pg_visibility </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> F.35. seg</td></tr></table></div></body></html>