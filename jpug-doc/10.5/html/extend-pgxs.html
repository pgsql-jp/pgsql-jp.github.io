<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>37.16. 拡張構築基盤</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="extend-extensions.html" title="37.15. 関連するオブジェクトを拡張としてパッケージ化" /><link rel="next" href="triggers.html" title="Chapter 38. トリガ" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">37.16. 拡張構築基盤</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="extend-extensions.html" title="37.15. 関連するオブジェクトを拡張としてパッケージ化">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="extend.html" title="Chapter 37. SQLの拡張">Up</a></td><th width="60%" align="center">Chapter 37. <acronym xmlns="http://www.w3.org/1999/xhtml" class="acronym">SQL</acronym>の拡張</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="triggers.html" title="Chapter 38. トリガ">Next</a></td></tr></table><hr></hr></div><div class="sect1" id="EXTEND-PGXS"><div class="titlepage"><div><div><h2 class="title" style="clear: both">37.16. 拡張構築基盤</h2></div></div></div><a id="id-1.8.3.19.2" class="indexterm"></a><p><span class="productname">PostgreSQL</span>拡張モジュールの配布を考えているのであれば、移植可能な構築システムを準備することはかなり難しいものになるかもしれません。
このため<span class="productname">PostgreSQL</span>インストレーションは単純な拡張モジュールをすでにインストールされているサーバに対して簡単に構築することができるように、<acronym class="acronym">PGXS</acronym>と呼ばれる拡張向けの構築基盤を提供します。
<acronym class="acronym">PGXS</acronym>は主にCコードを含む拡張を意図していますが、SQLのみからなる拡張でも使用することができます。
<acronym class="acronym">PGXS</acronym>が<span class="productname">PostgreSQL</span>と相互に作用する任意のソフトウェアを構築するために使用できるような万能な構築システムを意図したものではないことに注意してください。
これは単に、単純なサーバ拡張用の一般的な構築規則を自動化するものです。
より複雑なパッケージでは、独自の構築システムを作成する必要があるかもしれません。
   </p><p>独自の拡張で<acronym class="acronym">PGXS</acronym>基盤を使用するためには、簡単なメークファイルを作成する必要があります。
このメークファイルの中で、いくつか変数を設定し、大域的な<acronym class="acronym">PGXS</acronym>メークファイルをインクルードする必要があります。
以下に<code class="literal">isbn_issn</code>という名称の拡張モジュールを構築する例を示します。
このモジュールはいくつかのCコードを含む共有ライブラリ、拡張の制御ファイル、SQLスクリプト、ドキュメントテキストファイルから構成されます。
</p><pre class="programlisting">MODULES = isbn_issn
EXTENSION = isbn_issn
DATA = isbn_issn--1.0.sql
DOCS = README.isbn_issn

PG_CONFIG = pg_config
PGXS := $(shell $(PG_CONFIG) --pgxs)
include $(PGXS)</pre><p>
最後の３行は常に同じです。
ファイルのこの前に変数の設定と独自の<span class="application">make</span>ルールを記載してください。
   </p><p>以下の３個の変数の１つを構築対象に指定してください。

    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="varname">MODULES</code></span></dt><dd><p>同じ家系のソースファイルから構築される共有ライブラリのリストです。
（このリストにはライブラリ接頭辞を含めないでください。）
       </p></dd><dt><span class="term"><code class="varname">MODULE_big</code></span></dt><dd><p>複数のソースファイルから構築される共有ライブラリです。
（<code class="varname">OBJS</code>にオブジェクトファイルを列挙します。）
       </p></dd><dt><span class="term"><code class="varname">PROGRAM</code></span></dt><dd><p>構築する実行プログラムです。
（<code class="varname">OBJS</code>にオブジェクトファイルを列挙します。）
       </p></dd></dl></div><p>

以下の変数も設定することができます。

    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="varname">EXTENSION</code></span></dt><dd><p>拡張の名前です。
各名前に対して、<code class="literal"><em class="replaceable"><code>prefix</code></em>/share/extension</code>にインストールされる<code class="literal"><em class="replaceable"><code>extension</code></em>.control</code>を提供しなければなりません。
       </p></dd><dt><span class="term"><code class="varname">MODULEDIR</code></span></dt><dd><p>DATAおよびDOCSファイルのインストール先となるはずの<code class="literal"><em class="replaceable"><code>prefix</code></em>/share</code>サブディレクトリです。
（設定がない場合、デフォルトは<code class="varname">EXTENSION</code>が設定されている場合は<code class="literal">extension</code>に、設定されていない場合は<code class="literal">contrib</code>になります。）
       </p></dd><dt><span class="term"><code class="varname">DATA</code></span></dt><dd><p><code class="literal"><em class="replaceable"><code>prefix</code></em>/share/$MODULEDIR</code>にインストールされる様々なファイルです。
       </p></dd><dt><span class="term"><code class="varname">DATA_built</code></span></dt><dd><p><code class="literal"><em class="replaceable"><code>prefix</code></em>/share/$MODULEDIR</code>にインストールされる、最初に構築しなければならない様々なファイルです。
       </p></dd><dt><span class="term"><code class="varname">DATA_TSEARCH</code></span></dt><dd><p><code class="literal"><em class="replaceable"><code>prefix</code></em>/share/tsearch_data</code>以下にインストールされる様々なファイルです。
       </p></dd><dt><span class="term"><code class="varname">DOCS</code></span></dt><dd><p><code class="literal"><em class="replaceable"><code>prefix</code></em>/doc/$MODULEDIR</code>以下にインストールされる様々なファイルです。
       </p></dd><dt><span class="term"><code class="varname">SCRIPTS</code></span></dt><dd><p><code class="literal"><em class="replaceable"><code>prefix</code></em>/bin</code>にインストールされるスクリプトファイルです（バイナリファイルではありません）。
       </p></dd><dt><span class="term"><code class="varname">SCRIPTS_built</code></span></dt><dd><p><code class="literal"><em class="replaceable"><code>prefix</code></em>/bin</code>にインストールされる、最初に構築しなければならないスクリプトファイルです（バイナリファイルではありません）。
       </p></dd><dt><span class="term"><code class="varname">REGRESS</code></span></dt><dd><p>リグレッションテストケース（接尾辞がない）のリストです。
後述します。
       </p></dd><dt><span class="term"><code class="varname">REGRESS_OPTS</code></span></dt><dd><p><span class="application">pg_regress</span>に渡す追加オプションです。
       </p></dd><dt><span class="term"><code class="varname">NO_INSTALLCHECK</code></span></dt><dd><p><code class="literal">installcheck</code>ターゲットを定義しません。
テストの際に特殊な設定が必要、あるいは<span class="application">pg_regress</span>を使用しない場合などに有用です。
       </p></dd><dt><span class="term"><code class="varname">EXTRA_CLEAN</code></span></dt><dd><p><code class="literal">make clean</code>で削除される追加ファイルです。
       </p></dd><dt><span class="term"><code class="varname">PG_CPPFLAGS</code></span></dt><dd><p><code class="varname">CPPFLAGS</code>に追加されます。
       </p></dd><dt><span class="term"><code class="varname">PG_LIBS</code></span></dt><dd><p><code class="varname">PROGRAM</code>のリンク行に追加されます。
       </p></dd><dt><span class="term"><code class="varname">SHLIB_LINK</code></span></dt><dd><p><code class="varname">MODULE_big</code>リンク行に追加されます。
       </p></dd><dt><span class="term"><code class="varname">PG_CONFIG</code></span></dt><dd><p>構築対象の<span class="productname">PostgreSQL</span>インストレーション用の<span class="application">pg_config</span>プログラムへのパスです。
（通常は<code class="varname">PATH</code>内の最初に見つかる<code class="literal">pg_config</code>が単純に使用されます）
       </p></dd></dl></div><p>
   </p><p>このメークファイルを<code class="literal">Makefile</code>として拡張を保管するディレクトリ内に保管してください。
その後コンパイルするために<code class="literal">make</code>を、モジュールをインストールするために<code class="literal">make install</code>を行うことができます。
デフォルトでは、<code class="varname">PATH</code>の中で最初に見つかる<code class="command">pg_config</code>プログラムが対応する<span class="productname">PostgreSQL</span>インストレーション用に拡張はコンパイルされ、インストールされます。
メークファイルまたは<code class="literal">make</code>のコマンドラインのいずれかで<code class="varname">PG_CONFIG</code>を別の<code class="command">pg_config</code>プログラムを指し示すように設定することで、別のインストレーションを使用することができます。
   </p><p>構築ディレクトリを別にしておきたいのであれば、拡張のソースツリーの外のディレクトリで<code class="literal">make</code>を実行することもできます。
この方法は<a id="id-1.8.3.19.7.2" class="indexterm"></a><em class="firstterm">VPATH</em>構築とも呼ばれます。
以下にやり方を示します。
</p><pre class="programlisting">mkdir build_dir
cd build_dir
make -f /path/to/extension/source/tree/Makefile
make -f /path/to/extension/source/tree/Makefile install</pre><p>
   </p><p>あるいは、コアコードと同様な方法でVPATH構築用のディレクトリを設定できます。
そのようにする1つの方法は、コアスクリプト<code class="filename">config/prep_buildtree</code>を使うことです。
一度そうすれば、<code class="literal">make</code>変数<code class="varname">VPATH</code>を以下のように設定することで、構築できます。
</p><pre class="programlisting">make VPATH=/path/to/extension/source/tree
make VPATH=/path/to/extension/source/tree install</pre><p>
この方法はより様々なディレクトリのレイアウトで機能します。
   </p><p><code class="varname">REGRESS</code>変数に列挙されたスクリプトは、<code class="literal">make install</code>を実行した後で<code class="literal">make installcheck</code>によって呼び出すことができる、作成したモジュールのリグレッションテストで使用されます。
これが動作するためには、<span class="productname">PostgreSQL</span>サーバが実行していなければなりません。
<code class="varname">REGRESS</code>変数に列挙されたスクリプトは、拡張のディレクトリ内の<code class="literal">sql/</code>という名前のサブディレクトリ内に存在しなければなりません。
これらのファイルは<code class="literal">.sql</code>という拡張子を持たなければなりません。
この拡張子はメークファイル内の<code class="varname">REGRESS</code>リストには含まれません。
また試験ごとに<code class="literal">expected/</code>という名前のサブディレクトリ内に想定出力を内容として含む、同じステムに<code class="literal">.out</code>拡張子を付けた名前のファイルがなければなりません。
<code class="literal">make installcheck</code>は<span class="application">psql</span>を用いて各試験スクリプトを実行し、結果出力が想定ファイルに一致するかどうか比較します。
何らかの差異は<code class="command">diff -c</code>書式で<code class="literal">regression.diffs</code>に書き出されます。
想定ファイルがない試験を実行しようとすると<span class="quote">“<span class="quote">問題</span>”</span>として報告されます。
このためすべての想定ファイルがあることを確認してください。
   </p><div class="tip"><h3 class="title">Tip</h3><p>想定ファイルを作成する最も簡単な方法は、空のファイルを作成し、試験を実行する（当然差異が報告されます）ことです。
<code class="literal">results/</code>ディレクトリ内で見つかる実際の結果ファイルを確認し、テストの想定結果と合致するのであれば、<code class="literal">expected/</code>にコピーしてください。
    </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="extend-extensions.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="extend.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="triggers.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">37.15. 関連するオブジェクトを拡張としてパッケージ化 </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 38. トリガ</td></tr></table></div></body></html>