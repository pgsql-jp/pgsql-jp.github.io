<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>pg_upgrade</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="pgtesttiming.html" title="pg_test_timing" /><link rel="next" href="pgwaldump.html" title="pg_waldump" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center"><span xmlns="http://www.w3.org/1999/xhtml" class="application">pg_upgrade</span></th></tr><tr><td width="10%" align="left"><a accesskey="p" href="pgtesttiming.html" title="pg_test_timing">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="reference-server.html" title="PostgreSQLサーバアプリケーション">Up</a></td><th width="60%" align="center">PostgreSQLサーバアプリケーション</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="pgwaldump.html" title="pg_waldump">Next</a></td></tr></table><hr></hr></div><div class="refentry" id="PGUPGRADE"><div class="titlepage"></div><a id="id-1.9.5.11.1" class="indexterm"></a><div class="refnamediv"><h2><span class="refentrytitle"><span class="application">pg_upgrade</span></span></h2><p>pg_upgrade — <span class="productname">PostgreSQL</span>サーバインスタンスをアップグレードする</p></div><div class="refsynopsisdiv"><h2>Synopsis</h2><div class="cmdsynopsis"><p id="id-1.9.5.11.4.1"><code class="command">pg_upgrade</code>  <code class="option">-b</code>   <em class="replaceable"><code>oldbindir</code></em>   <code class="option">-B</code>   <em class="replaceable"><code>newbindir</code></em>   <code class="option">-d</code>   <em class="replaceable"><code>oldconfigdir</code></em>   <code class="option">-D</code>   <em class="replaceable"><code>newconfigdir</code></em>  [<em class="replaceable"><code>option</code></em>...]</p></div></div><div class="refsect1" id="id-1.9.5.11.5"><h2>説明</h2><p><span class="application">pg_upgrade</span>(これまでは<span class="application">pg_migrator</span>と呼ばれていました)を使用して、メジャーバージョンへのアップグレード、例えば、9.6.3から現時点のメジャーリリースの<span class="productname">PostgreSQL</span>、に通常必要とされたデータのダンプ/リストアを行うことなく、<span class="productname">PostgreSQL</span>データファイル内に格納されたデータをより最新の<span class="productname">PostgreSQL</span>メジャーバージョンに移行することができます。
これは、例えば9.6.2から9.6.3、10.1から10.2などマイナーバージョンへのアップグレードでは必要ありません。
 </p><p>PostgreSQLのメジャーリリースでは通常、システムテーブルのレイアウトをよく変更する、多くの機能が追加されます。
しかし内部データの格納書式はまれにしか変更されません。
<span class="application">pg_upgrade</span>はこの事実を使用して、システムテーブルを新しく作成し、古いユーザデータファイルを単に再利用することで、高速なアップグレードを実施します。
将来のメジャーリリースでついに古いデータ書式を読み取ることができなくなるようにデータ格納書式を変更した場合、<span class="application">pg_upgrade</span>ではこうしたアップグレードを扱うことができません。
（コミュニティはこうした状況を防ごうと考えています。）
 </p><p><span class="application">pg_upgrade</span>は古いクラスタと新しいクラスタとの間で、例えばコンパイル時の設定に互換性があるかどうか、32ビットバイナリか64ビットバイナリかなど、バイナリ互換性があることを確実にするために最善を尽くします。
任意の外部モジュールがバイナリ互換であることも重要ですが、これは<span class="application">pg_upgrade</span>では検査することができません。
 </p><p>pg_upgradeは8.4.X以降から現時点の<span class="productname">PostgreSQL</span>のメジャーリリース(スナップショット版やβリリースを含む)へのアップグレードをサポートします。
  </p></div><div class="refsect1" id="id-1.9.5.11.6"><h2>オプション</h2><p>    <span class="application">pg_upgrade</span>は以下のコマンドライン引数を受け付けます。

    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="option">-b</code> <em class="replaceable"><code>bindir</code></em><br /></span><span class="term"><code class="option">--old-bindir=</code><em class="replaceable"><code>bindir</code></em></span></dt><dd><p>古いPostgreSQLの実行ファイル格納ディレクトリ。<code class="envar">PGBINOLD</code>環境変数</p></dd><dt><span class="term"><code class="option">-B</code> <em class="replaceable"><code>bindir</code></em><br /></span><span class="term"><code class="option">--new-bindir=</code><em class="replaceable"><code>bindir</code></em></span></dt><dd><p>新しいPostgreSQLの実行ファイル格納ディレクトリ。<code class="envar">PGBINNEW</code>環境変数</p></dd><dt><span class="term"><code class="option">-c</code><br /></span><span class="term"><code class="option">--check</code></span></dt><dd><p>クラスタの検査のみを行い、データの変更を行いません。</p></dd><dt><span class="term"><code class="option">-d</code> <em class="replaceable"><code>configdir</code></em><br /></span><span class="term"><code class="option">--old-datadir=</code><em class="replaceable"><code>configdir</code></em></span></dt><dd><p>古いクラスタの設定データディレクトリ。<code class="envar">PGDATAOLD</code>環境変数</p></dd><dt><span class="term"><code class="option">-D</code> <em class="replaceable"><code>configdir</code></em><br /></span><span class="term"><code class="option">--new-datadir=</code><em class="replaceable"><code>configdir</code></em>y</span></dt><dd><p>新しいクラスタの設定データディレクトリ。<code class="envar">PGDATANEW</code>環境変数</p></dd><dt><span class="term"><code class="option">-j</code><br /></span><span class="term"><code class="option">--jobs</code></span></dt><dd><p>使用する同時実行プロセスまたはスレッド数。</p></dd><dt><span class="term"><code class="option">-k</code><br /></span><span class="term"><code class="option">--link</code></span></dt><dd><p>新しいクラスタにファイルをコピーするのではなく、ハードリンクを使用します。</p></dd><dt><span class="term"><code class="option">-o</code> <em class="replaceable"><code>options</code></em><br /></span><span class="term"><code class="option">--old-options</code> <em class="replaceable"><code>options</code></em></span></dt><dd><p>古い<code class="command">postgres</code>コマンドに直接渡すオプションです。複数の起動オプションが追加されます。</p></dd><dt><span class="term"><code class="option">-O</code> <em class="replaceable"><code>options</code></em><br /></span><span class="term"><code class="option">--new-options</code> <em class="replaceable"><code>options</code></em></span></dt><dd><p>新しい<code class="command">postgres</code>コマンドに直接渡すオプションです。複数の起動オプションが追加されます。</p></dd><dt><span class="term"><code class="option">-p</code> <em class="replaceable"><code>port</code></em><br /></span><span class="term"><code class="option">--old-port=</code><em class="replaceable"><code>port</code></em></span></dt><dd><p>古いクラスタのポート番号。<code class="envar">PGPORTOLD</code>環境変数</p></dd><dt><span class="term"><code class="option">-P</code> <em class="replaceable"><code>port</code></em><br /></span><span class="term"><code class="option">--new-port=</code><em class="replaceable"><code>port</code></em></span></dt><dd><p>新しいクラスタのポート番号。<code class="envar">PGPORTNEW</code>環境変数</p></dd><dt><span class="term"><code class="option">-r</code><br /></span><span class="term"><code class="option">--retain</code></span></dt><dd><p>正常に完了した場合であってもSQLファイルとログファイルを保持します。</p></dd><dt><span class="term"><code class="option">-U</code> <em class="replaceable"><code>username</code></em><br /></span><span class="term"><code class="option">--username=</code><em class="replaceable"><code>username</code></em></span></dt><dd><p>クラスタのインストールユーザの名称。<code class="envar">PGUSER</code>環境変数</p></dd><dt><span class="term"><code class="option">-v</code><br /></span><span class="term"><code class="option">--verbose</code></span></dt><dd><p>冗長な内部ログを有効にします。</p></dd><dt><span class="term"><code class="option">-V</code><br /></span><span class="term"><code class="option">--version</code></span></dt><dd><p>バージョン情報を表示し、終了します。</p></dd><dt><span class="term"><code class="option">-?</code><br /></span><span class="term"><code class="option">--help</code></span></dt><dd><p>使用方法を表示し、終了します。</p></dd></dl></div><p>
   </p></div><div class="refsect1" id="id-1.9.5.11.7"><h2>使用方法</h2><p><span class="application">pg_upgrade</span>を用いたアップグレードを行う手順を示します。
  </p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p class="title"><strong>古いクラスタの移動（省略可能）</strong></p><p>バージョンに関連したインストレーションディレクトリ(例えば<code class="filename">/opt/PostgreSQL/10</code>)を使用しているのであれば、古いクラスタを移動する必要はありません。
グラフィカルインストーラはすべて、バージョンに関連したインストレーションディレクトリを使用します。
    </p><p>インストレーションディレクトリがバージョンに関連していない（例えば<code class="filename">/usr/local/pgsql</code>）のであれば、新しい<span class="productname">PostgreSQL</span>のインストレーションに干渉しないように、現在のPostgreSQLインストレーションディレクトリを移動しなければなりません。
一度現在の<span class="productname">PostgreSQL</span>サーバを停止させていれば、PostgreSQLのインストレーションの名前を変更しても安全です。
古いディレクトリが<code class="filename">/usr/local/pgsql</code>であれば、以下のようにディレクトリ名を変更します。

</p><pre class="programlisting">mv /usr/local/pgsql /usr/local/pgsql.old</pre><p>
    </p></li><li class="step"><p class="title"><strong>ソースからのインストールの場合の新しいバージョンの構築</strong></p><p>古いクラスタと互換性を持つような<code class="command">configure</code>オプションを付けて新しいPostgreSQLソースを構築してください。
<span class="application">pg_upgrade</span>はアップグレードを始める前にすべての設定が互換性を持っていることを確認するために<code class="command">pg_controldata</code>を検査します。
    </p></li><li class="step"><p class="title"><strong>新しいPostgreSQLのバイナリのインストール</strong></p><p>新しいサーバのバイナリとサポートファイルをインストールしてください。
<span class="application">pg_upgrade</span>はデフォルトのインストレーションに含まれています。
    </p><p>ソースからインストールする場合、独自の場所に新しいサーバをインストールしたければ、以下のように<code class="literal">prefix</code>を使用してください。

</p><pre class="programlisting">make prefix=/usr/local/pgsql.new install</pre></li><li class="step"><p class="title"><strong>新しいPostgreSQLクラスタを初期化</strong></p><p><code class="command">initdb</code>を使用して新しいクラスタを初期化してください。<a id="id-1.9.5.11.7.3.4.2.2" class="indexterm"></a>
繰り返しますが、古いクラスタに合うように互換性がある<code class="command">initdb</code>のオプションを使用してください。
あらかじめ組み込まれたインストーラの多くは、この手順を自動的に実施します。
新しいクラスタを起動する必要はありません。
    </p></li><li class="step"><p class="title"><strong>独自の共有オブジェクトファイルをインストール</strong></p><p>例えば、<code class="filename">pgcrypto.so</code>、<code class="filename">contrib</code>や何らかのその他のソースからインストールしたものなど、古いクラスタで使用していた独自の共有オブジェクトファイル(またはDLL)をすべて、新しいクラスタにインストールしてください。
例えば<code class="command">CREATE EXTENSION pgcrypto</code>などのスキーマ定義はインストールしないでください。
これらは古いクラスタからアップグレードされるためです。
また、独自の全文検索ファイル(辞書、同義語、類語辞書、ストップワード)も新しいクラスタにコピーしなければなりません。
    </p></li><li class="step"><p class="title"><strong>認証の調整</strong></p><p><code class="command">pg_upgrade</code>は古いサーバと新しいサーバに複数回接続します。
このため、<code class="filename">pg_hba.conf</code>内で<code class="literal">trust</code>または<code class="literal">peer</code>認証に設定、あるいは、<code class="filename">~/.pgpass</code>ファイル(<a class="xref" href="libpq-pgpass.html" title="33.15. パスワードファイル">Section 33.15</a>参照)を使用するようにした方が良いかもしれません。
    </p></li><li class="step"><p class="title"><strong>両サーバの停止</strong></p><p>両サーバが停止していることを確実にしてください。
例えばUnixでは以下を使用します。

</p><pre class="programlisting">pg_ctl -D /opt/PostgreSQL/9.6 stop
pg_ctl -D /opt/PostgreSQL/10 stop</pre><p>

Windowsでは以下

</p><pre class="programlisting">NET STOP postgresql-9.6
NET STOP postgresql-10</pre><p>
    </p><p>ストリーミングレプリケーションおよびログシッピングのスタンバイサーバは、後のステップまで実行中のまま残すことができます。
    </p></li><li class="step"><p class="title"><strong>スタンバイサーバのアップグレードの準備</strong></p><p>スタンバイサーバを<a class="xref" href="pgupgrade.html#PGUPGRADE-STEP-REPLICAS" title="ストリーミングレプリケーションおよびログシッピングのスタンバイサーバのアップグレード">Step 10</a>の節で示した手順でアップグレードする場合は、<span class="application">pg_controldata</span>を実行して、古いスタンバイサーバが、古いプライマリ及びスタンバイのクラスタに同期していることを確認してください。
すべてのクラスタで<span class="quote">“<span class="quote">Latest checkpoint location</span>”</span>（最終チェックポイント位置）の値が一致することを確認してください。
（古いスタンバイサーバが、古いプライマリより先にシャットダウンされた場合は一致しないでしょう。）
また、新しいプライマリのクラスタの<code class="filename">postgresql.conf</code>ファイルで<code class="varname">wal_level</code>を<code class="literal">replica</code>に変更してください。
    </p><p>また、スタンバイサーバをアップグレードする場合は、新しいマスタークラスタ上の<code class="filename">postgresql.conf</code>ファイル内で<code class="varname">wal_level</code>の設定を<code class="literal">replica</code>に変更してください。
    </p></li><li class="step"><p class="title"><strong><span class="application">pg_upgrade</span>の実行</strong></p><p>古いサーバのものではなく、常に新しいサーバの<span class="application">pg_upgrade</span>バイナリを実行してください。
<span class="application">pg_upgrade</span>は古いクラスタおよび新しいクラスタのデータと実行形式ファイルの格納ディレクトリ（<code class="filename">bin</code>）の指定を要求します。
また、ユーザやポート番号の指定や、デフォルト動作のコピーではなくデータファイルのリンクを使用するかどうかを指定することができます。
    </p><p>リンクモードを使用する場合、アップグレードは非常に高速になり(ファイルのコピーがありません)、ディスク容量が少なくなりますが、アップグレード後に新しいクラスタを一度でも実行してしまうと、古いクラスタにアクセスすることができなくなります。
リンクモードはまた、古いクラスタと新しいクラスタのデータディレクトリが同じファイルシステムにあることが必要です。
（テーブル空間および<code class="filename">pg_wal</code>は異なるファイルシステムに置くことができます。）
すべてのオプションリストを参照するためには<code class="literal">pg_upgrade --help</code>を使用してください。
    </p><p><code class="option">--jobs</code>オプションにより複数のCPUコアを使用して、並行してファイルのコピー・リンク、データベーススキーマのダンプと再ロードを行うことができます。
この値の最大値として検討を始める際には、CPUコア数またはテーブル空間数を勧めます。
このオプションはマルチプロセッサを持つマシンで実行している複数のデータベースサーバをアップグレードする時間を大きく減らします。
    </p><p>Windowsユーザの場合、管理者アカウントでログオンしなければなりません。
また、<code class="literal">postgres</code>ユーザとしてシェルを起動し、適切なパスを設定してください。

</p><pre class="programlisting">RUNAS /USER:postgres "CMD.EXE"
SET PATH=%PATH%;C:\Program Files\PostgreSQL\10\bin;</pre><p>

そして、以下の例のように、引用符でくくったディレクトリを付けて<span class="application">pg_upgrade</span>を実行してください。

</p><pre class="programlisting">pg_upgrade.exe
        --old-datadir "C:/Program Files/PostgreSQL/9.6/data"
        --new-datadir "C:/Program Files/PostgreSQL/10/data"
        --old-bindir "C:/Program Files/PostgreSQL/9.6/bin"
        --new-bindir "C:/Program Files/PostgreSQL/10/bin"</pre><p>

起動後、<code class="command">pg_upgrade</code>は2つのクラスタに互換性があるかどうか検証し、その後、アップグレードを行います。
検査のみを行う<code class="command">pg_upgrade --check</code>を使用することができます。
この場合は古いサーバは稼動中であっても構いません。
また<code class="command">pg_upgrade --check</code>は、アップグレード後に手作業で行わなければならない調整作業があればその概要を示します。
リンクモードを使用する予定であれば、リンクモード固有の検査を有効にするために<code class="option">--check</code>を付けて<code class="option">--link</code>を使用すべきです。
<code class="command">pg_upgrade</code>は現在のディレクトリに対する書き込み権限を必要とします。
    </p><p>言うまでもありませんが、アップグレード中はクラスタにアクセスしてはいけません。
意図しないクライアント接続を防ぐために、デフォルトでは<span class="application">pg_upgrade</span>は50432ポートでサーバを稼働します。
古いクラスタと新しいクラスタが同時に稼動することはありませんので、両クラスタで同じポート番号を使用することができます。
しかし実行中の古いクラスタを検査する時には、新旧で異なるポート番号でなければなりません。
    </p><p>データベーススキーマのリストア中にエラーが発生した場合、<code class="command">pg_upgrade</code>は終了しますので、後述の<a class="xref" href="pgupgrade.html#PGUPGRADE-STEP-REVERT" title="古いクラスタへの戻し">Step 16</a>で示すように古いクラスタに戻さなければなりません。
再び<code class="command">pg_upgrade</code>を試すためには、pg_upgradeによるスキーマのリストアが成功するように古いクラスタを変更しなければなりません。
問題が<code class="filename">contrib</code>モジュールであれば、そのモジュールがユーザデータを格納するために使用されていないことが前提ですが、古いクラスタからその<code class="filename">contrib</code>モジュールをアンインストールし、アップグレードした後に新しいクラスタにそれをインストールする必要があるかもしれません。
    </p></li><li class="step" id="PGUPGRADE-STEP-REPLICAS"><p class="title"><strong>ストリーミングレプリケーションおよびログシッピングのスタンバイサーバのアップグレード</strong></p><p>リンクモードを使用した場合で、ストリーミングレプリケーション（<a class="xref" href="warm-standby.html#STREAMING-REPLICATION" title="26.2.5. ストリーミングレプリケーション">Section 26.2.5</a>参照)またはログシッピング（<a class="xref" href="warm-standby.html" title="26.2. ログシッピングスタンバイサーバ">Section 26.2</a>参照）のスタンバイサーバがある場合、以下の手順に従って、素早くアップグレードすることができます。
スタンバイサーバで<span class="application">pg_upgrade</span>は実行せず、代わりにプライマリで<span class="application">rsync</span>を実行することになります。
どのサーバもまだ起動しないでください。
    </p><p>リンクモードを使用<span class="emphasis"><em>しなかった</em></span>場合、<span class="application">rsync</span>の機能が使えない場合や使いたくない場合、あるいはもっと容易な方法を望む場合は、この節の手順を読み飛ばし、<span class="application">pg_upgrade</span>が完了して新しいプライマリが起動したら、単純にスタンバイサーバを再作成してください。
    </p><ol type="a" class="substeps"><li class="step"><p class="title"><strong>PostgreSQLの新しいバイナリをスタンバイサーバにインストール</strong></p><p>すべてのスタンバイサーバで新しいバイナリとサポートファイルがインストールされていることを確実にしてください。

      </p></li><li class="step"><p class="title"><strong>新しいスタンバイのデータディレクトリが存在<span class="emphasis"><em>しない</em></span>ことの確認</strong></p><p>新しいスタンバイのデータディレクトリが存在<span class="emphasis"><em>しない</em></span>か空であることを確実にしてください。
<span class="application">initdb</span>が実行されている場合は、スタンバイサーバの新しいデータディレクトリを削除してください。
      </p></li><li class="step"><p class="title"><strong>カスタム共有オブジェクトファイルのインストール</strong></p><p>新しいプライマリのクラスタにインストールしたのと同じカスタム共有オブジェクトファイルを新しいスタンバイにインストールしてください。
      </p></li><li class="step"><p class="title"><strong>スタンバイサーバの停止</strong></p><p>スタンバイサーバがまだ実行中なら、上記の手順に従って停止してください。
      </p></li><li class="step"><p class="title"><strong>設定ファイルの保存</strong></p><p>スタンバイの設定ディレクトリの設定ファイルで保持する必要のあるもの、例えば<code class="filename">postgresql.conf</code>や<code class="literal">recovery.conf</code>を保存してください。
これらは次のステップで上書きあるいは削除されるからです。
      </p></li><li class="step"><p class="title"><strong>Run <span class="application">rsync</span></strong></p><p>リンクモードを使用する場合、<span class="application">rsync</span>を使用してスタンバイサーバを素早くアップグレードすることができます。
これを実行するには、古いデータベースクラスタのディレクトリおよび新しいデータベースクラスタのディレクトリより上位にあるプライマリサーバ上のディレクトリで、<span class="emphasis"><em>プライマリ</em></span>上で各スタンバイサーバに対して以下を実行します。

</p><pre class="programlisting">rsync --archive --delete --hard-links --size-only --no-inc-recursive old_cluster new_cluster remote_dir</pre><p>

ここで<code class="option">old_cluster</code>および<code class="option">new_cluster</code>はプライマリのカレントディレクトリからの相対パス、<code class="option">remote_dir</code>はスタンバイサーバ上の古いクラスタと新しいクラスタのディレクトリの<span class="emphasis"><em>上位</em></span>のディレクトリです。
プライマリととスタンバイの指定したディレクトリより下のディレクトリ構造は一致しなければなりません。
リモートディレクトリの指定の詳細については<span class="application">rsync</span>のマニュアルを参照してください。
例を示します。

</p><pre class="programlisting">rsync --archive --delete --hard-links --size-only --no-inc-recursive /opt/PostgreSQL/9.5 \
      /opt/PostgreSQL/9.6 standby.example.com:/opt/PostgreSQL</pre><p>

<span class="application">rsync</span>の<code class="option">--dry-run</code>オプションを使うことで、そのコマンドが何をするか確認することができます。
<span class="application">rsync</span>は少なくとも1つのスタンバイに対して、プライマリ上で実行しなければなりませんが、アップグレード済みのスタンバイがまだ起動していなければ、そのスタンバイ上で<span class="application">rsync</span>を実行して、他のスタンバイをアップグレードすることができます。
      </p><p>これが実行するのは<span class="application">pg_upgrade</span>のリンクモードが作成したプライマリサーバ上の古いクラスタのファイルと新しいクラスタのファイルを接続するリンクについて記録することです。
次にスタンバイの古いクラスタ内の一致するファイルを探し、スタンバイの新しいクラスタ内に対応するリンクを作成します。
プライマリ上でリンクされなかったファイルは、プライマリからスタンバイにコピーされます。
（それらは通常は小さいです。）
これにより高速なアップグレードが可能になります。
残念ながら<span class="application">rsync</span>は一時テーブルやログを取らないテーブルに関連したファイルを不要であるにも関わらずコピーします。
これらのファイルが通常はスタンバイサーバに存在しないからです。
      </p><p>テーブル空間を使用している場合は、各テーブル空間のディレクトリについて、同様の<span class="application">rsync</span>コマンドを実行する必要があります。
例を示します。

</p><pre class="programlisting">rsync --archive --delete --hard-links --size-only --no-inc-recursive /vol1/pg_tblsp/PG_9.5_201510051 \
      /vol1/pg_tblsp/PG_9.6_201608131 standby.example.com:/vol1/pg_tblsp</pre><p>

<code class="filename">pg_wal</code>をデータディレクトリの外側に移動している場合は、そのディレクトリについても<span class="application">rsync</span>を実行しなければなりません。
      </p></li><li class="step"><p class="title"><strong>ストリーミングレプリケーションおよびログシッピングのスタンバイサーバの設定</strong></p><p>ログシッピングのためにサーバを設定します。
（スタンバイはまだプライマリと同期されているので、<code class="function">pg_start_backup()</code>と<code class="function">pg_stop_backup()</code>を実行したり、ファイルシステムのバックアップを取得したりする必要はありません。）
      </p></li></ol></li><li class="step"><p class="title"><strong><code class="filename">pg_hba.conf</code>の復旧</strong></p><p><code class="filename">pg_hba.conf</code>を変更している場合は、元の認証設定に戻してください。
また新しいクラスタにおけるこの他の設定ファイル、例えば<code class="filename">postgresql.conf</code>、も古いクラスタに合わせるように調整する必要があります。
    </p></li><li class="step"><p class="title"><strong>新しいサーバの起動</strong></p><p>ここで新しいサーバが安全に起動できます。
それから<span class="application">rsync</span>したすべてのスタンバイサーバを起動できます。
    </p></li><li class="step"><p class="title"><strong>移行後の処理</strong></p><p>アップグレード後の処理が必要な場合、pg_upgradeはその終了時に警告を発します。
また、管理者として実行しなければならないスクリプトファイルを生成します。
このスクリプトファイルは、アップグレード後の処理を必要とするデータベースそれぞれに接続します。
各スクリプトは以下を使用して実行しなければなりません。

</p><pre class="programlisting">psql --username=postgres --file=script.sql postgres</pre><p>

スクリプトは任意の順番で実行することができ、また、実行が終わったら削除することができます。
    </p><div class="caution"><h3 class="title">Caution</h3><p>一般的には、再構築用のスクリプトの実行が完了するより前に、再構築用のスクリプトで参照されるテーブルにアクセスすることは安全ではありません。
これを行うと間違った結果が生じたり、性能が劣化することがあり得ます。
再構築用のスクリプトで参照されないテーブルにはすぐにアクセスすることができます。
    </p></div></li><li class="step"><p class="title"><strong>統計情報</strong></p><p>オプティマイザの統計情報は<code class="command">pg_upgrade</code>により転送されませんので、アップグレード後に統計情報を再生成するコマンドを実行するように指示されます。
新しいクラスタに合わせるために接続パラメータを設定する必要があるかもしれません。
    </p></li><li class="step"><p class="title"><strong>古いクラスタの削除</strong></p><p>アップグレード処理が満足いくものであれば、<code class="command">pg_upgrade</code>の終了時に示されたスクリプトを使用して、古いクラスタのデータディレクトリを削除することができます。
（古いデータディレクトリ内にユーザ定義のテーブル空間がある場合には、自動削除は不可能です。）
（<code class="filename">bin</code>、<code class="filename">share</code>など）古いインストレーションディレクトリも削除できます。
    </p></li><li class="step" id="PGUPGRADE-STEP-REVERT"><p class="title"><strong>古いクラスタへの戻し</strong></p><p><code class="command">pg_upgrade</code>を実行した後に古いクラスタに戻したい場合、いくつかの選択肢があります。

     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="option">--check</code>を付けた<code class="command">pg_upgrade</code>を実行した場合、古いクラスタには変更はまったくなされていませんので、いつでも再使用することができます。
       </p></li><li class="listitem"><p><code class="option">--link</code>を付けた<code class="command">pg_upgrade</code>を実行した場合、データファイルは古いクラスタと新しいクラスタとで共有されます。
もし新しいクラスタを起動していた場合、新しいサーバはこの共有されたファイルに書き出しを行いますので、古いクラスタで使用することは危険です。
       </p></li><li class="listitem"><p><code class="option">--link</code>を<span class="emphasis"><em>付けず</em></span>に<code class="command">pg_upgrade</code>を実行した場合、あるいは、新しいサーバを起動していない場合、リンク処理が始まると、<code class="filename">$PGDATA/global/pg_control</code>に<code class="literal">.old</code>接尾辞が追加される点を除き、古いクラスタは変更されません。
古いクラスタを再度使用するためには、<code class="filename">$PGDATA/global/pg_control</code>から<code class="filename">.old</code>接尾辞を取り除きます。
その後、古いクラスタを再起動することができます。
       </p></li></ul></div><p>
    </p></li></ol></div></div><div class="refsect1" id="id-1.9.5.11.8"><h2>注釈</h2><p><span class="application">pg_upgrade</span>は次のOIDを参照する<code class="type">reg*</code>システムデータ型を含むデータベースのアップグレードをサポートしません。
<code class="type">regproc</code>、<code class="type">regprocedure</code>、<code class="type">regoper</code>、<code class="type">regoperator</code>、<code class="type">regconfig</code>、<code class="type">regdictionary</code>。（<code class="type">regtype</code>はアップグレード可能です。）
  </p><p>インストレーションに影響する場合、失敗、再構築、インデックス再作成はすべて<span class="application">pg_upgrade</span>により報告されます。
テーブルおよびインデックスを再構築するアップグレード後処理スクリプトは自動的に生成されます。
多くのクラスタのアップグレードを自動化することを考えているのであれば、
すべてのクラスタのアップグレードにおいて同一のデータベーススキーマを持つクラスタが同じアップグレード後処理を必要とすることが分かるはずです。
これはアップグレード後処理がデータ自体ではなくデータベーススキーマに基づいているためです。
  </p><p>展開試験を行うのであれば、古いクラスタのスキーマのみをコピーしたものを作成し、ダミーデータを挿入してから、アップグレードを行ってください。
  </p><p>設定ファイルしか持たないディレクトリを使用する<span class="productname">PostgreSQL</span> 9.2よりも前のクラスタをアップグレードする場合、例えば<code class="literal">-d /real-data-directory -o '-D /configuration-directory'</code>のように、実際のデータディレクトリの場所を<span class="application">pg_upgrade</span>に通知しなければならず、さらに設定用ディレクトリの場所をサーバに通知しなければなりません。
  </p><p>デフォルト以外のUnixドメインソケットディレクトリを使用する、または新しいクラスタのデフォルトとは異なるデフォルトを使用する9.1より前の古いサーバを使用している場合、古いサーバのソケット位置を指し示すように<code class="envar">PGHOST</code>を設定してください。（これはWindowsでは関係ありません。）
  </p><p>リンクモードを使用したいが、新しいクラスタを起動した時に古いクラスタを変更させたくない場合は、古いクラスタのコピーを取得してからリンクモードでアップグレードを行ってください。
有効な古いクラスタのコピーを取得するためには、サーバ稼動中に<code class="command">rsync</code>を使用して古いクラスタの変動があるかもしれないコピーを作成し、古いサーバを停止させた後に、<code class="command">rsync --checksum</code>を再度実行して一貫性を保つために何らかの変更をコピーに反映させます。
（<code class="command">rsync</code>はファイル更新時刻の粒度が1秒しかないので<code class="option">--checksum</code>が必要です。）
例えば<a class="xref" href="continuous-archiving.html#BACKUP-LOWLEVEL-BASE-BACKUP" title="25.3.3. 低レベルAPIを使用したベースバックアップの作成">Section 25.3.3</a>で説明した<code class="filename">postmaster.pid</code>など、一部のファイルを除外したいと考えるかもしれません。
スナップショットやコピーは同時、もしくはデータベースサーバが停止しているときに作らなければなりませんが、ファイルシステムがファイルシステムのスナップショットやコピーオンライトファイルコピーをサポートしているのなら、それを古いクラスタとテーブル空間のバックアップをするのに使うことができます。
  </p></div><div class="refsect1" id="id-1.9.5.11.9"><h2>関連項目</h2><span class="simplelist"><a class="xref" href="app-initdb.html" title="initdb"><span class="refentrytitle">initdb</span></a>, <a class="xref" href="app-pg-ctl.html" title="pg_ctl"><span class="refentrytitle"><span class="application">pg_ctl</span></span></a>, <a class="xref" href="app-pgdump.html" title="pg_dump"><span class="refentrytitle">pg_dump</span></a>, <a class="xref" href="app-postgres.html" title="postgres"><span class="refentrytitle"><span class="application">postgres</span></span></a></span></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="pgtesttiming.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="reference-server.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="pgwaldump.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top"><span class="application">pg_test_timing</span> </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> <span class="application">pg_waldump</span></td></tr></table></div></body></html>