<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>F.36. sepgsql</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="seg.html" title="F.35. seg" /><link rel="next" href="contrib-spi.html" title="F.37. spi" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">F.36. sepgsql</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="seg.html" title="F.35. seg">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="contrib.html" title="Appendix F. 追加で提供されるモジュール">Up</a></td><th width="60%" align="center">Appendix F. 追加で提供されるモジュール</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="contrib-spi.html" title="F.37. spi">Next</a></td></tr></table><hr></hr></div><div class="sect1" id="SEPGSQL"><div class="titlepage"><div><div><h2 class="title" style="clear: both">F.36. sepgsql</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="sepgsql.html#SEPGSQL-OVERVIEW">F.36.1. 概要</a></span></dt><dt><span class="sect2"><a href="sepgsql.html#SEPGSQL-INSTALLATION">F.36.2. インストール</a></span></dt><dt><span class="sect2"><a href="sepgsql.html#SEPGSQL-REGRESSION">F.36.3. リグレッションテスト</a></span></dt><dt><span class="sect2"><a href="sepgsql.html#SEPGSQL-PARAMETERS">F.36.4. GUCパラメータ</a></span></dt><dt><span class="sect2"><a href="sepgsql.html#SEPGSQL-FEATURES">F.36.5. 機能</a></span></dt><dt><span class="sect2"><a href="sepgsql.html#SEPGSQL-FUNCTIONS">F.36.6. sepgsql関数</a></span></dt><dt><span class="sect2"><a href="sepgsql.html#SEPGSQL-LIMITATIONS">F.36.7. 制限事項</a></span></dt><dt><span class="sect2"><a href="sepgsql.html#SEPGSQL-RESOURCES">F.36.8. 外部リソース</a></span></dt><dt><span class="sect2"><a href="sepgsql.html#SEPGSQL-AUTHOR">F.36.9. 作者</a></span></dt></dl></div><a id="id-1.11.7.45.2" class="indexterm"></a><p><code class="filename">sepgsql</code>は、SELinuxのセキュリティポリシーに基づいた、ラベルベースの強制アクセス制御（MAC; Mandatory Access Control）機能を提供するモジュールです。
 </p><div class="warning"><h3 class="title">Warning</h3><p>現在の実装にはいくつかの重要な制限事項があり、そのため、全ての操作に対して強制アクセス制御を適用するわけではありません。
詳細は <a class="xref" href="sepgsql.html#SEPGSQL-LIMITATIONS" title="F.36.7. 制限事項">Section F.36.7</a> をご覧ください。
   </p></div><div class="sect2" id="SEPGSQL-OVERVIEW"><div class="titlepage"><div><div><h3 class="title">F.36.1. 概要</h3></div></div></div><p>このモジュールは、<span class="productname">PostgreSQL</span>が標準で提供しているものに加えて、<span class="productname">SELinux</span>と統合されたアクセス制御のレイヤーを追加します。
<span class="productname">SELinux</span>の視点からは、このモジュールが<span class="productname">PostgreSQL</span>をユーザ空間オブジェクトマネージャとして機能することを可能にします。
すなわち、DMLクエリによる個々のテーブルや関数へのアクセスは、オペレーティングシステムのセキュリティポリシーによってチェックされます。
このチェックは、<span class="productname">PostgreSQL</span>による通常のSQLパーミッションチェックに対して追加的に実施されます。
  </p><p><span class="productname">SELinux</span>におけるアクセス制御の意思決定は、<code class="literal">system_u:object_r:sepgsql_table_t:s0</code>のような書式を持ったセキュリティラベルと呼ばれる文字列を用いて行われます。
個々のアクセス制御の意思決定には、２種類のラベルが利用されます。
すなわち、ある操作を行おうとする主体（サブジェクト）のラベルと、その操作の対象となるオブジェクトのラベルです。
これらのラベルはあらゆる種類のオブジェクトに対して適用されるため、（このモジュールを用いる事で）データベースに格納されたオブジェクトに対するアクセス制御は、他の一般的なオブジェクト、例えばファイルに対するものと同一の基準に従って意思決定される事になります。
このデザインは、情報資産を格納する方法とは独立に、一元管理されたセキュリティポリシーによって情報資産を保護することを意図しています。
  </p><p><a class="xref" href="sql-security-label.html" title="SECURITY LABEL"><span class="refentrytitle">SECURITY LABEL</span></a>を用いてデータベースオブジェクトにセキュリティラベルを設定することができます。
  </p></div><div class="sect2" id="SEPGSQL-INSTALLATION"><div class="titlepage"><div><div><h3 class="title">F.36.2. インストール</h3></div></div></div><p><code class="filename">sepgsql</code>は<span class="productname">SELinux</span>が有効な<span class="productname">Linux</span>カーネル 2.6.28 以上で動作します。
その他のプラットフォーム上では利用する事はできません。
加えて、（ディストリビューションによっては、必要なルールを古いバージョンのポリシーにバックポートしている可能性がありますが）<span class="productname">libselinux</span> 2.1.10以上、<span class="productname">selinux-policy</span> 3.9.13以上が必要です。
  </p><p><code class="command">sestatus</code>コマンドを用いて<span class="productname">SELinux</span>の状態を確認することができます。典型的な出力例は以下の通りです。
</p><pre class="screen">$ sestatus
SELinux status:                 enabled
SELinuxfs mount:                /selinux
Current mode:                   enforcing
Mode from config file:          enforcing
Policy version:                 24
Policy from config file:        targeted</pre><p>
<span class="productname">SELinux</span>が無効化されている、あるいはインストールされていない場合、このモジュールのインストールの前に、<span class="productname">SELinux</span>のセットアップを行わねばなりません。
  </p><p>このモジュールをビルドするには、PostgreSQLの<code class="literal">configure</code>コマンドに<code class="literal">--with-selinux</code>オプションを追加してください。
これは、ビルド時に<code class="filename">libselinux-devel</code>パッケージがインストールされている事を確認します。
  </p><p>このモジュールを利用するには、<code class="filename">postgresql.conf</code>の<a class="xref" href="runtime-config-client.html#GUC-SHARED-PRELOAD-LIBRARIES">shared_preload_libraries</a>パラメータに <code class="literal">sepgsql</code>を含める必要があります。これ以外の方法でロードされた場合、このモジュールは正しく機能しません。
このモジュールのロード後、各データベースに対して<code class="filename">sepgsql.sql</code>を実行し、セキュリティラベル管理のための関数のインストールや、初期セキュリティラベルの設定を行うべきです。
  </p><p>以下に<code class="filename">sepgsql</code>関数およびセキュリティラベルと共にデータベースクラスタを初期化する手順を示します。
インストール先に応じて、適宜パス名を読み替えるようにしてください。
  </p><pre class="screen">$ export PGDATA=/path/to/data/directory
$ initdb
$ vi $PGDATA/postgresql.conf
    #shared_preload_libraries = ''                # (change requires restart)
  を
    shared_preload_libraries = 'sepgsql'          # (change requires restart)
  に変更
$ for DBNAME in template0 template1 postgres; do
    postgres --single -F -c exit_on_error=true $DBNAME \
      &lt;/usr/local/pgsql/share/contrib/sepgsql.sql &gt;/dev/null
  done</pre><p><span class="productname">libselinux</span>と<span class="productname">selinux-policy</span>のバージョンによっては以下のようなメッセージが出力される事があります。
</p><pre class="screen">/etc/selinux/targeted/contexts/sepgsql_contexts:  line 33 has invalid object type db_blobs
/etc/selinux/targeted/contexts/sepgsql_contexts:  line 36 has invalid object type db_language
/etc/selinux/targeted/contexts/sepgsql_contexts:  line 37 has invalid object type db_language
/etc/selinux/targeted/contexts/sepgsql_contexts:  line 38 has invalid object type db_language
/etc/selinux/targeted/contexts/sepgsql_contexts:  line 39 has invalid object type db_language
/etc/selinux/targeted/contexts/sepgsql_contexts:  line 40 has invalid object type db_language</pre><p>
これらのメッセージは無害ですので無視してください。
  </p><p>インストール手順が正常に終了したら、通常通り、サーバを起動することができます。
  </p></div><div class="sect2" id="SEPGSQL-REGRESSION"><div class="titlepage"><div><div><h3 class="title">F.36.3. リグレッションテスト</h3></div></div></div><p><span class="productname">SELinux</span>の性質上、<code class="filename">sepgsql</code>のリグレッションテストを実行するには、いくつかの追加的な設定が必要で、そのうちの幾つかは<code class="literal">root</code>で実行する必要があります。
リグレッションテストは通常の<code class="literal">make check</code>や<code class="literal">make installcheck</code>コマンドで実行する事はできません。
必要な設定を行い、テスト用スクリプトを手動で実行する必要があります。
このテストはPostgreSQLビルドツリーの<code class="filename">contrib/sepgsql</code>ディレクトリで実行する必要があります。
しかしビルドツリーを必要とする一方、このテストはインストールされたサーバに対して実行する必要があります。
これは、<code class="literal">make check</code>ではなく、<code class="literal">make installcheck</code>によく似ています。
  </p><p>最初に、<a class="xref" href="sepgsql.html#SEPGSQL-INSTALLATION" title="F.36.2. インストール">Section F.36.2</a>に従って<code class="filename">sepgsql</code>をデータベースにセットアップします。
使用するOS上のユーザは、認証無しでデータベース特権ユーザとして接続できる必要があることに留意してください。
  </p><p>次に、リグレッションテスト用のポリシーパッケージのビルドとインストールを行ってください。
<code class="filename">sepgsql-regtest</code>ポリシーはリグレッションテストの実行に必要な一連のルールを含む特別な目的のポリシーパッケージです。
ポリシーのソースファイルである<code class="filename">sepgsql-regtest.te</code>から、SELinuxの提供するMakefileを用いて<code class="command">make</code>コマンドでビルドする事ができます。
この時、インストール先システムにおいて、適切な<code class="filename">Makefile</code>の位置を指定する必要があります。以下の例で示されているパスは一例です。
ビルドが完了したら、<code class="command">semodule</code>を用いてこのポリシーパッケージをインストールする事ができます。このコマンドは、指定されたポリシーパッケージをリンクし、カーネル空間にロードする役割を果たします。
インストールが正常終了したら、<code class="literal"><code class="command">semodule</code> -l</code>により有効なパッケージの一覧として<code class="literal">sepgsql-regtest</code>が表示されるはずです。
  </p><pre class="screen">$ cd .../contrib/sepgsql
$ make -f /usr/share/selinux/devel/Makefile
$ sudo semodule -u sepgsql-regtest.pp
$ sudo semodule -l | grep sepgsql
sepgsql-regtest 1.07</pre><p>次に、<code class="literal">sepgsql_regression_test_mode</code>を有効化してください。
安全のため、デフォルトでは<code class="filename">sepgsql-regtest</code>に含まれる全てのルールが有効化されている訳ではありません。
<code class="literal">sepgsql_regression_test_mode</code>パラメータはリグレッションテストを起動するために必要となる幾つかのルールを有効にします。
<code class="command">setsebool</code>コマンドによって有効化する事ができます。
  </p><pre class="screen">$ sudo setsebool sepgsql_regression_test_mode on
$ getsebool sepgsql_regression_test_mode
sepgsql_regression_test_mode --&gt; on</pre><p>次に、シェルが<code class="literal">unconfined_t</code>ドメインで動作している事を確認して下さい。
  </p><pre class="screen">$ id -Z
unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023</pre><p>利用者の動作ドメインを設定する方法について、必要であれば、詳細は<a class="xref" href="sepgsql.html#SEPGSQL-RESOURCES" title="F.36.8. 外部リソース">Section F.36.8</a>をご覧ください。
  </p><p>最後に、リグレッションテストのスクリプトを実行します。
  </p><pre class="screen">$ ./test_sepgsql</pre><p>このスクリプトは全ての設定ステップが正常に行われていることを確認し、その後、<code class="filename">sepgsql</code>モジュールに対するリグレッションテストを実行します。
  </p><p>テストの実行後は<code class="literal">sepgsql_regression_test_mode</code>パラメータを無効化する事をお勧めします。
  </p><pre class="screen">$ sudo setsebool sepgsql_regression_test_mode off</pre><p><code class="filename">sepgsql-regtest</code>ポリシーをアンロードする際は、以下のコマンドを実行してください。
  </p><pre class="screen">$ sudo semodule -r sepgsql-regtest</pre></div><div class="sect2" id="SEPGSQL-PARAMETERS"><div class="titlepage"><div><div><h3 class="title">F.36.4. GUCパラメータ</h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt id="GUC-SEPGSQL-PERMISSIVE"><span class="term">     <code class="varname">sepgsql.permissive</code> (<code class="type">boolean</code>)
     <a id="id-1.11.7.45.8.2.1.1.3" class="indexterm"></a>
    </span></dt><dd><p>このパラメータにより、オペレーティングシステムの設定に関わらず、<code class="filename">sepgsql</code>をパーミッシブモードで動作させる事ができます。
デフォルトの設定値はoffです。
<code class="filename">postgresql.conf</code>内、およびサーバ起動時のコマンドラインでのみ、このパラメータを設定する事ができます。
     </p><p>このパラメータがonの場合、たとえSELinuxがエンフォーシングモードで動作していたとしても、<code class="filename">sepgsql</code>関数はパーミッシブモードで動作します。
このパラメータは主としてテストの目的に有用です。
     </p></dd><dt id="GUC-SEPGSQL-DEBUG-AUDIT"><span class="term">     <code class="varname">sepgsql.debug_audit</code> (<code class="type">boolean</code>)
     <a id="id-1.11.7.45.8.2.2.1.3" class="indexterm"></a>
    </span></dt><dd><p>このパラメータにより、セキュリティポリシーの設定とは無関係に監査ログを出力する事が可能になります。
デフォルト値はoff（セキュリティポリシーの設定に従う）です。
     </p><p><span class="productname">SELinux</span>のセキュリティポリシーには、特定のアクセスを監査ログに記録するか否かを制御するルールも存在します。
デフォルトでは、ポリシーに違反したアクセスを記録し、それ以外はログに記録されません。
     </p><p>システムのポリシーとは無関係に、このパラメータは全ての監査ログの出力を強制します。
     </p></dd></dl></div></div><div class="sect2" id="SEPGSQL-FEATURES"><div class="titlepage"><div><div><h3 class="title">F.36.5. 機能</h3></div></div></div><div class="sect3" id="id-1.11.7.45.9.2"><div class="titlepage"><div><div><h4 class="title">F.36.5.1. 制御されるオブジェクトの種類</h4></div></div></div><p><span class="productname">SELinux</span>のセキュリティモデルでは、全てのアクセス制御ルールは動作主体（サブジェクト; 典型的にはデータベースクライアント）と対象オブジェクト間の関係として記述し、これらはセキュリティラベルによって識別されます。
ラベル付けされていないオブジェクトに対するアクセスが発生した場合、そのオブジェクトはあたかも<code class="literal">unlabeled_t</code>タイプが割り当てられているかのように振舞います。
   </p><p>現在の<code class="filename">sepgsql</code>では、スキーマ、テーブル、カラム、シーケンス、ビューおよび関数に対するラベル付けがサポートされています。
<code class="filename">sepgsql</code>の利用時には、これらのデータベースオブジェクトに対して、その生成時に自動的にセキュリティラベルが割り当てられます。
このラベルはデフォルトセキュリティラベルと呼ばれ、作成者のラベル、親関係にあたるオブジェクトのラベル、そして場合によっては作成されたオブジェクトの名前に基づいて、システムのセキュリティポリシーが決定します。
   </p><p>新しいデータベースオブジェクトのラベルは、タイプ遷移と呼ばれる異なったラベルを設定するための特別なルールがセキュリティポリシーに設定されている場合を除き、親関係にあるオブジェクトのラベルを引き継ぎます。
スキーマの親オブジェクトはデータベースであり、テーブル、シーケンス、ビュー、および関数はその属するスキーマが、カラムはその属するテーブルが親オブジェクトという事になります。
   </p></div><div class="sect3" id="id-1.11.7.45.9.3"><div class="titlepage"><div><div><h4 class="title">F.36.5.2. DMLパーミッション</h4></div></div></div><p>テーブルに対しては、構文の種類に応じて<code class="literal">db_table:select</code>、<code class="literal">db_table:insert</code>、<code class="literal">db_table:update</code>あるいは<code class="literal">db_table:delete</code>権限が全ての被参照テーブルに対してチェックされます。
加えて、<code class="literal">WHERE</code>句や<code class="literal">RETURNING</code>句で参照されるカラム、又は<code class="literal">UPDATE</code>の際のデータ元として利用されるカラムの属するテーブルに対して<code class="literal">db_table:select</code>権限もチェックされます。
   </p><p>参照された全てのカラムに対して列レベルの権限チェックが行われます。
<code class="literal">SELECT</code>構文で読み出されるカラムに対してだけでなく、他のDML構文で参照
されているカラムに対しても<code class="literal">db_column:select</code>権限がチェックされます。
また、<code class="literal">UPDATE</code>や<code class="literal">INSERT</code>によって操作の対象となっているカラム
に対しても、<code class="literal">db_column:update</code>や<code class="literal">db_column:insert</code>権限が
それぞれチェックされます。
   </p><p>以下の例を見てください
</p><pre class="synopsis">UPDATE t1 SET x = 2, y = md5sum(y) WHERE z = 100;</pre><p>

ここでは、更新される<code class="literal">t1.x</code>に対して<code class="literal">db_column:update</code>権限が、更新と同時に参照される<code class="literal">t1.y</code>に対しては<code class="literal">db_column:{select update}</code>権限が、そして参照されるだけの<code class="literal">t1.z</code>には<code class="literal">db_column:select</code>権限がチェックされます。
また、テーブルレベルでは<code class="literal">db_table:{select update}</code>権限がチェックされます。
   </p><p><code class="literal">SELECT</code>構文を用いてシーケンスを参照する場合、<code class="literal">db_sequence:get_value</code>がチェックされます。
しかし、現在のところ<code class="literal">lastval()</code>など関連する関数の実行時にはパーミッションチェックを行わない事に留意してください。
   </p><p>ビューに対しては<code class="literal">db_view:expand</code>権限がチェックされ、次いで、ビューから展開されたオブジェクトに対するパーミッションが個別にチェックされます。
   </p><p>利用者がクエリの一部として、あるいは近道インタフェースを用いた呼び出しによって関数を実行しようとするとき、<code class="literal">db_procedure:{execute}</code>権限がチェックされます。
関数がトラステッドプロシージャである場合、関数がトラステッドプロシージャのエントリーポイントとして振る舞う事ができるかどうかを検査するために<code class="literal">db_procedure:{entrypoint}</code>権限がチェックされます。
   </p><p>あらゆるスキーマオブジェクトにアクセスするためには、それらを含むスキーマに対する<code class="literal">db_schema:search</code>権限が必要です。
あるスキーマオブジェクトがスキーマ修飾無しに参照された場合、この権限を与えられていないスキーマは探索されません（あたかも利用者がスキーマに対する<code class="literal">USAGE</code>権限を有していないかのように振る舞います）。
明示的なスキーマ修飾があり、このスキーマに対して利用者が要求された権限を有していない場合、エラーが発生します。
   </p><p>クライアントは全ての被参照テーブル・カラムに対して参照の権限を有している必要があります。それらがビューに由来し、展開されたものであっても同様です。これにより、テーブルの内容がどのような方法によって参照されるかに関係なく、一貫したアクセス制御ルールを適用する事ができます。
   </p><p>データベーススーパーユーザに対して、標準のデータベース権限システムはDMLを用いたシステムカタログの更新と、TOASTテーブルの参照および更新を許していますが、<code class="filename">sepgsql</code>が有効なとき、これらの操作は禁止されます。
   </p></div><div class="sect3" id="id-1.11.7.45.9.4"><div class="titlepage"><div><div><h4 class="title">F.36.5.3. DDLパーミッション</h4></div></div></div><p>オブジェクトの作成、変更、削除やセキュリティラベルの変更など、<span class="productname">SELinux</span>は各オブジェクトに共通の操作を制御するためのパーミッションを何個か定義しています。
また、特定のスキーマに対する名前の追加や削除など、いくつかのオブジェクトにはそれ固有の操作を制御するための特別なパーミッションも定義されています。
   </p><p>新しいデータベースオブジェクトの作成には<code class="literal">create</code>権限が必要です。
<span class="productname">SELinux</span>は利用者のセキュリティラベルと新しいオブジェクトに付与される事になるセキュリティラベルの対に基づいて、この権限を許可、あるいは拒否します。
いくつかの場合では、追加的な権限チェックが行われます。
   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a class="xref" href="sql-createdatabase.html" title="CREATE DATABASE"><span class="refentrytitle">CREATE DATABASE</span></a>は、複製元またはテンプレートのデータベース
に対する<code class="literal">getattr</code>権限を要求します。
     </p></li><li class="listitem"><p>スキーマオブジェクトの作成は、それを含むスキーマに対して<code class="literal">add_name</code>
権限を要求します。
     </p></li><li class="listitem"><p>テーブルの作成は同時に、それがあたかも独立したオブジェクトであるかのように、
個々のテーブル列を作成する権限を要求します。
     </p></li><li class="listitem"><p><code class="literal">LEAKPROOF</code>属性を持った関数の作成は<code class="literal">install</code>権限を要求します。（これはまた、既存の関数に<code class="literal">LEAKPROOF</code>属性を設定する時にも要求されます）
     </p></li></ul></div><p><code class="literal">DROP</code>構文の実行時、削除されるオブジェクトに対して<code class="literal">drop</code>権限がチェックされます。
<code class="literal">CASCADE</code>により間接的に削除されるオブジェクトに対してもチェックは行われます。
特定のスキーマに含まれるオブジェクト（テーブル、ビュー、シーケンスや関数）の削除に際しては、スキーマに対する<code class="literal">remove_name</code>権限も併せてチェックされます。
   </p><p><code class="literal">ALTER</code>構文の実行時、テーブルに対するインデックスやトリガなど別オブジェクトに従属するもの（これらは代わりに親オブジェクトに対する権限がチェックされる）を除き、<code class="literal">setattr</code>がチェックされます。
いくつかの場合では、追加的な権限チェックが行われます。
   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>オブジェクトを新しいスキーマに移動させるには、古いスキーマに対して<code class="literal">remove_name</code>権限が、新しいスキーマに対して<code class="literal">add_name</code>権限が必要です。
     </p></li><li class="listitem"><p>関数に対する<code class="literal">LEAKPROOF</code>属性の設定は<code class="literal">install</code>権限を要求します。
     </p></li><li class="listitem"><p><a class="xref" href="sql-security-label.html" title="SECURITY LABEL"><span class="refentrytitle">SECURITY LABEL</span></a>コマンドの実行時、ラベル付けされるオブジェクトの古いラベルに対して<code class="literal">setattr</code>権限と<code class="literal">relabelfrom</code>権限が、入力された新しいラベルに対して<code class="literal">relabelto</code>権限がチェックされます。
（複数のラベルプロバイダがインストールされており、利用者が<span class="productname">SELinux</span>の管理下にないラベルを設定しようとした場合、<code class="literal">setattr</code>権限だけがチェックされるべきです。しかし実装上の制約により、現在はこれをチェックしていません）
     </p></li></ul></div></div><div class="sect3" id="id-1.11.7.45.9.5"><div class="titlepage"><div><div><h4 class="title">F.36.5.4. トラステッド プロシージャ</h4></div></div></div><p>トラステッド・プロシージャはSECURITY DEFINER関数やSet-UIDコマンドに似ています。通常、機密データに対する高度にコントロールされたアクセス手段を提供する目的で、<span class="productname">SELinux</span>は利用者のものとは異なるセキュリティラベルで信頼済みのコードを実行するための機能を持っています。
関数がトラステッド・プロシージャとして振舞うかどうかは、関数のセキュリティラベルおよびオペレーティングシステムのセキュリティポリシーに従って決まります。
例えば：
   </p><pre class="screen">postgres=# CREATE TABLE customer (
               cid     int primary key,
               cname   text,
               credit  text
           );
CREATE TABLE
postgres=# SECURITY LABEL ON COLUMN customer.credit
               IS 'system_u:object_r:sepgsql_secret_table_t:s0';
SECURITY LABEL
postgres=# CREATE FUNCTION show_credit(int) RETURNS text
             AS 'SELECT regexp_replace(credit, ''-[0-9]+$'', ''-xxxx'', ''g'')
                        FROM customer WHERE cid = $1'
           LANGUAGE sql;
CREATE FUNCTION
postgres=# SECURITY LABEL ON FUNCTION show_credit(int)
               IS 'system_u:object_r:sepgsql_trusted_proc_exec_t:s0';
SECURITY LABEL</pre><p>これらの操作は管理権限を持つ利用者で行ってください。
   </p><pre class="screen">postgres=# SELECT * FROM customer;
ERROR:  SELinux: security policy violation
postgres=# SELECT cid, cname, show_credit(cid) FROM customer;
 cid | cname  |     show_credit
-----+--------+---------------------
   1 | taro   | 1111-2222-3333-xxxx
   2 | hanako | 5555-6666-7777-xxxx
(2 rows)</pre><p>この場合、一般の利用者は<code class="literal">customer.credit</code>を直接参照することはできませんが、トラステッド・プロシージャである<code class="literal">show_credit</code>を用いる事で、一部の桁がマスクされた顧客のクレジットカード番号をプリントする事が可能になります。
   </p></div><div class="sect3" id="id-1.11.7.45.9.6"><div class="titlepage"><div><div><h4 class="title">F.36.5.5. 動的ドメイン遷移</h4></div></div></div><p>セキュリティポリシーによって許可されている場合、SELinuxの動的ドメイン遷移機能を用いて、利用者のラベルを新しいものに切り替える事ができます。
利用者のドメインは<code class="literal">setcurrent</code>権限および、古いドメインから新しいドメインに遷移するための<code class="literal">dyntransition</code>権限を有している必要があります。
   </p><p>利用者に自身のラベル、すなわち権限を切り替える事を可能にする動的ドメイン遷移は、システムによる自動切り替え（トラステッド・プロシージャの場合）に比べて慎重に取り扱う必要があります。
<code class="literal">dyntransition</code>権限は元々のドメインよりも小さな権限セットを持つドメインに切り替える場合にのみ安全であると考えられます。例えば、
   </p><pre class="screen">regression=# select sepgsql_getcon();
                    sepgsql_getcon
-------------------------------------------------------
 unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
(1 row)

regression=# SELECT sepgsql_setcon('unconfined_u:unconfined_r:unconfined_t:s0-s0:c1.c4');
 sepgsql_setcon 
----------------
 t
(1 row)

regression=# SELECT sepgsql_setcon('unconfined_u:unconfined_r:unconfined_t:s0-s0:c1.c1023');
ERROR:  SELinux: security policy violation</pre><p>上記の例では、広いMCSレンジ<code class="literal">c1.c1023</code>から狭いMCSレンジ<code class="literal">c1.c4</code>への遷移は許可されているものの、その逆は禁止されています。
   </p><p>動的ドメイン遷移とトラステッド・プロシージャの組み合わせは、典型的なコネクションプーラのライフサイクルに適合する興味深い利用法を提供します。
たとえコネクションプーリングソフトウェアが大半のSQLの実行を許可されていない場合でも、トラステッド・プロシージャの内側から<code class="literal">sepgsql_setcon()</code>関数を用いて利用者のセキュリティラベルを切り替える事ができます。（トラステッド・プロシージャは利用者のセキュリティラベルを切り替えるための認証情報を要求すべきです）
この後、現在のセッションはコネクションプーラの権限ではなく、対象となる利用者の権限で動作する事になります。
また、<code class="literal">sepgsql_setcon()</code>に<code class="literal">NULL</code>引数を与えて（適切な権限チェックを行う）トラステッド・プロシージャから再び呼び出す事で、コネクションプーラは後でセキュリティラベルを元に戻す事ができます。
ここでのポイントは、トラステッド・プロシージャだけが実際に有効なセキュリティラベルを変更する権限を持っており、正しい認証情報が与えられた場合にのみそれを実行するという事です。
言うまでもなく、安全な操作のためには、権限のないアクセスから認証情報を保持するテーブルや関数定義などを保護しなければなりません。
   </p></div><div class="sect3" id="id-1.11.7.45.9.7"><div class="titlepage"><div><div><h4 class="title">F.36.5.6. その他</h4></div></div></div><p>ロードされたモジュールは、セキュリティポリシーの適用を容易にバイパスできるため、<a class="xref" href="sql-load.html" title="LOAD"><span class="refentrytitle">LOAD</span></a>コマンドの実行は全面的に禁止されています。
   </p></div></div><div class="sect2" id="SEPGSQL-FUNCTIONS"><div class="titlepage"><div><div><h3 class="title">F.36.6. sepgsql関数</h3></div></div></div><p>   <a class="xref" href="sepgsql.html#SEPGSQL-FUNCTIONS-TABLE" title="Table F.30. Sepgsql 関数">Table F.30</a>に利用可能な関数を示します。
  </p><div class="table" id="SEPGSQL-FUNCTIONS-TABLE"><p class="title"><strong>Table F.30. Sepgsql 関数</strong></p><div class="table-contents"><table class="table" summary="Sepgsql 関数" border="1"><colgroup><col /><col /></colgroup><tbody><tr><td><code class="literal">sepgsql_getcon() returns text</code></td><td>利用者のドメイン、つまり、現在の利用者ラベルを返却します。
      </td></tr><tr><td><code class="literal">sepgsql_setcon(text) returns bool</code></td><td>セキュリティポリシーで許可されている場合、現在のセッションの利用者ドメインを新しいドメインへと切り替えます。
<code class="literal">NULL</code>を引数に取る事も可能で、その場合、元々の利用者ドメインへの遷移を意味します。
      </td></tr><tr><td><code class="literal">sepgsql_mcstrans_in(text) returns text</code></td><td>mcstransデーモンが動作している場合、入力されたMLS/MCSレンジを修飾フォーマットから直接フォーマットに変換します。
      </td></tr><tr><td><code class="literal">sepgsql_mcstrans_out(text) returns text</code></td><td>mcstransデーモンが動作している場合、入力されたMLS/MCSレンジを直接フォーマットから修飾フォーマットに変換します。
      </td></tr><tr><td><code class="literal">sepgsql_restorecon(text) returns bool</code></td><td>現在のデータベース内の全てのオブジェクトに対して初期ラベルを割り当てます。引数は<code class="literal">NULL</code>もしくはシステムの標準に代わる定義ファイルの名前です。
      </td></tr></tbody></table></div></div><br class="table-break" /></div><div class="sect2" id="SEPGSQL-LIMITATIONS"><div class="titlepage"><div><div><h3 class="title">F.36.7. 制限事項</h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Data Definition Language (DDL) パーミッション</span></dt><dd><p>実装上の制約により、いくつかのDDL操作はパーミッションをチェックしません。
     </p></dd><dt><span class="term">Data Control Language (DCL) パーミッション</span></dt><dd><p>実装上の制約により、DCL操作はパーミッションをチェックしません。
     </p></dd><dt><span class="term">行レベルアクセス制御</span></dt><dd><p><span class="productname">PostgreSQL</span>は行レベルアクセス制御をサポートしていますが、<code class="filename">sepgsql</code>はサポートしていません。
     </p></dd><dt><span class="term">隠れチャネル</span></dt><dd><p>たとえ利用者が参照を許可されていないオブジェクトであっても、<code class="filename">sepgsql</code>はその存在を隠すことを意図していません。
例えば、我々があるオブジェクトの内容を参照する事ができなくても、主キーの競合や外部キー違反、その他の方法によって不可視なオブジェクトが存在する事を推測できます。
"最高機密"テーブルの存在を隠すことは不可能であり、その内容を秘匿することだけを意図しています。
     </p></dd></dl></div></div><div class="sect2" id="SEPGSQL-RESOURCES"><div class="titlepage"><div><div><h3 class="title">F.36.8. 外部リソース</h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><a class="ulink" href="https://wiki.postgresql.org/wiki/SEPostgreSQL" target="_top">SE-PostgreSQL Introduction</a></span></dt><dd><p>このwikiページでは、概要、セキュリティ・デザイン、アーキテクチャ、管理、および将来の機能について紹介しています。
     </p></dd><dt><span class="term"><a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/SELinux_Users_and_Administrators_Guide/" target="_top">SELinux User's and Administrator's Guide</a></span></dt><dd><p>このドキュメントは<span class="productname">SELinux</span>システム管理に対する広範な知識を提供しています。
主としてRed Hatオペレーティングシステムを対象としていますが、それに限ったものではありません。
     </p></dd><dt><span class="term"><a class="ulink" href="https://fedoraproject.org/wiki/SELinux_FAQ" target="_top">Fedora SELinux FAQ</a></span></dt><dd><p>このドキュメントは<span class="productname">SELinux</span>に関するよくある質問と回答(FAQ)です。
主としてFedoraを対象としていますが、それに限ったものではありません。
     </p></dd></dl></div></div><div class="sect2" id="SEPGSQL-AUTHOR"><div class="titlepage"><div><div><h3 class="title">F.36.9. 作者</h3></div></div></div><p>   KaiGai Kohei <code class="email">&lt;<a class="email" href="mailto:kaigai@ak.jp.nec.com">kaigai@ak.jp.nec.com</a>&gt;</code>
  </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="seg.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="contrib.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="contrib-spi.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">F.35. seg </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> F.37. spi</td></tr></table></div></body></html>