<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>CLUSTER</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="sql-close.html" title="CLOSE" /><link rel="next" href="sql-comment.html" title="COMMENT" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">CLUSTER</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="sql-close.html" title="CLOSE">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="sql-commands.html" title="SQLコマンド">Up</a></td><th width="60%" align="center">SQLコマンド</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="sql-comment.html" title="COMMENT">Next</a></td></tr></table><hr></hr></div><div class="refentry" id="SQL-CLUSTER"><div class="titlepage"></div><a id="id-1.9.3.48.1" class="indexterm"></a><div class="refnamediv"><h2><span class="refentrytitle">CLUSTER</span></h2><p>CLUSTER — インデックスに従ってテーブルをクラスタ化する</p></div><div class="refsynopsisdiv"><h2>Synopsis</h2><pre class="synopsis">CLUSTER [VERBOSE] <em class="replaceable"><code>table_name</code></em> [ USING <em class="replaceable"><code>index_name</code></em> ]
CLUSTER [VERBOSE]</pre></div><div class="refsect1" id="id-1.9.3.48.5"><h2>説明</h2><p><code class="command">CLUSTER</code>は、<em class="replaceable"><code>index_name</code></em>で指定されたインデックスに基づき、<em class="replaceable"><code>table_name</code></em>で指定されたテーブルをクラスタ化するように、<span class="productname">PostgreSQL</span>に指示します。
このインデックスは前もって<em class="replaceable"><code>table_name</code></em>上に定義されていなければなりません。
  </p><p>テーブルがクラスタ化されると、それぞれのテーブルはインデックス情報に基づいて物理的に並べ直されます。
クラスタ化は、1回限りの操作です。
クラスタ化後にテーブルが更新されても、その変更はクラスタ化されません。
つまり、新規に追加された行や更新された行は、インデックス順には保管されません。
（インデックス順に保管したい場合は、コマンドを再度入力し、定期的に再クラスタ化を行います。
また、更新される行は十分な領域が利用可能ならば同一ページ内に保持されますので、テーブルの<code class="literal">fillfactor</code>格納パラメータを100%より小さく設定することで、更新処理中のクラスタ順序付けを保護するのに役に立ちます。）
  </p><p>テーブルがクラスタ化されると、<span class="productname">PostgreSQL</span>はクラスタ化に使用されたインデックスを記録します。
<code class="command">CLUSTER <em class="replaceable"><code>table_name</code></em></code>という構文によって、以前と同じインデックスを使用してテーブルを再クラスタ化します。
また<a class="xref" href="sql-altertable.html" title="ALTER TABLE"><span class="refentrytitle">ALTER TABLE</span></a>の<code class="literal">CLUSTER</code>もしくは<code class="literal">SET WITHOUT CLUSTER</code>構文を使用して、将来のクラスタ化操作で使用するインデックスを設定したり、過去の設定を取り消すことができます。
  </p><p>パラメータを指定しないで<code class="command">CLUSTER</code>を実行した場合、現在のデータベース内の以前にクラスタ化されたテーブルのうち、呼び出したユーザが所有する全てのテーブルを（スーパーユーザが実行する場合は全てのテーブルを）再クラスタ化します。
このパラメータを指定しない<code class="command">CLUSTER</code>を、トランザクションブロック内で実行することはできません。
  </p><p>クラスタ化を行っているテーブルでは、<code class="literal">ACCESS EXCLUSIVE</code>ロックが獲得されています。
これにより、<code class="command">CLUSTER</code>が終わるまで、そのテーブルに対するデータベース操作（読み書き両方）はできません。
  </p></div><div class="refsect1" id="id-1.9.3.48.6"><h2>パラメータ</h2><div class="variablelist"><dl class="variablelist"><dt><span class="term"><em class="replaceable"><code>table_name</code></em></span></dt><dd><p>テーブルの名前です（スキーマ修飾名も可）。
     </p></dd><dt><span class="term"><em class="replaceable"><code>index_name</code></em></span></dt><dd><p>インデックスの名前です。
     </p></dd><dt><span class="term"><code class="literal">VERBOSE</code></span></dt><dd><p>各テーブルのクラスタ化を行う時に進行状況報告を出力します。
     </p></dd></dl></div></div><div class="refsect1" id="id-1.9.3.48.7"><h2>注釈</h2><p>テーブル内の個々の行にランダムにアクセスする場合、テーブル内のデータの順序は重要でありません。
しかし、テーブル内の特定のデータにアクセスが集中していて、それらのデータをひとまとめにしているインデックスが存在する時は、<code class="command">CLUSTER</code>による利益を享受できます。
テーブルからインデックスの値の範囲や、一致する複数の行を保有する1つのインデックスの値を要求する場合、<code class="command">CLUSTER</code>が役に立ちます。
一度インデックスが一致する最初の行に対するテーブルページを認識すると、一致する他の全ての行も同じテーブルページに存在する可能性が高いので、ディスクアクセスを減らして問い合わせ処理の速度を向上することができるからです。

   </p><p><code class="command">CLUSTER</code>は、指定されたインデックスによるインデックススキャン、または（インデックスがB-Treeの場合）シーケンシャルスキャン後のソートのいずれかを用いて、テーブルを再ソートすることができます。
プランナのコストパラメータと利用可能な統計情報に基づき、より高速な方式の選択を試みます。
   </p><p>インデックススキャンが使用される場合、インデックス順にテーブルデータを並べた、テーブルの一時コピーが作成されます。
同様に、テーブルの各インデックスの一時コピーも作成されます。
したがって、ディスクには、少なくともテーブルとインデックスの合計サイズと同じ容量の空き領域が必要です。
   </p><p>シーケンシャルスキャンとソートが使用される場合も一時的なソートファイルが作成されます。
一時的に必要となるサイズの最大値はテーブルサイズの倍のサイズにインデックスサイズを加えた値となります。
この方式はインデックススキャンより高速になることが多いのですが、必要なディスク容量に耐えられない場合は、一時的に<a class="xref" href="runtime-config-query.html#GUC-ENABLE-SORT">enable_sort</a>を<code class="literal">off</code>にすることで、この方式を無効にすることができます。
   </p><p>クラスタ処理の前に<a class="xref" href="runtime-config-resource.html#GUC-MAINTENANCE-WORK-MEM">maintenance_work_mem</a>を程良く大きな値に設定することを勧めます。
（しかし<code class="command">CLUSTER</code>操作専用に割り当てられるRAMの容量を超えないようにしてください。）
   </p><p>プランナはテーブルの順序付けに関する統計情報を記録しているため、新しくクラスタ化されたテーブルでは、<a class="xref" href="sql-analyze.html" title="ANALYZE"><span class="refentrytitle">ANALYZE</span></a>を実行することが推奨されます。
そうしないと、プランナが問い合わせ計画を適切に選択できない可能性があります。
   </p><p><code class="command">CLUSTER</code>はどのインデックスでクラスタ化したかを記録していますので、対象のテーブルを定期的に再クラスタ化できるように、最初にクラスタ化したいテーブルを手作業でクラスタ化し、その後にパラメータをまったく持たない<code class="command">CLUSTER</code>を実行する定期的な保守用スクリプトを設定することができます。
   </p></div><div class="refsect1" id="id-1.9.3.48.8"><h2>例</h2><p>インデックス<code class="literal">employees_ind</code>に基づいて、テーブル<code class="literal">emp</code>をクラスタ化します。
</p><pre class="programlisting">CLUSTER employees USING employees_ind;</pre><p>
  </p><p>以前に使用したインデックスを使用して、テーブル<code class="literal">employees</code>をクラスタ化します。
</p><pre class="programlisting">CLUSTER employees;</pre><p>
  </p><p>データベース内の、以前にクラスタ化されたテーブルを全てクラスタ化します。
</p><pre class="programlisting">CLUSTER;</pre></div><div class="refsect1" id="id-1.9.3.48.9"><h2>互換性</h2><p>標準SQLには<code class="command">CLUSTER</code>文はありません。
  </p><pre class="synopsis">CLUSTER <em class="replaceable"><code>index_name</code></em> ON <em class="replaceable"><code>table_name</code></em></pre><p>
という構文も、8.3より前のバージョンの<span class="productname">PostgreSQL</span>との互換性のためサポートされます。
  </p></div><div class="refsect1" id="id-1.9.3.48.10"><h2>関連項目</h2><span class="simplelist"><a class="xref" href="app-clusterdb.html" title="clusterdb"><span class="refentrytitle"><span class="application">clusterdb</span></span></a></span></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="sql-close.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="sql-commands.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="sql-comment.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">CLOSE </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> COMMENT</td></tr></table></div></body></html>