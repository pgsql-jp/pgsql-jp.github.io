<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>18.2. データベースクラスタの作成</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="postgres-user.html" title="18.1. PostgreSQLユーザアカウント" /><link rel="next" href="server-start.html" title="18.3. データベースサーバの起動" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">18.2. データベースクラスタの作成</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="postgres-user.html" title="18.1. PostgreSQLユーザアカウント">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="runtime.html" title="Chapter 18. サーバの準備と運用">Up</a></td><th width="60%" align="center">Chapter 18. サーバの準備と運用</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="server-start.html" title="18.3. データベースサーバの起動">Next</a></td></tr></table><hr></hr></div><div class="sect1" id="CREATING-CLUSTER"><div class="titlepage"><div><div><h2 class="title" style="clear: both">18.2. データベースクラスタの作成</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="creating-cluster.html#CREATING-CLUSTER-MOUNT-POINTS">18.2.1. セカンダリファイルシステムの使用</a></span></dt><dt><span class="sect2"><a href="creating-cluster.html#CREATING-CLUSTER-NFS">18.2.2. ネットワークファイルシステムの使用</a></span></dt></dl></div><a id="id-1.6.5.4.2" class="indexterm"></a><a id="id-1.6.5.4.3" class="indexterm"></a><p>まず最初に、ディスク上にデータベース格納領域を初期化する必要があります。
この格納領域を<em class="firstterm">データベースクラスタ</em>と呼びます。（標準<acronym class="acronym">SQL</acronym>ではカタログクラスタという用語が使用されています）。
データベースクラスタはデータベースの集合で、稼働しているデータベースサーバのただ一つのインスタンスを通して管理されます。
初期化が終わると、データベースクラスタには<code class="literal">postgres</code>という名前のデータベースが含まれています。
このデータベースは、ユーティリティ、ユーザ、サードパーティ製アプリケーションが使用するデフォルトデータベースになります。
データベースサーバ自身はこの<code class="literal">postgres</code>データベースの存在を必要としていませんが、多くの外部ユーティリティはその存在を想定しています。
初期化中に他にも<code class="literal">template1</code>というデータベースが各クラスタ内に作成されます。
その名前から推測できるように、これはその後に作成されるデータベースのテンプレートとして使われます。
したがって、実際の作業に使用しない方がよいです。
（クラスタ内における新しいデータベースの作成については<a class="xref" href="managing-databases.html" title="Chapter 22. データベース管理">Chapter 22</a>を参照してください。）
  </p><p>ファイルシステムの観点から見ると、データベースクラスタというのは、すべてのデータが格納される1つのディレクトリということになります。
これは<em class="firstterm">データディレクトリ</em>もしくは<em class="firstterm">データ領域</em>と呼ばれます。
どこにデータを格納するかは完全にユーザの自由です。
特にデフォルトの領域はありませんが、一般的によく使われるのは<code class="filename">/usr/local/pgsql/data</code>か<code class="filename">/var/lib/pgsql/data</code>です。
データベースクラスタを初期化するためには、<span class="productname">PostgreSQL</span>と一緒にインストールされるコマンド<a class="xref" href="app-initdb.html" title="initdb"><span class="refentrytitle">initdb</span></a><a id="id-1.6.5.4.5.7" class="indexterm"></a>を使用してください。
データベースクラスタのファイルシステム上の場所は<code class="option">-D</code>オプションで示します。
例えば次のようにします。
</p><pre class="screen"><code class="prompt">$</code> <strong class="userinput"><code>initdb -D /usr/local/pgsql/data</code></strong></pre><p>
このコマンドは、前節で説明した<span class="productname">PostgreSQL</span>ユーザアカウントでログインして実行する必要があります。
  </p><div class="tip"><h3 class="title">Tip</h3><p><code class="option">-D</code>オプションを使う代わりに<code class="envar">PGDATA</code>環境変数を設定することもできます。
    <a id="id-1.6.5.4.6.1.3" class="indexterm"></a>
   </p></div><p>他にも以下のように<a class="xref" href="app-pg-ctl.html" title="pg_ctl"><span class="refentrytitle"><span class="application">pg_ctl</span></span></a><a id="id-1.6.5.4.7.2" class="indexterm"></a>プログラム経由で<code class="command">initdb</code>を実行することができます。
</p><pre class="screen"><code class="prompt">$</code> <strong class="userinput"><code>pg_ctl -D /usr/local/pgsql/data initdb</code></strong></pre><p>
<code class="command">pg_ctl</code>がデータベースサーバインスタンスの管理に使用する単一のコマンドになりますので、サーバの起動や停止に<code class="command">pg_ctl</code>を使用している場合(<a class="xref" href="server-start.html" title="18.3. データベースサーバの起動">Section 18.3</a>参照)はこちらの方がより直感的かもしれません。
  </p><p>もし指定したディレクトリが存在しない場合は、<code class="command">initdb</code>はその新しいディレクトリを作成しようとします。
もちろん、その親ディレクトリに書き込み権限がない場合<code class="command">initdb</code>は失敗します。
<span class="productname">PostgreSQL</span>ユーザがデータディレクトリだけでなく、親ディレクトリも所有することを一般的に推奨します。
このようにすると問題になることはありません。
目的の親ディレクトリが存在しない場合は、まずそのディレクトリを作成する必要があります。
親の親ディレクトリが書き込み可能でない場合は、root権限を使用して作成します。
そのため、手順は下記のようになります。
</p><pre class="screen">root# <strong class="userinput"><code>mkdir /usr/local/pgsql</code></strong>
root# <strong class="userinput"><code>chown postgres /usr/local/pgsql</code></strong>
root# <strong class="userinput"><code>su postgres</code></strong>
postgres$ <strong class="userinput"><code>initdb -D /usr/local/pgsql/data</code></strong></pre><p>
  </p><p>データディレクトリが存在し、すでにファイルが含まれている場合は、<code class="command">initdb</code>は実行を拒否します。これは、誤って既存のインストールを上書きしないようにするためです。
  </p><p>データディレクトリにはデータベースの中のすべてのデータが保持されるため、権限を持たない人からのアクセスを確実に制限することが不可欠です。
ですから、<code class="command">initdb</code>は<span class="productname">PostgreSQL</span>ユーザ以外からアクセス権を剥奪します。
  </p><p>しかし、ディレクトリの内容は安全ですが、デフォルトのクライアント認証の設定では、すべてのローカルユーザはデータベースに接続でき、データベーススーパーユーザになることさえ可能です。
他のローカルユーザを信用しない場合、<code class="command">initdb</code>の<code class="option">-W</code>、<code class="option">--pwprompt</code>、<code class="option">--pwfile</code>オプションのいずれか1つを使用して、データベーススーパーユーザにパスワードを付与することを推奨します。
   <a id="id-1.6.5.4.11.5" class="indexterm"></a>
また、デフォルトの<code class="literal">trust</code>認証モードを使用しないように、<code class="option">-A md5</code>もしくは<code class="option">-A password</code>を指定してください。
もしくは、<code class="command">initdb</code>の後、初回のサーバの起動の<span class="emphasis"><em>前</em></span>に、生成済みの<code class="filename">pg_hba.conf</code>ファイルを変更してください。
（他の穏当な方法として、<code class="literal">peer</code>認証やファイルシステムの権限を使用して、接続を制限することもできます。
詳細については<a class="xref" href="client-authentication.html" title="Chapter 20. クライアント認証">Chapter 20</a>を参照してください。）
  </p><p><code class="command">initdb</code>はまた、データベースクラスタのデフォルトのロケール<a id="id-1.6.5.4.12.2" class="indexterm"></a>を初期化します。
通常は、環境のロケール設定を初期化されたデータベースにそのまま適用します。
データベースに異なるロケールを指定することも可能です。
詳細については<a class="xref" href="locale.html" title="23.1. ロケールのサポート">Section 23.1</a>を参照してください。
特定のデータベースクラスタ内で使用されるデフォルトのソート順は<code class="command">initdb</code>で設定されます。
異なるソート順を使用する新しいデータベースを作成することもできますが、initdbが作成するテンプレートデータベースで使用される順は削除して再作成しない限り変更することができません。
また、<code class="literal">C</code>や<code class="literal">POSIX</code>以外のロケールを使用する場合には性能上の影響もあります。
ですので初回にこれを正しく選択することが重要です。
  </p><p>また<code class="command">initdb</code>は、データベースクラスタのデフォルトの文字セット符号化方式も設定します。
通常これは、ロケールの設定と合うものが選ばれなければなりません。
詳細は<a class="xref" href="multibyte.html" title="23.3. 文字セットサポート">Section 23.3</a>を参照してください。
  </p><p>非<code class="literal">C</code>および非<code class="literal">POSIX</code>のロケールでは、文字セットのソート順はオペレーティングシステムの照合ライブラリに依存しています。
これは、インデックスに格納されているキーの順序を制御します。
このためにクラスタは、スナップショットのリストア、バイナリストリーミングレプリケーション、異なるオペレーティングシステム、またはオペレーティングシステムのアップグレードのいずれでも互換性のない照合ライブラリバージョンに切り替えることは出来ません。
  </p><div class="sect2" id="CREATING-CLUSTER-MOUNT-POINTS"><div class="titlepage"><div><div><h3 class="title">18.2.1. セカンダリファイルシステムの使用</h3></div></div></div><a id="id-1.6.5.4.15.2" class="indexterm"></a><p>多くのインストールでは、マシンの<span class="quote">“<span class="quote">ルート</span>”</span>ボリューム以外のファイルシステム（ボリューム）上にデータベースクラスタを作成します。
この選択をした場合、セカンダリボリュームの最上位ディレクトリ（マウントポイント）をデータディレクトリとして使用することはお勧めできません。
最善の方法はマウントポイントディレクトリ内に<span class="productname">PostgreSQL</span>ユーザが所有するディレクトリを作成し、その中にデータディレクトリを作成することです。
これにより、権限の問題、特に<span class="application">pg_upgrade</span>などの操作での問題を避けることができ、またセカンダリボリュームがオフラインになったときに、確実にきれいなエラーを起こすようになります。
   </p></div><div class="sect2" id="CREATING-CLUSTER-NFS"><div class="titlepage"><div><div><h3 class="title">18.2.2. ネットワークファイルシステムの使用</h3></div></div></div><a id="id-1.6.5.4.16.2" class="indexterm"></a><a id="id-1.6.5.4.16.3" class="indexterm"></a><a id="id-1.6.5.4.16.4" class="indexterm"></a><p>多くのインストレーションはネットワークファイルシステム上にデータベースクラスタを作成します。
直接<acronym class="acronym">NFS</acronym>を介して行うこともありますし、<acronym class="acronym">NFS</acronym>を内部的に使うネットワークアタッチドストレージ（<acronym class="acronym">NAS</acronym>）デバイスを使用することもあります。
<span class="productname">PostgreSQL</span>は<acronym class="acronym">NFS</acronym>ファイルシステムに特別なことを何も行いません。
つまり<acronym class="acronym">NFS</acronym>はローカル接続のドライブとまったく同様に振る舞うという前提です。
クライアントとサーバの<acronym class="acronym">NFS</acronym>実装が標準ファイルシステム・セマンティックスを持たないならば、信頼性の問題を引き起こす可能性があります。
（<a class="ulink" href="http://www.time-travellers.org/shane/papers/NFS_considered_harmful.html" target="_top">http://www.time-travellers.org/shane/papers/NFS_considered_harmful.html</a>参照）。
具体的には、<acronym class="acronym">NFS</acronym>サーバへの遅延（非同期）書きこみがデータ破損の問題を引き起こす可能性があります。
可能ならば<acronym class="acronym">NFS</acronym>ファイルシステムを（キャッシュ無しで）同期マウントし、この危険を防止してください。更に、<acronym class="acronym">NFS</acronym>をソフトマウントすることは薦められません。
   </p><p>ストレージエリアネットワーク（<acronym class="acronym">SAN</acronym>）は通常<acronym class="acronym">NFS</acronym>とは異なる通信プロトコルを使用し、この種の危険がある場合と無い場合があります。
これは、データの整合性の保証に関するベンダのドキュメントを参照することをお勧めします。
<span class="productname">PostgreSQL</span>は、使用しているファイルシステム以上に信頼性が高くなることはありません。
   </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="postgres-user.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="runtime.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="server-start.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">18.1. <span class="productname">PostgreSQL</span>ユーザアカウント </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 18.3. データベースサーバの起動</td></tr></table></div></body></html>