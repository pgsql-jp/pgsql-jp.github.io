<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>SPI_prepare</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="spi-spi-execute-with-args.html" title="SPI_execute_with_args" /><link rel="next" href="spi-spi-prepare-cursor.html" title="SPI_prepare_cursor" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">SPI_prepare</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="spi-spi-execute-with-args.html" title="SPI_execute_with_args">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="spi-interface.html" title="46.1. インタフェース関数">Up</a></td><th width="60%" align="center">46.1. インタフェース関数</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="spi-spi-prepare-cursor.html" title="SPI_prepare_cursor">Next</a></td></tr></table><hr></hr></div><div class="refentry" id="SPI-SPI-PREPARE"><div class="titlepage"></div><a id="id-1.8.12.9.7.1" class="indexterm"></a><div class="refnamediv"><h2><span class="refentrytitle">SPI_prepare</span></h2><p>SPI_prepare — 文を準備する。文の実行はまだ行わない</p></div><div class="refsynopsisdiv"><h2>Synopsis</h2><pre class="synopsis">SPIPlanPtr SPI_prepare(const char * <em class="parameter"><code>command</code></em>, int <em class="parameter"><code>nargs</code></em>, Oid * <em class="parameter"><code>argtypes</code></em>)</pre></div><div class="refsect1" id="id-1.8.12.9.7.5"><h2>説明</h2><p><code class="function">SPI_prepare</code>は指定したコマンド用の準備済み文を作成し、それを返します。
しかし、そのコマンドは実行しません。
その準備済み文は<code class="function">SPI_execute_plan</code>を使って後で繰り返し実行できます。
  </p><p>同じ、あるいは類似のコマンドが繰り返し実行される場合、一度だけ解析を計画作成を行うことには一般に利点があります。
また、コマンドの実行計画を再利用することにはさらに利点があるかも知れません。
<code class="function">SPI_prepare</code>はコマンド文字列を、解析結果をカプセル化した準備済み文に変換します。
実行の度に独自計画を生成するのが役に立たないと分かった場合には、準備済み文は実行計画をキャッシュする場所も提供します。
  </p><p>プリペアドコマンドは、通常のコマンド内の定数となる場所を（<code class="literal">$1</code>、<code class="literal">$2</code>などの）パラメータで記述することで一般化することができます。
そしてパラメータの実際の値は、<code class="function">SPI_execute_plan</code> が呼び出される時に指定されます。
これにより、プリペアドコマンドは、パラメータがない場合に比べ、より広範な状況で使用できるようになります。
  </p><p><code class="function">SPI_finish</code>は文用に割り当てられたメモリを解放しますので、<code class="function">SPI_prepare</code>で返される文は、そのプロシージャの現在の呼び出し内でのみ使用することができます。
しかし、関数<code class="function">SPI_keepplan</code>や<code class="function">SPI_saveplan</code>を使用して長期間文を保存することもできます。
  </p></div><div class="refsect1" id="id-1.8.12.9.7.6"><h2>引数</h2><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">const char * <em class="parameter"><code>command</code></em></code></span></dt><dd><p>コマンド文字列
     </p></dd><dt><span class="term"><code class="literal">int <em class="parameter"><code>nargs</code></em></code></span></dt><dd><p>入力パラメータ（<code class="literal">$1</code>、<code class="literal">$2</code>など）の数
     </p></dd><dt><span class="term"><code class="literal">Oid * <em class="parameter"><code>argtypes</code></em></code></span></dt><dd><p>パラメータのデータ型の<acronym class="acronym">OID</acronym>を持つ配列へのポインタ
     </p></dd></dl></div></div><div class="refsect1" id="id-1.8.12.9.7.7"><h2>戻り値</h2><p><code class="function">SPI_prepare</code>は<code class="type">SPIPlan</code>への非NULLのポインタを返します。
ここで<code class="type">SPIPlan</code>は準備済み文を表すopaque構造体です
エラーの場合、<code class="symbol">NULL</code>が返され、<code class="function">SPI_execute</code>で使用されるエラーコードと同じコードの1つが<code class="varname">SPI_result</code>に設定されます。
しかし、<em class="parameter"><code>command</code></em>が<code class="symbol">NULL</code>の場合や、<em class="parameter"><code>nargs</code></em>が0未満の場合、<em class="parameter"><code>nargs</code></em>が0より大きくかつ<em class="parameter"><code>argtypes</code></em>が<code class="symbol">NULL</code>の場合は、<code class="symbol">SPI_ERROR_ARGUMENT</code>に設定されます。
  </p></div><div class="refsect1" id="id-1.8.12.9.7.8"><h2>注意</h2><p>パラメータが定義されていなければ、<code class="function">SPI_execute_plan</code>が最初に使用された時に一般的な計画が作成され、以降の実行すべてでも利用されます。
パラメータがあれば、始めの何回かの<code class="function">SPI_execute_plan</code>の使用で、与えられたパラメータの値に固有の独自計画が作成されます。
同じ準備済み文が十分に使用された後、<code class="function">SPI_execute_plan</code>は一般的な計画を作成し、独自計画よりもそれほど高価でなければ、毎回再計画する代わりに一般的な計画を使い始めるようになります。
このデフォルトの動作が不適切であれば、<code class="function">SPI_prepare_cursor</code>に<code class="literal">CURSOR_OPT_GENERIC_PLAN</code>または<code class="literal">CURSOR_OPT_CUSTOM_PLAN</code>フラグを設定することで、それぞれ一般的な計画か独自計画を強制的に利用するよう変更できます。
  </p><p>プリペアド文の主要な利点は、文の解析処理と計画作成処理の繰り返しを防止することですが、<span class="productname">PostgreSQL</span>では、以前にそのプリペアド文を使用してから、文の中で使用されているデータベースオブジェクトが定義（DDL）の変更を受けた時は常に再解析処理と計画再作成処理を強制します。
また、一度使用してから<a class="xref" href="runtime-config-client.html#GUC-SEARCH-PATH">search_path</a>の値が変わった場合も、文は新しい<code class="varname">search_path</code>を使用して再解析されます。
（後者の振る舞いは<span class="productname">PostgreSQL</span> 9.3の時に追加されました。）
プリペアド文の動作については<a class="xref" href="sql-prepare.html" title="PREPARE"><span class="refentrytitle">PREPARE</span></a>を参照してください。
  </p><p>この関数は接続済みのプロシージャからのみ呼び出してください。
  </p><p><code class="type">SPIPlanPtr</code>は<code class="filename">spi.h</code>内でopaque構造体型へのポインタとして宣言されています。
たいていの場合将来のバージョンの<span class="productname">PostgreSQL</span>でそのコードが壊れてしまうため、この内容に直接アクセスすることは避けてください。
  </p><p>そのデータ構造はもはや実行計画を含むとは限りませんので、<code class="type">SPIPlanPtr</code>という名前はいくらか歴史的なものです。
  </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="spi-spi-execute-with-args.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="spi-interface.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="spi-spi-prepare-cursor.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">SPI_execute_with_args </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> SPI_prepare_cursor</td></tr></table></div></body></html>