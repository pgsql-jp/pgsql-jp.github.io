<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>UPDATE</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="sql-unlisten.html" title="UNLISTEN" /><link rel="next" href="sql-vacuum.html" title="VACUUM" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">UPDATE</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="sql-unlisten.html" title="UNLISTEN">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="sql-commands.html" title="SQLコマンド">Up</a></td><th width="60%" align="center">SQLコマンド</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="sql-vacuum.html" title="VACUUM">Next</a></td></tr></table><hr></hr></div><div class="refentry" id="SQL-UPDATE"><div class="titlepage"></div><a id="id-1.9.3.176.1" class="indexterm"></a><div class="refnamediv"><h2><span class="refentrytitle">UPDATE</span></h2><p>UPDATE — テーブルの行を更新する</p></div><div class="refsynopsisdiv"><h2>Synopsis</h2><pre class="synopsis">[ WITH [ RECURSIVE ] <em class="replaceable"><code>with_query</code></em> [, ...] ]
UPDATE [ ONLY ] <em class="replaceable"><code>table_name</code></em> [ * ] [ [ AS ] <em class="replaceable"><code>alias</code></em> ]
    SET { <em class="replaceable"><code>column_name</code></em> = { <em class="replaceable"><code>expression</code></em> | DEFAULT } |
          ( <em class="replaceable"><code>column_name</code></em> [, ...] ) = [ ROW ] ( { <em class="replaceable"><code>expression</code></em> | DEFAULT } [, ...] ) |
          ( <em class="replaceable"><code>column_name</code></em> [, ...] ) = ( <em class="replaceable"><code>sub-SELECT</code></em> )
        } [, ...]
    [ FROM <em class="replaceable"><code>from_list</code></em> ]
    [ WHERE <em class="replaceable"><code>condition</code></em> | WHERE CURRENT OF <em class="replaceable"><code>cursor_name</code></em> ]
    [ RETURNING * | <em class="replaceable"><code>output_expression</code></em> [ [ AS ] <em class="replaceable"><code>output_name</code></em> ] [, ...] ]</pre></div><div class="refsect1" id="id-1.9.3.176.5"><h2>説明</h2><p><code class="command">UPDATE</code>は、条件を満たす全ての行の指定した列の値を変更します。
<code class="literal">SET</code>句には、変更する列のみを指定する必要があります。
<code class="literal">SET</code>句にて明示的に指定されなかった列の値は変更されません。
  </p><p>データベース内の他のテーブルの情報を使用してテーブルを変更するには、2つの方法があります。
1つは副問い合わせを使用する方法、もう1つは<code class="literal">FROM</code>句で追加のテーブルを指定する方法です。
どちらの方法が適切であるかは状況次第です。
  </p><p><code class="literal">RETURNING</code>句を指定すると、<code class="command">UPDATE</code>は実際に更新された各行に基づいて計算された値を返すようになります。
そのテーブルの列および<code class="literal">FROM</code>で指定された他のテーブルの列を使用した式を計算することができます。
テーブル列の新しい（更新された後の）値が使用されます。
<code class="literal">RETURNING</code>リストの構文は<code class="command">SELECT</code>の出力リストと同一です。
  </p><p>更新を行うためには、そのテーブルまたは少なくとも更新対象の列について<code class="literal">UPDATE</code>権限を持たなければなりません。
また<em class="replaceable"><code>expressions</code></em>や<em class="replaceable"><code>condition</code></em>で値を読み込む列に対する<code class="literal">SELECT</code>権限も必要になります。
  </p></div><div class="refsect1" id="id-1.9.3.176.6"><h2>パラメータ</h2><div class="variablelist"><dl class="variablelist"><dt><span class="term"><em class="replaceable"><code>with_query</code></em></span></dt><dd><p><code class="literal">WITH</code>句により<code class="command">UPDATE</code>問い合わせ内で名前で参照可能な１つ以上の副問い合わせを指定することができます。
<a class="xref" href="queries-with.html" title="7.8. WITH問い合わせ（共通テーブル式）">Section 7.8</a>と<a class="xref" href="sql-select.html" title="SELECT"><span class="refentrytitle">SELECT</span></a>を参照してください。
     </p></dd><dt><span class="term"><em class="replaceable"><code>table_name</code></em></span></dt><dd><p>更新対象のテーブルの名前です（スキーマ修飾名でも可）。
テーブルの前に<code class="literal">ONLY</code>を指定すると、指名されたテーブルでのみマッチする行が更新されます。
<code class="literal">ONLY</code>を指定しないと、指名したテーブルから継承されたすべてのテーブルでもマッチする行が同時に更新されます。
オプションで、テーブル名の後に<code class="literal">*</code>を指定して、明示的に子テーブルが含まれることを示すこともできます。
     </p></dd><dt><span class="term"><em class="replaceable"><code>alias</code></em></span></dt><dd><p>対象テーブルの代替名です。
別名が指定されると、テーブルの実際の名前は完全に隠蔽されます。
たとえば、<code class="literal">UPDATE foo AS f</code>では、<code class="command">UPDATE</code>文の残りの部分では<code class="literal">foo</code>ではなく<code class="literal">f</code>としてこのテーブルを参照しなければなりません。
     </p></dd><dt><span class="term"><em class="replaceable"><code>column_name</code></em></span></dt><dd><p><em class="replaceable"><code>table_name</code></em>で指名されたテーブル内の列名です。
必要に応じて、列名を副フィールド名や配列の指示子で修飾することも可能です。
対象列の指定にはテーブル名を含めないでください。
たとえば、<code class="literal">UPDATE table_name SET table_name.col = 1</code>は無効です。
     </p></dd><dt><span class="term"><em class="replaceable"><code>expression</code></em></span></dt><dd><p>列に代入する式です。
この式では、テーブル内の対象列やその他の列の変更前の値を使用することができます。
     </p></dd><dt><span class="term"><code class="literal">DEFAULT</code></span></dt><dd><p>      列にデフォルト値を設定します
      （デフォルト式が割り当てられていない場合はNULLになります）。
     </p></dd><dt><span class="term"><em class="replaceable"><code>sub-SELECT</code></em></span></dt><dd><p>その前の括弧内の列リストに列挙されているのと同じ数の出力列を生成する<code class="literal">SELECT</code>副問い合わせです。
副問い合わせは実行時に最大でも1行しか生成してはいけません。
1行だけ生成されたときは、各列の値が対象の列に代入されます。
1行も生成されなかったときは、対象の列にNULL値が代入されます。
副問い合わせは、更新対象のテーブルの現在行の古い値を参照することができます。
     </p></dd><dt><span class="term"><em class="replaceable"><code>from_list</code></em></span></dt><dd><p><code class="literal">WHERE</code>条件や更新用の式において、他のテーブルの列を指定するために使用するテーブル式の集合です。
これは<code class="command">SELECT</code>文の<a class="xref" href="sql-select.html#SQL-FROM" title="FROM句"><code class="literal">FROM</code>句</a>で指定するテーブルのリストに似ています。
自己結合を行う場合を除き、<em class="replaceable"><code>from_list</code></em>に更新対象のテーブルを含めてはいけません。
（自己結合を行う場合は、<em class="replaceable"><code>from_list</code></em>内で更新対象のテーブルとその別名を指定しておく必要があります）。
     </p></dd><dt><span class="term"><em class="replaceable"><code>condition</code></em></span></dt><dd><p>      <code class="type">boolean</code>型の値を返す式です。
      この式が<code class="literal">true</code>を返す行のみが更新されます。
     </p></dd><dt><span class="term"><em class="replaceable"><code>cursor_name</code></em></span></dt><dd><p><code class="literal">WHERE CURRENT OF</code>条件で使用されるカーソルの名前です。
更新対象の行は、そのカーソルからもっとも最近に取り出された行です。
カーソルは<code class="command">UPDATE</code>の対象テーブルに対するグループ化のない問い合わせでなければなりません。
<code class="literal">WHERE CURRENT OF</code>を論理条件といっしょに指定することはできません。
<code class="literal">WHERE CURRENT OF</code>付きのカーソル使用に関する情報については<a class="xref" href="sql-declare.html" title="DECLARE"><span class="refentrytitle">DECLARE</span></a>を参照してください。
     </p></dd><dt><span class="term"><em class="replaceable"><code>output_expression</code></em></span></dt><dd><p>各行を更新した後に計算され、<code class="command">UPDATE</code>によって返される式です。
この式には、<em class="replaceable"><code>table_name</code></em>または<code class="literal">FROM</code>で指定したテーブル（複数可）の任意の列名を使用することができます。
すべての列を返す場合は<code class="literal">*</code>と記載してください。
     </p></dd><dt><span class="term"><em class="replaceable"><code>output_name</code></em></span></dt><dd><p>返される列で使用される名前です。
     </p></dd></dl></div></div><div class="refsect1" id="id-1.9.3.176.7"><h2>出力</h2><p>正常に処理が終わると、<code class="command">UPDATE</code>コマンドは以下の形式のコマンドタグを返します。
</p><pre class="screen">UPDATE <em class="replaceable"><code>count</code></em></pre><p>
<em class="replaceable"><code>count</code></em>は、合致したが変更されなかった行を含む、更新された行数を意味します。
<code class="literal">BEFORE UPDATE</code>トリガにより更新が抑制された場合に、<em class="replaceable"><code>condition</code></em>に合致した行数より少なくなる可能性があることに注意してください。
<em class="replaceable"><code>count</code></em>が0の場合は<em class="replaceable"><code>condition</code></em>に一致する行がなかったことを意味します
（これはエラーとはみなされません）。
  </p><p><code class="command">UPDATE</code>コマンドが<code class="literal">RETURNING</code>句を持つ場合、その結果は、<code class="literal">RETURNING</code>リストで定義した列と値を持ち、そのコマンドで更新された行全体に対して計算を行う<code class="command">SELECT</code>文の結果と似たものになるでしょう。
  </p></div><div class="refsect1" id="id-1.9.3.176.8"><h2>注釈</h2><p><code class="literal">FROM</code>句が存在する場合、基本的に、対象テーブルと<em class="replaceable"><code>from_list</code></em>で指定されたテーブルが結合され、この結合の出力行が対象テーブルの更新操作の結果となります。
<code class="literal">FROM</code>句を使用する場合、更新対象テーブルの1行に対して、結合結果が複数行にならないように注意してください。
言い換えると、対象テーブルの個々の行は、他テーブルの複数の行と結合すべきではありません。
結合結果が複数行になった場合、対象行の更新には結合結果のいずれか1行のみが使用されますが、どの行が使用されるかは簡単には予測できません。
  </p><p>このような不定性の問題があるため、他テーブルの参照は副問い合わせ内のみに留めておいた方がより安全です（ただし、結合よりも可読性や実行速度は低下します）。
  </p><p>パーティションテーブルの場合、行を更新することによってそのパーティションの制約を満たさなくなることがありえます。
パーティショニングのキーの新しい値に対して適切なパーティションに行を移動する仕組みがないため、この場合にはエラーが発生します。
これはパーティションを直接更新する場合にも起こります。
  </p></div><div class="refsect1" id="id-1.9.3.176.9"><h2>例</h2><p><code class="structname">films</code>テーブルの<code class="structfield">kind</code>列にある<code class="literal">Drama</code>という単語を<code class="literal">Dramatic</code>に変更します。

</p><pre class="programlisting">UPDATE films SET kind = 'Dramatic' WHERE kind = 'Drama';</pre><p>
  </p><p><code class="structname">weather</code>テーブルの特定の行に対し、気温に関する項目を調整し、降水量をデフォルト値に戻します。

</p><pre class="programlisting">UPDATE weather SET temp_lo = temp_lo+1, temp_hi = temp_lo+15, prcp = DEFAULT
  WHERE city = 'San Francisco' AND date = '2003-07-03';</pre><p>
  </p><p>同じ操作を行い、更新された項目を返します。

</p><pre class="programlisting">UPDATE weather SET temp_lo = temp_lo+1, temp_hi = temp_lo+15, prcp = DEFAULT
  WHERE city = 'San Francisco' AND date = '2003-07-03'
  RETURNING temp_lo, temp_hi, prcp;</pre><p>
  </p><p>もう一つの方法である列リスト構文を使用して同じ更新を行います。
</p><pre class="programlisting">UPDATE weather SET (temp_lo, temp_hi, prcp) = (temp_lo+1, temp_lo+15, DEFAULT)
  WHERE city = 'San Francisco' AND date = '2003-07-03';</pre><p>
  </p><p><code class="literal">FROM</code>句の構文を使用して、Acme Corporationを顧客とするセールスマンのセールスカウントを1増加させます。
</p><pre class="programlisting">UPDATE employees SET sales_count = sales_count + 1 FROM accounts
  WHERE accounts.name = 'Acme Corporation'
  AND employees.id = accounts.sales_person;</pre><p>
  </p><p><code class="literal">WHERE</code>句で副問い合わせを使用して、同じ操作を行います。
</p><pre class="programlisting">UPDATE employees SET sales_count = sales_count + 1 WHERE id =
  (SELECT sales_person FROM accounts WHERE name = 'Acme Corporation');</pre><p>
  </p><p>accountsテーブルのコンタクト先の氏名を、現在アサインされているセールスマンと一致するよう更新します。
</p><pre class="programlisting">UPDATE accounts SET (contact_first_name, contact_last_name) =
    (SELECT first_name, last_name FROM salesmen
     WHERE salesmen.id = accounts.sales_id);</pre><p>
同じような結果は結合を使っても得ることができます。
</p><pre class="programlisting">UPDATE accounts SET contact_first_name = first_name,
                    contact_last_name = last_name
  FROM salesmen WHERE salesmen.id = accounts.sales_id;</pre><p>
ただし、<code class="structname">salesmen</code>.<code class="structfield">id</code>が一意キーでない場合、2番目の問い合わせは予期しない結果をもたらすかもしれません。
一方で、最初の問い合わせは、複数の<code class="structfield">id</code>がマッチしたときはエラーを発生することが保証されます。
また、ある<code class="structname">accounts</code>.<code class="structfield">sales_id</code>エントリにマッチするレコードがない場合、最初の問い合わせは対応する名前フィールドをNULLに設定しますが、2番目の問い合わせは、その行を全く更新しません。
  </p><p>summaryテーブルの統計情報を現在のデータに合うように更新します。
</p><pre class="programlisting">UPDATE summary s SET (sum_x, sum_y, avg_x, avg_y) =
    (SELECT sum(x), sum(y), avg(x), avg(y) FROM data d
     WHERE d.group_id = s.group_id);</pre><p>
  </p><p>新しい商品とその在庫数を挿入します。
既にその商品が存在している場合は、代わりに既存商品の在庫数を更新します。
トランザクション全体が失敗することがないようにこの操作を行うには、セーブポイントを使用してください。
</p><pre class="programlisting">BEGIN;
-- 何かしらの他の操作を行います。
SAVEPOINT sp1;
INSERT INTO wines VALUES('Chateau Lafite 2003', '24');
-- 上記のコマンドが一意キー違反により失敗したとします。
-- この場合、次のコマンドを実行します。
ROLLBACK TO sp1;
UPDATE wines SET stock = stock + 24 WHERE winename = 'Chateau Lafite 2003';
-- 他の操作を続けた後、最後に次を実行します。
COMMIT;</pre><p>
  </p><p><code class="structname">films</code>テーブルにおいて、<code class="literal">c_films</code>カーソルが現在位置している行の<code class="structfield">kind</code>列を変更します。
</p><pre class="programlisting">UPDATE films SET kind = 'Dramatic' WHERE CURRENT OF c_films;</pre></div><div class="refsect1" id="id-1.9.3.176.10"><h2>互換性</h2><p>このコマンドは標準<acronym class="acronym">SQL</acronym>に準拠しています。
ただし<code class="literal">FROM</code>句および<code class="literal">RETURNING</code>句は<span class="productname">PostgreSQL</span>の拡張です。
<code class="command">UPDATE</code>で<code class="literal">WITH</code>が使用可能であることも同様に拡張です。
  </p><p>他のデータベースシステムには、<code class="literal">FROM</code>オプション内で、対象テーブルが再度指定されることを前提として動作するものもあります。
これは<span class="productname">PostgreSQL</span>における<code class="literal">FROM</code>の解釈方法とは異なります。
この拡張機能を使用するアプリケーションを移植する時は注意してください。
  </p><p>標準に従うと、括弧内の対象列名の部分リストに対する入力値は、正しい数の列を生成する任意の行値による式です。
<span class="productname">PostgreSQL</span>では入力値として、<a class="link" href="sql-expressions.html#SQL-SYNTAX-ROW-CONSTRUCTORS" title="4.2.13. 行コンストラクタ">行コンストラクタ</a>あるいはsub-<code class="literal">SELECT</code>しか許していません。
行コンストラクタを使う場合、個々の列の更新値を<code class="literal">DEFAULT</code>として指定することができますが、sub-<code class="literal">SELECT</code>の内部ではできません。
  </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="sql-unlisten.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="sql-commands.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="sql-vacuum.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">UNLISTEN </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> VACUUM</td></tr></table></div></body></html>