<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Chapter 61. 汎用WALレコード</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="index-cost-estimation.html" title="60.6. インデックスコスト推定関数" /><link rel="next" href="gist.html" title="Chapter 62. GiSTインデックス" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">Chapter 61. 汎用WALレコード</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="index-cost-estimation.html" title="60.6. インデックスコスト推定関数">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="internals.html" title="Part VII. 内部情報">Up</a></td><th width="60%" align="center">Part VII. 内部情報</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="gist.html" title="Chapter 62. GiSTインデックス">Next</a></td></tr></table><hr></hr></div><div class="chapter" id="GENERIC-WAL"><div class="titlepage"><div><div><h2 class="title">Chapter 61. 汎用WALレコード</h2></div></div></div><p>組み込みのWALにログを書き込むすべてのモジュールは、それぞれに独自の型のWALレコードがありますが、ページへの変更を汎用的な方法で記述する汎用WALレコード型もあります。
カスタムアクセスメソッドを提供する拡張では、独自のWALの再実行(redo)ルーチンを登録できないため、汎用WALレコードが役立ちます。
  </p><p>汎用WALレコードを構築するためのAPIは<code class="filename">access/generic_xlog.h</code>に定義されており、<code class="filename">access/transam/generic_xlog.c</code>で実装されています。
  </p><p>汎用WALレコードの機能を使ってWAL書き込みを伴うデータ更新を行うには、以下の手順に従ってください。

   </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><code class="function">state = GenericXLogStart(relation)</code> により、指定のリレーションについての汎用WALレコードの構築を開始します。
     </p></li><li class="listitem"><p><code class="function">page = GenericXLogRegisterBuffer(state, buffer, flags)</code> により、現在の汎用WALレコード内で更新されるバッファを登録します。
この関数はバッファページの一時コピーへのポインタを返すので、更新はそれに対して行ってください。
（バッファの内容は直接更新しないでください。）
3番目の引数は、操作についてのフラグのビットマスクです。
現在のところ、使用できるフラグは<code class="literal">GENERIC_XLOG_FULL_IMAGE</code>のみで、これはWALレコードには変更の差分ではなく、ページ全体のイメージが含まれることを示します。
典型的には、このフラグはページが新しいか、あるいは完全に書き換えられるときにセットされます。
WAL書き込み対象の動作が複数のページを更新する必要がある場合は、<code class="function">GenericXLogRegisterBuffer</code>を繰り返すことができます。
     </p></li><li class="listitem"><p>前の手順で取得したページのイメージに更新を適用する。
     </p></li><li class="listitem"><p><code class="function">GenericXLogFinish(state)</code>により、バッファの変更を適用し、汎用WALレコードを送出する。
     </p></li></ol></div><p>
  </p><p>WALレコードの構築は、上記の手順内の間のどこででも、<code class="function">GenericXLogAbort(state)</code>を呼び出すことで中止できます。
これによりページイメージのコピーに対する変更はすべて廃棄されます。
  </p><p>汎用WALレコードの機能を使うときは、以下の点に注意してください。

   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>バッファの直接更新は許されません！
すべての更新は<code class="function">GenericXLogRegisterBuffer()</code>で取得したコピーに対して行わなければなりません。
言い換えれば、汎用WALレコードを使うコードでは<code class="function">BufferGetPage()</code>を呼び出してはいけません。
しかし、適切なときにバッファにピンを立てる、外す、そしてロックする、解除するのが呼び出し側の責任であることに変わりはありません。
各ターゲットバッファの排他的ロックを<code class="function">GenericXLogRegisterBuffer()</code>の前から<code class="function">GenericXLogFinish()</code>の後まで保持していなければなりません。
     </p></li><li class="listitem"><p>手順2のバッファの登録と、手順3のページイメージの更新は自由に混在させることができます。
つまり、両方の手順を任意の順序で繰り返すことができます。
バッファの登録は、再生時にロックを取得する順序と同じにすべきであることを覚えていてください。
     </p></li><li class="listitem"><p>汎用WALレコードに登録できるバッファの最大数は<code class="literal">MAX_GENERIC_XLOG_PAGES</code>です。
この制限を超えるとエラーが発生します。
     </p></li><li class="listitem"><p>汎用WALでは、更新対象のページが標準的なレイアウトになっている、特に<code class="structfield">pd_lower</code>と<code class="structfield">pd_upper</code>の間には意味のあるデータがないということを想定しています。
     </p></li><li class="listitem"><p>ここではバッファページのコピーを更新するため、<code class="function">GenericXLogStart()</code>はクリティカルセクションを開始しません。
従って、<code class="function">GenericXLogStart()</code>と<code class="function">GenericXLogFinish()</code>の間では、メモリの割り当て、エラーの発生などを安全に実行できます。
唯一の本当のクリティカルセクションは<code class="function">GenericXLogFinish()</code>の内部にあります。
エラー終了の中で<code class="function">GenericXLogAbort()</code>を呼び出すことについても心配する必要はありません。
     </p></li><li class="listitem"><p><code class="function">GenericXLogFinish()</code>はバッファをダーティにして、LSNの設定をすることの処理をします。
これについて明示的な処理をする必要はありません。
     </p></li><li class="listitem"><p>ログを取らないリレーションは、実際のWALレコードが送出されないことを除けば、すべてが同じように動作します。
従って、通常は、ログを取らないリレーションについて明示的な検査をする必要はありません。
     </p></li><li class="listitem"><p>汎用WALを再生する機能は、バッファの排他的ロックを、バッファが登録されたのと同じ順序で取得します。
すべての変更を再生した後で、ロックは同じ順序で解放されます。
     </p></li><li class="listitem"><p>登録バッファに<code class="literal">GENERIC_XLOG_FULL_IMAGE</code>が指定されない場合、汎用WALレコードは古いページイメージと新しいページイメージの間の差分を含むものとされます。
この差分はバイト毎の比較に基づくものです。
これはデータをページ内で移動する場合、あまり小さくなりませんが、将来は改善されるかもしれません。
     </p></li></ul></div><p>
  </p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="index-cost-estimation.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="internals.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="gist.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">60.6. インデックスコスト推定関数 </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 62. GiSTインデックス</td></tr></table></div></body></html>