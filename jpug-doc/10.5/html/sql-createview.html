<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>CREATE VIEW</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="sql-createusermapping.html" title="CREATE USER MAPPING" /><link rel="next" href="sql-deallocate.html" title="DEALLOCATE" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">CREATE VIEW</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="sql-createusermapping.html" title="CREATE USER MAPPING">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="sql-commands.html" title="SQLコマンド">Up</a></td><th width="60%" align="center">SQLコマンド</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="sql-deallocate.html" title="DEALLOCATE">Next</a></td></tr></table><hr></hr></div><div class="refentry" id="SQL-CREATEVIEW"><div class="titlepage"></div><a id="id-1.9.3.93.1" class="indexterm"></a><div class="refnamediv"><h2><span class="refentrytitle">CREATE VIEW</span></h2><p>CREATE VIEW — 新しいビューを定義する</p></div><div class="refsynopsisdiv"><h2>Synopsis</h2><pre class="synopsis">CREATE [ OR REPLACE ] [ TEMP | TEMPORARY ] [ RECURSIVE ] VIEW <em class="replaceable"><code>name</code></em> [ ( <em class="replaceable"><code>column_name</code></em> [, ...] ) ]
    [ WITH ( <em class="replaceable"><code>view_option_name</code></em> [= <em class="replaceable"><code>view_option_value</code></em>] [, ... ] ) ]
    AS <em class="replaceable"><code>query</code></em>
    [ WITH [ CASCADED | LOCAL ] CHECK OPTION ]</pre></div><div class="refsect1" id="id-1.9.3.93.5"><h2>説明</h2><p><code class="command">CREATE VIEW</code>は問い合わせによるビューを定義します。
ビューは物理的な実体として存在するものではありません。
その代わり、問い合わせでビューが参照される度に、指定された問い合わせが実行されます。
  </p><p><code class="command">CREATE OR REPLACE VIEW</code>も同様の働きをしますが、
このコマンドでは、同じ名前のビューが既に存在している場合、そのビューを置き換えます。
新しい問い合わせは、既存のビュー問い合わせが生成する列と同じ列(つまり、同じ順序の同じデータ型の同じ列名)を生成しなければなりません。
しかし、そのリストの最後に列を追加しても構いません。
出力列を生成する計算をまったく異なるものにしても構いません。
  </p><p>スキーマ名が付けられている場合（例えば、<code class="literal">CREATE VIEW myschema.myview ...</code>）、ビューは指定されたスキーマに作成されます。
スキーマ名がなければ、そのビューは現在のスキーマに作成されます。
一時ビューは特別なスキーマに作成されます。
そのため、一時ビューを作成する時にはスキーマ名を付けることはできません。
ビュー名は、同じスキーマ内の他のビュー、テーブル、シーケンス、インデックス、外部テーブルとは異なる名前である必要があります。
  </p></div><div class="refsect1" id="id-1.9.3.93.6"><h2>パラメータ</h2><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">TEMPORARY</code>または<code class="literal">TEMP</code></span></dt><dd><p>これが指定された場合、ビューは一時ビューとして作成されます。
現在のセッションが終わった時、一時ビューは自動的に削除されます。
一時ビューが存在する間、現在のセッションでは、これと同じ名前の永続リレーションはスキーマ修飾した名前で参照していない限り不可視です。
     </p><p>ビューで参照されるテーブルの一部が一時テーブルであった場合、（<code class="literal">TEMPORARY</code>の指定があってもなくても）ビューは一時ビューとして作成されます。
     </p></dd><dt><span class="term"><code class="literal">RECURSIVE</code></span></dt><dd><p>再帰的ビューを作成します。
</p><pre class="synopsis">CREATE RECURSIVE VIEW [ <em class="replaceable"><code>schema</code></em> . ] <em class="replaceable"><code>view_name</code></em> (<em class="replaceable"><code>column_names</code></em>) AS SELECT <em class="replaceable"><code>...</code></em>;</pre><p>
という構文は
</p><pre class="synopsis">CREATE VIEW [ <em class="replaceable"><code>schema</code></em> . ] <em class="replaceable"><code>view_name</code></em> AS WITH RECURSIVE <em class="replaceable"><code>view_name</code></em> (<em class="replaceable"><code>column_names</code></em>) AS (SELECT <em class="replaceable"><code>...</code></em>) SELECT <em class="replaceable"><code>column_names</code></em> FROM <em class="replaceable"><code>view_name</code></em>;</pre><p>
と同等です。
再帰的ビューではビューの列名リストを指定する必要があります。
     </p></dd><dt><span class="term"><em class="replaceable"><code>name</code></em></span></dt><dd><p>作成するビューの名前です（スキーマ修飾名も可）。
     </p></dd><dt><span class="term"><em class="replaceable"><code>column_name</code></em></span></dt><dd><p>ビューの列名として使用する名前のリストで、省略可能です。省略された場合、問い合わせに由来する名前が使用されます。
     </p></dd><dt><span class="term"><code class="literal">WITH ( <em class="replaceable"><code>view_option_name</code></em> [= <em class="replaceable"><code>view_option_value</code></em>] [, ... ] )</code></span></dt><dd><p>この句はビュー用のオプションのパラメータを指定します。
以下のパラメータがサポートされています。

      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">check_option</code> (<code class="type">string</code>)</span></dt><dd><p>このパラメータは<code class="literal">local</code>か<code class="literal">cascaded</code>のいずれかで、<code class="literal">WITH [ CASCADED | LOCAL ] CHECK OPTION</code>を指定するのと同じです(以下を参照)。
このオプションは、既存のビューについて<a class="xref" href="sql-alterview.html" title="ALTER VIEW"><span class="refentrytitle">ALTER VIEW</span></a>を使って変更することができます。
         </p></dd><dt><span class="term"><code class="literal">security_barrier</code> (<code class="type">boolean</code>)</span></dt><dd><p>行単位セキュリティを提供することを意図したビューでは、これを有効にしなければなりません。
詳細については<a class="xref" href="rules-privileges.html" title="40.5. ルールと権限">Section 40.5</a>を参照してください。
         </p></dd></dl></div><p>
     </p></dd><dt><span class="term"><em class="replaceable"><code>query</code></em></span></dt><dd><p>ビューの列と行を生成する<a class="xref" href="sql-select.html" title="SELECT"><span class="refentrytitle">SELECT</span></a>または<a class="xref" href="sql-values.html" title="VALUES"><span class="refentrytitle">VALUES</span></a>コマンドです。
     </p></dd><dt><span class="term"><code class="literal">WITH [ CASCADED | LOCAL ] CHECK OPTION</code>
      <a id="id-1.9.3.93.6.2.7.1.2" class="indexterm"></a>
      <a id="id-1.9.3.93.6.2.7.1.3" class="indexterm"></a>
    </span></dt><dd><p>このオプションは、自動的に更新可能なビューの動作を制御します。
このオプションが指定された場合、ビューに対する<code class="command">INSERT</code>および<code class="command">UPDATE</code>コマンドでは、新しい行がビュー定義の条件を満たすことが検査されます(つまり、新しい行がビューで見ることができるかどうか、検査されます)。
条件を満たさない場合、更新は拒絶されます。
<code class="literal">CHECK OPTION</code>が指定されない場合、ビューに対する<code class="command">INSERT</code>および<code class="command">UPDATE</code>コマンドは、ビューで見ることができない行を作ることができます。
以下のcheck optionがサポートされます。

      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">LOCAL</code></span></dt><dd><p>新しい行は、そのビュー自体に直接定義されている条件に対してのみ検査されます。
ビューが基にするビューについて定義されている条件は、(それらも<code class="literal">CHECK OPTION</code>を指定しているのでなければ)検査されません。
         </p></dd><dt><span class="term"><code class="literal">CASCADED</code></span></dt><dd><p>新しい行は、そのビュー、およびそれが基にするすべてのビューの条件に対して検査されます。
<code class="literal">CHECK OPTION</code>が指定され、<code class="literal">LOCAL</code>も<code class="literal">CASCADED</code>も指定されていないときは、<code class="literal">CASCADED</code>が指定されたとみなされます。
         </p></dd></dl></div><p>
     </p><p><code class="literal">CHECK OPTION</code>は<code class="literal">RECURSIVE</code>なビューで使うことはできません。
     </p><p><code class="literal">CHECK OPTION</code>は、自動更新可能で、かつ<code class="literal">INSTEAD OF</code>トリガーも<code class="literal">INSTEAD</code>ルールもないビューについてのみサポートされていることに注意してください。
自動更新可能ビューが<code class="literal">INSTEAD OF</code>トリガーのあるビューに基づいて定義されている場合、<code class="literal">LOCAL CHECK OPTION</code>を使って自動更新可能ビューの条件を検査することはできますが、<code class="literal">INSTEAD OF</code>トリガーを持つ基のビューの条件は検査されません(cascaded check optionはトリガーで更新されるビューにまでは伝わらず、またトリガーで更新可能なビューに直接定義されたcheck optionは無視されます)。
ビューあるいはその基となるリレーションに<code class="literal">INSTEAD</code>ルールがあり、<code class="command">INSERT</code>あるいは<code class="command">UPDATE</code>の書き換えが生じる場合、その書き換えられたクエリでは(<code class="literal">INSTEAD</code>ルールのあるリレーションに基づく自動更新可能ビューのものも含めて)すべてのcheck optionが無視されます。
     </p></dd></dl></div></div><div class="refsect1" id="id-1.9.3.93.7"><h2>注釈</h2><p>ビューを削除するには、<a class="xref" href="sql-dropview.html" title="DROP VIEW"><span class="refentrytitle">DROP VIEW</span></a>文を使用してください。

   </p><p>ビューの列の名前と型は指定通りに割り当てられることに注意してください。
例えば、次のコマンドを見てください。
</p><pre class="programlisting">CREATE VIEW vista AS SELECT 'Hello World';</pre><p>
この例は列の名前がデフォルトの<code class="literal">?column?</code>になるので好ましくありません。
また、列のデータ型もデフォルトの<code class="type">text</code>になりますが、これは求めるものと違うかもしれません。
ビューの結果として文字リテラルを返したい場合は、次のように指定するのがよりよい方法です。
</p><pre class="programlisting">CREATE VIEW vista AS SELECT text 'Hello World' AS hello;</pre><p>
   </p><p>ビューが参照するテーブルにアクセスできるかどうかは、ビューの所有者の権限で決定されます。
これは、場合によっては、背後のテーブルに対する安全で制限されたアクセスを提供します。
しかしすべてのビューが不正な改変に対して安全ではありません。
<a class="xref" href="rules-privileges.html" title="40.5. ルールと権限">Section 40.5</a>を参照してください。
ビュー内で実行される関数については、ビューを使用した問い合わせにおいて、その関数が直接呼び出された場合と同様に扱われます。
したがって、ビューを使用するユーザには、ビュー内で使用される全ての関数を呼び出す権限が必要です。
   </p><p><code class="command">CREATE OR REPLACE VIEW</code>が既存のビューに対して使用されると、ビューを定義するSELECTルールのみが変更されます。
所有者、権限、SELECT以外のルールなど他のビューの属性はそのまま変更されません。
置き換えるためにはビューの所有者（所有ロールのメンバである場合も含む）でなければなりません。
   </p><div class="refsect2" id="SQL-CREATEVIEW-UPDATABLE-VIEWS"><h3>更新可能ビュー</h3><a id="id-1.9.3.93.7.6.2" class="indexterm"></a><p>簡単なビューは自動更新可能になります。
システムは、ビューに対する<code class="command">INSERT</code>、<code class="command">UPDATE</code>、<code class="command">DELETE</code>文を通常のテーブルの場合と同じ方法で使用できるようにします。
以下の条件のすべてを満たす場合に、ビューは自動更新可能になります。

    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>ビューの<code class="literal">FROM</code>リストには正確に１つだけの項目を持たなければならず、それはテーブルまたは他の更新可能ビューでなければなりません。
      </p></li><li class="listitem"><p>ビューの定義の最上位レベルにおいて<code class="literal">WITH</code>、<code class="literal">DISTINCT</code>、<code class="literal">GROUP BY</code>、<code class="literal">HAVING</code>、<code class="literal">LIMIT</code>、<code class="literal">OFFSET</code>を含めてはなりません。
      </p></li><li class="listitem"><p>ビューの定義の最上位レベルにおいて集合操作（<code class="literal">UNION</code>、<code class="literal">INTERSECT</code>、<code class="literal">EXCEPT</code>）を含めてはなりません。
      </p></li><li class="listitem"><p>ビューの選択リストに、集約関数、ウィンドウ関数、集合を返す関数を含めてはなりません。
      </p></li></ul></div><p>
   </p><p>自動更新可能ビューでは、更新可能な列と更新不可能な列を混在させることができます。
基になるリレーションの更新可能な列を単純に参照する列は更新可能です。
そうでなければ列は更新不可能で、<code class="command">INSERT</code>あるいは<code class="command">UPDATE</code>文でその列に値を設定しようとしたらエラーが発生します。
   </p><p>ビューが自動更新可能であれば、システムはビューに対する<code class="command">INSERT</code>、<code class="command">UPDATE</code>または<code class="command">DELETE</code>文を基となるベースリレーションへの対応する文に変換します。
<code class="literal">ON CONFLICT UPDATE</code>句を持つ<code class="command">INSERT</code>文は完全にサポートされます。
   </p><p>自動更新可能ビューが<code class="literal">WHERE</code>条件を持つ場合、
ベースリレーションのどの行をビューに対する<code class="command">UPDATE</code>、<code class="command">DELETE</code>文により変更可能かをその条件が制限します。
しかし<code class="command">UPDATE</code>による行の変更の結果<code class="literal">WHERE</code>を満たさなくなり、その結果、ビューからは参照することができなくなることがあります。
同様に<code class="command">INSERT</code>コマンドは<code class="literal">WHERE</code>条件を満たさず、そのためビューを通して参照することができない行をベースリレーションに挿入する可能性があります（<code class="literal">ON CONFLICT UPDATE</code>はビューを通して見えない既存の行に同様に影響を及ぼすかもしれません）。
<code class="literal">CHECK OPTION</code>は<code class="command">INSERT</code>や<code class="command">UPDATE</code>がビューで見ることができない行を作るのを防ぐために使うことができます。
   </p><p>自動更新可能ビューが<code class="literal">security_barrier</code>属性を持つ場合、ビューのすべての<code class="literal">WHERE</code>条件(および<code class="literal">LEAKPROOF</code>の演算子を使ったすべての条件)が、必ず、ビューのユーザが追加した条件より前に評価されます。
詳細は<a class="xref" href="rules-privileges.html" title="40.5. ルールと権限">Section 40.5</a>を参照してください。
このため、最終的には(ユーザの<code class="literal">WHERE</code>条件を満たさないために)戻されない行もロックされてしまう場合があることに注意してください。
<code class="command">EXPLAIN</code>を使って、リレーションのレベルでどの条件が使われ(その結果、行をロックしない)、どの条件が使われないかを調べることができます。
   </p><p>これらの条件をすべて満たさないより複雑なビューはデフォルトで読み取り専用です。
システムはビューに対する挿入、更新、削除を許可しません。
ビューに対する<code class="literal">INSTEAD OF</code>トリガを作成することで、更新可能ビューの効果を得ることができます。
このトリガはビューに対する挿入試行などを他のテーブルに対する適切な操作に変換するものでなければなりません。
詳細については<a class="xref" href="sql-createtrigger.html" title="CREATE TRIGGER"><span class="refentrytitle">CREATE TRIGGER</span></a>を参照してください。
他にもルールを作成する（<a class="xref" href="sql-createrule.html" title="CREATE RULE"><span class="refentrytitle">CREATE RULE</span></a>参照）ことでも実現できますが、実際にはトリガの方が理解しやすく正しく使用するのが容易です。
   </p><p>ビューに対する挿入、更新、削除を行うユーザは、ビューに対して対応する挿入、更新、削除権限を持たなければなりません。
さらにビューの所有者は基となるベースリレーションに対する適切な権限を持たなければなりません。
しかし、更新を行うユーザは基となるベースリレーションに対する権限をまったく必要としません（<a class="xref" href="rules-privileges.html" title="40.5. ルールと権限">Section 40.5</a>参照）。
   </p></div></div><div class="refsect1" id="id-1.9.3.93.8"><h2>例</h2><p>全てのコメディ映画（Comedy films）からなるビューを作成します。

</p><pre class="programlisting">CREATE VIEW comedies AS
    SELECT *
    FROM films
    WHERE kind = 'Comedy';</pre><p>
これはビューを作成した時点で<code class="literal">film</code>テーブル内にある列を持つビューを作成します。
ビューを作成するために<code class="literal">*</code>が使用されていますが、その後にテーブルに追加された列はビューには含まれません。
  </p><p><code class="literal">LOCAL CHECK OPTION</code>を使ってビューを作成します。

</p><pre class="programlisting">CREATE VIEW universal_comedies AS
    SELECT *
    FROM comedies
    WHERE classification = 'U'
    WITH LOCAL CHECK OPTION;</pre><p>
これは<code class="literal">comedies</code>ビューに基づくビューを作成し、<code class="literal">kind = 'Comedy'</code>かつ<code class="literal">classification = 'U'</code>である映画だけを表示します。
このビューでの行の<code class="command">INSERT</code>や<code class="command">UPDATE</code>は、<code class="literal">classification = 'U'</code>でなければ拒絶されますが、映画の<code class="literal">kind</code>は検査されません。
  </p><p><code class="literal">CASCADED CHECK OPTION</code>でビューを作成します。

</p><pre class="programlisting">CREATE VIEW pg_comedies AS
    SELECT *
    FROM comedies
    WHERE classification = 'PG'
    WITH CASCADED CHECK OPTION;</pre><p>
これは新しい行について<code class="literal">kind</code>と<code class="literal">classification</code>の両方を検査するビューを作成します。
  </p><p>更新可能な列と更新不可能な列が混在するビューを作成します。

</p><pre class="programlisting">CREATE VIEW comedies AS
    SELECT f.*,
           country_code_to_name(f.country_code) AS country,
           (SELECT avg(r.rating)
            FROM user_ratings r
            WHERE r.film_id = f.id) AS avg_rating
    FROM films f
    WHERE f.kind = 'Comedy';</pre><p>
このビューは<code class="command">INSERT</code>、<code class="command">UPDATE</code>、<code class="command">DELETE</code>をサポートします。
<code class="literal">films</code>テーブルからのすべての列は更新可能ですが、計算される列<code class="literal">country</code>と<code class="literal">avg_rating</code>は更新できません。
  </p><p>1から100までの数からなる再帰的ビューを作成します。
</p><pre class="programlisting">CREATE RECURSIVE VIEW public.nums_1_100 (n) AS
    VALUES (1)
UNION ALL
    SELECT n+1 FROM nums_1_100 WHERE n &lt; 100;</pre><p>
上記の<code class="command">CREATE</code>において再帰的ビューの名前はスキーマ修飾されていますが、その内側の自己参照はスキーマ修飾されていないことに注意してください。
これは、暗黙的に作成されるCTEの名前はスキーマ修飾できないからです。
  </p></div><div class="refsect1" id="id-1.9.3.93.9"><h2>互換性</h2><p><code class="command">CREATE OR REPLACE VIEW</code>は<span class="productname">PostgreSQL</span>の言語拡張です。
一時ビューという概念も言語拡張です。
同様に<code class="literal">WITH ( ... )</code>句も拡張です。
  </p></div><div class="refsect1" id="id-1.9.3.93.10"><h2>関連項目</h2><span class="simplelist"><a class="xref" href="sql-alterview.html" title="ALTER VIEW"><span class="refentrytitle">ALTER VIEW</span></a>, <a class="xref" href="sql-dropview.html" title="DROP VIEW"><span class="refentrytitle">DROP VIEW</span></a>, <a class="xref" href="sql-creatematerializedview.html" title="CREATE MATERIALIZED VIEW"><span class="refentrytitle">CREATE MATERIALIZED VIEW</span></a></span></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="sql-createusermapping.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="sql-commands.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="sql-deallocate.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">CREATE USER MAPPING </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> DEALLOCATE</td></tr></table></div></body></html>