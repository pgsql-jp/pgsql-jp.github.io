<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>F.46. xml2</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="uuid-ossp.html" title="F.45. uuid-ossp" /><link rel="next" href="contrib-prog.html" title="Appendix G. 追加で提供されるプログラム" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">F.46. xml2</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="uuid-ossp.html" title="F.45. uuid-ossp">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="contrib.html" title="Appendix F. 追加で提供されるモジュール">Up</a></td><th width="60%" align="center">Appendix F. 追加で提供されるモジュール</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="contrib-prog.html" title="Appendix G. 追加で提供されるプログラム">Next</a></td></tr></table><hr></hr></div><div class="sect1" id="XML2"><div class="titlepage"><div><div><h2 class="title" style="clear: both">F.46. xml2</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="xml2.html#id-1.11.7.55.4">F.46.1. 廃止予定の可能性についてのお知らせ</a></span></dt><dt><span class="sect2"><a href="xml2.html#id-1.11.7.55.5">F.46.2. 関数の説明</a></span></dt><dt><span class="sect2"><a href="xml2.html#id-1.11.7.55.6">F.46.3. <code class="literal">xpath_table</code></a></span></dt><dt><span class="sect2"><a href="xml2.html#id-1.11.7.55.7">F.46.4. XSLT関数</a></span></dt><dt><span class="sect2"><a href="xml2.html#id-1.11.7.55.8">F.46.5. 作者</a></span></dt></dl></div><a id="id-1.11.7.55.2" class="indexterm"></a><p><code class="filename">xml2</code>モジュールはXPath問い合わせとXSLT機能を提供します。
 </p><div class="sect2" id="id-1.11.7.55.4"><div class="titlepage"><div><div><h3 class="title">F.46.1. 廃止予定の可能性についてのお知らせ</h3></div></div></div><p><span class="productname">PostgreSQL</span> 8.3から、SQL/XML標準に基づくXML関連の機能はコアサーバ内に存在します。
その機能は、XML構文検査、XPath問い合わせなど本モジュールが行なうことと同等のこととそれ以上のことを範囲としますが、APIには互換性はありません。
新しい標準APIのため、本モジュールは今後のバージョンのPostgreSQLで削除される予定ですので、アプリケーションの変換が推奨されています。
本モジュールの機能に新しいAPIに適用できないものがあることが分かった場合、その不足に取り組むことができるように<code class="email">&lt;<a class="email" href="mailto:pgsql-hackers@postgresql.org">pgsql-hackers@postgresql.org</a>&gt;</code>にその問題を表明してください。
  </p></div><div class="sect2" id="id-1.11.7.55.5"><div class="titlepage"><div><div><h3 class="title">F.46.2. 関数の説明</h3></div></div></div><p><a class="xref" href="xml2.html#XML2-FUNCTIONS-TABLE" title="Table F.35. 関数">Table F.35</a>に本モジュールで提供する関数を示します。
これらの関数は簡単なXML解析とXPath問い合わせを提供します。
すべての引数は<code class="type">text</code>型です。
簡潔にするため説明しません。
  </p><div class="table" id="XML2-FUNCTIONS-TABLE"><p class="title"><strong>Table F.35. 関数</strong></p><div class="table-contents"><table class="table" summary="関数" border="1"><colgroup><col /><col /><col /></colgroup><thead><tr><th>関数</th><th>結果</th><th>説明</th></tr></thead><tbody><tr><td>       <code class="function">        xml_valid(document)
       </code>
      </td><td>       <code class="type">bool</code>
      </td><td>       <p>これはパラメータとして与えられた文書テキストを解析し、文書が整形式のXMLであれば真を返します。
（注意:これは標準のPostgreSQL関数<code class="function">xml_is_well_formed()</code>の別名です。
XMLでは整形と検証が異なる意味を持つため、<code class="function">xml_valid()</code>と言う名前は技術的には正しくありません。）
       </p>
      </td></tr><tr><td>        <code class="function">         xpath_string(document, query)
        </code>
      </td><td>       <code class="type">text</code>
      </td><td rowspan="3">       <p>これらの関数は与えられた文書に対するXPath問い合わせを評価し、結果を指定した型にキャストします。
       </p>
      </td></tr><tr><td>       <code class="function">        xpath_number(document, query)
       </code>
      </td><td>       <code class="type">float4</code>
      </td></tr><tr><td>       <code class="function">        xpath_bool(document, query)
       </code>
      </td><td>       <code class="type">bool</code>
      </td></tr><tr><td>        <code class="function">         xpath_nodeset(document, query, toptag, itemtag)
        </code>
      </td><td>       <code class="type">text</code>
      </td><td>       <p>これは文書に対する問い合わせを評価し、XMLタグ内に結果を包みます。
結果が複数の値であれば、出力は以下のようになります。
</p><pre class="synopsis">&lt;toptag&gt;
&lt;itemtag&gt;Value 1 which could be an XML fragment&lt;/itemtag&gt;
&lt;itemtag&gt;Value 2....&lt;/itemtag&gt;
&lt;/toptag&gt;</pre><p>
<code class="literal">toptag</code>または<code class="literal">itemtag</code>が空文字だった場合、対応するタグは省略されます。
       </p>
      </td></tr><tr><td>        <code class="function">         xpath_nodeset(document, query)
        </code>
      </td><td>       <code class="type">text</code>
      </td><td>       <p><code class="function">xpath_nodeset(document, query, toptag, itemtag)</code>と同様ですが、結果は両方のタグを省きます。
       </p>
      </td></tr><tr><td>        <code class="function">         xpath_nodeset(document, query, itemtag)
        </code>
      </td><td>       <code class="type">text</code>
      </td><td>       <p><code class="function">xpath_nodeset(document, query, toptag, itemtag)</code>と同様ですが、結果は<code class="literal">toptag</code>を省きます。
       </p>
      </td></tr><tr><td>        <code class="function">         xpath_list(document, query, separator)
        </code>
      </td><td>       <code class="type">text</code>
      </td><td>       <p>この関数は複数の値を指定した区切り文字で区切って返します。
例えば、区切り文字が<code class="literal">,</code>ならば<code class="literal">Value 1,Value 2,Value 3</code>となります。
       </p>
      </td></tr><tr><td>        <code class="function">         xpath_list(document, query)
        </code>
      </td><td>       <code class="type">text</code>
      </td><td>これは、<code class="literal">,</code>を区切り文字として使用する、上の関数のラッパです。
      </td></tr></tbody></table></div></div><br class="table-break" /></div><div class="sect2" id="id-1.11.7.55.6"><div class="titlepage"><div><div><h3 class="title">F.46.3. <code class="literal">xpath_table</code></h3></div></div></div><a id="id-1.11.7.55.6.2" class="indexterm"></a><pre class="synopsis">xpath_table(text key, text document, text relation, text xpaths, text criteria) returns setof record</pre><p><code class="function">xpath_table</code>は各文書集合に対するXPath問い合わせ集合を評価し、結果をテーブルとして返すテーブル関数です。
元文書テーブルの主キーフィールドが結果の第一列として返されますので、結果セットを容易に結合で使用することができます。
パラメータについては<a class="xref" href="xml2.html#XML2-XPATH-TABLE-PARAMETERS" title="Table F.36. xpath_tableのパラメータ">Table F.36</a>で説明します。
  </p><div class="table" id="XML2-XPATH-TABLE-PARAMETERS"><p class="title"><strong>Table F.36. <code class="function">xpath_table</code>のパラメータ</strong></p><div class="table-contents"><table class="table" summary="xpath_tableのパラメータ" border="1"><colgroup><col /><col /></colgroup><thead><tr><th>パラメータ</th><th>説明</th></tr></thead><tbody><tr><td><em class="parameter"><code>key</code></em></td><td>       <p><span class="quote">“<span class="quote">key</span>”</span>フィールドの名前です。
これは、出力テーブルの第一列として使用される単なるフィールドです。
つまり、これは各出力行の出現元を識別するレコードです。
（後述の複数値に関する注記を参照してください。）
       </p>
      </td></tr><tr><td><em class="parameter"><code>document</code></em></td><td>       <p>XML文書を含むフィールドの名前です。
       </p>
      </td></tr><tr><td><em class="parameter"><code>relation</code></em></td><td>       <p>文書を含むテーブルまたはビューの名前です。
       </p>
      </td></tr><tr><td><em class="parameter"><code>xpaths</code></em></td><td>       <p><code class="literal">|</code>で区切られた、1つ以上のXPath式です。
       </p>
      </td></tr><tr><td><em class="parameter"><code>criteria</code></em></td><td>       <p>WHERE句の内容です。
これは省略することができません。
リレーション内の全行を処理したい場合は<code class="literal">true</code>または<code class="literal">1=1</code>を使用してください。
       </p>
      </td></tr></tbody></table></div></div><br class="table-break" /><p>（XPath文字列を除く）これらのパラメータは普通のSQL SELECT 文に単純に置換されます。
このため、多少の柔軟性があります。
  </p><p>   <code class="literal">    SELECT &lt;key&gt;, &lt;document&gt; FROM &lt;relation&gt; WHERE &lt;criteria&gt;
   </code>
  </p><p>文は上の通りですので、これらのパラメータにはそれぞれの場所で有効なものであれば<span class="emphasis"><em>何でも</em></span>よいわけです。
このSELECTの結果は正確に2つの列を返さなければなりません（キーまたは文書に対して複数のフィールドを列挙させようとしない限りです）。
この簡略された手法では、SQLインジェクション攻撃を防ぐためにユーザから与えられた値をすべて検証しなければならないことに注意してください。
  </p><p>この関数は、出力列を指定するための<code class="literal">AS</code>句を付けた<code class="literal">FROM</code>式内で使用されなければなりません。
以下に例を示します。
</p><pre class="programlisting">SELECT * FROM
xpath_table('article_id',
            'article_xml',
            'articles',
            '/article/author|/article/pages|/article/title',
            'date_entered &gt; ''2003-01-01'' ')
AS t(article_id integer, author text, page_count integer, title text);</pre><p>
この<code class="literal">AS</code>句は、出力テーブルの列名とその型を定義します。
先頭が<span class="quote">“<span class="quote">key</span>”</span>フィールド、残りがXPath問い合わせに対応します。
結果列より多くのXPath問い合わせが存在する場合、余った問い合わせは無視されます。
XPath問い合わせより多くの結果列が存在する場合は余った列はNULLになります。
  </p><p>この例で<code class="structname">page_count</code>結果列が整数として定義されていることに注意してください。
関数は内部的に文字列表現で扱います。
このため、出力内で整数で扱いたいと言っている時、XPath結果の文字列表現を取り出し、整数（または<code class="type">AS</code>句で要求した任意の型）に変換するためにPostgreSQLの入力関数を使用します。
例えば結果が空など、変換できない場合はエラーになります。
ですので、データに何らかの問題があると考えられる場合、列型として<code class="type">text</code>に限定する方がよいかもしれません。
  </p><p><code class="command">SELECT</code>文の呼び出しでは、単なる<code class="literal">SELECT *</code>でなければならない必要性はありません。
出力列を名前で参照することも他のテーブルと結合することも可能です。
この関数は希望の何らかの操作（例えば集約、結合、ソートなど）を行うことができる仮想テーブルを生成します。
このため以下をより複雑な例として示すことができます。
</p><pre class="programlisting">SELECT t.title, p.fullname, p.email
FROM xpath_table('article_id', 'article_xml', 'articles',
                 '/article/title|/article/author/@id',
                 'xpath_string(article_xml,''/article/@date'') &gt; ''2003-03-20'' ')
       AS t(article_id integer, title text, author_id integer),
     tblPeopleInfo AS p
WHERE t.author_id = p.person_id;</pre><p>
当然ながら、簡便にするためにこれをすべてビューとして包み隠すことができます。
  </p><div class="sect3" id="id-1.11.7.55.6.12"><div class="titlepage"><div><div><h4 class="title">F.46.3.1. 複数値の結果</h4></div></div></div><p><code class="function">xpath_table</code>関数は各XPath問い合わせの結果が複数の値を持つ可能性があることを前提としています。
このため、この関数が返す行数は入力文書の数と同じにならない可能性があります。
返される最初の行には各問い合わせの最初の結果が、2番目の行には各問い合わせの2番目の結果が含まれます。
問い合わせの1つが他よりも少ない値を持つ場合は代わりにNULL値が返されます。
   </p><p>指定したXPath問い合わせが単一の結果（おそらく一意な文書識別子）のみを返すことがユーザが分かっている場合があります。
もしこれを複数の結果を返すXPathと一緒に使用されると、単一値の結果は結果の最初の行にのみ現れます。
この解決方法はより単純なXPath問い合わせに対する結合部分としてキーフィールドを使用することです。
以下に例を示します。

</p><pre class="programlisting">CREATE TABLE test (
    id int PRIMARY KEY,
    xml text
);

INSERT INTO test VALUES (1, '&lt;doc num="C1"&gt;
&lt;line num="L1"&gt;&lt;a&gt;1&lt;/a&gt;&lt;b&gt;2&lt;/b&gt;&lt;c&gt;3&lt;/c&gt;&lt;/line&gt;
&lt;line num="L2"&gt;&lt;a&gt;11&lt;/a&gt;&lt;b&gt;22&lt;/b&gt;&lt;c&gt;33&lt;/c&gt;&lt;/line&gt;
&lt;/doc&gt;');

INSERT INTO test VALUES (2, '&lt;doc num="C2"&gt;
&lt;line num="L1"&gt;&lt;a&gt;111&lt;/a&gt;&lt;b&gt;222&lt;/b&gt;&lt;c&gt;333&lt;/c&gt;&lt;/line&gt;
&lt;line num="L2"&gt;&lt;a&gt;111&lt;/a&gt;&lt;b&gt;222&lt;/b&gt;&lt;c&gt;333&lt;/c&gt;&lt;/line&gt;
&lt;/doc&gt;');

SELECT * FROM
  xpath_table('id','xml','test',
              '/doc/@num|/doc/line/@num|/doc/line/a|/doc/line/b|/doc/line/c',
              'true')
  AS t(id int, doc_num varchar(10), line_num varchar(10), val1 int, val2 int, val3 int)
WHERE id = 1 ORDER BY doc_num, line_num

 id | doc_num | line_num | val1 | val2 | val3
----+---------+----------+------+------+------
  1 | C1      | L1       |    1 |    2 |    3
  1 |         | L2       |   11 |   22 |   33</pre><p>
   </p><p>各行に<code class="literal">doc_num</code>を付けるためには、2つの<code class="function">xpath_table</code>を呼び出し、その結果を結合することです。

</p><pre class="programlisting">SELECT t.*,i.doc_num FROM
  xpath_table('id', 'xml', 'test',
              '/doc/line/@num|/doc/line/a|/doc/line/b|/doc/line/c',
              'true')
    AS t(id int, line_num varchar(10), val1 int, val2 int, val3 int),
  xpath_table('id', 'xml', 'test', '/doc/@num', 'true')
    AS i(id int, doc_num varchar(10))
WHERE i.id=t.id AND i.id=1
ORDER BY doc_num, line_num;

 id | line_num | val1 | val2 | val3 | doc_num
----+----------+------+------+------+---------
  1 | L1       |    1 |    2 |    3 | C1
  1 | L2       |   11 |   22 |   33 | C1
(2 rows)</pre><p>
   </p></div></div><div class="sect2" id="id-1.11.7.55.7"><div class="titlepage"><div><div><h3 class="title">F.46.4. XSLT関数</h3></div></div></div><p>libxsltがインストールされている場合、以下の関数を使用することができます。
  </p><div class="sect3" id="id-1.11.7.55.7.3"><div class="titlepage"><div><div><h4 class="title">F.46.4.1. <code class="literal">xslt_process</code></h4></div></div></div><a id="id-1.11.7.55.7.3.2" class="indexterm"></a><pre class="synopsis">xslt_process(text document, text stylesheet, text paramlist) returns text</pre><p>この関数はXSLスタイルシートを文書に適用し、変換した結果を返します。
<code class="literal">paramlist</code>は、'a=1,b=2'という形で指定された、変換で使用されるパラメータ代入式のリストです。
パラメータ解析はあまり熟考されたものではないことに注意してください。パラメータ値にカンマを入れることができません。
   </p><p>また、変換用のパラメータを渡さない、2つのパラメータを取るバージョンの<code class="function">xslt_process</code>も存在します。
   </p></div></div><div class="sect2" id="id-1.11.7.55.8"><div class="titlepage"><div><div><h3 class="title">F.46.5. 作者</h3></div></div></div><p>   John Gray <code class="email">&lt;<a class="email" href="mailto:jgray@azuli.co.uk">jgray@azuli.co.uk</a>&gt;</code>
  </p><p>本モジュールの開発はTorchbox Ltd. (www.torchbox.com)が後援しました。
PostgreSQLと同じBSDライセンスです。
  </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="uuid-ossp.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="contrib.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="contrib-prog.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">F.45. uuid-ossp </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Appendix G. 追加で提供されるプログラム</td></tr></table></div></body></html>