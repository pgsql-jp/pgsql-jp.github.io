<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>11.12. インデックス使用状況の検証</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="indexes-index-only-scans.html" title="11.11. インデックスオンリースキャン" /><link rel="next" href="textsearch.html" title="Chapter 12. 全文検索" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">11.12. インデックス使用状況の検証</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="indexes-index-only-scans.html" title="11.11. インデックスオンリースキャン">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="indexes.html" title="Chapter 11. インデックス">Up</a></td><th width="60%" align="center">Chapter 11. インデックス</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="textsearch.html" title="Chapter 12. 全文検索">Next</a></td></tr></table><hr></hr></div><div class="sect1" id="INDEXES-EXAMINE"><div class="titlepage"><div><div><h2 class="title" style="clear: both">11.12. インデックス使用状況の検証</h2></div></div></div><a id="id-1.5.10.15.2" class="indexterm"></a><p><span class="productname">PostgreSQL</span>では、インデックスのメンテナンスやチューニングは必要ありませんが、どのインデックスが実際の問い合わせで使われているかを確認することは、やはり重要です。
個々のコマンドでのインデックスの使用状況は、<a class="xref" href="sql-explain.html" title="EXPLAIN"><span class="refentrytitle">EXPLAIN</span></a>コマンドで検証できます。
この目的のための用例を<a class="xref" href="using-explain.html" title="14.1. EXPLAINの利用">Section 14.1</a>に示します。
また、<a class="xref" href="monitoring-stats.html" title="28.2. 統計情報コレクタ">Section 28.2</a>に示す通り、稼働中のサーバにおけるインデックス使用状況の全体的な統計情報を取り出すこともできます。
  </p><p>どのインデックスを作成すべきかを判断するための一般的な手順を定めることは困難です。
これまでの節では、例として典型的なケースをいくつか記述してきました。
十分な検証がしばしば必要です。
本節の残りで、検証のためのヒントをいくつか説明しておきます。
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>まず、必ず<a class="xref" href="sql-analyze.html" title="ANALYZE"><span class="refentrytitle">ANALYZE</span></a>コマンドを実行してください。
このコマンドにより、テーブル内の値の分布に関する統計情報を収集します。
この情報は、問い合わせにより返される行数を推測する際に必要となります。
推測された行数は、可能な各問い合わせ計画に実際のコストを割り当てるために、プランナで必要となります。
実際の統計情報が欠如している場合、何らかのデフォルト値が仮定されますが、このデフォルト値は、ほぼ間違いなく不正確です。
したがって、<code class="command">ANALYZE</code>コマンドを実行せずに、アプリケーションのインデックス使用状況を検証しても、あまり意味がありません。
より詳細な情報は<a class="xref" href="routine-vacuuming.html#VACUUM-FOR-STATISTICS" title="24.1.3. プランナ用の統計情報の更新">Section 24.1.3</a>と<a class="xref" href="routine-vacuuming.html#AUTOVACUUM" title="24.1.6. 自動バキュームデーモン">Section 24.1.6</a>を参照してください。
    </p></li><li class="listitem"><p>検証には、実際に使用するデータを使ってください。
テストデータを使ってインデックスを作成した場合、テストデータに必要なインデックスはわかりますが、それ以上はわかりません。
    </p><p>非常に小さなテストデータを使用することも、結果に特に致命的な影響を与えます。
100,000行から1,000行を選択する場合は、インデックスが使用される可能性がありますが、100行から1行を選択する場合はインデックスはまず使用されません。
なぜなら、100行はおそらく1つのディスクページに収まるため、1ページを逐次読み取るよりも高速な計画は存在しないからです。
    </p><p>また、アプリケーションがまだ実動していない場合、テストデータを作成しなければならないことがよくありますが、その際にも注意が必要です。
非常に類似した値や、完全にランダムな値、またはソートされた順序で値が挿入されている場合は、その統計情報は、実際のデータの分布とかけ離れたものになってしまいます。
    </p></li><li class="listitem"><p>インデックスが使用されていない場合、テストのためにインデックスを強制的に使用するようにすると便利です。
様々な計画の種類を無効にすることを設定できる実行時パラメータがあります
（<a class="xref" href="runtime-config-query.html#RUNTIME-CONFIG-QUERY-ENABLE" title="19.7.1. プランナメソッド設定">Section 19.7.1</a>を参照してください）。
例えば、最も基本的な計画であるシーケンシャルスキャン（<code class="varname">enable_seqscan</code>）およびネステッドループ結合（<code class="varname">enable_nestloop</code>）を無効に設定すると、システムは別の計画を使用するように強制されます。
そのような設定を行っても、システムがシーケンシャルスキャンやネステッドループ結合を選択する場合は、インデックスを使用しない理由としておそらくもっと根本的な理由があるということになります。
例えば、問い合わせの条件がインデックスに適合しない、などが考えられます。
（どのような問い合わせで、どのようなインデックスを使用できるかは、前節までで説明済みです。）
    </p></li><li class="listitem"><p>強制的にインデックスを使うように設定することで、インデックスを使用するようになった場合は、次の2つの可能性が考えられます。
システムの判断が正しく、インデックスの使用が実際には適切ではないという可能性と、問い合わせ計画のコスト推定が実情を反映していない可能性です。
したがって、インデックスを使った問い合わせの実行時間と、使わない場合の実行時間を計測する必要があります。
この場合、<code class="command">EXPLAIN ANALYZE</code>コマンドが便利です。
    </p></li><li class="listitem"><p>コスト推定が間違っていると判明した場合、やはり2つの可能性が考えられます。
総コストは、各計画ノードの行単位のコストに、計画ノードの推定選択度を掛けることで算出されます。
計画ノードのコスト推定は、実行時パラメータによって設定することができます
（<a class="xref" href="runtime-config-query.html#RUNTIME-CONFIG-QUERY-CONSTANTS" title="19.7.2. プランナコスト定数">Section 19.7.2</a>を参照してください）。
推定選択度が不正確であるのは、統計情報が不十分であるのが原因です。
統計情報収集用のパラメータを調節することによって、この状況を改善することができるかもしれません。
（<a class="xref" href="sql-altertable.html" title="ALTER TABLE"><span class="refentrytitle">ALTER TABLE</span></a>を参照してください）。
    </p><p>コストを適切に調節できない場合は、明示的にインデックスの使用を強制する必要が考えられます。
あるいは、<span class="productname">PostgreSQL</span>開発者に問題の調査を依頼することになるかもしれません。
    </p></li></ul></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="indexes-index-only-scans.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="indexes.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="textsearch.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">11.11. インデックスオンリースキャン </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 12. 全文検索</td></tr></table></div></body></html>