<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>53.2. サーバ内部からのエラーの報告</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="source-format.html" title="53.1. 書式" /><link rel="next" href="error-style-guide.html" title="53.3. エラーメッセージのスタイルガイド" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">53.2. サーバ内部からのエラーの報告</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="source-format.html" title="53.1. 書式">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="source.html" title="Chapter 53. PostgreSQLコーディング規約">Up</a></td><th width="60%" align="center">Chapter 53. PostgreSQLコーディング規約</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="error-style-guide.html" title="53.3. エラーメッセージのスタイルガイド">Next</a></td></tr></table><hr></hr></div><div class="sect1" id="ERROR-MESSAGE-REPORTING"><div class="titlepage"><div><div><h2 class="title" style="clear: both">53.2. サーバ内部からのエラーの報告</h2></div></div></div><a id="id-1.10.6.3.2" class="indexterm"></a><a id="id-1.10.6.3.3" class="indexterm"></a><p>サーバコード内から生成されるエラー、警告、ログメッセージは、<code class="function">ereport</code>もしくはこれに似た古い<code class="function">elog</code>を使用して作成してください。
この関数の使用はいくつか説明が必要なほど複雑です。
   </p><p>すべてのメッセージには、深刻度レベル（<code class="literal">DEBUG</code>から<code class="literal">PANIC</code>までの範囲）と主メッセージテキストという、2つの必須要素があります。
さらに、省略可能な要素があります。
その中で最もよく使用されるのは、SQL仕様のSQLSTATE規則に従うエラー識別コードです。
<code class="function">ereport</code>自身はシェル関数で、主に、メッセージ生成をCソースコード内の関数呼び出しのように行わせる、構文の便宜上存在します。
<code class="function">ereport</code>で直接受け付けられる唯一のパラメータは深刻度レベルです。
主メッセージテキストと任意の省略可能なメッセージ要素は、<code class="function">ereport</code>呼び出し内で<code class="function">errmsg</code>などの補助関数を呼び出すことで生成されます。
   </p><p>典型的な<code class="function">ereport</code>の呼び出しは以下のようなものです。
</p><pre class="programlisting">ereport(ERROR,
        (errcode(ERRCODE_DIVISION_BY_ZERO),
         errmsg("division by zero")));</pre><p>
これはエラー深刻度レベル<code class="literal">ERROR</code>（普通のエラー）を指定します。
<code class="function">errcode</code>呼び出しは、<code class="filename">src/include/utils/errcodes.h</code>で定義されたマクロを使用してSQLSTATEエラーコードを指定します。
<code class="function">errmsg</code>呼び出しは主メッセージテキストを提供します。
補助関数呼び出しを囲む余計な括弧群に注意してください。
これらはいらいらさせられますが、構文上必要です。
   </p><p>以下に、より複雑な例を示します。
</p><pre class="programlisting">ereport(ERROR,
        (errcode(ERRCODE_AMBIGUOUS_FUNCTION),
         errmsg("function %s is not unique",
                func_signature_string(funcname, nargs,
                                      NIL, actual_arg_types)),
         errhint("Unable to choose a best candidate function. "
                 "You might need to add explicit typecasts.")));</pre><p>
これは、実行時の値をメッセージテキスト内に埋め込むための整形用コードの使用を示します。
また、省略可能な<span class="quote">“<span class="quote">ヒント</span>”</span>メッセージも提供されています。
   </p><p>深刻度レベルが<code class="literal">ERROR</code>以上であれば、<code class="function">ereport</code>はユーザ定義関数の実行を中断し呼び出し元には戻りません。
深刻度レベルが<code class="literal">ERROR</code>未満であれば、<code class="function">ereport</code>は正常に戻ります。
   </p><p><code class="function">ereport</code>で使用可能な補助ルーチンを以下に示します。
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="function">errcode(sqlerrcode)</code>は、その条件用のSQLSTATEエラー識別コードを指定します。
このルーチンが呼び出されないと、エラー識別子のデフォルトは、エラー深刻度レベルが<code class="literal">ERROR</code>以上の場合には<code class="literal">ERRCODE_INTERNAL_ERROR</code>に、エラー深刻度レベルが<code class="literal">WARNING</code>の場合には<code class="literal">ERRCODE_WARNING</code>に、さもなければ（<code class="literal">NOTICE</code>以下）<code class="literal">ERRCODE_SUCCESSFUL_COMPLETION</code>になります。
これらのデフォルトはしばしば便利ですが、<code class="function">errcode()</code>呼び出しを省略する前に、常に適切かどうかを検討してください。
    </p></li><li class="listitem"><p><code class="function">errmsg(const char *msg, ...)</code>は、主エラーメッセージテキストを指定し、また、実行時の値をそこに挿入することもできます。
挿入は、<code class="function">sprintf</code>様式の書式コードで指定されます。
<code class="function">sprintf</code>で受け付けられる標準の書式コードに加え、<code class="literal">%m</code>書式コードを使用して、現在の<code class="literal">errno</code>の値用の<code class="function">strerror</code>で返されるエラーメッセージを挿入することができます。
     <a href="#ftn.id-1.10.6.3.9.2.2.1.7" class="footnote"><sup class="footnote" id="id-1.10.6.3.9.2.2.1.7">[13]</sup></a>
<code class="literal">%m</code>は<code class="function">errmsg</code>のパラメータリスト内に対応する項目を必要としません。
メッセージ文字列は、書式コードの処理を行う前に、地域化のために<code class="function">gettext</code>を通ることに注意してください。
    </p></li><li class="listitem"><p><code class="function">errmsg_internal(const char *msg, ...)</code>は、そのメッセージ文字列は変換されず、国際化用メッセージ辞書に含まれない点を除き、<code class="function">errmsg</code>と同一です。
これは、おそらく翻訳作業を行う価値がない<span class="quote">“<span class="quote">発生し得ない</span>”</span>場合用に使用すべきです。
    </p></li><li class="listitem"><p><code class="function">errmsg_plural(const char *fmt_singular, const char *fmt_plural, unsigned long n, ...)</code>は<code class="function">errmsg</code>のようですが、メッセージの各種の複数書式があります。
<em class="replaceable"><code>fmt_singular</code></em>は英語の単数書式、<em class="replaceable"><code>fmt_plural</code></em>は英語の複数書式、<em class="replaceable"><code>n</code></em>はどの複数書式が必要なのかを決定する整数値で、残りの引数は選択された書式文字列に従って書式化されます。
より詳細な情報は<a class="xref" href="nls-programmer.html#NLS-GUIDELINES" title="54.2.2. メッセージ記述の指針">Section 54.2.2</a>を参照してください。
    </p></li><li class="listitem"><p><code class="function">errdetail(const char *msg, ...)</code>は省略可能な<span class="quote">“<span class="quote">詳細</span>”</span>メッセージを提供します。
これは、主メッセージ内に記述するには不適切と考えられる追加情報がある場合に使用されます。
このメッセージ文字列は<code class="function">errmsg</code>とまったく同じ方法で処理されます。
    </p></li><li class="listitem"><p><code class="function">errdetail_internal(const char *msg, ...)</code>は、メッセージが翻訳されない、または、国際化メッセージ辞書内に含まれない点を除き、<code class="function">errdetail</code>と同じです。
これは、例えばほとんどのユーザに役に立つにはあまりにも技術的すぎるなど、翻訳する手間をかける価値がない詳細メッセージで有用であるはずです。
    </p></li><li class="listitem"><p><code class="function">errdetail_plural(const char *fmt_singular, const char *fmt_plural, unsigned long n, ...)</code>は<code class="function">errdetail</code>と似ていますが、メッセージの各種の複数書式をサポートします。
より詳細な情報は<a class="xref" href="nls-programmer.html#NLS-GUIDELINES" title="54.2.2. メッセージ記述の指針">Section 54.2.2</a>を参照してください。
    </p></li><li class="listitem"><p>この文字列がサーバログのみに渡り、クライアントに渡らない点を除き<code class="function">errdetail_log(const char *msg, ...)</code>は<code class="function">errdetail</code>と同一です。
<code class="function">errdetail</code>（や上記の等価物の１つ）と<code class="function">errdetail_log</code>が共に使用された場合、１つの文字列はクライアントに渡り、もう１つはログに渡ります。
クライアントに送られるレポートに含めるにはセキュリティに対して慎重を期さなければならないもの、あるいは膨大すぎるエラー詳細に対して効果があります。
    </p></li><li class="listitem"><p><code class="function">errdetail_log_plural(const char *fmt_singular, const char *fmt_plural, unsigned long n, ...)</code>は<code class="function">errdetail_log</code>と似ていますが、メッセージの各種の複数書式をサポートします。
より詳細な情報は<a class="xref" href="nls-programmer.html#NLS-GUIDELINES" title="54.2.2. メッセージ記述の指針">Section 54.2.2</a>を参照してください。
    </p></li><li class="listitem"><p><code class="function">errhint(const char *msg, ...)</code>は、省略可能な<span class="quote">“<span class="quote">ヒント</span>”</span>メッセージを提供します。
これは、何が悪かったのかについての事実に基づく詳細とは反対で、問題を解決させる方法に関する提言を提供するために使用されます。
このメッセージ文字列は<code class="function">errmsg</code>とまったく同じ方法で処理されます。
    </p></li><li class="listitem"><p><code class="function">errcontext(const char *msg, ...)</code>は通常<code class="function">ereport</code>メッセージ側から直接呼び出されません。
エラーが発生したコンテキスト、例えばPL関数の現在位置の情報を提供するために<code class="literal">error_context_stack</code>コールバック関数内で使用されます。
メッセージ文字列は<code class="function">errmsg</code>とまったく同じ方法で処理されます。
他の補助関数とは異なり、1つの<code class="function">ereport</code>呼び出しで何度も呼び出すことができます。
こうして提供される文字列の並びは、改行で区切った形で連結されます。
    </p></li><li class="listitem"><p><code class="function">errposition(int cursorpos)</code>は、問い合わせ文字列内でエラーが発生した位置をテキストで指定します。
現在、問い合わせ処理の字句解析および構文解析段階でエラーが検出された場合にのみ役に立ちます。
    </p></li><li class="listitem"><p><code class="function">errtable(Relation rel)</code>はエラーレポートにおいて名前とスキーマ名が外部フィールドとして含まれなければならないリレーションを指定します。
    </p></li><li class="listitem"><p><code class="function">errtablecol(Relation rel, int attnum)</code>はエラーレポートにおいて名前、テーブル名、およびスキーマ名が外部フィールドとして含まれなければならない列を指定します。
    </p></li><li class="listitem"><p><code class="function">errtableconstraint(Relation rel, const char *conname)</code>はエラーレポートにおいて名前、テーブル名、およびスキーマ名が外部フィールドとして含まれなければならないテーブル制約を指定します。
この目的のため、関連した<code class="structname">pg_constraint</code>エントリの有る無しに関わらず、インデックスは制約と見なされなければなりません。進行中のヒープリレーションを受け渡すにはインデックスではなく<code class="literal">rel</code>とすることに注意してください。
    </p></li><li class="listitem"><p><code class="function">errdatatype(Oid datatypeOid)</code>はエラーレポートにおいて名前とスキーマ名が外部フィールドとして含まれなければならないデータ型を指定します。
    </p></li><li class="listitem"><p><code class="function">errdomainconstraint(Oid datatypeOid, const char *conname)</code>はエラーレポートにおいて名前、ドメイン名、およびスキーマ名が外部フィールドとして含まれなければならないドメイン制約を指定します。
    </p></li><li class="listitem"><p><code class="function">errcode_for_file_access()</code>は、ファイルアクセス関連のシステムコールでの失敗用のSQLSTATEエラー識別子を適切に選択する、便利な関数です。
保存された<code class="literal">errno</code>を使用して、どのエラーコードを生成するかを決定します。
通常、これは主エラーメッセージテキスト内で<code class="literal">%m</code>と組み合わせて使用されなければなりません。
    </p></li><li class="listitem"><p><code class="function">errcode_for_socket_access()</code>は、ソケット関連のシステムコールでの失敗用のSQLSTATEエラー識別子を適切に選択する、便利な関数です。
    </p></li><li class="listitem"><p><code class="function">errhidestmt(bool hide_stmt)</code>は、postmasterのログ内のメッセージにおける<code class="literal">STATEMENT:</code>部分を抑制するために呼び出すことができます。
通常これは、メッセージテキスト内にすでに現在の文が含まれている場合に適しています。
    </p></li><li class="listitem"><p><code class="function">errhidecontext(bool hide_ctx)</code>は、postmasterのログ内のメッセージにおける<code class="literal">CONTEXT:</code>部分を抑制するために呼び出すことができます。
これは、冗長なデバッグメッセージにおいてコンテキストを繰り返し含めることがログのサイズを巨大にしてしまうような場合にのみ用いられるべきです。
    </p></li></ul></div><p>
   </p><div class="note"><h3 class="title">Note</h3><p><code class="function">ereport</code>呼び出しにおいて、最大限でも<code class="function">errtable</code>、<code class="function">errtablecol</code>、 <code class="function">errtableconstraint</code>、<code class="function">errdatatype</code>、または<code class="function">errdomainconstraint</code>のうちの一つの関数が使用されなければなりません。
これらの関数は、アプリケーションが自動エラー対応であって欲しいと期待するエラーレポートにおいて使用されるべきです。
<span class="productname">PostgreSQL</span> 9.3の時点で、この機能を完璧に保証する範囲はSQLSTATEクラス23（整合性制約違反）のみですが、将来的には十中八九拡張されそうです。
    </p></div><p>まだ頻繁に使用されている、古めの<code class="function">elog</code>関数があります。
以下の<code class="function">elog</code>呼び出しは、
</p><pre class="programlisting">elog(level, "format string", ...);</pre><p>
以下とまったく同じです。
</p><pre class="programlisting">ereport(level, (errmsg_internal("format string", ...)));</pre><p>
SQLSTATEエラーコードが常にデフォルトになること、メッセージ文字列が変換されないことに注意してください。
したがって、<code class="function">elog</code>は、内部エラーと低レベルなデバッグ用ログにのみ使用すべきです。
一般ユーザを対象とする任意のメッセージは<code class="function">ereport</code>を使用すべきです。
それでもなお、システム内の<span class="quote">“<span class="quote">発生できなかった</span>”</span>内部エラーの検査に<code class="function">elog</code>がまだ多く使用されています。
これは、こうした単純な表記のメッセージに適しています。
   </p><p><a class="xref" href="error-style-guide.html" title="53.3. エラーメッセージのスタイルガイド">Section 53.3</a>に推奨するエラーメッセージの作成についての提言を示します。
   </p><div class="footnotes"><br /><hr style="width:100; text-align:left;margin-left: 0" /><div id="ftn.id-1.10.6.3.9.2.2.1.7" class="footnote"><p><a href="#id-1.10.6.3.9.2.2.1.7" class="para"><sup class="para">[13] </sup></a>つまり、<code class="function">ereport</code>呼び出しに達した時点の値です。
補助報告ルーチン内で<code class="literal">errno</code>を変更しても効果はありません。
<code class="function">errmsg</code>内で<code class="literal">strerror(errno)</code>を明示的に記述したとしても正確なものにはなりません。
したがって、このようにはしないでください。
      </p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="source-format.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="source.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="error-style-guide.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">53.1. 書式 </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 53.3. エラーメッセージのスタイルガイド</td></tr></table></div></body></html>