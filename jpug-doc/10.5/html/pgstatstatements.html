<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>F.30. pg_stat_statements</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="pgrowlocks.html" title="F.29. pgrowlocks" /><link rel="next" href="pgstattuple.html" title="F.31. pgstattuple" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">F.30. pg_stat_statements</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="pgrowlocks.html" title="F.29. pgrowlocks">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="contrib.html" title="Appendix F. 追加で提供されるモジュール">Up</a></td><th width="60%" align="center">Appendix F. 追加で提供されるモジュール</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="pgstattuple.html" title="F.31. pgstattuple">Next</a></td></tr></table><hr></hr></div><div class="sect1" id="PGSTATSTATEMENTS"><div class="titlepage"><div><div><h2 class="title" style="clear: both">F.30. pg_stat_statements</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="pgstatstatements.html#id-1.11.7.39.6">F.30.1. <code class="structname">pg_stat_statements</code> ビュー</a></span></dt><dt><span class="sect2"><a href="pgstatstatements.html#id-1.11.7.39.7">F.30.2. 関数</a></span></dt><dt><span class="sect2"><a href="pgstatstatements.html#id-1.11.7.39.8">F.30.3. 設定パラメータ</a></span></dt><dt><span class="sect2"><a href="pgstatstatements.html#id-1.11.7.39.9">F.30.4. サンプル出力</a></span></dt><dt><span class="sect2"><a href="pgstatstatements.html#id-1.11.7.39.10">F.30.5. 作者</a></span></dt></dl></div><a id="id-1.11.7.39.2" class="indexterm"></a><p><code class="filename">pg_stat_statements</code>モジュールは、サーバで実行されたすべてのSQL文の実行時の統計情報を記録する手段を提供します。
 </p><p>このモジュールは追加の共有メモリを必要とするため、<code class="filename">postgresql.conf</code>の<a class="xref" href="runtime-config-client.html#GUC-SHARED-PRELOAD-LIBRARIES">shared_preload_libraries</a>に<code class="literal">pg_stat_statements</code>を追加してモジュールをロードしなければなりません。
このことは、このモジュールを追加もしくは削除するには、サーバを再起動する必要があるということを意味しています。
 </p><p><code class="filename">pg_stat_statements</code>はロードされると、サーバのデータベース全体に渡って統計情報を記録します。
この統計情報にアクセスしたり操作したりするために、このモジュールはビュー<code class="structname">pg_stat_statements</code>とユーティリティ関数<code class="function">pg_stat_statements_reset</code>、<code class="function">pg_stat_statements</code>を提供します。
これらは大域的に利用可能ではなく、<code class="command">CREATE EXTENSION pg_stat_statements</code>で特定のデータベースで可能になります。
 </p><div class="sect2" id="id-1.11.7.39.6"><div class="titlepage"><div><div><h3 class="title">F.30.1. <code class="structname">pg_stat_statements</code> ビュー</h3></div></div></div><p>このモジュールにって収集された統計情報は、<code class="structname">pg_stat_statements</code>というビューを通して利用することができます。
このビューは、1行に対して、それぞれ個々のデータベースID、ユーザID、および問い合わせIDを含んでいます（モジュールが記録できるSQL文の最大数まで）。
ビューの列は、<a class="xref" href="pgstatstatements.html#PGSTATSTATEMENTS-COLUMNS" title="Table F.22. pg_stat_statementsの列">Table F.22</a>に示す通りです。
  </p><div class="table" id="PGSTATSTATEMENTS-COLUMNS"><p class="title"><strong>Table F.22. <code class="structname">pg_stat_statements</code>の列</strong></p><div class="table-contents"><table class="table" summary="pg_stat_statementsの列" border="1"><colgroup><col /><col /><col /><col /></colgroup><thead><tr><th>名前</th><th>型</th><th>参照元</th><th>説明</th></tr></thead><tbody><tr><td><code class="structfield">userid</code></td><td><code class="type">oid</code></td><td><code class="literal"><a class="link" href="catalog-pg-authid.html" title="51.8. pg_authid"><code class="structname">pg_authid</code></a>.oid</code></td><td>SQL文を実行したユーザのOID</td></tr><tr><td><code class="structfield">dbid</code></td><td><code class="type">oid</code></td><td><code class="literal"><a class="link" href="catalog-pg-database.html" title="51.15. pg_database"><code class="structname">pg_database</code></a>.oid</code></td><td>SQL文が実行されたデータベースのOID</td></tr><tr><td><code class="structfield">queryid</code></td><td><code class="type">bigint</code></td><td> </td><td>文の解析木から計算された内部ハッシュコード</td></tr><tr><td><code class="structfield">query</code></td><td><code class="type">text</code></td><td> </td><td>代表的な文の文字列</td></tr><tr><td><code class="structfield">calls</code></td><td><code class="type">bigint</code></td><td> </td><td>実行回数</td></tr><tr><td><code class="structfield">total_time</code></td><td><code class="type">double precision</code></td><td> </td><td>SQL文の処理に費やした総時間（ミリ秒単位）</td></tr><tr><td><code class="structfield">min_time</code></td><td><code class="type">double precision</code></td><td> </td><td>SQL文の処理に費やした最小時間（ミリ秒単位）</td></tr><tr><td><code class="structfield">max_time</code></td><td><code class="type">double precision</code></td><td> </td><td>SQL文の処理に費やした最大時間（ミリ秒単位）</td></tr><tr><td><code class="structfield">mean_time</code></td><td><code class="type">double precision</code></td><td> </td><td>SQL文の処理に費やした平均時間（ミリ秒単位）</td></tr><tr><td><code class="structfield">stddev_time</code></td><td><code class="type">double precision</code></td><td> </td><td>SQL文の処理に費やした時間の母標準偏差（ミリ秒単位）</td></tr><tr><td><code class="structfield">rows</code></td><td><code class="type">bigint</code></td><td> </td><td>SQL文によって取得された、あるいは影響を受けた行の総数</td></tr><tr><td><code class="structfield">shared_blks_hit</code></td><td><code class="type">bigint</code></td><td> </td><td>SQL文によってヒットした共有ブロックキャッシュの総数</td></tr><tr><td><code class="structfield">shared_blks_read</code></td><td><code class="type">bigint</code></td><td> </td><td>SQL文によって読み込まれた共有ブロックの総数</td></tr><tr><td><code class="structfield">shared_blks_dirtied</code></td><td><code class="type">bigint</code></td><td> </td><td>文によりダーティ状態となった共有ブロックの総数</td></tr><tr><td><code class="structfield">shared_blks_written</code></td><td><code class="type">bigint</code></td><td> </td><td>SQL文によって書き込まれた共有ブロックの総数</td></tr><tr><td><code class="structfield">local_blks_hit</code></td><td><code class="type">bigint</code></td><td> </td><td>SQL文によってヒットしたローカルブロックキャッシュの総数</td></tr><tr><td><code class="structfield">local_blks_read</code></td><td><code class="type">bigint</code></td><td> </td><td>SQL文によって読み込まれたローカルブロックの総数</td></tr><tr><td><code class="structfield">local_blks_dirtied</code></td><td><code class="type">bigint</code></td><td> </td><td>SQL文によりダーティ状態となったローカルブロックの総数</td></tr><tr><td><code class="structfield">local_blks_written</code></td><td><code class="type">bigint</code></td><td> </td><td>SQL文によって書き込まれたローカルブロックの総数</td></tr><tr><td><code class="structfield">temp_blks_read</code></td><td><code class="type">bigint</code></td><td> </td><td>SQL文によって読み込まれた一時ブロックの総数</td></tr><tr><td><code class="structfield">temp_blks_written</code></td><td><code class="type">bigint</code></td><td> </td><td>SQL文によって書き込まれた一時ブロックの総数</td></tr><tr><td><code class="structfield">blk_read_time</code></td><td><code class="type">double precision</code></td><td> </td><td>SQL文がブロック読み取りに費やした、ミリ秒単位の総時間
（<a class="xref" href="runtime-config-statistics.html#GUC-TRACK-IO-TIMING">track_io_timing</a>が有効な場合。無効であればゼロ）
      </td></tr><tr><td><code class="structfield">blk_write_time</code></td><td><code class="type">double precision</code></td><td> </td><td>SQL文がブロック書き出しに費やした、ミリ秒単位の総時間
（<a class="xref" href="runtime-config-statistics.html#GUC-TRACK-IO-TIMING">track_io_timing</a>が有効な場合。無効であればゼロ）
      </td></tr></tbody></table></div></div><br class="table-break" /><p>セキュリティ上の理由から、スーパーユーザと<code class="literal">pg_read_all_stats</code>ロールのメンバだけが、他のユーザによって実行されたSQLテキストや問い合わせの<code class="structfield">queryid</code>を見ることができます。
ただし、ユーザのデータベースにビューがインストールされている場合、統計情報については他のユーザから見ることができます。
  </p><p>計画作成が可能な問い合わせ（つまり<code class="command">SELECT</code>、<code class="command">INSERT</code>、<code class="command">UPDATE</code>、<code class="command">DELETE</code>）は、内部のハッシュ計算に従った、同一の問い合わせ構造を持つ限り、１つの<code class="structname">pg_stat_statements</code>項目に組み合わせられます。
典型的には、２つの問い合わせは、問い合わせの中に現れるリテラル定数の値以外、意味的に等価である場合、この目的では同一とみなされます。
しかし、ユーティリティコマンド（つまりこの他のコマンドすべて）は問い合わせ文字列のテキストを基に厳密に比較されます。
  </p><p>他の問い合わせと合致させるために定数値が無視された場合、<code class="structname">pg_stat_statements</code>の表示の中で定数は<code class="literal">$1</code>のようなパラメータ記号に置換されます。
問い合わせの残りのテキストは、<code class="structname">pg_stat_statements</code>項目に関連付いた特定の<code class="structfield">queryid</code>ハッシュ値を持つ、１つ目の問い合わせのテキストです。
  </p><p>一部の状況では、見た目上異なるテキストを持つ問い合わせが１つの<code class="structname">pg_stat_statements</code>項目にまとめられることがあります。
通常これは意味的に等しい問い合わせでのみ発生しますが、関連がない問い合わせが１つの項目にまとめられるハッシュ競合の可能性がわずかながら存在します。
（しかしこれは別のユーザまたは別のデータベースに属する問い合わせでは発生することはあり得ません。）
  </p><p><code class="structfield">queryid</code>ハッシュ値は問い合わせの解析後の表現に対して計算されますので、<code class="varname">search_path</code>の設定が異なる等の要因の結果として異なる意味を持つ場合、同じテキストを持つ問い合わせが別の項目として現れるという、反対もまたあり得ます。
  </p><p><code class="structname">pg_stat_statements</code>の消費者は、問い合わせテキストよりもより安定で信頼できる各項目への識別子として(おそらく<code class="structfield">dbid</code>や<code class="structfield">userid</code>と組み合わせて)<code class="structfield">queryid</code>を使いたいかもしれません。
しかし、<code class="structfield">queryid</code>ハッシュ値の安定性には限定された保証しかないのを理解することは重要です。
識別子は解析後の木から得られますので、その値は、とりわけ、この表現に現れる内部オブジェクト識別子の関数です。
これは少々直観に反する結果です。
例えば、<code class="filename">pg_stat_statements</code>は見たところは同一の問い合わせを、それらが2つの問い合わせの実行の間に削除され再作成されたテーブルを参照しているのであれば、別個のものとみなします。
ハッシュ処理はプラットフォームのマシンアーキテクチャやその他の面の違いにも敏感です。
その上、<span class="productname">PostgreSQL</span>のメジャーバージョンをまたがって<code class="structfield">queryid</code>が安定であるとみなすのは安全ではありません。
  </p><p>経験上、<code class="structfield">queryid</code>値は、基礎となるサーバのバージョンとカタログメタデータの詳細が全く同じである限り、安定していて比較可能とみなすことができます。
物理WAL再生に基づくレプリケーションに参加する2つのサーバでは、同じ問い合わせに対して同一の<code class="structfield">queryid</code>値を持つことが期待できます。
しかし、論理レプリケーションの仕組みは、レプリカが対応する詳細すべてで同一であることを約束しません。そのため、論理レプリカの集まりで増えるコストを識別するのに<code class="structfield">queryid</code>は有用ではありません。
疑わしければ、直接テストすることを薦めます。
  </p><p>代表的な問い合わせテキストの定数を置き換えるのに使われたパラメータ記号は、元の問い合わせテキストの最も大きな<code class="literal">$</code><em class="replaceable"><code>n</code></em>パラメータの次の数字から、もしそれがなければ<code class="literal">$1</code>から始まります。
ある場合には、この番号付けに影響する隠れたパラメータ記号があるかもしれないことに言及しておく価値はあります。
例えば、<span class="application">PL/pgSQL</span>は関数の局所変数の値を問い合わせに挿入するために隠れたパラメータ記号を使います。そのため、<code class="literal">SELECT i + 1 INTO j</code>のような<span class="application">PL/pgSQL</span>文は<code class="literal">SELECT i + $2</code>のような代表的なテキストになります。
  </p><p>代表的な問い合わせテキストは外部ディスクファイルに保持され、共有メモリを消費しません。
そのため、非常に長い問い合わせテキストであっても保存に成功します。
しかし、数多くの長い問い合わせテキストが蓄積されると、外部ファイルは手に負えないくらい大きくなるかもしれません。
もしそのようなことが起きれば、回復手法として、<code class="filename">pg_stat_statements</code>は問い合わせテキストを破棄することを選ぶでしょう。その結果、各<code class="structfield">queryid</code>に関連する統計は保存されるものの、<code class="structname">pg_stat_statements</code>ビュー内に存在するエントリはすべて<code class="structfield">query</code>フィールドがヌルになります。
もしこのようなことが起きたら、再発防止のため<code class="varname">pg_stat_statements.max</code>を減らすことを検討してください。
  </p></div><div class="sect2" id="id-1.11.7.39.7"><div class="titlepage"><div><div><h3 class="title">F.30.2. 関数</h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">     <code class="function">pg_stat_statements_reset() returns void</code>
     <a id="id-1.11.7.39.7.2.1.1.2" class="indexterm"></a>
    </span></dt><dd><p><code class="function">pg_stat_statements_reset</code>は<code class="filename">pg_stat_statements</code>によってこれまでに収集したすべての統計情報を削除します。
デフォルトでは、この関数はスーパーユーザのみ実行することができます。
     </p></dd><dt><span class="term">     <code class="function">pg_stat_statements(showtext boolean) returns setof record</code>
     <a id="id-1.11.7.39.7.2.2.1.2" class="indexterm"></a>
    </span></dt><dd><p><code class="structname">pg_stat_statements</code>ビューは同じく<code class="function">pg_stat_statements</code>という名前の関数の項で定義されています。
クライアントが<code class="function">pg_stat_statements</code>関数を直接呼び出し、<code class="literal">showtext := false</code>と指定することで問い合わせテキストを省略することが可能です(すなわち、ビューの<code class="structfield">query</code>列に対応する<code class="literal">OUT</code>引数はNULLを返します)。
この機能は不定長の問い合わせテキストを繰り返し取得するオーバヘッドを避けたいと考える外部のツールをサポートすること意図したものです。
そのようなツールは代わりに、それが<code class="filename">pg_stat_statements</code>自身が行なっていることのすべてですので、各項目で最初に観察された問い合わせテキストをキャッシュし、必要とされる問い合わせテキストのみを取得できます。
サーバは問い合わせテキストをファイルに格納しますので、この方法は<code class="structname">pg_stat_statements</code>データの繰り返しの検査に対する物理I/Oを減らすでしょう。
     </p></dd></dl></div></div><div class="sect2" id="id-1.11.7.39.8"><div class="titlepage"><div><div><h3 class="title">F.30.3. 設定パラメータ</h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">     <code class="varname">pg_stat_statements.max</code> (<code class="type">integer</code>)
    </span></dt><dd><p><code class="varname">pg_stat_statements.max</code>は、このモジュールによって記録されるSQL文の最大数(すなわち、<code class="structname">pg_stat_statements</code>ビューにおける行の最大数)です。これを超えて異なるSQL文を検出した場合は、最も実行回数の低いSQL文の情報が捨てられます。
デフォルトは5000です。
このパラメータはサーバの起動時にのみ指定できます。
     </p></dd><dt><span class="term">     <code class="varname">pg_stat_statements.track</code> (<code class="type">enum</code>)
    </span></dt><dd><p><code class="varname">pg_stat_statements.track</code>は、どのSQL文をモジュールによって計測するかを制御します。
<code class="literal">top</code>を指定した場合は（直接クライアントによって発行された）最上層のSQL文を記録します。
<code class="literal">all</code>は（関数の中から呼び出された文などの）入れ子になった文も記録します。
<code class="literal">none</code>は文に関する統計情報収集を無効にします。
デフォルトは<code class="literal">top</code>です。
この設定はスーパーユーザだけが変更できます。
     </p></dd><dt><span class="term">     <code class="varname">pg_stat_statements.track_utility</code> (<code class="type">boolean</code>)
    </span></dt><dd><p><code class="varname">pg_stat_statements.track_utility</code>は、このモジュールがユーティリティコマンドを記録するかどうかを指定します。
ユーティリティコマンドとは、 <code class="command">SELECT</code>、<code class="command">INSERT</code>、<code class="command">UPDATE</code>および<code class="command">DELETE</code>以外のすべてです。
デフォルトは<code class="literal">on</code>です。
この設定はスーパーユーザのみが変更できます。
     </p></dd><dt><span class="term">     <code class="varname">pg_stat_statements.save</code> (<code class="type">boolean</code>)
    </span></dt><dd><p><code class="varname">pg_stat_statements.save</code>は、サーバを終了させる際に文の統計情報を保存するかどうかを指定します。
<code class="literal">off</code>の場合、統計情報は終了時に保存されず、サーバ開始時に再読み込みもされません。
デフォルト値は<code class="literal">on</code>です。
このパラメータは<code class="filename">postgresql.conf</code>ファイル、またはサーバコマンドラインでのみ設定できます。
     </p></dd></dl></div><p>このモジュールは、<code class="varname">pg_stat_statements.max</code>に比例する追加の共有メモリを必要とします。
<code class="varname">pg_stat_statements.track</code>に<code class="literal">none</code>が設定されていても、モジュールがロードされている限り常にこのメモリが消費されることに注意してください。
  </p><p>これらのパラメータは<code class="filename">postgresql.conf</code>の中で設定しなければなりません。
典型的な使用方法は以下のようになります。

</p><pre class="programlisting"># postgresql.conf
shared_preload_libraries = 'pg_stat_statements'

pg_stat_statements.max = 10000
pg_stat_statements.track = all</pre><p>
  </p></div><div class="sect2" id="id-1.11.7.39.9"><div class="titlepage"><div><div><h3 class="title">F.30.4. サンプル出力</h3></div></div></div><pre class="screen">bench=# SELECT pg_stat_statements_reset();

$ pgbench -i bench
$ pgbench -c10 -t300 bench

bench=# \x
bench=# SELECT query, calls, total_time, rows, 100.0 * shared_blks_hit /
               nullif(shared_blks_hit + shared_blks_read, 0) AS hit_percent
          FROM pg_stat_statements ORDER BY total_time DESC LIMIT 5;
-[ RECORD 1 ]---------------------------------------------------------------------
query       | UPDATE pgbench_branches SET bbalance = bbalance + $1 WHERE bid = $2;
calls       | 3000
total_time  | 9609.00100000002
rows        | 2836
hit_percent | 99.9778970000200936
-[ RECORD 2 ]---------------------------------------------------------------------
query       | UPDATE pgbench_tellers SET tbalance = tbalance + $1 WHERE tid = $2;
calls       | 3000
total_time  | 8015.156
rows        | 2990
hit_percent | 99.9731126579631345
-[ RECORD 3 ]---------------------------------------------------------------------
query       | copy pgbench_accounts from stdin
calls       | 1
total_time  | 310.624
rows        | 100000
hit_percent | 0.30395136778115501520
-[ RECORD 4 ]---------------------------------------------------------------------
query       | UPDATE pgbench_accounts SET abalance = abalance + $1 WHERE aid = $2;
calls       | 3000
total_time  | 271.741999999997
rows        | 3000
hit_percent | 93.7968855088209426
-[ RECORD 5 ]---------------------------------------------------------------------
query       | alter table pgbench_accounts add primary key (aid)
calls       | 1
total_time  | 81.42
rows        | 0
hit_percent | 34.4947735191637631</pre></div><div class="sect2" id="id-1.11.7.39.10"><div class="titlepage"><div><div><h3 class="title">F.30.5. 作者</h3></div></div></div><p>   Takahiro Itagaki <code class="email">&lt;<a class="email" href="mailto:itagaki.takahiro@oss.ntt.co.jp">itagaki.takahiro@oss.ntt.co.jp</a>&gt;</code>。
   Peter Geoghegan <code class="email">&lt;<a class="email" href="mailto:peter@2ndquadrant.com">peter@2ndquadrant.com</a>&gt;</code>により問い合わせの正規化が追加されました。
  </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="pgrowlocks.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="contrib.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="pgstattuple.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">F.29. pgrowlocks </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> F.31. pgstattuple</td></tr></table></div></body></html>