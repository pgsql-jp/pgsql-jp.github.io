<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>F.2. amcheck</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="adminpack.html" title="F.1. adminpack" /><link rel="next" href="auth-delay.html" title="F.3. auth_delay" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">F.2. amcheck</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="adminpack.html" title="F.1. adminpack">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="contrib.html" title="Appendix F. 追加で提供されるモジュール">Up</a></td><th width="60%" align="center">Appendix F. 追加で提供されるモジュール</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="auth-delay.html" title="F.3. auth_delay">Next</a></td></tr></table><hr></hr></div><div class="sect1" id="AMCHECK"><div class="titlepage"><div><div><h2 class="title" style="clear: both">F.2. amcheck</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="amcheck.html#id-1.11.7.11.7">F.2.1. 関数</a></span></dt><dt><span class="sect2"><a href="amcheck.html#id-1.11.7.11.8">F.2.2. <code class="filename">amcheck</code>を効果的に使う</a></span></dt><dt><span class="sect2"><a href="amcheck.html#id-1.11.7.11.9">F.2.3. 破損の修復</a></span></dt></dl></div><a id="id-1.11.7.11.2" class="indexterm"></a><p><code class="filename">amcheck</code>モジュールは、インデックスの構造の論理的な一貫性を検査する機能を提供します。
構造が適正であると見なされれば、エラーは報告されません。
 </p><p>この関数は、特定のインデックスの構造表現における様々な<span class="emphasis"><em>不変量</em></span>を検査します。
インデックスの走査や、その他の重要な操作を担うアクセスメソッド関数の正しさは、これらの不変量を常に保つことに依存しています。
たとえば、ある関数は、とりわけすべてのB-Treeページの中の項目が<span class="quote">“<span class="quote">論理的な</span>”</span>順序になっていることを検査します。（たとえば<code class="type">text</code>のB-Treeインデックスでは、インデックスタプルは語句の照合順になっていなければなりません。）
その特定の不変量が何らかの理由で保たれなければ、該当するページで二分探索が不正なインデックス走査をもたらし、SQL問い合わせに誤った答えを返すことになるでしょう。
 </p><p>検証は、インデックス走査自身で使われるのと同じ手続きを用いて行われます。
その手続きは、ユーザ定義演算子クラスのコードかもしれません。
たとえば、B-Treeインデックスの検査は、一つ以上のB-Treeサポート関数1ルーチンを用いる比較に依存しています。
演算子クラスサポート関数の詳細については<a class="xref" href="xindex.html#XINDEX-SUPPORT" title="37.14.3. インデックスメソッドのサポートルーチン">Section 37.14.3</a>をご覧ください。
 </p><p>  <code class="filename">amcheck</code>関数はスーパーユーザだけが使用できます。
 </p><div class="sect2" id="id-1.11.7.11.7"><div class="titlepage"><div><div><h3 class="title">F.2.1. 関数</h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">     <code class="function">bt_index_check(index regclass) returns void</code>
     <a id="id-1.11.7.11.7.2.1.1.2" class="indexterm"></a>
    </span></dt><dd><p><code class="function">bt_index_check</code>は対象となるB-Treeインデックスが、様々な不変量を維持していることをテストします。
例を示します。
</p><pre class="screen">test=# SELECT bt_index_check(c.oid), c.relname, c.relpages
FROM pg_index i
JOIN pg_opclass op ON i.indclass[0] = op.oid
JOIN pg_am am ON op.opcmethod = am.oid
JOIN pg_class c ON i.indexrelid = c.oid
JOIN pg_namespace n ON c.relnamespace = n.oid
WHERE am.amname = 'btree' AND n.nspname = 'pg_catalog'
-- Don't check temp tables, which may be from another session:
AND c.relpersistence != 't'
-- Function may throw an error when this is omitted:
AND i.indisready AND i.indisvalid
ORDER BY c.relpages DESC LIMIT 10;
 bt_index_check |             relname             | relpages 
----------------+---------------------------------+----------
                | pg_depend_reference_index       |       43
                | pg_depend_depender_index        |       40
                | pg_proc_proname_args_nsp_index  |       31
                | pg_description_o_c_o_index      |       21
                | pg_attribute_relid_attnam_index |       14
                | pg_proc_oid_index               |       10
                | pg_attribute_relid_attnum_index |        9
                | pg_amproc_fam_proc_index        |        5
                | pg_amop_opr_fam_index           |        5
                | pg_amop_fam_strat_index         |        5
(10 rows)</pre><p>
この例では、データベース<span class="quote">“<span class="quote">test</span>”</span>中のすべてのカタログインデックスの検証を行うセッションを示しています。
検証したもっとも大きな10個のインデックスの詳細だけが表示されています。
エラーは出ていないので、テストしたすべてのインデックスは論理的に一貫していることがわかります。
当然のことながら、この問い合わせは、検証可能なデータベース中のすべてのインデックスに対して<code class="function">bt_index_check</code>を呼び出すように変更できます。
     </p><p><code class="function">bt_index_check</code>は、ターゲットとなるインデックスと、それが所属するヒープリレーションに対して<code class="literal">AccessShareLock</code>を獲得します。
このロックモードは、単純な<code class="literal">SELECT</code>文がリレーションに対して獲得するのと同じものです。
<code class="function">bt_index_check</code>は、子／親関係に渡る不変量も、ターゲットのインデックスがヒープリレーションと一貫性があることも検査しません。
実行中のプロダクション環境で定期的、軽量なデータ破損検査が必要な場合、<code class="function">bt_index_check</code>を使うのが、検査の完全性と、アプリケーションの性能と稼働への影響を限定することとの間の最良のトレードオフになることがしばしばあります。
     </p></dd><dt><span class="term">     <code class="function">bt_index_parent_check(index regclass) returns void</code>
     <a id="id-1.11.7.11.7.2.2.1.2" class="indexterm"></a>
    </span></dt><dd><p><code class="function">bt_index_parent_check</code>は、ターゲットとなるB-Treeインデックスが様々な不変量を保っていることを検査します。
<code class="function">bt_index_parent_check</code>により実施される検査は、<code class="function">bt_index_check</code>により実施される検査のスーパーセットになっています。
<code class="function">bt_index_parent_check</code>は、<code class="function">bt_index_check</code>の更なる完璧版であると考えることができます。
つまり、<code class="function">bt_index_check</code>と違って<code class="function">bt_index_parent_check</code>は、子／親関係に渡る不変量も検査します。
しかし、ターゲットのインデックスがヒープリレーションと一貫性があることは検査しません。
<code class="function">bt_index_parent_check</code>は、論理的な非一貫性やその他の問題を発見した場合、一般的な習慣に従ってエラーを報告します。
     </p><p><code class="function">bt_index_parent_check</code>は、ターゲットインデックスに<code class="literal">ShareLock</code>を獲得することを必要とします。
（<code class="literal">ShareLock</code>はヒープリレーションにも獲得されます。）
このロックは、<code class="command">INSERT</code>、<code class="command">UPDATE</code>、<code class="command">DELETE</code>が並行してデータ更新することを防ぎます。
また、このロックは<code class="command">VACUUM</code>その他のユーティリティコマンドによって、背後にあるリレーションが同時に処理されることを防ぎます。
この関数は実行中のみロックを保持し、トランザクション全体に保持するのではないことに注意してください。
     </p><p><code class="function">bt_index_parent_check</code>による追加の検査では、様々な病的な事象を検出する可能性があります。
これらの現象は、チェック対象のインデックスが使用している間違った実装がされたB-Tree演算子クラスによるものや、もしかしたら関連するB-Treeインデックスアクセスメソッドのコード中のまだ見つかっていないバグによるものなのかもしれません。
<code class="function">bt_index_check</code>と違って、<code class="function">bt_index_parent_check</code>は、ホットスタンバイモードが有効な場合（すなわち、読み出し専用物理レプリカ）では使用できません。
     </p></dd></dl></div></div><div class="sect2" id="id-1.11.7.11.8"><div class="titlepage"><div><div><h3 class="title">F.2.2. <code class="filename">amcheck</code>を効果的に使う</h3></div></div></div><p><code class="filename">amcheck</code>は、<a class="link" href="app-initdb.html#APP-INITDB-DATA-CHECKSUMS"><span class="application">データページチェックサム</span></a>が検知できないような、様々なタイプの障害モードを効果的に検知できます。
以下のようなものがあります。
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>演算子クラスの正しくない実装によって引き起こされる構造の非一貫性。
    </p><p>オペレーティングシステムの照合順の比較ルールの変更による問題も含まれます。
<code class="type">text</code>のような照合可能な型のデータの比較は、不変でなけれならず（B-Treeインデックスの走査のための、すべての比較が不変でなければならないのと同じことです）、それはオペレーティングシステムの照合順が決して変化してはいけないことを意味します。
まれであるとは言え、オペレーティングシステムの照合順ルールの更新は、これらの問題を引き起こします。
もっと普通に起こることとしては、マスターサーバとスタンバイサーバの照合順の違いが関与することです。
これは、使用されているオペレーティングシステムの<span class="emphasis"><em>メジャー</em></span>バージョンに一貫性がないことによります。
そうした一貫性の欠如は一般的にスタンバイサーバでのみ起こるので、通常スタンバイサーバでのみ検出されます。
    </p><p>そうした問題が起きても、影響を受けた照合順を使って順序付けられた個々のインデックスには影響ないかもしれません。
これは単純に、振る舞いにおける一貫性のなさにかかわらず<span class="emphasis"><em>インデックスされた</em></span>値は同じ絶対的な順になるからです。
<span class="productname">PostgreSQL</span>がオペレーティングシステムのロケールと照合順をどう使用するかについての更なる詳細については、<a class="xref" href="locale.html" title="23.1. ロケールのサポート">Section 23.1</a>と<a class="xref" href="collation.html" title="23.2. 照合順序サポート">Section 23.2</a>をご覧ください。
    </p></li><li class="listitem"><p>依拠する<span class="productname">PostgreSQL</span>のアクセスメソッド、あるいはソートコードにおける、潜在的なまだ見つかっていないバグによる破損。
    </p><p>新規、あるいは提案中の <span class="productname">PostgreSQL</span>の機能が、論理的な非一貫性をもたらしかねないかどうか全般的にテストする際に、インデックスの構造的な一貫性の自動検証が役立ちます。
わかりやすいテスト戦略の一つは、関数標準の回帰テストを実行中に、<code class="filename">amcheck</code>を継続的に呼び出すことです。
テストの実行に関する詳細は、<a class="xref" href="regress-run.html" title="32.1. テストの実行">Section 32.1</a>をご覧ください。
    </p></li><li class="listitem"><p>単にチェックサムが有効になっていないファイルシステムあるいはストレージサブシステムの障害。
    </p><p><code class="filename">amcheck</code>は、ブロックをアクセスする際に共有バッファがヒットした場合、検査時に共有メモリバッファ上に表現されたページを調査します。
結果として、<code class="filename">amcheck</code>は、検査時にファイルシステムから読み込んだデータを調査するとは限りません。
チェックサムが有効な場合、<code class="filename">amcheck</code>は壊れたブロックをバッファに読み込んだ際にチェックサム障害によるエラーを報告するかもしれません。
    </p></li><li class="listitem"><p>RAMおよび、広範囲に渡るメモリサブシステムとオペレーティングシステムの障害による破損。
    </p><p><span class="productname">PostgreSQL</span>は、訂正可能なメモリーエラーからは身を守らないので、業界標準のエラー訂正コード(ECC)、あるいはもっと優れた保護機構を使ったRAMを使って運用する前提となっています。
しかし、ECCメモリは典型的には単一ビットエラーに対してのみ耐性があり、メモリ破損に起因する障害に対して<span class="emphasis"><em>完全な</em></span>保護を提供すると考えるべきではありません。
    </p></li></ul></div><p>
一般的に、<code class="filename">amcheck</code>は破損の存在を証明することはできますが、破損がないことを証明することはできません。
 </p></div><div class="sect2" id="id-1.11.7.11.9"><div class="titlepage"><div><div><h3 class="title">F.2.3. 破損の修復</h3></div></div></div><p><code class="filename">amcheck</code>が報告するエラーが関与する破損で、擬陽性のものはありません。
実用的には、<code class="filename">amcheck</code>はハードウェアの問題よりも、ソフトウェアバグを発見する可能性が高いです。
<code class="filename">amcheck</code>は、定義により発生してはならないはずの条件下で発生したエラーを報告するので、<code class="filename">amcheck</code>の報告するエラーを注意深く解析することがしばしば求められます。
 </p><p><code class="filename">amcheck</code>が検出した問題を修復する一般的な方法はありません。
不変条件違反の根本的な原因の説明が求められます。
<code class="filename">amcheck</code>が検出した破損の診断には、<a class="xref" href="pageinspect.html" title="F.23. pageinspect">pageinspect</a>が有用な役割を担うかもしれません。
<code class="command">REINDEX</code>は破損の修復には効果的ではないかもしれません。
 </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="adminpack.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="contrib.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="auth-delay.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">F.1. adminpack </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> F.3. auth_delay</td></tr></table></div></body></html>