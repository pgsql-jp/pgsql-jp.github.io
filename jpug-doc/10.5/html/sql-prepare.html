<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>PREPARE</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="sql-notify.html" title="NOTIFY" /><link rel="next" href="sql-prepare-transaction.html" title="PREPARE TRANSACTION" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">PREPARE</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="sql-notify.html" title="NOTIFY">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="sql-commands.html" title="SQLコマンド">Up</a></td><th width="60%" align="center">SQLコマンド</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="sql-prepare-transaction.html" title="PREPARE TRANSACTION">Next</a></td></tr></table><hr></hr></div><div class="refentry" id="SQL-PREPARE"><div class="titlepage"></div><a id="id-1.9.3.152.1" class="indexterm"></a><a id="id-1.9.3.152.2" class="indexterm"></a><div class="refnamediv"><h2><span class="refentrytitle">PREPARE</span></h2><p>PREPARE — 実行する文を準備する</p></div><div class="refsynopsisdiv"><h2>Synopsis</h2><pre class="synopsis">PREPARE <em class="replaceable"><code>name</code></em> [ ( <em class="replaceable"><code>data_type</code></em> [, ...] ) ] AS <em class="replaceable"><code>statement</code></em></pre></div><div class="refsect1" id="id-1.9.3.152.6"><h2>説明</h2><p><code class="command">PREPARE</code>はプリペアド文を作成します。
プリペアド文は、性能を最適化するために利用可能なサーバ側オブジェクトです。
<code class="command">PREPARE</code>文を実行すると、指定された問い合わせの構文解析、書き換えが行われます。
その後、<code class="command">EXECUTE</code>文が発行された際に、プリペアド文は実行計画が作成され、実行されます。
この作業の分割により構文解析作業が繰り返されることを防止でき、さらに、特定のパラメータ値に合わせた実行計画を提供することができます。
  </p><p>プリペアド文はパラメータ、すなわち文が実行される時に代入される値を取ることができます。
プリペアド文を作成する時には<code class="literal">$1</code>や<code class="literal">$2</code>などを使用して、位置によりパラメータを参照してください。
対応するパラメータのデータ型のリストをオプションで指定することもできます。
パラメータのデータ型の指定がない、または、<code class="literal">unknown</code>と宣言されている場合、型はパラメータが使用される文脈より（可能ならば）推測されます。
文の実行時には、<code class="command">EXECUTE</code>文内にこれらのパラメータの実際の値を指定します。
詳細は<a class="xref" href="sql-execute.html" title="EXECUTE"><span class="refentrytitle">EXECUTE</span></a>を参照してください。
  </p><p>プリペアド文は現在のデータベースセッションの期間中にのみ保持されます。
セッションが終了すると、プリペアド文は破棄されます。
そのため、再び利用する場合は、再作成する必要があります。
また、これは、1つのプリペアド文を同時実行中の複数のデータベースクライアントから使用することはできないことを意味します。
ただし、各クライアントが個別にプリペアド文を作成することはできます。
プリペアド文を手作業で削除するには、<a class="xref" href="sql-deallocate.html" title="DEALLOCATE"><span class="refentrytitle">DEALLOCATE</span></a>コマンドを使用します。
  </p><p>プリペアド文は潜在的には、単一のセッションで同類の問い合わせを多数実行する場合に、パフォーマンスにおける最大の利益がえられます。
パフォーマンスの違いは、文の書き換えや実行計画が複雑なほど顕著になるでしょう。
例えば、問い合わせに多数のテーブルの結合が含まれている場合や、いくつものルールを適用しなければならない場合などが考えられます。
書き換えおよび実行計画が比較的単純で、実行コストが高い文の場合は、プリペアド文の効果はそれほど現れないでしょう。
  </p></div><div class="refsect1" id="id-1.9.3.152.7"><h2>パラメータ</h2><div class="variablelist"><dl class="variablelist"><dt><span class="term"><em class="replaceable"><code>name</code></em></span></dt><dd><p>個々のプリペアド文に与えられる任意の名前です。
この名前は、1つのセッション内で一意でなければいけません。プリペアド文の実行および削除の時に、この名前が使用されます。
     </p></dd><dt><span class="term"><em class="replaceable"><code>data_type</code></em></span></dt><dd><p>プリペアド文に対するパラメータのデータ型です。
特定のパラメータのデータ型の指定がない、または、<code class="literal">unknown</code>と指定された場合、パラメータが使用される文脈から推測されます。
プリペアド文自体の中でこのパラメータを参照する時は、<code class="literal">$1</code>、<code class="literal">$2</code>などを使用します。
     </p></dd><dt><span class="term"><em class="replaceable"><code>statement</code></em></span></dt><dd><p>任意の<code class="command">SELECT</code>、<code class="command">INSERT</code>、<code class="command">UPDATE</code>、<code class="command">DELETE</code>、<code class="command">VALUES</code>文です。
     </p></dd></dl></div></div><div class="refsect1" id="SQL-PREPARE-NOTES"><h2>注釈</h2><p>プリペアド文では、提供された<code class="command">EXECUTE</code>の値に対してそれぞれ再計画するのでなく、一般的な計画を利用することができます。
プリペアド文がパラメータを持たない場合、これは即座に起こります。
パラメータを持つ場合は、5回以上の実行の後で、予測されるコストの平均（計画のオーバーヘッドを含む）が一般的な計画のコスト予測よりも高価である計画が生成されたときに、これが起こります。
ひと度、一般的な計画が選ばれれば、そのプリペアド文が存続する間は、それが利用されます。
多くの重複する値がある列で、稀な値を指定した<code class="command">EXECUTE</code>を実行すると、計画のオーバーヘッドを加えた後でも、一般的な計画よりもずっと安価な独自計画が生成できるため、一般的な計画が決して使われなくなるかもしれません。
  </p><p>一般的な計画では、<code class="command">EXECUTE</code>に提供される各値は、列の個別の値の1つで、列の値は均一に分散していることを仮定します。
例えば、統計情報が列の3つの個別値を記録している場合、一般的な計画では列の同値比較において、処理される行の33%にマッチすると仮定します。
列の統計について、一般的な計画では、一意列の選択性について正確に計算することも許しています。
均一に分散していない列における比較や、存在しない値の指定は、平均的な計画のコストに影響を与えるため、一般的な計画が選択されるかどうか、また一般的な計画がいつ選択されるかにも影響します。
  </p><p>プリペアド文に対して<span class="productname">PostgreSQL</span>が使用する問い合わせ計画を検証するためには、<a class="xref" href="sql-explain.html" title="EXPLAIN"><span class="refentrytitle">EXPLAIN</span></a>、例えば<code class="command">EXPLAIN EXECUTE</code>を使用してください。
一般的な計画が使用される場合には、<code class="literal">$<em class="replaceable"><code>n</code></em></code>というパラメータ記号が含まれ、独自計画が使用される場合は提供されたパラメータの値で置換されます。
一般的な計画での行推定は、そのパラメータに対して計算した選択性を反映したものになります。
  </p><p>問い合わせの実行計画や問い合わせの最適化のために<span class="productname">PostgreSQL</span>が収集する統計に関する詳細は、<a class="xref" href="sql-analyze.html" title="ANALYZE"><span class="refentrytitle">ANALYZE</span></a>のドキュメントを参照してください。
  </p><p>プリペアド文の主要な利点は、文の解析処理と計画作成処理の繰り返しを防止することですが、<span class="productname">PostgreSQL</span>では、以前にそのプリペアド文を使用してから、文の中で使用されているデータベースオブジェクトが定義（DDL）の変更を受けた時は常に再解析処理と計画再作成処理を強制します。
また、一度使用してから<a class="xref" href="runtime-config-client.html#GUC-SEARCH-PATH">search_path</a>の値が変わった場合も、文は新しい<code class="varname">search_path</code>を使用して再解析されます。
（後者の振る舞いは<span class="productname">PostgreSQL</span> 9.3の時に追加されました。）
これらの規則により、プリペアド文の使用は意味的に同じ問い合わせを繰り返し再投入することとほぼ同じになりますが、特に最善の計画が使用している間に変わらずに残る場合、オブジェクトの変更がない場合の性能という利点があります。
意味的な等価性が完全ではない場合の例は、
文が未修飾名によってテーブルを参照し、その後同じ名前のテーブルが新たに<code class="varname">search_path</code>内で前に現れるスキーマ内に作成された場合、文の中で使用されるオブジェクトには変更がありませんので、自動再解析は行われません。
しかし他の何らかの変更により強制的に再解析された場合、その後の使用では新しいテーブルが参照されるようになります。

  </p><p><a class="link" href="view-pg-prepared-statements.html" title="51.76. pg_prepared_statements"><code class="structname">pg_prepared_statements</code></a>システムビューを問い合わせることによりセッションで利用可能なプリペアド文をすべて確認することができます。
  </p></div><div class="refsect1" id="SQL-PREPARE-EXAMPLES"><h2>例</h2><p><code class="command">INSERT</code>文に対してプリペアド文を作成し、実行します。
</p><pre class="programlisting">PREPARE fooplan (int, text, bool, numeric) AS
    INSERT INTO foo VALUES($1, $2, $3, $4);
EXECUTE fooplan(1, 'Hunter Valley', 't', 200.00);</pre><p>
  </p><p><code class="command">SELECT</code>文に対してプリペアド文を作成し、実行します。
</p><pre class="programlisting">PREPARE usrrptplan (int) AS
    SELECT * FROM users u, logs l WHERE u.usrid=$1 AND u.usrid=l.usrid
    AND l.date = $2;
EXECUTE usrrptplan(1, current_date);</pre><p>

第2パラメータのデータ型が指定されていないことに注目してください。
このため<code class="literal">$2</code>が使用される文脈からデータ型が推測されます。
  </p></div><div class="refsect1" id="id-1.9.3.152.10"><h2>互換性</h2><p>標準SQLには<code class="command">PREPARE</code>文が含まれていますが、埋め込みSQLでの使用に限られています。
また、標準SQLの<code class="command">PREPARE</code>文では多少異なる構文が使用されます。
  </p></div><div class="refsect1" id="id-1.9.3.152.11"><h2>関連項目</h2><span class="simplelist"><a class="xref" href="sql-deallocate.html" title="DEALLOCATE"><span class="refentrytitle">DEALLOCATE</span></a>, <a class="xref" href="sql-execute.html" title="EXECUTE"><span class="refentrytitle">EXECUTE</span></a></span></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="sql-notify.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="sql-commands.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="sql-prepare-transaction.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">NOTIFY </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> PREPARE TRANSACTION</td></tr></table></div></body></html>