<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>F.32. pg_trgm</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="pgstattuple.html" title="F.31. pgstattuple" /><link rel="next" href="pgvisibility.html" title="F.33. pg_visibility" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">F.32. pg_trgm</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="pgstattuple.html" title="F.31. pgstattuple">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="contrib.html" title="Appendix F. 追加で提供されるモジュール">Up</a></td><th width="60%" align="center">Appendix F. 追加で提供されるモジュール</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="pgvisibility.html" title="F.33. pg_visibility">Next</a></td></tr></table><hr></hr></div><div class="sect1" id="PGTRGM"><div class="titlepage"><div><div><h2 class="title" style="clear: both">F.32. pg_trgm</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="pgtrgm.html#id-1.11.7.41.4">F.32.1. トライグラム（またはトリグラフ）の概念</a></span></dt><dt><span class="sect2"><a href="pgtrgm.html#id-1.11.7.41.5">F.32.2. 関数と演算子</a></span></dt><dt><span class="sect2"><a href="pgtrgm.html#id-1.11.7.41.6">F.32.3. GUCパラメータ</a></span></dt><dt><span class="sect2"><a href="pgtrgm.html#id-1.11.7.41.7">F.32.4. インデックスサポート</a></span></dt><dt><span class="sect2"><a href="pgtrgm.html#id-1.11.7.41.8">F.32.5. テキスト検索の統合</a></span></dt><dt><span class="sect2"><a href="pgtrgm.html#id-1.11.7.41.9">F.32.6. 参考</a></span></dt><dt><span class="sect2"><a href="pgtrgm.html#id-1.11.7.41.10">F.32.7. 作者</a></span></dt></dl></div><a id="id-1.11.7.41.2" class="indexterm"></a><p><code class="filename">pg_trgm</code>モジュールは、類似文字列の高速検索をサポートするインデックス演算子クラスだけではなく、トライグラム一致に基づく英数字の類似度の決定に関する関数と演算子も提供します。
 </p><div class="sect2" id="id-1.11.7.41.4"><div class="titlepage"><div><div><h3 class="title">F.32.1. トライグラム（またはトリグラフ）の概念</h3></div></div></div><p>トライグラムは文字列から3つの連続する文字を取り出したグループです。
共有するトライグラムの個数を数えることで、２つの文字列の類似度を測定することができます。
この単純な考えが、多くの自然言語における単語の類似度を測定する際に非常に効率的であることが判明しています。
  </p><div class="note"><h3 class="title">Note</h3><p><code class="filename">pg_trgm</code>は、文字列からトライグラムを抽出する時に単語以外の文字（英数字以外）を無視します。
文字列内に含まれるトライグラム集合を決める際、文字列の前に２つの空白、後に1つの空白が付いているものとみなされます。
例えば、<span class="quote">“<span class="quote"><code class="literal">cat</code></span>”</span>という文字列のトライグラム集合は、<span class="quote">“<span class="quote"><code class="literal">  c</code></span>”</span>、<span class="quote">“<span class="quote"><code class="literal"> ca</code></span>”</span>、<span class="quote">“<span class="quote"><code class="literal">cat</code></span>”</span>、<span class="quote">“<span class="quote"><code class="literal">at </code></span>”</span>です。
<span class="quote">“<span class="quote"><code class="literal">foo|bar</code></span>”</span>という文字列のトライグラム集合は、<span class="quote">“<span class="quote"><code class="literal">  f</code></span>”</span>、<span class="quote">“<span class="quote"><code class="literal"> fo</code></span>”</span>、<span class="quote">“<span class="quote"><code class="literal">foo</code></span>”</span>、<span class="quote">“<span class="quote"><code class="literal">oo </code></span>”</span>、<span class="quote">“<span class="quote"><code class="literal">  b</code></span>”</span>、<span class="quote">“<span class="quote"><code class="literal"> ba</code></span>”</span>、<span class="quote">“<span class="quote"><code class="literal">bar</code></span>”</span>、<span class="quote">“<span class="quote"><code class="literal">ar </code></span>”</span>です。
   </p></div></div><div class="sect2" id="id-1.11.7.41.5"><div class="titlepage"><div><div><h3 class="title">F.32.2. 関数と演算子</h3></div></div></div><p><code class="filename">pg_trgm</code>モジュールで提供される関数を<a class="xref" href="pgtrgm.html#PGTRGM-FUNC-TABLE" title="Table F.25. pg_trgm関数">Table F.25</a>に、演算子を<a class="xref" href="pgtrgm.html#PGTRGM-OP-TABLE" title="Table F.26. pg_trgm演算子">Table F.26</a>に示します。
  </p><div class="table" id="PGTRGM-FUNC-TABLE"><p class="title"><strong>Table F.25. <code class="filename">pg_trgm</code>関数</strong></p><div class="table-contents"><table class="table" summary="pg_trgm関数" border="1"><colgroup><col /><col /><col /></colgroup><thead><tr><th>関数</th><th>戻り値</th><th>説明</th></tr></thead><tbody><tr><td><code class="function">similarity(text, text)</code><a id="id-1.11.7.41.5.3.2.2.1.1.2" class="indexterm"></a></td><td><code class="type">real</code></td><td>２つの引数がどの程度似ているかを示す数値を返します。
結果はゼロ（２つの文字列がまったく類似していないことを示す）から1（２つの文字列が同一であることを示す）までの範囲です。
      </td></tr><tr><td><code class="function">show_trgm(text)</code><a id="id-1.11.7.41.5.3.2.2.2.1.2" class="indexterm"></a></td><td><code class="type">text[]</code></td><td>与えられた文字列内のすべてのトライグラムからなる配列を返します。
（実際これはデバッグ時を除いて役に立つことはほぼありません。）
      </td></tr><tr><td>       <code class="function">word_similarity(text, text)</code>
       <a id="id-1.11.7.41.5.3.2.2.3.1.2" class="indexterm"></a>
      </td><td><code class="type">real</code></td><td>最初の引数文字列中のトライグラムの集合と、二番目の引数文字列中の順序付きトライグラム集合の中で最も類似度の高い連続した範囲の類似度を表す数字を返します。
詳細は以下の説明をご覧ください。
      </td></tr><tr><td><code class="function">show_limit()</code><a id="id-1.11.7.41.5.3.2.2.4.1.2" class="indexterm"></a></td><td><code class="type">real</code></td><td><code class="literal">%</code>演算子で使用される現在の類似度閾値を返します。
これは、例えば２つの単語それぞれでミススペルがあったとしても類似しているものとみなす、その2つの単語間の最低の類似度を設定します。（<span class="emphasis"><em>廃止予定</em></span>）
      </td></tr><tr><td><code class="function">set_limit(real)</code><a id="id-1.11.7.41.5.3.2.2.5.1.2" class="indexterm"></a></td><td><code class="type">real</code></td><td><code class="literal">%</code>演算子で使用される現在の類似度閾値を設定します。
閾値は0から1までの値でなければなりません（デフォルトは0.3です）。
渡された値と同じ値が返ります。（<span class="emphasis"><em>廃止予定</em></span>）
      </td></tr></tbody></table></div></div><br class="table-break" /><p>以下の例を考えます。

</p><pre class="programlisting"># SELECT word_similarity('word', 'two words');
 word_similarity
-----------------
             0.8
(1 row)</pre><p>

最初の文字列では、トライグラムの集合は<code class="literal">{"  w"," wo","ord","wor","rd "}</code>です。
二番目の文字列では、順序付きトライグラムの集合は<code class="literal">{"  t"," tw",two,"wo ","  w"," wo","wor","ord","rds", ds "}</code>です。
二番目の文字列中の順序付きトライグラムの集合の中で最も類似度の高い範囲は、<code class="literal">{"  w"," wo","wor","ord"}</code>で、類似度は<code class="literal">0.8</code>となります。
  </p><p>この関数が返す値は、最初の文字列と、二番目の文字列の部分文字列の間の最大の類似度を表す値であると、概ね解釈できます。
しかし、この関数は範囲の境界に対してパディングを行いません。
ですから、語の一部が一致するよりも、語全体が一致する方がより高い得点を得ます。
  </p><div class="table" id="PGTRGM-OP-TABLE"><p class="title"><strong>Table F.26. <code class="filename">pg_trgm</code>演算子</strong></p><div class="table-contents"><table class="table" summary="pg_trgm演算子" border="1"><colgroup><col /><col /><col /></colgroup><thead><tr><th>演算子</th><th>戻り値</th><th>説明</th></tr></thead><tbody><tr><td><code class="type">text</code> <code class="literal">%</code> <code class="type">text</code></td><td><code class="type">boolean</code></td><td>２つの引数が<code class="varname">pg_trgm.similarity_threshold</code>で設定された類似度閾値以上の類似度を持つ場合<code class="literal">true</code>を返します。
      </td></tr><tr><td><code class="type">text</code> <code class="literal">&lt;%</code> <code class="type">text</code></td><td><code class="type">boolean</code></td><td>最初の引数中のトライグラムの集合と、二番目の引数中の順序付きトライグラム集合の中の範囲の類似度が、<code class="varname">pg_trgm.word_similarity_threshold</code>引数で設定した現在の語類似度の閾値よりも高い場合に<code class="literal">true</code>を返します。
      </td></tr><tr><td><code class="type">text</code> <code class="literal">%&gt;</code> <code class="type">text</code></td><td><code class="type">boolean</code></td><td><code class="literal">&lt;%</code>演算子の交代演算子です。
      </td></tr><tr><td><code class="type">text</code> <code class="literal">&lt;-&gt;</code> <code class="type">text</code></td><td><code class="type">real</code></td><td>引数間の<span class="quote">“<span class="quote">距離</span>”</span>、この場合は1 - <code class="function">similarity()</code>の値を返します。
      </td></tr><tr><td>       <code class="type">text</code> <code class="literal">&lt;&lt;-&gt;</code> <code class="type">text</code>
      </td><td><code class="type">real</code></td><td>引数間の<span class="quote">“<span class="quote">距離</span>”</span>、この場合は1 - <code class="function">word_similarity()</code>の値を返します。
      </td></tr><tr><td>       <code class="type">text</code> <code class="literal">&lt;-&gt;&gt;</code> <code class="type">text</code>
      </td><td><code class="type">real</code></td><td><code class="literal">&lt;&lt;-&gt;</code>演算子の交代演算子です。
      </td></tr></tbody></table></div></div><br class="table-break" /></div><div class="sect2" id="id-1.11.7.41.6"><div class="titlepage"><div><div><h3 class="title">F.32.3. GUCパラメータ</h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt id="GUC-PGTRGM-SIMILARITY-THRESHOLD"><span class="term">     <code class="varname">pg_trgm.similarity_threshold</code> (<code class="type">real</code>)
     <a id="id-1.11.7.41.6.2.1.1.3" class="indexterm"></a>
    </span></dt><dd><p><code class="literal">%</code>演算子が使用する現在の類似度閾値を設定します。
閾値は0から1の間でなければなりません。（デフォルトは0.3です）
     </p></dd><dt id="GUC-PGTRGM-WORD-SIMILARITY-THRESHOLD"><span class="term">      <code class="varname">pg_trgm.word_similarity_threshold</code> (<code class="type">real</code>)
      <a id="id-1.11.7.41.6.2.2.1.3" class="indexterm"></a>
     </span></dt><dd><p><code class="literal">&lt;%</code>と<code class="literal">%&gt;</code><code class="literal">%</code>演算子が使用する現在の語類似度閾値を設定します。
閾値は0から1の間でなければなりません。（デフォルトは0.6です）
      </p></dd></dl></div></div><div class="sect2" id="id-1.11.7.41.7"><div class="titlepage"><div><div><h3 class="title">F.32.4. インデックスサポート</h3></div></div></div><p><code class="literal">pg_trgm</code>モジュールは、テキスト列全体に非常に高速な類似度検索を行うためのインデックスを作成することができるように、GiSTおよびGINインデックス演算子クラスを提供します。
これらのインデックス種類は上記類似度演算子をサポートし、さらに<code class="literal">LIKE</code>、<code class="literal">ILIKE</code>、<code class="literal">~</code>および<code class="literal">~*</code>問い合わせにおけるトライグラムを基にしたインデックス検索をサポートします。
（これらのインデックスは等価性や単純な比較演算子をサポートしません。ですので通常のB-treeインデックスも必要になるかもしれません。）
  </p><p>例：

</p><pre class="programlisting">CREATE TABLE test_trgm (t text);
CREATE INDEX trgm_idx ON test_trgm USING GIST (t gist_trgm_ops);</pre><p>
または
</p><pre class="programlisting">CREATE INDEX trgm_idx ON test_trgm USING GIN (t gin_trgm_ops);</pre><p>
  </p><p>この段階で、テキスト列<code class="structfield">t</code>に類似度検索で使用可能なインデックスがあります。
典型的な問い合わせを以下に示します。
</p><pre class="programlisting">SELECT t, similarity(t, '<em class="replaceable"><code>word</code></em>') AS sml
  FROM test_trgm
  WHERE t % '<em class="replaceable"><code>word</code></em>'
  ORDER BY sml DESC, t;</pre><p>
これは、<em class="replaceable"><code>word</code></em>に十分似たテキスト列の値をすべて、類似度の高い順番に返します。
インデックスは非常に大規模なデータ群に対する高速操作を行うために使用されます。
  </p><p>以下は上の問い合わせを変形させたものです。
</p><pre class="programlisting">SELECT t, t &lt;-&gt; '<em class="replaceable"><code>word</code></em>' AS dist
  FROM test_trgm
  ORDER BY dist LIMIT 10;</pre><p>
これはGINインデックスではなくGiSTインデックスにより非常に効率的に実装することができます。
通常、類似度が高いものの中から少ない個数のみを必要とする場合、1番目の式よりも効率的です。
  </p><p>また、語の類似度に対して<code class="structfield">t</code>列のインデックスを使うことができます。
例を示します。
</p><pre class="programlisting">SELECT t, word_similarity('<em class="replaceable"><code>word</code></em>', t) AS sml
  FROM test_trgm
  WHERE '<em class="replaceable"><code>word</code></em>' &lt;% t
  ORDER BY sml DESC, t;</pre><p>
これは、<em class="replaceable"><code>word</code></em>のトライグラム集合に十分似ている順序順序付きトライグラム集合に対応する連続した領域が存在するテキスト列中のすべての値を返します。
結果は、最も似ているものから、最も似ていないものへの順にソートされます。
インデックスは、非常に大きなデータ集合に対しても高速な操作ができるようにするために使われます。
  </p><p>先の問い合わせをちょっと変更すると次のようになります。
</p><pre class="programlisting">SELECT t, '<em class="replaceable"><code>word</code></em>' &lt;&lt;-&gt; t AS dist
  FROM test_trgm
  ORDER BY dist LIMIT 10;</pre><p>
これはGINインデックスではなく、GiSTインデックスによって極めて効率的に実装できます。
  </p><p><span class="productname">PostgreSQL</span> 9.1から、これらのインデックス種類は<code class="literal">LIKE</code>および<code class="literal">ILIKE</code>におけるインデックス検索をサポートします。
以下に例を示します。
</p><pre class="programlisting">SELECT * FROM test_trgm WHERE t LIKE '%foo%bar';</pre><p>
インデックス検索は、検索文字列からトライグラムを抽出し、それらをインデックスから検索することによって動作します。
検索文字列内のトライグラムが多ければ、よりインデックス検索が効率的になります。
B-treeを基にした検索とは異なり、検索文字列の左側が固定されている必要はありません。
  </p><p><span class="productname">PostgreSQL</span> 9.3から、これらの種類のインデックスは正規表現一致（<code class="literal">~</code>および<code class="literal">~*</code>演算子）に対するインデックス検索もサポートします。
以下に例を示します。
</p><pre class="programlisting">SELECT * FROM test_trgm WHERE t ~ '(foo|bar)';</pre><p>
インデックス検索は、正規表現からトライグラムを抽出し、それらをインデックスから検索することで動作します。
より多くのトライグラムが正規表現から抽出される場合、インデックス検索はより効率的になります。
B-treeを基にした検索と異なり、検索文字列は先頭一致である必要はありません。
  </p><p><code class="literal">LIKE</code>および正規表現検索の両方で、トライグラムが抽出されないパターンでは完全インデックススキャンより性能が落ちることに注意してください。
  </p><p>GiSTまたはGINインデックスの選択は、他で説明されるGiSTとGINの相対的な性能特性に依存します。
これについては、別途議論されています。
  </p></div><div class="sect2" id="id-1.11.7.41.8"><div class="titlepage"><div><div><h3 class="title">F.32.5. テキスト検索の統合</h3></div></div></div><p>トライグラム一致は全文テキストインデックスと一緒に使用する時、非常に有用なツールです。
特に、全文検索機構では直接一致しない、ミススペルがある入力単語の認識を行うために役に立ちます。
  </p><p>第一段階は文書内で一意な単語からなる補助テーブルを生成することです。

</p><pre class="programlisting">CREATE TABLE words AS SELECT word FROM
        ts_stat('SELECT to_tsvector(''simple'', bodytext) FROM documents');</pre><p>

ここで<code class="structname">documents</code>は、検索対象の<code class="structfield">bodytext</code>テキストフィールドを持つテーブルです。
言語固有の設定を使用するのではなく、<code class="function">to_tsvector</code>関数で<code class="literal">simple</code>設定を使用する理由は、元の（語幹抽出されていない）単語のリストが欲しいためです。
  </p><p>次にword列にトライグラムインデックスを作成します。

</p><pre class="programlisting">CREATE INDEX words_idx ON words USING GIN (word gin_trgm_ops);</pre><p>

これで、上の例に似た<code class="literal">SELECT</code>問い合わせを使用して、ユーザの検索語内でミススペルのある単語を提示できるようになります。
有用な追加された試験は、選択された単語の長さがミススペルのある単語の長さとほぼ同じになることを要求するものです。
  </p><div class="note"><h3 class="title">Note</h3><p><code class="structname">words</code>テーブルは別に生成された静的なテーブルですので、文書群の更新に合理的に追従できるよう定期的に再生成する必要があります。
正確に最新状態を維持する必要性は通常ありません。
   </p></div></div><div class="sect2" id="id-1.11.7.41.9"><div class="titlepage"><div><div><h3 class="title">F.32.6. 参考</h3></div></div></div><p>GiST開発サイト
   <a class="ulink" href="http://www.sai.msu.su/~megera/postgres/gist/" target="_top">http://www.sai.msu.su/~megera/postgres/gist/</a>
  </p><p>Tsearch2開発サイト
   <a class="ulink" href="http://www.sai.msu.su/~megera/postgres/gist/tsearch/V2/" target="_top">http://www.sai.msu.su/~megera/postgres/gist/tsearch/V2/</a>
  </p></div><div class="sect2" id="id-1.11.7.41.10"><div class="titlepage"><div><div><h3 class="title">F.32.7. 作者</h3></div></div></div><p>   Oleg Bartunov <code class="email">&lt;<a class="email" href="mailto:oleg@sai.msu.su">oleg@sai.msu.su</a>&gt;</code>, Moscow, Moscow University, Russia
  </p><p>   Teodor Sigaev <code class="email">&lt;<a class="email" href="mailto:teodor@sigaev.ru">teodor@sigaev.ru</a>&gt;</code>, Moscow, Delta-Soft Ltd.,Russia
  </p><p>   Alexander Korotkov <code class="email">&lt;<a class="email" href="mailto:a.korotkov@postgrespro.ru">a.korotkov@postgrespro.ru</a>&gt;</code>, Moscow, Postgres Professional, Russia
  </p><p>文書作成: Christopher Kings-Lynne
  </p><p>本モジュールはロシアモスクワのDelta-Soft Ltd.による後援です。
  </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="pgstattuple.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="contrib.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="pgvisibility.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">F.31. pgstattuple </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> F.33. pg_visibility</td></tr></table></div></body></html>