<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>42.2. PL/pgSQLの構造</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="plpgsql-overview.html" title="42.1. 概要" /><link rel="next" href="plpgsql-declarations.html" title="42.3. 宣言" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">42.2. <span xmlns="http://www.w3.org/1999/xhtml" class="application">PL/pgSQL</span>の構造</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="plpgsql-overview.html" title="42.1. 概要">Prev</a> </td><td width="10%" align="left"><a accesskey="u" href="plpgsql.html" title="Chapter 42. PL/pgSQL - SQL手続き言語">Up</a></td><th width="60%" align="center">Chapter 42. <span xmlns="http://www.w3.org/1999/xhtml" class="application">PL/pgSQL</span> - <acronym xmlns="http://www.w3.org/1999/xhtml" class="acronym">SQL</acronym>手続き言語</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 10.5文書">Home</a></td><td width="10%" align="right"> <a accesskey="n" href="plpgsql-declarations.html" title="42.3. 宣言">Next</a></td></tr></table><hr></hr></div><div class="sect1" id="PLPGSQL-STRUCTURE"><div class="titlepage"><div><div><h2 class="title" style="clear: both">42.2. <span class="application">PL/pgSQL</span>の構造</h2></div></div></div><p><span class="application">PL/pgSQL</span>で書かれた関数は<a class="xref" href="sql-createfunction.html" title="CREATE FUNCTION"><span class="refentrytitle">CREATE FUNCTION</span></a>コマンドを実行することでサーバに定義されます。
そのようなコマンドは通常、例えば次のようになります。
</p><pre class="programlisting">CREATE FUNCTION somefunc(integer, text) RETURNS integer
AS '<em class="replaceable"><code>function body text</code></em>'
LANGUAGE plpgsql;</pre><p>
関数本体は<code class="command">CREATE FUNCTION</code>にとっては単なる文字列リテラルです。
関数本体を書くのには、普通の単一引用符構文よりは、ドル引用符(<a class="xref" href="sql-syntax-lexical.html#SQL-SYNTAX-DOLLAR-QUOTING" title="4.1.2.4. ドル記号で引用符付けされた文字列定数">Section 4.1.2.4</a>を参照)を使うのが、多くの場合役に立ちます。
ドル引用符でなければ、関数本体内の単一引用符やバックスラッシュをすべて二重化してエスケープしなければなりません。
この章のほぼすべての例では、関数本体にドル記号で括られたリテラルを使っています。
  </p><p><span class="application">PL/pgSQL</span>はブロック構造の言語です。
関数本体のテキスト全体は<em class="firstterm">ブロック</em>でなければなりません。
ブロックは以下のように定義されます。

</p><pre class="synopsis">[<span class="optional"> &lt;&lt;<em class="replaceable"><code>label</code></em>&gt;&gt; </span>]
[<span class="optional"> DECLARE
    <em class="replaceable"><code>declarations</code></em> </span>]
BEGIN
    <em class="replaceable"><code>statements</code></em>
END [<span class="optional"> <em class="replaceable"><code>label</code></em> </span>];</pre><p>
    </p><p>ブロック内の宣言や文はそれぞれ、セミコロンで終わります。
上に示したように、他のブロック内に出現するブロックの<code class="literal">END</code>の後にはセミコロンが必要ですが、関数本体を完結する最後の<code class="literal">END</code>には不要です。
    </p><div class="tip"><h3 class="title">Tip</h3><p><code class="literal">BEGIN</code>の直後にセミコロンを書くことも、同じように間違いです。
これは不正であり、構文エラーとなります。
     </p></div><p><em class="replaceable"><code>label</code></em>が必要となるのは、<code class="literal">EXIT</code>文が使用されるブロックを特定したい場合、またはブロック内で宣言された変数名を修飾したい場合だけです。
<code class="literal">END</code>の後にラベルを配置する時は、そのブロックの先頭ラベルと一致させなければなりません。
    </p><p>全てのキーワードは大文字と小文字を区別しません。
識別子は二重引用符でくくられていない限り、通常のSQLコマンドと同様に、暗黙的に小文字に変換されます。
    </p><p><span class="application">PL/pgSQL</span>コード内では、通常のSQLと同じ方法のコメントが動作します。
二重のダッシュ(<code class="literal">--</code>)はその行末までをコメントとするコメントを開始します。
<code class="literal">/*</code>はコメントブロックの始まりを意味し、次に<code class="literal">*/</code>が現れるまでをコメントとします。
ブロックコメントは入れ子になります。
    </p><p>ブロックの文節内の全ての文は<em class="firstterm">副ブロック</em>になることができます。
副ブロックは論理的なグループ分けや変数を文の小さな集まりに局所化するのに使用できます。
副ブロックにおいて宣言された変数は、副ブロック内部では外側のブロックにおける同名の変数を遮蔽しますが、外側のラベルを変数名に付加して指定すればアクセスできます。
以下に例を示します。
</p><pre class="programlisting">CREATE FUNCTION somefunc() RETURNS integer AS $$
&lt;&lt; outerblock &gt;&gt;
DECLARE
    quantity integer := 30;
BEGIN
    RAISE NOTICE 'Quantity here is %', quantity;  -- Quantity here is 30と表示
    quantity := 50;
    --
    -- 副ブロックの作成
    --
    DECLARE
        quantity integer := 80;
    BEGIN
        RAISE NOTICE 'Quantity here is %', quantity;  -- Quantity here is 80と表示
        RAISE NOTICE 'Outer quantity here is %', outerblock.quantity;  -- Quantity here is 50と表示
    END;

    RAISE NOTICE 'Quantity here is %', quantity;  -- Quantity here is 50と表示

    RETURN quantity;
END;
$$ LANGUAGE plpgsql;</pre><p>
    </p><div class="note"><h3 class="title">Note</h3><p><span class="application">PL/pgSQL</span>関数の本体を囲む、隠れた<span class="quote">“<span class="quote">外側のブロック</span>”</span>が存在します。
この隠れたブロックにおいて、関数のパラメータがあれば宣言をして、同様に<code class="literal">FOUND</code>のような特殊な変数（<a class="xref" href="plpgsql-statements.html#PLPGSQL-STATEMENTS-DIAGNOSTICS" title="42.5.5. 結果ステータスの取得">Section 42.5.5</a>を参照）を提供します。
この外側のブロックのラベルは関数名となります。
つまりパラメータと特殊な変数は関数名によって修飾することを意味します。
     </p></div><p><span class="application">PL/pgSQL</span>における文をまとめるための<code class="command">BEGIN</code>/<code class="command">END</code>とトランザクション制御用の同名のSQLコマンドとを取り違えないようにすることが重要です。
<span class="application">PL/pgSQL</span>の<code class="command">BEGIN</code>/<code class="command">END</code>は単にまとめるためのもので、トランザクションを始めたり終わらせたりしません。
関数とトリガプロシージャは常に外側の問い合わせで確立されたトランザクションの内側で実行されます。
トランザクションの実行させる文脈はありませんので、これらはトランザクションを開始することもコミットすることもできません。
しかし、<code class="literal">EXCEPTION</code>句を含むブロックは外側のトランザクションに影響しないでロールバックできるサブトランザクションを、実質的に作成できます。
これについては<a class="xref" href="plpgsql-control-structures.html#PLPGSQL-ERROR-TRAPPING" title="42.6.6. エラーの捕捉">Section 42.6.6</a>を参照してください。
    </p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="plpgsql-overview.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="plpgsql.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="plpgsql-declarations.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">42.1. 概要 </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 42.3. 宣言</td></tr></table></div></body></html>